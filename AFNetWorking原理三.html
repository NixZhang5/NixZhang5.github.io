<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    

    

    



    <meta charset="utf-8">
    
    
    
    
    <title>AFNetWorkingåŸç†ä¸‰ AFURLRequestSerialization | Xinping&#39;s Blog | å› ä¸ºæœ‰äº†å±æœºæ„Ÿï¼Œæ‰€ä»¥æ‰ä¼šä¹‰æ— åé¡¾ã€‚</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="AFNetWorkingåŸç†">
    <meta name="description" content="AFURLRequestSerializationåºåˆ—åŒ–ç½‘ç»œè¯·æ±‚å‚æ•°">
<meta name="keywords" content="AFNetWorkingåŸç†">
<meta property="og:type" content="article">
<meta property="og:title" content="AFNetWorkingåŸç†ä¸‰ AFURLRequestSerialization">
<meta property="og:url" content="https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html">
<meta property="og:site_name" content="Xinping&#39;s Blog">
<meta property="og:description" content="AFURLRequestSerializationåºåˆ—åŒ–ç½‘ç»œè¯·æ±‚å‚æ•°">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-07-01T03:39:01.038Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AFNetWorkingåŸç†ä¸‰ AFURLRequestSerialization">
<meta name="twitter:description" content="AFURLRequestSerializationåºåˆ—åŒ–ç½‘ç»œè¯·æ±‚å‚æ•°">
    
        <link rel="alternate" type="application/atom+xml" title="Xinping&#39;s Blog" href="/atom.xml">
    
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//unpkg.com/hexo-theme-material-indigo@latest/css/style.css">
    <script>window.lazyScripts=[]</script>

    <!-- custom head -->
    

</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap" style="background-image:url(/img/brand.jpg)">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">å¼ æ–°å¹³</h5>
          <a href="mailto:351235445@qq.com" title="351235445@qq.com" class="mail">351235445@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                ä¸»é¡µ
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                Archives
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                Tags
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                Categories
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/NixZhang5" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">AFNetWorkingåŸç†ä¸‰ AFURLRequestSerialization</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">AFNetWorkingåŸç†ä¸‰ AFURLRequestSerialization</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-06-27T03:28:59.000Z" itemprop="datePublished" class="page-time">
  2019-06-27
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/iOS/">iOS</a></li></ul>

            
        </h5>
    </div>

    


</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap post-toc-shrink" id="post-toc">
            <h4>TOC</h4>
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#å·¥å…·å‡½æ•°"><span class="post-toc-number">1.</span> <span class="post-toc-text">å·¥å…·å‡½æ•°</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#AFPercentEscapedStringFromString"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">AFPercentEscapedStringFromString</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#AFQueryStringFromParameters"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">AFQueryStringFromParameters</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#AFURLRequestSerialization"><span class="post-toc-number">2.</span> <span class="post-toc-text">AFURLRequestSerialization</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#AFHTTPRequestSerializer"><span class="post-toc-number">3.</span> <span class="post-toc-text">AFHTTPRequestSerializer</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ç¼“å­˜ç­–ç•¥"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">ç¼“å­˜ç­–ç•¥</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#AFMultipartFormDataåè®®"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">AFMultipartFormDataåè®®</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer"><span class="post-toc-number">4.</span> <span class="post-toc-text">AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer</span></a></li></ol>
        </nav>
    </aside>


<article id="post-AFNetWorkingåŸç†ä¸‰"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">AFNetWorkingåŸç†ä¸‰ AFURLRequestSerialization</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-06-27 11:28:59" datetime="2019-06-27T03:28:59.000Z"  itemprop="datePublished">2019-06-27</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/iOS/">iOS</a></li></ul>



            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <p>AFURLRequestSerializationåºåˆ—åŒ–ç½‘ç»œè¯·æ±‚å‚æ•°</p>
<a id="more"></a>

<p>AFURLRequestSerializationåŒ…å«äº†å››ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>å…¨å±€æ–¹æ³•:AFPercentEscapedStringFromStringå’ŒAFQueryStringFromParametersã€‚</li>
<li>åè®®AFURLRequestSerializationæä¾›äº†ä¸€ä¸ªåºåˆ—åŒ–parameterså‚æ•°çš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå‚æ•°è½¬æ¢ä¸ºæŸ¥è¯¢å­—ç¬¦ä¸²ã€HTTPè¯·æ±‚ä½“ã€è®¾ç½®æ°å½“çš„è¯·æ±‚å¤´ç­‰ã€‚</li>
<li>AFHTTPRequestSerializerç»§æ‰¿è‡ªAFURLRequestSerializationåè®®ã€‚æä¾›äº†æŸ¥è¯¢å­—ç¬¦ä¸²/URLæ ¼å¼çš„å‚æ•°åºåˆ—åŒ–ã€é»˜è®¤è¯·æ±‚å¤´å¤„ç†ã€‚åŒæ—¶ä»¥æä¾›HTTPçŠ¶æ€ç å’Œè¿”å›æ•°æ®çš„éªŒè¯ç­‰å·¥ä½œã€‚<br>_ AFMultipartFormDataåè®®ã€‚ä¸»è¦ç”¨äºæ·»åŠ multipart/form-dataè¯·æ±‚çš„Content-Disposition: file; filename=#{generated filename}; name=#{name}â€ å’Œ Content-Type: #{generated mimeType}çš„è¯·æ±‚ä½“åŸŸã€‚</li>
<li>ç±»å‹AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializerã€‚ä¸»è¦é’ˆå¯¹JSONå’ŒPlistç±»å‹çš„åºåˆ—åŒ–ä¼˜åŒ–ã€‚</li>
</ol>
<h3 id="å·¥å…·å‡½æ•°"><a href="#å·¥å…·å‡½æ•°" class="headerlink" title="å·¥å…·å‡½æ•°"></a>å·¥å…·å‡½æ•°</h3><h4 id="AFPercentEscapedStringFromString"><a href="#AFPercentEscapedStringFromString" class="headerlink" title="AFPercentEscapedStringFromString"></a>AFPercentEscapedStringFromString</h4><p>æŠŠå­—ç¬¦ä¸²è½¬åŒ–æˆç¬¦åˆæ ‡å‡†çš„URLç¼–ç å­—ç¬¦ä¸²ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªå­—ç¬¦é›†NSMutableCharacterSetæ¥å®šä¹‰éœ€è¦è¿›è¡Œè½¬ç çš„å­—ç¬¦ï¼Œå†é€šè¿‡-[NSString stringByAddingPercentEncodingWithAllowedCharacters]æ–¹æ³•æ¥è¿›è¡Œè½¬ç ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">AFURLRequestSerialization.h</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * AFPercentEscapedStringFromString(<span class="built_in">NSString</span> *string);</span><br><span class="line"></span><br><span class="line">AFURLRequestSerialization.m</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> * AFPercentEscapedStringFromString(<span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">    <span class="comment">// does not include "?" or "/" due to RFC 3986 - Section 3.4</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kAFCharactersGeneralDelimitersToEncode = <span class="string">@":#[]@"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kAFCharactersSubDelimitersToEncode = <span class="string">@"!$&amp;'()*+,;="</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableCharacterSet</span> * allowedCharacterSet = [[<span class="built_in">NSCharacterSet</span> URLQueryAllowedCharacterSet] mutableCopy];</span><br><span class="line">    [allowedCharacterSet removeCharactersInString:[kAFCharactersGeneralDelimitersToEncode stringByAppendingString:kAFCharactersSubDelimitersToEncode]];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSUInteger</span> <span class="keyword">const</span> batchSize = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSUInteger</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *escaped = <span class="string">@""</span>.mutableCopy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (index &lt; string.length) &#123;</span><br><span class="line">        <span class="built_in">NSUInteger</span> length = MIN(string.length - index, batchSize);</span><br><span class="line">        <span class="built_in">NSRange</span> range = <span class="built_in">NSMakeRange</span>(index, length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// To avoid breaking up character sequences such as ğŸ‘´ğŸ»ğŸ‘®ğŸ½</span></span><br><span class="line">        range = [string rangeOfComposedCharacterSequencesForRange:range];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSString</span> *substring = [string substringWithRange:range];</span><br><span class="line">        <span class="built_in">NSString</span> *encoded = [substring stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</span><br><span class="line">        [escaped appendString:encoded];</span><br><span class="line"></span><br><span class="line">        index += range.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> escaped;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AFQueryStringFromParameters"><a href="#AFQueryStringFromParameters" class="headerlink" title="AFQueryStringFromParameters"></a>AFQueryStringFromParameters</h4><p>æŠŠå­—å…¸è½¬åŒ–ä¸º&amp;æ‹¼æ¥çš„å‚æ•°ï¼Œé€šè¿‡AFQueryStringPairç±»æ¥å®ç°çš„ã€‚</p>
<p>AFQueryStringPairæ¥å­˜å–æ¯ä¸€ä¸ªæŸ¥è¯¢å±æ€§ï¼Œå°†æŸ¥è¯¢çš„é”®å€¼ä¿æŒèµ·æ¥ï¼Œç„¶åé€šè¿‡URLEncodedStringValueæ–¹æ³•åœ¨éœ€è¦æ—¶è¿›è¡Œæ‹¼æ¥ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ä¸Šé¢æ‰€è¿°çš„AFPercentEscapedStringFromStringæ–¹æ³•è¿›è¡Œäº†URLEncodeã€‚å…¶ä¸­æœ€ä¸»è¦çš„æ–¹æ³•æ˜¯AFQueryStringPairsFromKeyAndValueï¼Œå®ƒå°†å­—å…¸çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹ç”Ÿæˆçš„å¯¹åº”çš„AFQueryStringPairå¯¹è±¡ï¼Œä¾‹å¦‚å°†machine:[iphone, mac]è½¬æ¢ä¸ºURLEncodedStringValueå€¼æ˜¯machine[]=iphoneå’Œmachine[]=macçš„ä¸¤ä¸ªAFQueryStringPairå¯¹è±¡ã€‚ä¹‹åAFQueryStringFromParametersæ–¹æ³•å†ä»¥â€™&amp;â€™ç¬¦å·å¯¹å®ƒä»¬è¿›è¡Œæ‹¼æ¥ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">AFURLRequestSerialization.h</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * AFQueryStringFromParameters(<span class="built_in">NSDictionary</span> *parameters);</span><br><span class="line"></span><br><span class="line">AFURLRequestSerialization.m</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFQueryStringPair</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> field;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> value;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithField:(<span class="keyword">id</span>)field value:(<span class="keyword">id</span>)value;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)URLEncodedStringValue;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFQueryStringPair</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithField:(<span class="keyword">id</span>)field value:(<span class="keyword">id</span>)value &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.field = field;</span><br><span class="line">    <span class="keyword">self</span>.value = value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)URLEncodedStringValue &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.value || [<span class="keyword">self</span>.value isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> AFPercentEscapedStringFromString([<span class="keyword">self</span>.field description]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@=%@"</span>, AFPercentEscapedStringFromString([<span class="keyword">self</span>.field description]), AFPercentEscapedStringFromString([<span class="keyword">self</span>.value description])];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSArray</span> * AFQueryStringPairsFromDictionary(<span class="built_in">NSDictionary</span> *dictionary);</span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSArray</span> * AFQueryStringPairsFromKeyAndValue(<span class="built_in">NSString</span> *key, <span class="keyword">id</span> value);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> * AFQueryStringFromParameters(<span class="built_in">NSDictionary</span> *parameters) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutablePairs = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">for</span> (AFQueryStringPair *pair <span class="keyword">in</span> AFQueryStringPairsFromDictionary(parameters)) &#123;</span><br><span class="line">        [mutablePairs addObject:[pair URLEncodedStringValue]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [mutablePairs componentsJoinedByString:<span class="string">@"&amp;"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> * AFQueryStringPairsFromDictionary(<span class="built_in">NSDictionary</span> *dictionary) &#123;</span><br><span class="line">    <span class="keyword">return</span> AFQueryStringPairsFromKeyAndValue(<span class="literal">nil</span>, dictionary);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> * AFQueryStringPairsFromKeyAndValue(<span class="built_in">NSString</span> *key, <span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableQueryStringComponents = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSSortDescriptor</span> *sortDescriptor = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"description"</span> ascending:<span class="literal">YES</span> selector:<span class="keyword">@selector</span>(compare:)];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *dictionary = value;</span><br><span class="line">        <span class="comment">// Sort dictionary keys to ensure consistent ordering in query string, which is important when deserializing potentially ambiguous sequences, such as an array of dictionaries</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> nestedKey <span class="keyword">in</span> [dictionary.allKeys sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</span><br><span class="line">            <span class="keyword">id</span> nestedValue = dictionary[nestedKey];</span><br><span class="line">            <span class="keyword">if</span> (nestedValue) &#123;</span><br><span class="line">                [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue((key ? [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@[%@]"</span>, key, nestedKey] : nestedKey), nestedValue)];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *array = value;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> nestedValue <span class="keyword">in</span> array) &#123;</span><br><span class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue([<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@[]"</span>, key], nestedValue)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSSet</span> *set = value;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> [set sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</span><br><span class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue(key, obj)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [mutableQueryStringComponents addObject:[[AFQueryStringPair alloc] initWithField:key value:value]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mutableQueryStringComponents;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="AFURLRequestSerialization"><a href="#AFURLRequestSerialization" class="headerlink" title="AFURLRequestSerialization"></a>AFURLRequestSerialization</h3><p>å…ˆå£°æ˜äº†ä¸€ä¸ªåè®®AFURLRequestSerializationç»§æ‰¿äº†NSSecureCodingå’ŒNSCopyingæ¥ä¿è¯æ‰€æœ‰å®ç°è¿™ä¸ªåºåˆ—åŒ–åè®®çš„åºåˆ—åŒ–å™¨ç±»éƒ½æœ‰å®‰å…¨ç¼–ç å’Œå¤åˆ¶çš„èƒ½åŠ›ã€‚åè®®ä¹Ÿå®šä¹‰äº†åºåˆ—åŒ–çš„è§„èŒƒæ–¹æ³•ã€‚ï¼ˆåè®®ï¼Œæœ‰åˆ©äºæ‰©å±•ï¼‰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    AFURLRequestSerializationåè®®å¯ä»¥è¢«ä¸€ä¸ªç¼–ç ç‰¹å®šhttpè¯·æ±‚çš„å¯¹è±¡å®ç°ã€‚</span></span><br><span class="line"><span class="comment">    è¯·æ±‚åºåˆ—åŒ–å™¨ï¼ˆRequest serializerï¼‰å¯ä»¥ç¼–ç æŸ¥è¯¢è¯­å¥ã€HTTPè¯·æ±‚ä½“ï¼Œå¦‚æœå¿…é¡»çš„è¯ï¼Œå¯ä»¥è‡ªè¡Œè®¾ç½®åˆé€‚çš„HTTPè¯·æ±‚ä½“å†…å®¹ï¼ˆå¦‚ï¼šAgent:iOSï¼‰ã€‚</span></span><br><span class="line"><span class="comment">    ä¾‹å¦‚ï¼Œä¸€ä¸ªJSONè¯·æ±‚åºåˆ—åŒ–å™¨ä¼šæŠŠè¯·æ±‚ä½“Content-Typeè®¾ç½®ä¸ºapplication/jsonã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">AFURLRequestSerialization</span> &lt;<span class="title">NSObject</span>, <span class="title">NSSecureCoding</span>, <span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è¿”å›ä¸€ä¸ªä½¿ç”¨äº†æŒ‡å®šå‚æ•°ç¼–ç çš„è¯·æ±‚çš„æ‹·è´ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                        withParameters:(<span class="keyword">nullable</span> <span class="keyword">id</span>)parameters</span><br><span class="line">                                                 error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error <span class="built_in">NS_SWIFT_NOTHROW</span>;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h3 id="AFHTTPRequestSerializer"><a href="#AFHTTPRequestSerializer" class="headerlink" title="AFHTTPRequestSerializer"></a>AFHTTPRequestSerializer</h3><h4 id="ç¼“å­˜ç­–ç•¥"><a href="#ç¼“å­˜ç­–ç•¥" class="headerlink" title="ç¼“å­˜ç­–ç•¥"></a>ç¼“å­˜ç­–ç•¥</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">NSURLRequestCachePolicy</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        é»˜è®¤ç¼“å­˜ç­–ç•¥ã€‚å…·ä½“å·¥ä½œï¼šå¦‚æœä¸€ä¸ªNSCachedURLResponseå¯¹äºè¯·æ±‚å¹¶ä¸å­˜åœ¨ï¼Œæ•°æ®å°†ä¼šä»æºç«¯è·å–ã€‚å¦‚æœè¯·æ±‚æ‹¥æœ‰ä¸€ä¸ªç¼“å­˜çš„å“åº”ï¼Œé‚£ä¹ˆURLåŠ è½½ç³»ç»Ÿä¼šæ£€æŸ¥è¿™ä¸ªå“åº”æ¥å†³å®šï¼Œå¦‚æœå®ƒæŒ‡å®šå†…å®¹å¿…é¡»é‡æ–°ç”Ÿæ•ˆçš„è¯ã€‚å‡å¦‚å†…å®¹å¿…é¡»é‡æ–°ç”Ÿæ•ˆï¼Œå°†å»ºç«‹ä¸€ä¸ªè¿å‘æºç«¯çš„è¿æ¥æ¥æŸ¥çœ‹å†…å®¹æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚å‡å¦‚å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆå“åº”å°±ä»æœ¬åœ°ç¼“å­˜è¿”å›æ•°æ®ã€‚å¦‚æœå†…å®¹å˜åŒ–äº†ï¼Œé‚£ä¹ˆæ•°æ®å°†ä»æºç«¯è·å–</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestUseProtocolCachePolicy</span> = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        URLåº”è¯¥åŠ è½½æºç«¯æ•°æ®ï¼Œä¸ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span> = <span class="number">1</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æœ¬åœ°ç¼“å­˜æ•°æ®ã€ä»£ç†å’Œå…¶ä»–ä¸­ä»‹éƒ½è¦å¿½è§†ä»–ä»¬çš„ç¼“å­˜ï¼Œç›´æ¥åŠ è½½æºæ•°æ®</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadIgnoringLocalAndRemoteCacheData</span> = <span class="number">4</span>, <span class="comment">// Unimplemented</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadIgnoringCacheData</span> = <span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æŒ‡å®šå·²å­˜çš„ç¼“å­˜æ•°æ®åº”è¯¥ç”¨æ¥å“åº”è¯·æ±‚ï¼Œä¸ç®¡å®ƒçš„ç”Ÿå‘½æ—¶é•¿å’Œè¿‡æœŸæ—¶é—´ã€‚å¦‚æœåœ¨ç¼“å­˜ä¸­æ²¡æœ‰å·²å­˜æ•°æ®æ¥å“åº”è¯·æ±‚çš„è¯ï¼Œæ•°æ®ä»æºç«¯åŠ è½½ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReturnCacheDataElseLoad</span> = <span class="number">2</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æŒ‡å®šå·²å­˜çš„ç¼“å­˜æ•°æ®ç”¨æ¥æ»¡è¶³è¯·æ±‚ï¼Œä¸ç®¡ç”Ÿå‘½æ—¶é•¿å’Œè¿‡æœŸæ—¶é—´ã€‚å¦‚æœåœ¨ç¼“å­˜ä¸­æ²¡æœ‰å·²å­˜æ•°æ®æ¥å“åº”URLåŠ è½½è¯·æ±‚çš„è¯ï¼Œä¸å»å°è¯•ä»æºæ®µåŠ è½½æ•°æ®ï¼Œæ­¤æ—¶è®¤ä¸ºåŠ è½½è¯·æ±‚å¤±è´¥ã€‚è¿™ä¸ªå¸¸é‡æŒ‡å®šäº†ä¸€ä¸ªç±»ä¼¼äºç¦»çº¿æ¨¡å¼çš„è¡Œä¸º</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReturnCacheDataDontLoad</span> = <span class="number">3</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æŒ‡å®šå¦‚æœå·²å­˜çš„ç¼“å­˜æ•°æ®è¢«æä¾›å®ƒçš„æºæ®µç¡®è®¤ä¸ºæœ‰æ•ˆåˆ™å…è®¸ä½¿ç”¨ç¼“å­˜æ•°æ®å“åº”è¯·æ±‚ï¼Œå¦åˆ™ä»æºæ®µåŠ è½½æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadRevalidatingCacheData</span> = <span class="number">5</span>, <span class="comment">// Unimplemented</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>NSURLRequestReturnCacheDataDontLoadæ˜¯ç”¨äºç¦»çº¿æ¨¡å¼çš„ï¼Œæˆ‘ä¸ºäº†èƒ½è®©ç”¨æˆ·åœ¨ç¦»çº¿ä¸‹é¢é˜…è¯»ï¼Œæˆ‘å°±è®¾è®¡äº†å½“æ²¡æœ‰ç½‘ç»œçš„æ—¶å€™çš„ç­–ç•¥ä¸ºNSURLRequestReturnCacheDataDontLoadã€‚</p>
<h4 id="åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜"><a href="#åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜" class="headerlink" title="åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜"></a>åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜</h4><p>HTTPåºåˆ—åŒ–å™¨ç±»AFHTTPRequestSerializerï¼Œå®ç°äº†AFURLRequestSerializationåè®®ï¼Œå¹¶å‚è€ƒäº†NSMutableURLRequestç±»å£°æ˜äº†å¾ˆå¤šè¯·æ±‚è®¾ç½®ç›¸å…³å±æ€§ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    AFHTTPRequestSerializerå®ç°äº†AFURLRequestSerializationåè®®ï¼Œä¸ºæŸ¥è¯¢è¯­å¥ã€URLè¡¨å•ç¼–ç å‚æ•°çš„åºåˆ—åŒ–æä¾›ä¸€ä¸ªå…·ä½“çš„å®ç°å’Œé»˜è®¤çš„è¯·æ±‚å¤´ï¼Œä»¥åŠçŠ¶æ€ç å’Œå†…å®¹ç±»å‹çš„æ ¡éªŒã€‚</span></span><br><span class="line"><span class="comment">    æ‰€æœ‰çš„requestå’Œresponseéƒ½è¢«é¼“åŠ±å»ç»§æ‰¿AFHTTPRequestSerializerç±»ï¼Œä»¥ç¡®ä¿é»˜è®¤æ–¹æ³•å’Œå±æ€§çš„ä¸€è‡´æ€§ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPRequestSerializer</span> : <span class="title">NSObject</span> &lt;<span class="title">AFURLRequestSerialization</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    å­—ç¬¦ä¸²ç¼–ç æ–¹å¼ï¼Œé»˜è®¤ä¸ºNSUTF8StringEncoding</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    æ˜¯å¦å…è®¸æ‰‹æœºè®¿é—®ï¼Œé»˜è®¤ä¸ºYES</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> allowsCellularAccess;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ç¼“å­˜ç­–ç•¥ã€‚é»˜è®¤ä¸ºNSURLRequestUseProtocolCachePolicy</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setCachePolicy:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSURLRequestCachePolicy</span> cachePolicy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    æ˜¯å¦ç”¨cookieæ¥å¤„ç†åˆ›å»ºçš„è¯·æ±‚ã€‚é»˜è®¤ä¸ºYES</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setHTTPShouldHandleCookies</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> HTTPShouldHandleCookies;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    åˆ›å»ºçš„è¯·æ±‚åœ¨æ”¶åˆ°ä¸Šä¸ªä¼ è¾“ï¼ˆtransmissionï¼‰å“åº”ä¹‹å‰æ˜¯å¦ç»§ç»­å‘é€æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">    é»˜è®¤ä¸ºNO(å³ç­‰å¾…ä¸Šæ¬¡ä¼ è¾“å®Œæˆåå†è¯·æ±‚)</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setHTTPShouldUsePipelining:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> HTTPShouldUsePipelining;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è¯·æ±‚çš„ç½‘ç»œæœåŠ¡ç±»å‹ã€‚</span></span><br><span class="line"><span class="comment">    è¿™ä¸ªæœåŠ¡ç±»å‹å‘æ•´ä¸ªç½‘ç»œä¼ è¾“å±‚æ¬¡æä¾›äº†ä¸€ä¸ªå…³äºè¯¥è¯·æ±‚ç›®çš„çš„æç¤ºã€‚</span></span><br><span class="line"><span class="comment">    ï¼ˆThe service type is used to provide the networking layers a hint of the purpose of the request.ï¼‰</span></span><br><span class="line"><span class="comment">    é»˜è®¤ä¸ºNSURLNetworkServiceTypeDefault</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setNetworkServiceType:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSURLRequestNetworkServiceType</span> networkServiceType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è¯·æ±‚çš„è¶…æ—¶é—´éš”ï¼Œå•ä½ç§’ã€‚é»˜è®¤ä¸º60ç§’</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setTimeoutInterval:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> timeoutInterval;</span><br><span class="line"></span><br><span class="line"><span class="comment">///---------------------------------------</span></span><br><span class="line"><span class="comment">/// @name Configuring HTTP Request Headers</span></span><br><span class="line"><span class="comment">///---------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    åºåˆ—è¯·æ±‚çš„é»˜è®¤è¯·æ±‚å¤´ã€‚é»˜è®¤å€¼åŒ…æ‹¬</span></span><br><span class="line"><span class="comment">    'Accept-Languageâ€™  å†…å®¹ä¸º 'NSLocale +preferredLanguagesâ€™ æ–¹æ³•è·å–çš„è¯­éŸ³</span></span><br><span class="line"><span class="comment">    'User-Agentâ€™  å†…å®¹ä¸ºå„ç§bundleçš„æ ‡å¿—å·²ç»ç³»ç»Ÿä¿¡æ¯</span></span><br><span class="line"><span class="comment">    å¯ä»¥ä½¿ç”¨'setValue:forHTTPHeaderField:â€™æ–¹æ³•æ·»åŠ æˆ–åˆ é™¤è¯·æ±‚å¤´</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *HTTPRequestHeaders;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ç±»æ–¹æ³•åˆ›å»ºå®ä¾‹å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)serializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è®¾ç½®HTTPHeader</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)value forHTTPHeaderField:(<span class="built_in">NSString</span> *)field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è·å–HTTPHeader fieldå¯¹åº”çš„ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)valueForHTTPHeaderField:(<span class="built_in">NSString</span> *)field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è®¾ç½®èº«ä»½ä¿¡æ¯header</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setAuthorizationHeaderFieldWithUsername:(<span class="built_in">NSString</span> *)username</span><br><span class="line">                                       password:(<span class="built_in">NSString</span> *)password;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    æ¸…é™¤èº«ä»½è®¤è¯ä¿¡æ¯header</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)clearAuthorizationHeader;</span><br><span class="line"></span><br><span class="line"><span class="comment">///-------------------------------------------------------</span></span><br><span class="line"><span class="comment">/// @name Configuring Query String Parameter Serialization</span></span><br><span class="line"><span class="comment">///-------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    å“ªäº›HTTPè¯·æ±‚æ–¹æ³•ä¼šå°†å‚æ•°ç¼–ç æˆæŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆå¦‚:name=xgb&amp;gender=1ï¼‰ã€‚é»˜è®¤ä¸ºGET, HEADå’ŒDELETEã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSSet</span> &lt;<span class="built_in">NSString</span> *&gt; *HTTPMethodsEncodingParametersInURI;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    æŸ¥è¯¢å‚æ•°çš„è½¬ä¹‰æ ·å¼.(ç›®å‰åªæœ‰ä¸€ç§)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setQueryStringSerializationWithStyle:(AFHTTPRequestQueryStringSerializationStyle)style;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è‡ªå®šä¹‰å‚æ•°çš„è½¬ä¹‰æ–¹å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setQueryStringSerializationWithBlock:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> * (^)(<span class="built_in">NSURLRequest</span> *request, <span class="keyword">id</span> parameters, <span class="built_in">NSError</span> * __autoreleasing *error))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">///-------------------------------</span></span><br><span class="line"><span class="comment">/// @name Creating Request Objects</span></span><br><span class="line"><span class="comment">///-------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    å¦‚æœè¯·æ±‚æ–¹å¼ä¸ºGET`, `HEAD`, or `DELETEæ—¶ã€å‚æ•°ä¼šè¢«æ‹¼æ¥åˆ°URLä¸­ã€å¦åˆ™å½“åšbodyå¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                 URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                parameters:(<span class="keyword">nullable</span> <span class="keyword">id</span>)parameters</span><br><span class="line">                                     error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°"><a href="#åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°" class="headerlink" title="åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°"></a>åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * AFHTTPRequestSerializerObservedKeyPaths() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSArray</span> *_AFHTTPRequestSerializerObservedKeyPaths = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        _AFHTTPRequestSerializerObservedKeyPaths = @[<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowsCellularAccess)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldHandleCookies)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldUsePipelining)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(networkServiceType)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(timeoutInterval))];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _AFHTTPRequestSerializerObservedKeyPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AFHTTPRequestSerializerObservedKeyPathsæ–¹æ³•å®šä¹‰å¯ä»¥éœ€è¦è¢«è§‚å¯Ÿçš„å±æ€§ï¼ˆè¿™äº›å±æ€§ä¸ºå…¬å¼€çš„å±æ€§ï¼Œå¯èƒ½è¢«ç”¨æˆ·ä¿®æ”¹ï¼‰ï¼ŒåŒ…æ‹¬cachePolicyã€HTTPShouldHandleCookiesã€HTTPShouldUsePipeliningã€networkServiceTypeå’ŒtimeoutIntervalã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPRequestSerializer</span> ()</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ä¿å­˜ç”¨æˆ·ä¿®æ”¹è¿‡çš„å±æ€§ï¼ŒåŒ…æ‹¬AFHTTPRequestSerializerObservedKeyPathsåŒ…å«çš„å±æ€§ã€‚</span></span><br><span class="line"><span class="comment">    å½“ç”¨æˆ·ä¿®æ”¹è¿™äº›å±æ€§å€¼æ—¶è®°å½•èµ·æ¥ï¼Œåˆ›å»ºRequestæ—¶ä½¿ç”¨ï¼Œæ²¡ä¿®æ”¹çš„ä½¿ç”¨é»˜è®¤å€¼ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span> *mutableObservedChangedKeyPaths;</span><br><span class="line"><span class="comment">/** çœŸæ­£å­˜å‚¨Headerçš„å±æ€§ã€‚ */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span> *mutableHTTPRequestHeaders;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ç”¨ä¸€ä¸ªä¸²è¡Œçº¿ç¨‹æ¥ç»Ÿä¸€å¤„ç†Headerçš„ä¿®æ”¹ï¼Œé¿å…å¤šçº¿ç¨‹é€ æˆçš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">dispatch_queue_t</span> requestHeaderModificationQueue;</span><br><span class="line"><span class="comment">/** ç›®å‰åªæœ‰ä¸€ä¸ªå€¼ */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AFHTTPRequestQueryStringSerializationStyle queryStringSerializationStyle;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ç”¨äºè‡ªå®šä¹‰æŸ¥è¯¢å­—ç¬¦ä¸²çš„æ‹¼æ¥ã€‚</span></span><br><span class="line"><span class="comment">    å› ä¸ºAFURLRequestSerializationåè®®å®šä¹‰çš„æ–¹æ³•-requestBySerializingRequest:withParameters:error:ä¼ å…¥çš„parametersæ˜¯ä»¥å­—å…¸çš„å½¢å¼ä¼ å…¥ï¼Œæ‰€ä»¥éœ€è¦å°†å­—å…¸æ‹¼æ¥æˆæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨AFQueryStringFromParametersæ–¹æ³•æ‹¼æ¥ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFQueryStringSerializationBlock queryStringSerialization;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFHTTPRequestSerializer</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)serializer &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    åˆå§‹åŒ–æ–¹æ³•ä¸»è¦æ˜¯å¯¹ä¸€äº›å±æ€§åˆå§‹åŒ–ï¼Œä»¥åŠå°†HTTPå¤´éƒ¨æŒ‰ç…§w3cæ ‡å‡†è¿›è¡Œäº†å°è£…ï¼Œæ ¹æ®AFHTTPRequestSerializerObservedKeyPathsæ–¹æ³•å¯¹ä¸€äº›å¿…è¦çš„å±æ€§ä½¿ç”¨KVOè¿›è¡Œäº†ç›‘å¬ã€‚åœ¨è¿™äº›è¢«ç›‘å¬çš„å±æ€§çš„setteré‡Œé¢æ‰‹åŠ¨åœ°å‘é€é€šçŸ¥ï¼Œé¿å…å‡ºç°å¥‡æ€ªçš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.stringEncoding = <span class="built_in">NSUTF8StringEncoding</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.mutableHTTPRequestHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    <span class="keyword">self</span>.requestHeaderModificationQueue = dispatch_queue_create(<span class="string">"requestHeaderModificationQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Accept-Language HTTP Header; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.4</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *acceptLanguagesComponents = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    [[<span class="built_in">NSLocale</span> preferredLanguages] enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="keyword">float</span> q = <span class="number">1.0</span>f - (idx * <span class="number">0.1</span>f);</span><br><span class="line">        [acceptLanguagesComponents addObject:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@;q=%0.1g"</span>, obj, q]];</span><br><span class="line">        *stop = q &lt;= <span class="number">0.5</span>f;</span><br><span class="line">    &#125;];</span><br><span class="line">    [<span class="keyword">self</span> setValue:[acceptLanguagesComponents componentsJoinedByString:<span class="string">@", "</span>] forHTTPHeaderField:<span class="string">@"Accept-Language"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *userAgent = <span class="literal">nil</span>;</span><br><span class="line"><span class="meta">#if TARGET_OS_IOS</span></span><br><span class="line">    <span class="comment">// User-Agent Header; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.43</span></span><br><span class="line">    userAgent = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@/%@ (%@; iOS %@; Scale/%0.2f)"</span>, [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleExecutableKey] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleIdentifierKey], [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][<span class="string">@"CFBundleShortVersionString"</span>] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleVersionKey], [[<span class="built_in">UIDevice</span> currentDevice] model], [[<span class="built_in">UIDevice</span> currentDevice] systemVersion], [[<span class="built_in">UIScreen</span> mainScreen] scale]];</span><br><span class="line"><span class="meta">#elif TARGET_OS_WATCH</span></span><br><span class="line">    <span class="comment">// User-Agent Header; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.43</span></span><br><span class="line">    userAgent = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@/%@ (%@; watchOS %@; Scale/%0.2f)"</span>, [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleExecutableKey] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleIdentifierKey], [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][<span class="string">@"CFBundleShortVersionString"</span>] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleVersionKey], [[<span class="built_in">WKInterfaceDevice</span> currentDevice] model], [[<span class="built_in">WKInterfaceDevice</span> currentDevice] systemVersion], [[<span class="built_in">WKInterfaceDevice</span> currentDevice] screenScale]];</span><br><span class="line"><span class="meta">#elif defined(__MAC_OS_X_VERSION_MIN_REQUIRED)</span></span><br><span class="line">    userAgent = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@/%@ (Mac OS X %@)"</span>, [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleExecutableKey] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleIdentifierKey], [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][<span class="string">@"CFBundleShortVersionString"</span>] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleVersionKey], [[<span class="built_in">NSProcessInfo</span> processInfo] operatingSystemVersionString]];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="keyword">if</span> (userAgent) &#123;</span><br><span class="line">        <span class="keyword">if</span> (![userAgent canBeConvertedToEncoding:<span class="built_in">NSASCIIStringEncoding</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSMutableString</span> *mutableUserAgent = [userAgent mutableCopy];</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">CFStringTransform</span>((__bridge <span class="built_in">CFMutableStringRef</span>)(mutableUserAgent), <span class="literal">NULL</span>, (__bridge <span class="built_in">CFStringRef</span>)<span class="string">@"Any-Latin; Latin-ASCII; [:^ASCII:] Remove"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">                userAgent = mutableUserAgent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span> setValue:userAgent forHTTPHeaderField:<span class="string">@"User-Agent"</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// HTTP Method Definitions; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html</span></span><br><span class="line">    <span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI = [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"GET"</span>, <span class="string">@"HEAD"</span>, <span class="string">@"DELETE"</span>, <span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.mutableObservedChangedKeyPaths = [<span class="built_in">NSMutableSet</span> set];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="built_in">NSSelectorFromString</span>(keyPath)]) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addObserver:<span class="keyword">self</span> forKeyPath:keyPath options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:AFHTTPRequestSerializerObserverContext];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="built_in">NSSelectorFromString</span>(keyPath)]) &#123;</span><br><span class="line">            [<span class="keyword">self</span> removeObserver:<span class="keyword">self</span> forKeyPath:keyPath context:AFHTTPRequestSerializerObserverContext];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Workarounds for crashing behavior using Key-Value Observing with XCTest</span></span><br><span class="line"><span class="comment">// See https://github.com/AFNetworking/AFNetworking/issues/2523</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setAllowsCellularAccess:(<span class="built_in">BOOL</span>)allowsCellularAccess &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowsCellularAccess))];</span><br><span class="line">    _allowsCellularAccess = allowsCellularAccess;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowsCellularAccess))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setCachePolicy:(<span class="built_in">NSURLRequestCachePolicy</span>)cachePolicy &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy))];</span><br><span class="line">    _cachePolicy = cachePolicy;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setHTTPShouldHandleCookies:(<span class="built_in">BOOL</span>)HTTPShouldHandleCookies &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldHandleCookies))];</span><br><span class="line">    _HTTPShouldHandleCookies = HTTPShouldHandleCookies;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldHandleCookies))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setHTTPShouldUsePipelining:(<span class="built_in">BOOL</span>)HTTPShouldUsePipelining &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldUsePipelining))];</span><br><span class="line">    _HTTPShouldUsePipelining = HTTPShouldUsePipelining;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldUsePipelining))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNetworkServiceType:(<span class="built_in">NSURLRequestNetworkServiceType</span>)networkServiceType &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(networkServiceType))];</span><br><span class="line">    _networkServiceType = networkServiceType;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(networkServiceType))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTimeoutInterval:(<span class="built_in">NSTimeInterval</span>)timeoutInterval &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(timeoutInterval))];</span><br><span class="line">    _timeoutInterval = timeoutInterval;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(timeoutInterval))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)HTTPRequestHeaders &#123;</span><br><span class="line">    <span class="built_in">NSDictionary</span> __block *value;</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        value = [<span class="built_in">NSDictionary</span> dictionaryWithDictionary:<span class="keyword">self</span>.mutableHTTPRequestHeaders];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="built_in">NSString</span> *)value</span><br><span class="line">forHTTPHeaderField:(<span class="built_in">NSString</span> *)field</span><br><span class="line">&#123;</span><br><span class="line">    dispatch_barrier_async(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span>.mutableHTTPRequestHeaders setValue:value forKey:field];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)valueForHTTPHeaderField:(<span class="built_in">NSString</span> *)field &#123;</span><br><span class="line">    <span class="built_in">NSString</span> __block *value;</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        value = [<span class="keyword">self</span>.mutableHTTPRequestHeaders valueForKey:field];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//é€šè¿‡è´¦å·å¯†ç è®¾ç½®æˆæƒè¯·æ±‚å¤´</span></span><br><span class="line">- (<span class="keyword">void</span>)setAuthorizationHeaderFieldWithUsername:(<span class="built_in">NSString</span> *)username</span><br><span class="line">                                       password:(<span class="built_in">NSString</span> *)password</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSData</span> *basicAuthCredentials = [[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@:%@"</span>, username, password] dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *base64AuthCredentials = [basicAuthCredentials base64EncodedStringWithOptions:(<span class="built_in">NSDataBase64EncodingOptions</span>)<span class="number">0</span>];</span><br><span class="line">    [<span class="keyword">self</span> setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Basic %@"</span>, base64AuthCredentials] forHTTPHeaderField:<span class="string">@"Authorization"</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ¸…é™¤æˆæƒç”¨è¯·æ±‚å¤´</span></span><br><span class="line">- (<span class="keyword">void</span>)clearAuthorizationHeader &#123;</span><br><span class="line">    dispatch_barrier_async(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span>.mutableHTTPRequestHeaders removeObjectForKey:<span class="string">@"Authorization"</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">//è®¾ç½®æŸ¥è¯¢å‚æ•°çš„ç¼–ç æ–¹å¼</span></span><br><span class="line">- (<span class="keyword">void</span>)setQueryStringSerializationWithStyle:(AFHTTPRequestQueryStringSerializationStyle)style &#123;</span><br><span class="line">    <span class="keyword">self</span>.queryStringSerializationStyle = style;</span><br><span class="line">    <span class="keyword">self</span>.queryStringSerialization = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è®¾ç½®æŸ¥è¯¢å‚æ•°è‡ªå®šä¹‰ç¼–ç çš„block</span></span><br><span class="line">- (<span class="keyword">void</span>)setQueryStringSerializationWithBlock:(<span class="built_in">NSString</span> *(^)(<span class="built_in">NSURLRequest</span> *, <span class="keyword">id</span>, <span class="built_in">NSError</span> *__autoreleasing *))block &#123;</span><br><span class="line">    <span class="keyword">self</span>.queryStringSerialization = block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">//é€šè¿‡è¯·æ±‚æ–¹å¼ã€URLã€å‚æ•°å­—å…¸ç”Ÿæˆè¯·æ±‚</span></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                 URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                parameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                     error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(method);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(URLString);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:URLString];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(url);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url];</span><br><span class="line">    mutableRequest.HTTPMethod = method;</span><br><span class="line">    <span class="comment">//å¦‚æœæŸä¸ªå…³é”®å±æ€§è¢«è‡ªä¸»è®¾ç½®è¿‡ã€åˆ™ç”¨æ–°çš„ã€‚ä¸ç„¶ç›´æ¥ç”¨æ¨¡æ¿ç”Ÿæˆçš„`NSMutableURLRequest`å³å¯</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</span><br><span class="line">            [mutableRequest setValue:[<span class="keyword">self</span> valueForKeyPath:keyPath] forKey:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¯¹reqè¿›ä¸€æ­¥è®¾ç½®(æ‹¼æ¥URLã€è¯·æ±‚ä½“ã€è¯·æ±‚å¤´)</span></span><br><span class="line">    mutableRequest = [[<span class="keyword">self</span> requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> mutableRequest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - AFURLRequestSerialization</span></span><br><span class="line">- (<span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               withParameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                        error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(request);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [request mutableCopy];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®è¯·æ±‚å¤´</span></span><br><span class="line">    [<span class="keyword">self</span>.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> field, <span class="keyword">id</span> value, <span class="built_in">BOOL</span> * __unused stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®å‚æ•°parametersè®¾ç½®æŸ¥è¯¢å­—æ®µ</span></span><br><span class="line">    <span class="built_in">NSString</span> *query = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (parameters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.queryStringSerialization) &#123;</span><br><span class="line">            <span class="built_in">NSError</span> *serializationError;</span><br><span class="line">            query = <span class="keyword">self</span>.queryStringSerialization(request, parameters, &amp;serializationError);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">                <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                    *error = serializationError;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="keyword">self</span>.queryStringSerializationStyle) &#123;</span><br><span class="line">                <span class="keyword">case</span> AFHTTPRequestQueryStringDefaultStyle:</span><br><span class="line">                    query = AFQueryStringFromParameters(parameters);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å‚æ•°æ˜¯æ‹¼åˆ°urlè¿˜æ˜¯æ”¾åˆ°HTTPBody</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (query &amp;&amp; query.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mutableRequest.URL = [<span class="built_in">NSURL</span> URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? <span class="string">@"&amp;%@"</span> : <span class="string">@"?%@"</span>, query]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// #2864: an empty string is a valid x-www-form-urlencoded payload</span></span><br><span class="line">        <span class="keyword">if</span> (!query) &#123;</span><br><span class="line">            query = <span class="string">@""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) &#123;</span><br><span class="line">            [mutableRequest setValue:<span class="string">@"application/x-www-form-urlencoded"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        [mutableRequest setHTTPBody:[query dataUsingEncoding:<span class="keyword">self</span>.stringEncoding]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mutableRequest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSKeyValueObserving</span></span><br><span class="line"><span class="comment">// å¯ä»¥å†³å®šæ˜¯å¦å‘é€KVOé€šçŸ¥</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([AFHTTPRequestSerializerObservedKeyPaths() containsObject:key]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">                      ofObject:(__unused <span class="keyword">id</span>)object</span><br><span class="line">                        change:(<span class="built_in">NSDictionary</span> *)change</span><br><span class="line">                       context:(<span class="keyword">void</span> *)context</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (context == AFHTTPRequestSerializerObserverContext) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([change[<span class="built_in">NSKeyValueChangeNewKey</span>] isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰æ–°å€¼ã€åˆ™æ¸…ç©ºæ‰€å±ç›‘å¬</span></span><br><span class="line">            [<span class="keyword">self</span>.mutableObservedChangedKeyPaths removeObject:keyPath];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.mutableObservedChangedKeyPaths addObject:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSSecureCoding</span></span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)supportsSecureCoding &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)decoder &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">self</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.mutableHTTPRequestHeaders = [[decoder decodeObjectOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>] forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(mutableHTTPRequestHeaders))] mutableCopy];</span><br><span class="line">    <span class="keyword">self</span>.queryStringSerializationStyle = (AFHTTPRequestQueryStringSerializationStyle)[[decoder decodeObjectOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>] forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(queryStringSerializationStyle))] unsignedIntegerValue];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder &#123;</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        [coder encodeObject:<span class="keyword">self</span>.mutableHTTPRequestHeaders forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(mutableHTTPRequestHeaders))];</span><br><span class="line">    &#125;);</span><br><span class="line">    [coder encodeInteger:<span class="keyword">self</span>.queryStringSerializationStyle forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(queryStringSerializationStyle))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSCopying</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFHTTPRequestSerializer *serializer = [[[<span class="keyword">self</span> <span class="keyword">class</span>] allocWithZone:zone] init];</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        serializer.mutableHTTPRequestHeaders = [<span class="keyword">self</span>.mutableHTTPRequestHeaders mutableCopyWithZone:zone];</span><br><span class="line">    &#125;);</span><br><span class="line">    serializer.queryStringSerializationStyle = <span class="keyword">self</span>.queryStringSerializationStyle;</span><br><span class="line">    serializer.queryStringSerialization = <span class="keyword">self</span>.queryStringSerialization;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>å®ç°é‡Œé¢ç”¨åˆ°äº† KVO å’Œ GCD<br>KVOå¾ˆå·§å¦™çš„æŠŠå‡ ä¸ªå±æ€§å€¼çš„æ›´æ”¹ç»Ÿä¸€å¤„ç†ï¼Œä»£ç æ¸…æ™°ã€ç®€æ´<br>GCDæ …æ å‡½æ•°</p>
<h4 id="AFMultipartFormDataåè®®"><a href="#AFMultipartFormDataåè®®" class="headerlink" title="AFMultipartFormDataåè®®"></a>AFMultipartFormDataåè®®</h4><p>ä¸Šä¼ å›¾ç‰‡æˆ–è€…å…¶ä»–æ–‡ä»¶çš„</p>
<ol>
<li>åˆå§‹åŒ–è¾¹ç•Œ</li>
<li>bodyå¤´</li>
<li>body</li>
<li>ç»“æŸè¾¹ç•Œ</li>
</ol>
<p>åè®®ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                         name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                        error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                         name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                     fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                     mimeType:(<span class="built_in">NSString</span> *)mimeType</span><br><span class="line">                        error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithInputStream:(<span class="keyword">nullable</span> <span class="built_in">NSInputStream</span> *)inputStream</span><br><span class="line">                             name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                         fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                           length:(int64_t)length</span><br><span class="line">                         mimeType:(<span class="built_in">NSString</span> *)mimeType;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithFileData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                      fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                      mimeType:(<span class="built_in">NSString</span> *)mimeType;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithFormData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          name:(<span class="built_in">NSString</span> *)name;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithHeaders:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *)headers</span><br><span class="line">                         body:(<span class="built_in">NSData</span> *)body;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)throttleBandwidthWithPacketSize:(<span class="built_in">NSUInteger</span>)numberOfBytes</span><br><span class="line">                                  delay:(<span class="built_in">NSTimeInterval</span>)delay;</span><br></pre></td></tr></table></figure>

<p>Bodyéƒ¨åˆ†ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPBodyPart</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="comment">// ç¼–ç æ–¹å¼</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</span><br><span class="line"><span class="comment">// å¤´</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> *headers;</span><br><span class="line"><span class="comment">// è¾¹ç•Œ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *boundary;</span><br><span class="line"><span class="comment">// ä¸»ä½“</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> body;</span><br><span class="line"><span class="comment">// ä¸»é¢˜å†…å®¹é•¿åº¦</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> bodyContentLength;</span><br><span class="line"><span class="comment">// æµ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSInputStream</span> *inputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦æœ‰åˆå§‹è¾¹ç•Œ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> hasInitialBoundary;</span><br><span class="line"><span class="comment">// æ˜¯å¦æœ‰ç»“æŸè¾¹ç•Œ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> hasFinalBoundary;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦æœ‰å¯ç”¨å­—èŠ‚ï¼Œæ˜¯å¦ä¸ºnil</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span> = hasBytesAvailable) <span class="built_in">BOOL</span> bytesAvailable;</span><br><span class="line"><span class="comment">// é•¿åº¦</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> contentLength;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer</span><br><span class="line">        maxLength:(<span class="built_in">NSUInteger</span>)length;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>AFHTTPBodyPartç±»å±æ€§å¯ä»¥çœ‹å‡ºï¼Œå·²ç»åŒ…å«äº†å››å¤§ç»„æˆéƒ¨åˆ†</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    AFEncapsulationBoundaryPhase = <span class="number">1</span>,</span><br><span class="line">    AFHeaderPhase                = <span class="number">2</span>,</span><br><span class="line">    AFBodyPhase                  = <span class="number">3</span>,</span><br><span class="line">    AFFinalBoundaryPhase         = <span class="number">4</span>,</span><br><span class="line">&#125; AFHTTPBodyPartReadPhase;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPBodyPart</span> () &lt;<span class="title">NSCopying</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨æšä¸¾ åŒ…è£…body4å¤§ç»„æˆéƒ¨åˆ†</span></span><br><span class="line">    AFHTTPBodyPartReadPhase _phase;</span><br><span class="line">    <span class="comment">// è¾“å…¥æµ</span></span><br><span class="line">    <span class="built_in">NSInputStream</span> *_inputStream;</span><br><span class="line">    <span class="comment">// æ¯ä¸ªç»„æˆéƒ¨åˆ†çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> _phaseReadOffset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µ</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)transitionToNextPhase;</span><br><span class="line"><span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)readData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">           intoBuffer:(uint8_t *)buffer</span><br><span class="line">            maxLength:(<span class="built_in">NSUInteger</span>)length;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>å¯¹AFHTTPBodyPartçš„æ‰©å±•éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹å‡ºæ›¾åŠ äº†ä¸‰ä¸ªå±æ€§ã€ä¸¤ä¸ªæ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AFHTTPBodyPart å®ç°éƒ¨åˆ†</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFHTTPBodyPart</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> transitionToNextPhase];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="keyword">if</span> (_inputStream) &#123;</span><br><span class="line">        [_inputStream close];</span><br><span class="line">        _inputStream = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bodyå¯èƒ½æœ‰å¥½å‡ ç§ç±»å‹ï¼Œæ ¹æ®ä¸åŒçš„ç±»å‹è¿”å›ä¸åŒæ–¹æ³•åˆ›å»ºçš„NSInputStream ã€‚</span></span><br><span class="line">- (<span class="built_in">NSInputStream</span> *)inputStream &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_inputStream) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.body isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            _inputStream = [<span class="built_in">NSInputStream</span> inputStreamWithData:<span class="keyword">self</span>.body];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.body isKindOfClass:[<span class="built_in">NSURL</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            _inputStream = [<span class="built_in">NSInputStream</span> inputStreamWithURL:<span class="keyword">self</span>.body];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.body isKindOfClass:[<span class="built_in">NSInputStream</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            _inputStream = <span class="keyword">self</span>.body;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _inputStream = [<span class="built_in">NSInputStream</span> inputStreamWithData:[<span class="built_in">NSData</span> data]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _inputStream;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®headerå­—å…¸æ‹¼bodyå¤´</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)stringForHeaders &#123;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *headerString = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *field <span class="keyword">in</span> [<span class="keyword">self</span>.headers allKeys]) &#123;</span><br><span class="line">        [headerString appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@: %@%@"</span>, field, [<span class="keyword">self</span>.headers valueForKey:field], kAFMultipartFormCRLF]];</span><br><span class="line">    &#125;</span><br><span class="line">    [headerString appendString:kAFMultipartFormCRLF];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithString:headerString];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–bodyçš„å¤§å°  ç”¨åˆ°å‡ ä¸ªå‡½æ•°</span></span><br><span class="line">- (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)contentLength &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> length = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–è¾¹ç•Œ</span></span><br><span class="line">    <span class="built_in">NSData</span> *encapsulationBoundaryData = [([<span class="keyword">self</span> hasInitialBoundary] ? AFMultipartFormInitialBoundary(<span class="keyword">self</span>.boundary) : AFMultipartFormEncapsulationBoundary(<span class="keyword">self</span>.boundary)) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">    length += [encapsulationBoundaryData length];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤´</span></span><br><span class="line">    <span class="built_in">NSData</span> *headersData = [[<span class="keyword">self</span> stringForHeaders] dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">    length += [headersData length];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸»ä½“</span></span><br><span class="line">    length += _bodyContentLength;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»“æŸè¾¹ç•Œ</span></span><br><span class="line">    <span class="built_in">NSData</span> *closingBoundaryData = ([<span class="keyword">self</span> hasFinalBoundary] ? [AFMultipartFormFinalBoundary(<span class="keyword">self</span>.boundary) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding] : [<span class="built_in">NSData</span> data]);</span><br><span class="line">    length += [closingBoundaryData length];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ•°æ®</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)hasBytesAvailable &#123;</span><br><span class="line">    <span class="comment">// Allows `read:maxLength:` to be called again if `AFMultipartFormFinalBoundary` doesn't fit into the available buffer</span></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFFinalBoundaryPhase) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.inputStream.streamStatus) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusNotOpen</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusOpening</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusOpen</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusReading</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusWriting</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusAtEnd</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusClosed</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusError</span>:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯æŠŠbodyæ•°æ®å†™å…¥åˆ°bufferä¸­ã€‚é€šè¿‡è§‚å¯Ÿç€è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯å¾—çŸ¥ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•è‚¯å®šåœ¨å…¶ä»–çš„ä»£ç ä¸­çš„æŸä¸ªå¾ªç¯ä¸­è¢«è°ƒç”¨ï¼Œç›®çš„æ˜¯å¾—åˆ°æƒ³è¦çš„æ•°æ®æ ¼å¼</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer</span><br><span class="line">        maxLength:(<span class="built_in">NSUInteger</span>)length</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSInteger</span> totalNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFEncapsulationBoundaryPhase) &#123;</span><br><span class="line">        <span class="built_in">NSData</span> *encapsulationBoundaryData = [([<span class="keyword">self</span> hasInitialBoundary] ? AFMultipartFormInitialBoundary(<span class="keyword">self</span>.boundary) : AFMultipartFormEncapsulationBoundary(<span class="keyword">self</span>.boundary)) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:encapsulationBoundaryData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFHeaderPhase) &#123;</span><br><span class="line">        <span class="built_in">NSData</span> *headersData = [[<span class="keyword">self</span> stringForHeaders] dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:headersData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFBodyPhase) &#123;</span><br><span class="line">        <span class="built_in">NSInteger</span> numberOfBytesRead = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        numberOfBytesRead = [<span class="keyword">self</span>.inputStream read:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</span><br><span class="line">        <span class="keyword">if</span> (numberOfBytesRead == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            totalNumberOfBytesRead += numberOfBytesRead;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span>.inputStream streamStatus] &gt;= <span class="built_in">NSStreamStatusAtEnd</span>) &#123;</span><br><span class="line">                [<span class="keyword">self</span> transitionToNextPhase];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFFinalBoundaryPhase) &#123;</span><br><span class="line">        <span class="built_in">NSData</span> *closingBoundaryData = ([<span class="keyword">self</span> hasFinalBoundary] ? [AFMultipartFormFinalBoundary(<span class="keyword">self</span>.boundary) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding] : [<span class="built_in">NSData</span> data]);</span><br><span class="line">        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:closingBoundaryData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalNumberOfBytesRead;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)readData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">           intoBuffer:(uint8_t *)buffer</span><br><span class="line">            maxLength:(<span class="built_in">NSUInteger</span>)length</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ¯”è¾ƒæ•°æ®å’Œå…è®¸çš„æœ€å¤§é•¿åº¦ é€‰å–æ¯”è¾ƒå°çš„é‚£ä¸ª</span></span><br><span class="line">    <span class="built_in">NSRange</span> range = <span class="built_in">NSMakeRange</span>((<span class="built_in">NSUInteger</span>)_phaseReadOffset, MIN([data length] - ((<span class="built_in">NSUInteger</span>)_phaseReadOffset), length));</span><br><span class="line">    <span class="comment">// copy dataä¸­rangeçš„æ•°æ®åˆ°buffer</span></span><br><span class="line">    [data getBytes:buffer range:range];</span><br><span class="line"></span><br><span class="line">    _phaseReadOffset += range.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((<span class="built_in">NSUInteger</span>)_phaseReadOffset) &gt;= [data length]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> transitionToNextPhase];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">NSInteger</span>)range.length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)transitionToNextPhase &#123;</span><br><span class="line">    <span class="comment">// ä¿è¯ä¸»çº¿ç¨‹æ‰§è¡Œä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> (![[<span class="built_in">NSThread</span> currentThread] isMainThread]) &#123;</span><br><span class="line">        <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [<span class="keyword">self</span> transitionToNextPhase];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (_phase) &#123;</span><br><span class="line">        <span class="keyword">case</span> AFEncapsulationBoundaryPhase:</span><br><span class="line">            _phase = AFHeaderPhase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AFHeaderPhase: <span class="comment">// æ‰“å¼€æµï¼Œå‡†å¤‡æ¥æ”¶æ•°æ®</span></span><br><span class="line">            [<span class="keyword">self</span>.inputStream scheduleInRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop] forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">            [<span class="keyword">self</span>.inputStream open];</span><br><span class="line">            _phase = AFBodyPhase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AFBodyPhase: <span class="comment">// å…³é—­æµ</span></span><br><span class="line">            [<span class="keyword">self</span>.inputStream close];</span><br><span class="line">            _phase = AFFinalBoundaryPhase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AFFinalBoundaryPhase:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            _phase = AFEncapsulationBoundaryPhase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡ç½®offset</span></span><br><span class="line">    _phaseReadOffset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSCopying</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFHTTPBodyPart *bodyPart = [[[<span class="keyword">self</span> <span class="keyword">class</span>] allocWithZone:zone] init];</span><br><span class="line"></span><br><span class="line">    bodyPart.stringEncoding = <span class="keyword">self</span>.stringEncoding;</span><br><span class="line">    bodyPart.headers = <span class="keyword">self</span>.headers;</span><br><span class="line">    bodyPart.bodyContentLength = <span class="keyword">self</span>.bodyContentLength;</span><br><span class="line">    bodyPart.body = <span class="keyword">self</span>.body;</span><br><span class="line">    bodyPart.boundary = <span class="keyword">self</span>.boundary;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bodyPart;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>å…¶å®AFHTTPBodyPartå°±åƒæ˜¯ä¸€ä¸ªä¸ªå…·ä½“çš„æ•°æ®ä¸€æ ·ï¼Œè€ŒAFMultipartBodyStreamæ›´åƒæ˜¯ä¸€ä¸ªç®¡é“ï¼Œå’Œbodyç›¸è¿ï¼Œæ•°æ®ä»bodyæ²¿ç€ç®¡é“æµå…¥requestä¸­å»ã€‚</p>
<p>è¿™å±‚æŠ½è±¡çš„æ¦‚å¿µè¿˜æ˜¯è›®é‡è¦çš„ã€‚å†è®¾è®¡ä¹‹åˆï¼Œè¿™ä¸¤ä¸ªæŠ½è±¡ç±»å°±åº”è¯¥å„è‡ªå®Œæˆå„è‡ªçš„ä»»åŠ¡ï¼Œå³ä½¿bodyä¸­ä¹Ÿæœ‰stream ä½†é‚£ä¹Ÿåªå±äºbodyè‡ªèº«çš„ä¸šåŠ¡ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AFHTTPBodyPartå°±åƒæ˜¯ä¸€ä¸ªä¸ªå…·ä½“çš„æ•°æ®ä¸€æ ·ï¼Œè€ŒAFMultipartBodyStreamæ›´åƒæ˜¯ä¸€ä¸ªç®¡é“</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFMultipartBodyStream</span> : <span class="title">NSInputStream</span> &lt;<span class="title">NSStreamDelegate</span>&gt;</span></span><br><span class="line"><span class="comment">// è¯»å–åŒ…çš„å¤§å°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> numberOfBytesInPacket;</span><br><span class="line"><span class="comment">// å»¶æ—¶</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> delay;</span><br><span class="line"><span class="comment">// è¾“å…¥æµ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSInputStream</span> *inputStream;</span><br><span class="line"><span class="comment">// å†…å®¹å¤§å°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> contentLength;</span><br><span class="line"><span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span> = isEmpty) <span class="built_in">BOOL</span> empty;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithStringEncoding:(<span class="built_in">NSStringEncoding</span>)encoding;</span><br><span class="line">- (<span class="keyword">void</span>)setInitialAndFinalBoundaries;</span><br><span class="line">- (<span class="keyword">void</span>)appendHTTPBodyPart:(AFHTTPBodyPart *)bodyPart;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>å®ƒæ˜¯ç»§æ‰¿è‡ªNSInputStreamçš„ï¼Œæ•°æ®æœ€ç»ˆæ˜¯é€šè¿‡setHTTPBodySteamæ–¹æ³•ä¼ é€’ç»™Requestçš„ã€‚æ˜¯ä¸€ä¸ªNSInputStreamç±»å‹ï¼Œå› æ­¤AFMultipartBodyStream ç»§æ‰¿è‡ªNSInputStream</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - NSInputStream</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer</span><br><span class="line">        maxLength:(<span class="built_in">NSUInteger</span>)length</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> streamStatus] == <span class="built_in">NSStreamStatusClosed</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSInteger</span> totalNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// éå†è¯»å–æ•°æ®</span></span><br><span class="line">    <span class="keyword">while</span> ((<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead &lt; MIN(length, <span class="keyword">self</span>.numberOfBytesInPacket)) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰è¯»å–çš„bodyä¸å­˜åœ¨æˆ–è€…bodyæ²¡æœ‰å¯è¯»å­—èŠ‚</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.currentHTTPBodyPart || ![<span class="keyword">self</span>.currentHTTPBodyPart hasBytesAvailable]) &#123;</span><br><span class="line">            <span class="comment">// æŠŠä¸‹ä¸€ä¸ªbodyèµ‹å€¼ç»™å½“å‰çš„body å¦‚æœä¸‹ä¸€ä¸ªä¸ºnil å°±é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (!(<span class="keyword">self</span>.currentHTTPBodyPart = [<span class="keyword">self</span>.HTTPBodyPartEnumerator nextObject])) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// å½“å‰bodyå­˜åœ¨</span></span><br><span class="line">            <span class="comment">// å‰©ä½™å¯è¯»æ–‡ä»¶çš„å¤§å°</span></span><br><span class="line">            <span class="built_in">NSUInteger</span> maxLength = MIN(length, <span class="keyword">self</span>.numberOfBytesInPacket) - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead;</span><br><span class="line">            <span class="comment">// æŠŠå½“å‰çš„bodyçš„æ•°æ®è¯»å…¥åˆ°bufferä¸­</span></span><br><span class="line">            <span class="built_in">NSInteger</span> numberOfBytesRead = [<span class="keyword">self</span>.currentHTTPBodyPart read:&amp;buffer[totalNumberOfBytesRead] maxLength:maxLength];</span><br><span class="line">            <span class="keyword">if</span> (numberOfBytesRead == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">self</span>.streamError = <span class="keyword">self</span>.currentHTTPBodyPart.inputStream.streamError;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                totalNumberOfBytesRead += numberOfBytesRead;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.delay &gt; <span class="number">0.0</span>f) &#123;</span><br><span class="line">                    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="keyword">self</span>.delay];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalNumberOfBytesRead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•æ˜¯AFMultipartBodyStreamé€šè¿‡bodyè¯»å–æ•°æ®çš„æ ¸å¿ƒæ–¹æ³•ã€‚ä¸‹é¢é€šè¿‡ä¸¾ä¸€ä¸ªä¾‹å­æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ç©¶ç«Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ</p>
<ol>
<li>å‡å¦‚æˆ‘ä»¬ä¸Šä¼ ä¸€å¼ å›¾ç‰‡img.png ä»–çš„å¤§å°ä¸º80000ï¼Œä¹Ÿå°±æ˜¯å·®ä¸å¤š80kå§ã€‚</li>
<li>é€šè¿‡AFMultipartBodyStreamè¯»å–æ•°æ®ï¼Œä¼šé¦–å…ˆè°ƒç”¨ä¸Šè¾¹çš„æ–¹æ³•ã€‚è¯»å–æ•°æ®å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§è¯»å–çš„ï¼Œè€Œæ˜¯åˆ†æ‰¹åˆ†æ¬¡è¯»å–çš„ï¼Œè¿™è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæ¯æ¬¡è¯»å–çš„å¤§å°ä¸º32kï¼Œä¹Ÿå°±æ˜¯32*1024 = 32768çš„å¤§å°ã€‚</li>
<li>ç¬¬ä¸€æ¬¡è°ƒç”¨åself.currentHTTPBodyPart æŒ‡å‘æˆ‘ä»¬çš„img.png é€šè¿‡NSInteger numberOfBytesRead = [self.currentHTTPBodyPart read:&amp;buffer[totalNumberOfBytesRead] maxLength:maxLength]; æ–¹æ³•åœ¨bodyä¸­è¯»å–äº†32768å¤§å°çš„æ•°æ®ä¿å­˜åˆ°äº†ç¼“å­˜bufferä¸­ã€‚</li>
<li>ç”±äºæ•´ä¸ªå›¾ç‰‡å¤§å°æ˜¯80000 ä¸€æ¬¡è°ƒç”¨åªè¯»å–äº†32768 è¿˜æœ‰æ•°æ®æ²¡è¯»å®Œï¼Œä¸€æ¬¡è¿™ä¸ªæ–¹æ³•è¿˜ä¼šå†æ¬¡è¢«è°ƒç”¨ã€‚</li>
<li>ç¬¬äºŒæ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç”±äº[self.currentHTTPBodyPart hasBytesAvailable]è¿˜æœ‰æ•°æ®ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šèµ°åˆ°elseçš„æ–¹æ³•ä¸­ï¼Œself.currentHTTPBodyPartå¹¶æ²¡æœ‰æŒ‡å‘åˆ«çš„bodyã€‚å› æ­¤ç»§ç»­æ‰§è¡Œ 3.çš„æ–¹æ³•ã€‚</li>
<li>è‡³äºä¸ºä»€ä¹ˆèƒ½æ¥ç€ä»ä¸Šæ¬¡çš„å·²è¯»å–çš„æ•°æ®å¼€å§‹è¯»æ•°æ®ï¼Œè¿™ä¸ªæ˜¯bodyå†…éƒ¨å°è£…å®ç°çš„ï¼Œå¯å‚è€ƒæœ¬æ–‡ä¸Šè¾¹å…³äºbodyçš„ä»‹ç»ã€‚</li>
<li>é‡å¤ 3 4 5 çš„æ­¥éª¤ï¼Œç›´åˆ°æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œstreamå°±ä¼šå…³é—­æµã€‚åˆ°æ­¤æˆ‘ä»¬çš„çªå˜æ•°æ®å°±ä»¥æµçš„å½¢å¼ä¸Šä¼ åˆ°æœåŠ¡å™¨äº†ã€‚</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)multipartFormRequestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                              URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                             parameters:(<span class="built_in">NSDictionary</span> *)parameters</span><br><span class="line">                              constructingBodyWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> &lt;AFMultipartFormData&gt; formData))block</span><br><span class="line">                                                  error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(method);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(![method isEqualToString:<span class="string">@"GET"</span>] &amp;&amp; ![method isEqualToString:<span class="string">@"HEAD"</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [<span class="keyword">self</span> requestWithMethod:method URLString:URLString parameters:<span class="literal">nil</span> error:error];</span><br><span class="line"></span><br><span class="line">    __block AFStreamingMultipartFormData *formData = [[AFStreamingMultipartFormData alloc] initWithURLRequest:mutableRequest stringEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parameters) &#123;</span><br><span class="line">        <span class="keyword">for</span> (AFQueryStringPair *pair <span class="keyword">in</span> AFQueryStringPairsFromDictionary(parameters)) &#123;</span><br><span class="line">            <span class="built_in">NSData</span> *data = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> ([pair.value isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                data = pair.value;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([pair.value isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line">                data = [<span class="built_in">NSData</span> data];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                data = [[pair.value description] dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (data) &#123;</span><br><span class="line">                [formData appendPartWithFormData:data name:[pair.field description]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (block) &#123;</span><br><span class="line">        block(formData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [formData requestByFinalizingMultipartFormData];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// setHTTPBodyStreamæ–¹æ³•  éœ€è¦è®¾ç½®NSInputStreamç±»å‹çš„å¯¹è±¡</span></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestByFinalizingMultipartFormData &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.bodyStream isEmpty]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the initial and final boundaries to ensure correct Content-Length</span></span><br><span class="line">    [<span class="keyword">self</span>.bodyStream setInitialAndFinalBoundaries];</span><br><span class="line">    [<span class="keyword">self</span>.request setHTTPBodyStream:<span class="keyword">self</span>.bodyStream];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.request setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"multipart/form-data; boundary=%@"</span>, <span class="keyword">self</span>.boundary] forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">    [<span class="keyword">self</span>.request setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%llu"</span>, [<span class="keyword">self</span>.bodyStream contentLength]] forHTTPHeaderField:<span class="string">@"Content-Length"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šä¼ å¤šä¸ªæ–‡ä»¶çš„æ—¶å€™å›ç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªæ¥å—AFMultipartFormDataåè®®çš„å¯¹è±¡ï¼ŒAFNæ²¡æœ‰è®©AFMultipartBodyStreamæ¥å—è¿™ä¸ªåè®®æ¥å¤„ç†ã€‚è€Œæ˜¯ç”¨å¦å¤–ä¸€ä¸ªç±»AFStreamingMultipartFormDataæ¥æ¥å—è¿™ä¸ªåè®®ï¼Œå°±æ˜¯ä¸ºäº†æŠŠåŠŸèƒ½å’Œä¸šåŠ¡ä»£ç é€»è¾‘åˆ†å¼€ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFStreamingMultipartFormData</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSMutableURLRequest</span> *request;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *boundary;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFMultipartBodyStream *bodyStream;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFStreamingMultipartFormData</span> : <span class="title">NSObject</span> &lt;<span class="title">AFMultipartFormData</span>&gt;</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithURLRequest:(<span class="built_in">NSMutableURLRequest</span> *)urlRequest</span><br><span class="line">                    stringEncoding:(<span class="built_in">NSStringEncoding</span>)encoding;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestByFinalizingMultipartFormData;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFStreamingMultipartFormData</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithURLRequest:(<span class="built_in">NSMutableURLRequest</span> *)urlRequest</span><br><span class="line">                    stringEncoding:(<span class="built_in">NSStringEncoding</span>)encoding</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.request = urlRequest;</span><br><span class="line">    <span class="keyword">self</span>.stringEncoding = encoding;</span><br><span class="line">    <span class="keyword">self</span>.boundary = AFCreateMultipartFormBoundary();</span><br><span class="line">    <span class="keyword">self</span>.bodyStream = [[AFMultipartBodyStream alloc] initWithStringEncoding:encoding];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setRequest:(<span class="built_in">NSMutableURLRequest</span> *)request</span><br><span class="line">&#123;</span><br><span class="line">    _request = [request mutableCopy];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                         name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                        error:(<span class="built_in">NSError</span> * __autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileURL);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *fileName = [fileURL lastPathComponent];</span><br><span class="line">    <span class="built_in">NSString</span> *mimeType = AFContentTypeForPathExtension([fileURL pathExtension]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> appendPartWithFileURL:fileURL name:name fileName:fileName mimeType:mimeType error:error];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                         name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                     fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                     mimeType:(<span class="built_in">NSString</span> *)mimeType</span><br><span class="line">                        error:(<span class="built_in">NSError</span> * __autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileURL);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileName);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(mimeType);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (![fileURL isFileURL]) &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *userInfo = @&#123;<span class="built_in">NSLocalizedFailureReasonErrorKey</span>: <span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"Expected URL to be a file URL"</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>)&#125;;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            *error = [[<span class="built_in">NSError</span> alloc] initWithDomain:AFURLRequestSerializationErrorDomain code:<span class="built_in">NSURLErrorBadURL</span> userInfo:userInfo];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([fileURL checkResourceIsReachableAndReturnError:error] == <span class="literal">NO</span>) &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *userInfo = @&#123;<span class="built_in">NSLocalizedFailureReasonErrorKey</span>: <span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"File URL not reachable."</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>)&#125;;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            *error = [[<span class="built_in">NSError</span> alloc] initWithDomain:AFURLRequestSerializationErrorDomain code:<span class="built_in">NSURLErrorBadURL</span> userInfo:userInfo];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSDictionary</span> *fileAttributes = [[<span class="built_in">NSFileManager</span> defaultManager] attributesOfItemAtPath:[fileURL path] error:error];</span><br><span class="line">    <span class="keyword">if</span> (!fileAttributes) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mutableHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    [mutableHeaders setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"form-data; name=\"%@\"; filename=\"%@\""</span>, name, fileName] forKey:<span class="string">@"Content-Disposition"</span>];</span><br><span class="line">    [mutableHeaders setValue:mimeType forKey:<span class="string">@"Content-Type"</span>];</span><br><span class="line"></span><br><span class="line">    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];</span><br><span class="line">    bodyPart.stringEncoding = <span class="keyword">self</span>.stringEncoding;</span><br><span class="line">    bodyPart.headers = mutableHeaders;</span><br><span class="line">    bodyPart.boundary = <span class="keyword">self</span>.boundary;</span><br><span class="line">    bodyPart.body = fileURL;</span><br><span class="line">    bodyPart.bodyContentLength = [fileAttributes[<span class="built_in">NSFileSize</span>] unsignedLongLongValue];</span><br><span class="line">    [<span class="keyword">self</span>.bodyStream appendHTTPBodyPart:bodyPart];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithInputStream:(<span class="built_in">NSInputStream</span> *)inputStream</span><br><span class="line">                             name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                         fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                           length:(int64_t)length</span><br><span class="line">                         mimeType:(<span class="built_in">NSString</span> *)mimeType</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileName);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(mimeType);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mutableHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    [mutableHeaders setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"form-data; name=\"%@\"; filename=\"%@\""</span>, name, fileName] forKey:<span class="string">@"Content-Disposition"</span>];</span><br><span class="line">    [mutableHeaders setValue:mimeType forKey:<span class="string">@"Content-Type"</span>];</span><br><span class="line"></span><br><span class="line">    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];</span><br><span class="line">    bodyPart.stringEncoding = <span class="keyword">self</span>.stringEncoding;</span><br><span class="line">    bodyPart.headers = mutableHeaders;</span><br><span class="line">    bodyPart.boundary = <span class="keyword">self</span>.boundary;</span><br><span class="line">    bodyPart.body = inputStream;</span><br><span class="line"></span><br><span class="line">    bodyPart.bodyContentLength = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)length;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.bodyStream appendHTTPBodyPart:bodyPart];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithFileData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                      fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                      mimeType:(<span class="built_in">NSString</span> *)mimeType</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileName);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(mimeType);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mutableHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    [mutableHeaders setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"form-data; name=\"%@\"; filename=\"%@\""</span>, name, fileName] forKey:<span class="string">@"Content-Disposition"</span>];</span><br><span class="line">    [mutableHeaders setValue:mimeType forKey:<span class="string">@"Content-Type"</span>];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> appendPartWithHeaders:mutableHeaders body:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithFormData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mutableHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    [mutableHeaders setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"form-data; name=\"%@\""</span>, name] forKey:<span class="string">@"Content-Disposition"</span>];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> appendPartWithHeaders:mutableHeaders body:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithHeaders:(<span class="built_in">NSDictionary</span> *)headers</span><br><span class="line">                         body:(<span class="built_in">NSData</span> *)body</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(body);</span><br><span class="line"></span><br><span class="line">    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];</span><br><span class="line">    bodyPart.stringEncoding = <span class="keyword">self</span>.stringEncoding;</span><br><span class="line">    bodyPart.headers = headers;</span><br><span class="line">    bodyPart.boundary = <span class="keyword">self</span>.boundary;</span><br><span class="line">    bodyPart.bodyContentLength = [body length];</span><br><span class="line">    bodyPart.body = body;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.bodyStream appendHTTPBodyPart:bodyPart];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)throttleBandwidthWithPacketSize:(<span class="built_in">NSUInteger</span>)numberOfBytes</span><br><span class="line">                                  delay:(<span class="built_in">NSTimeInterval</span>)delay</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.bodyStream.numberOfBytesInPacket = numberOfBytes;</span><br><span class="line">    <span class="keyword">self</span>.bodyStream.delay = delay;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestByFinalizingMultipartFormData &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.bodyStream isEmpty]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the initial and final boundaries to ensure correct Content-Length</span></span><br><span class="line">    [<span class="keyword">self</span>.bodyStream setInitialAndFinalBoundaries];</span><br><span class="line">    [<span class="keyword">self</span>.request setHTTPBodyStream:<span class="keyword">self</span>.bodyStream];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.request setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"multipart/form-data; boundary=%@"</span>, <span class="keyword">self</span>.boundary] forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">    [<span class="keyword">self</span>.request setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%llu"</span>, [<span class="keyword">self</span>.bodyStream contentLength]] forHTTPHeaderField:<span class="string">@"Content-Length"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.request;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>å®šä¹‰AFStreamingMultipartFormDataï¼Œæ¥å—AFMultipartFormDataï¼Œå®ç°åè®®æ–¹æ³•ï¼ŒæŠŠæ–‡ä»¶å°è£…æˆbodyPartå¯¹è±¡å­˜å‚¨åˆ°AFStreamingMultipartFormDataå¯¹è±¡çš„å±æ€§bodyStreamçš„æ•°ç»„ä¸­ã€‚é€šè¿‡read maxLengthè¯»å–æ•°æ®ã€‚</p>
<h3 id="AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer"><a href="#AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer" class="headerlink" title="AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer"></a>AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer</h3><p>è¿™ä¸¤ä¸ªç±»ç»§æ‰¿è‡ªAFHTTPRequestSerializerã€‚ä»–ä»¬çš„åŸºæœ¬å®ç°éƒ½æ˜¯ç»§æ‰¿è‡ªçˆ¶ç±»ã€‚ä½†æ˜¯ä¹Ÿæ ¹æ®è‡ªèº«ä¸åŒæƒ…å†µï¼Œåšäº†å¤„ç†ã€‚<br>å¯¹äºAFJSONRequestSerializerã€‚éœ€è¦æŠŠContent-TypeæŒ‡å®šä¸ºâ€application/jsonã€‚åŒæ—¶HTTPBody<br>éœ€è¦ä½¿ç”¨JSONåºåˆ—åŒ–ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request</span><br><span class="line">                               withParameters:(id)parameters</span><br><span class="line">                                        error:(NSError *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    NSParameterAssert(request);</span><br><span class="line">    /*</span><br><span class="line">     å¯¹äº`GET`,`HEAD`,`DELETE`ç­‰æ–¹æ³•ä¸­ã€‚ç›´æ¥ä½¿ç”¨çˆ¶ç±»çš„å¤„ç†æ–¹å¼</span><br><span class="line">     */</span><br><span class="line">    if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line">        return [super requestBySerializingRequest:request withParameters:parameters error:error];</span><br><span class="line">    &#125;</span><br><span class="line">    NSMutableURLRequest *mutableRequest = [request mutableCopy];</span><br><span class="line">    //æŠŠ`HTTPRequestHeaders`ä¸­çš„å€¼æ·»åŠ è¿›å…¥è¯·æ±‚å¤´ä¸­ã€‚</span><br><span class="line">    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) &#123;</span><br><span class="line">        if (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    if (parameters) &#123;</span><br><span class="line">        //è®¾ç½®è¯·æ±‚å¤´çš„`Content-Type`ç±»å‹</span><br><span class="line">        if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) &#123;</span><br><span class="line">            [mutableRequest setValue:@&quot;application/json&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (![NSJSONSerialization isValidJSONObject:parameters]) &#123;</span><br><span class="line">            if (error) &#123;</span><br><span class="line">                NSDictionary *userInfo = @&#123;NSLocalizedFailureReasonErrorKey: NSLocalizedStringFromTable(@&quot;The `parameters` argument is not valid JSON.&quot;, @&quot;AFNetworking&quot;, nil)&#125;;</span><br><span class="line">                *error = [[NSError alloc] initWithDomain:AFURLRequestSerializationErrorDomain code:NSURLErrorCannotDecodeContentData userInfo:userInfo];</span><br><span class="line">            &#125;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        //æŠŠparametersè½¬æ¢ä¸ºJSONåºåˆ—åŒ–çš„data</span><br><span class="line">        NSData *jsonData = [NSJSONSerialization dataWithJSONObject:parameters options:self.writingOptions error:error];</span><br><span class="line">        if (!jsonData) &#123;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        //JSONåºåˆ—åŒ–çš„æ•°æ®è®¾ç½®ä¸ºhttpbody</span><br><span class="line">        [mutableRequest setHTTPBody:jsonData];</span><br><span class="line">    &#125;</span><br><span class="line">    return mutableRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºAFPropertyListRequestSerializerä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               withParameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                        error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(request);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     å¯¹äº`GET`,`HEAD`,`DELETE`ç­‰æ–¹æ³•ä¸­ã€‚ç›´æ¥ä½¿ç”¨çˆ¶ç±»çš„å¤„ç†æ–¹å¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> requestBySerializingRequest:request withParameters:parameters error:error];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [request mutableCopy];</span><br><span class="line">    <span class="comment">//æŠŠ`HTTPRequestHeaders`ä¸­çš„å€¼æ·»åŠ è¿›å…¥è¯·æ±‚å¤´ä¸­ã€‚</span></span><br><span class="line">    [<span class="keyword">self</span>.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> field, <span class="keyword">id</span> value, <span class="built_in">BOOL</span> * __unused stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">if</span> (parameters) &#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®è¯·æ±‚å¤´çš„`Content-Type`ç±»å‹</span></span><br><span class="line">        <span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) &#123;</span><br><span class="line">            [mutableRequest setValue:<span class="string">@"application/x-plist"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŠŠparametersè½¬æ¢ä¸ºPliståºåˆ—åŒ–çš„data</span></span><br><span class="line">        <span class="built_in">NSData</span> *plistData = [<span class="built_in">NSPropertyListSerialization</span> dataWithPropertyList:parameters format:<span class="keyword">self</span>.format options:<span class="keyword">self</span>.writeOptions error:error];</span><br><span class="line">        <span class="keyword">if</span> (!plistData) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Pliståºåˆ—åŒ–çš„æ•°æ®è®¾ç½®ä¸ºhttpbody</span></span><br><span class="line">        [mutableRequest setHTTPBody:plistData];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mutableRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        </div>

        <blockquote class="post-copyright">
    
    <footer>
        <a href="https://nixzhang5.github.io">
            <img src="/img/avatar.jpg" alt="å¼ æ–°å¹³">
            å¼ æ–°å¹³
        </a>
    </footer>
</blockquote>

        


        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AFNetWorkingåŸç†/">AFNetWorkingåŸç†</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html&title=ã€ŠAFNetWorkingåŸç†ä¸‰ AFURLRequestSerializationã€‹ â€” Xinping's Blog&pic=https://nixzhang5.github.io/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html&title=ã€ŠAFNetWorkingåŸç†ä¸‰ AFURLRequestSerializationã€‹ â€” Xinping's Blog&source=AFURLRequestSerializationåºåˆ—åŒ–ç½‘ç»œè¯·æ±‚å‚æ•°" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠAFNetWorkingåŸç†ä¸‰ AFURLRequestSerializationã€‹ â€” Xinping's Blog&url=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html&via=https://nixzhang5.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="waves-block waves-effect prev">
      <a href="/AFNetWorkingåŸç†å››.html" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">AFNetWorkingåŸç†å›› AFURLResponseSerialization</h4>
      </a>
    </div>
  

  
    <div class="waves-block waves-effect next">
      <a href="/Appç­¾ååŸç†.html" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">Appç­¾ååŸç†</h4>
      </a>
    </div>
  
</nav>



    




















</article>



</div>

        <footer class="footer">
    <div class="top">
        

        <p>
            
                <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            
            <span>This blog is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</span>
        </p>
    </div>
    <div class="bottom">
        <p><span>å¼ æ–°å¹³ &copy; 2015 - 2019</span>
            <span>
                
                Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a>
            </span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html&title=ã€ŠAFNetWorkingåŸç†ä¸‰ AFURLRequestSerializationã€‹ â€” Xinping's Blog&pic=https://nixzhang5.github.io/img/avatar.jpg" data-title="å¾®åš">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="å¾®ä¿¡">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html&title=ã€ŠAFNetWorkingåŸç†ä¸‰ AFURLRequestSerializationã€‹ â€” Xinping's Blog&source=AFURLRequestSerializationåºåˆ—åŒ–ç½‘ç»œè¯·æ±‚å‚æ•°" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=ã€ŠAFNetWorkingåŸç†ä¸‰ AFURLRequestSerializationã€‹ â€” Xinping's Blog&url=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html&via=https://nixzhang5.github.io" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>æ‰«ä¸€æ‰«ï¼Œåˆ†äº«åˆ°å¾®ä¿¡</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJ0lEQVR42u3aQW4CMQwFUO5/aSp11YoO/bZDVZKXFYJhxm8WlhP7dovX/XNdff66Hv91df3VlY+/LlsYGBhvy7g/XY+hJ5hJ6Mmdf6BiYGAcwMiTbIJ5nnaTJJ4/FwMDA+N5KEnifl4mJqUkBgYGRi/h9sLK74yBgYHR28TmBVxv45p8v2AvjoGB8YaMeWPgdZ//tL+BgYHxLxn31pok1uq/ongwMDC2ZuRHaUmWy1P2ZFAjCggDA2M7Rv6w3pBEr9m5bLOKgYGxBaM6FlY4rB+EiIGBgVE9/Mo3tNX0PWmXftuLY2BgHMZIMFVAL7lHyRoDA2NrxqRwnJSV86bmsvoXAwPj3zNWPaw3UpZf+Us7AQMD4xhGfuzVS4t5iOViFAMD4wBGtbmYU/NQqkMbPyRcDAyMrRn5rfMCMT96qw5wFCZEMDAwNmL02op5Y7IaXPkbDAyMAxj5zFW1YVktIpOXi4GBcSajXIq9oFVQHRqL9uIYGBhbMJI0moe4tmGQHO1hYGCcw6gWdmtTc+8lRjUsBgbGdoz58X2y+UzSbrVhgIGBcQJjMh6xKk03xywwMDAOYNyLKxnIyFN2NdzL14qBgbE1I19Jcuwd9E8SNAYGxjmMSZKtNh1zRt4ewMDAOIdRTbJrD93ypH8ZFQYGBkbM6I1TLDjaw8DAwAgKwV7Q1VZBeWYEAwNjI0Z16GF+uDZpZ2JgYJzGeEVjYJKUe2kdAwNjU8YHLvHRPzRahlgAAAAASUVORK5CYII=" alt="å¾®ä¿¡åˆ†äº«äºŒç»´ç ">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false };


</script>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/main.min.js"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="//unpkg.com/hexo-theme-material-indigo@latest/js/search.min.js" async></script>








<script>
(function() {
    var OriginTitile = document.title, titleTime;
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            document.title = 'æ­»é¬¼å»å“ªé‡Œäº†ï¼';
            clearTimeout(titleTime);
        } else {
            document.title = 'æ¬¢è¿å›æ¥ï¼';
            titleTime = setTimeout(function() {
                document.title = OriginTitile;
            },2000);
        }
    });
})();
</script>



</body>
</html>
