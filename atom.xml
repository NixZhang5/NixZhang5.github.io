<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Xinping&#39;s Blog</title>
  
  <subtitle>å› ä¸ºæœ‰äº†å±æœºæ„Ÿï¼Œæ‰€ä»¥æ‰ä¼šä¹‰æ— åé¡¾ã€‚</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://nixzhang5.github.io/"/>
  <updated>2019-06-27T10:41:03.556Z</updated>
  <id>https://nixzhang5.github.io/</id>
  
  <author>
    <name>å¼ æ–°å¹³</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>AFNetWorkingåŸç†ä¸‰ AFURLRequestSerialization</title>
    <link href="https://nixzhang5.github.io/AFNetWorking%E5%8E%9F%E7%90%86%E4%B8%89.html"/>
    <id>https://nixzhang5.github.io/AFNetWorkingåŸç†ä¸‰.html</id>
    <published>2019-06-27T03:28:59.000Z</published>
    <updated>2019-06-27T10:41:03.556Z</updated>
    
    <content type="html"><![CDATA[<p>AFURLRequestSerializationåŒ…å«äº†å››ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>å…¨å±€æ–¹æ³•:AFPercentEscapedStringFromStringå’ŒAFQueryStringFromParametersã€‚</li><li>åè®®AFURLRequestSerializationæä¾›äº†ä¸€ä¸ªåºåˆ—åŒ–parameterså‚æ•°çš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå‚æ•°è½¬æ¢ä¸ºæŸ¥è¯¢å­—ç¬¦ä¸²ã€HTTPè¯·æ±‚ä½“ã€è®¾ç½®æ°å½“çš„è¯·æ±‚å¤´ç­‰ã€‚</li><li>AFHTTPRequestSerializerç»§æ‰¿è‡ªAFURLRequestSerializationåè®®ã€‚æä¾›äº†æŸ¥è¯¢å­—ç¬¦ä¸²/URLæ ¼å¼çš„å‚æ•°åºåˆ—åŒ–ã€é»˜è®¤è¯·æ±‚å¤´å¤„ç†ã€‚åŒæ—¶ä»¥æä¾›HTTPçŠ¶æ€ç å’Œè¿”å›æ•°æ®çš„éªŒè¯ç­‰å·¥ä½œã€‚<br>_ AFMultipartFormDataåè®®ã€‚ä¸»è¦ç”¨äºæ·»åŠ multipart/form-dataè¯·æ±‚çš„Content-Disposition: file; filename=#{generated filename}; name=#{name}â€ å’Œ Content-Type: #{generated mimeType}çš„è¯·æ±‚ä½“åŸŸã€‚</li><li>ç±»å‹AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializerã€‚ä¸»è¦é’ˆå¯¹JSONå’ŒPlistç±»å‹çš„åºåˆ—åŒ–ä¼˜åŒ–ã€‚</li></ol><a id="more"></a><h3 id="å·¥å…·å‡½æ•°"><a href="#å·¥å…·å‡½æ•°" class="headerlink" title="å·¥å…·å‡½æ•°"></a>å·¥å…·å‡½æ•°</h3><h4 id="AFPercentEscapedStringFromString"><a href="#AFPercentEscapedStringFromString" class="headerlink" title="AFPercentEscapedStringFromString"></a>AFPercentEscapedStringFromString</h4><p>æŠŠå­—ç¬¦ä¸²è½¬åŒ–æˆç¬¦åˆæ ‡å‡†çš„URLç¼–ç å­—ç¬¦ä¸²ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸€ä¸ªå­—ç¬¦é›†NSMutableCharacterSetæ¥å®šä¹‰éœ€è¦è¿›è¡Œè½¬ç çš„å­—ç¬¦ï¼Œå†é€šè¿‡-[NSString stringByAddingPercentEncodingWithAllowedCharacters]æ–¹æ³•æ¥è¿›è¡Œè½¬ç ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">AFURLRequestSerialization.h</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * AFPercentEscapedStringFromString(<span class="built_in">NSString</span> *string);</span><br><span class="line"></span><br><span class="line">AFURLRequestSerialization.m</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> * AFPercentEscapedStringFromString(<span class="built_in">NSString</span> *string) &#123;</span><br><span class="line">    <span class="comment">// does not include "?" or "/" due to RFC 3986 - Section 3.4</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kAFCharactersGeneralDelimitersToEncode = <span class="string">@":#[]@"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> kAFCharactersSubDelimitersToEncode = <span class="string">@"!$&amp;'()*+,;="</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableCharacterSet</span> * allowedCharacterSet = [[<span class="built_in">NSCharacterSet</span> URLQueryAllowedCharacterSet] mutableCopy];</span><br><span class="line">    [allowedCharacterSet removeCharactersInString:[kAFCharactersGeneralDelimitersToEncode stringByAppendingString:kAFCharactersSubDelimitersToEncode]];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSUInteger</span> <span class="keyword">const</span> batchSize = <span class="number">50</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSUInteger</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *escaped = <span class="string">@""</span>.mutableCopy;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (index &lt; string.length) &#123;</span><br><span class="line">        <span class="built_in">NSUInteger</span> length = MIN(string.length - index, batchSize);</span><br><span class="line">        <span class="built_in">NSRange</span> range = <span class="built_in">NSMakeRange</span>(index, length);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// To avoid breaking up character sequences such as ğŸ‘´ğŸ»ğŸ‘®ğŸ½</span></span><br><span class="line">        range = [string rangeOfComposedCharacterSequencesForRange:range];</span><br><span class="line"></span><br><span class="line">        <span class="built_in">NSString</span> *substring = [string substringWithRange:range];</span><br><span class="line">        <span class="built_in">NSString</span> *encoded = [substring stringByAddingPercentEncodingWithAllowedCharacters:allowedCharacterSet];</span><br><span class="line">        [escaped appendString:encoded];</span><br><span class="line"></span><br><span class="line">        index += range.length;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> escaped;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="AFQueryStringFromParameters"><a href="#AFQueryStringFromParameters" class="headerlink" title="AFQueryStringFromParameters"></a>AFQueryStringFromParameters</h4><p>æŠŠå­—å…¸è½¬åŒ–ä¸º&amp;æ‹¼æ¥çš„å‚æ•°ï¼Œé€šè¿‡AFQueryStringPairç±»æ¥å®ç°çš„ã€‚</p><p>AFQueryStringPairæ¥å­˜å–æ¯ä¸€ä¸ªæŸ¥è¯¢å±æ€§ï¼Œå°†æŸ¥è¯¢çš„é”®å€¼ä¿æŒèµ·æ¥ï¼Œç„¶åé€šè¿‡URLEncodedStringValueæ–¹æ³•åœ¨éœ€è¦æ—¶è¿›è¡Œæ‹¼æ¥ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ä¸Šé¢æ‰€è¿°çš„AFPercentEscapedStringFromStringæ–¹æ³•è¿›è¡Œäº†URLEncodeã€‚å…¶ä¸­æœ€ä¸»è¦çš„æ–¹æ³•æ˜¯AFQueryStringPairsFromKeyAndValueï¼Œå®ƒå°†å­—å…¸çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹ç”Ÿæˆçš„å¯¹åº”çš„AFQueryStringPairå¯¹è±¡ï¼Œä¾‹å¦‚å°†machine:[iphone, mac]è½¬æ¢ä¸ºURLEncodedStringValueå€¼æ˜¯machine[]=iphoneå’Œmachine[]=macçš„ä¸¤ä¸ªAFQueryStringPairå¯¹è±¡ã€‚ä¹‹åAFQueryStringFromParametersæ–¹æ³•å†ä»¥â€™&amp;â€™ç¬¦å·å¯¹å®ƒä»¬è¿›è¡Œæ‹¼æ¥ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">AFURLRequestSerialization.h</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * AFQueryStringFromParameters(<span class="built_in">NSDictionary</span> *parameters);</span><br><span class="line"></span><br><span class="line">AFURLRequestSerialization.m</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFQueryStringPair</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> field;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> value;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithField:(<span class="keyword">id</span>)field value:(<span class="keyword">id</span>)value;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)URLEncodedStringValue;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFQueryStringPair</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithField:(<span class="keyword">id</span>)field value:(<span class="keyword">id</span>)value &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.field = field;</span><br><span class="line">    <span class="keyword">self</span>.value = value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)URLEncodedStringValue &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>.value || [<span class="keyword">self</span>.value isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> AFPercentEscapedStringFromString([<span class="keyword">self</span>.field description]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@=%@"</span>, AFPercentEscapedStringFromString([<span class="keyword">self</span>.field description]), AFPercentEscapedStringFromString([<span class="keyword">self</span>.value description])];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSArray</span> * AFQueryStringPairsFromDictionary(<span class="built_in">NSDictionary</span> *dictionary);</span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSArray</span> * AFQueryStringPairsFromKeyAndValue(<span class="built_in">NSString</span> *key, <span class="keyword">id</span> value);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> * AFQueryStringFromParameters(<span class="built_in">NSDictionary</span> *parameters) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutablePairs = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">for</span> (AFQueryStringPair *pair <span class="keyword">in</span> AFQueryStringPairsFromDictionary(parameters)) &#123;</span><br><span class="line">        [mutablePairs addObject:[pair URLEncodedStringValue]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [mutablePairs componentsJoinedByString:<span class="string">@"&amp;"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> * AFQueryStringPairsFromDictionary(<span class="built_in">NSDictionary</span> *dictionary) &#123;</span><br><span class="line">    <span class="keyword">return</span> AFQueryStringPairsFromKeyAndValue(<span class="literal">nil</span>, dictionary);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSArray</span> * AFQueryStringPairsFromKeyAndValue(<span class="built_in">NSString</span> *key, <span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *mutableQueryStringComponents = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSSortDescriptor</span> *sortDescriptor = [<span class="built_in">NSSortDescriptor</span> sortDescriptorWithKey:<span class="string">@"description"</span> ascending:<span class="literal">YES</span> selector:<span class="keyword">@selector</span>(compare:)];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *dictionary = value;</span><br><span class="line">        <span class="comment">// Sort dictionary keys to ensure consistent ordering in query string, which is important when deserializing potentially ambiguous sequences, such as an array of dictionaries</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> nestedKey <span class="keyword">in</span> [dictionary.allKeys sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</span><br><span class="line">            <span class="keyword">id</span> nestedValue = dictionary[nestedKey];</span><br><span class="line">            <span class="keyword">if</span> (nestedValue) &#123;</span><br><span class="line">                [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue((key ? [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@[%@]"</span>, key, nestedKey] : nestedKey), nestedValue)];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *array = value;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> nestedValue <span class="keyword">in</span> array) &#123;</span><br><span class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue([<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@[]"</span>, key], nestedValue)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSSet</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="built_in">NSSet</span> *set = value;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> [set sortedArrayUsingDescriptors:@[ sortDescriptor ]]) &#123;</span><br><span class="line">            [mutableQueryStringComponents addObjectsFromArray:AFQueryStringPairsFromKeyAndValue(key, obj)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [mutableQueryStringComponents addObject:[[AFQueryStringPair alloc] initWithField:key value:value]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mutableQueryStringComponents;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AFURLRequestSerialization"><a href="#AFURLRequestSerialization" class="headerlink" title="AFURLRequestSerialization"></a>AFURLRequestSerialization</h3><p>å…ˆå£°æ˜äº†ä¸€ä¸ªåè®®AFURLRequestSerializationç»§æ‰¿äº†NSSecureCodingå’ŒNSCopyingæ¥ä¿è¯æ‰€æœ‰å®ç°è¿™ä¸ªåºåˆ—åŒ–åè®®çš„åºåˆ—åŒ–å™¨ç±»éƒ½æœ‰å®‰å…¨ç¼–ç å’Œå¤åˆ¶çš„èƒ½åŠ›ã€‚åè®®ä¹Ÿå®šä¹‰äº†åºåˆ—åŒ–çš„è§„èŒƒæ–¹æ³•ã€‚ï¼ˆåè®®ï¼Œæœ‰åˆ©äºæ‰©å±•ï¼‰</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    AFURLRequestSerializationåè®®å¯ä»¥è¢«ä¸€ä¸ªç¼–ç ç‰¹å®šhttpè¯·æ±‚çš„å¯¹è±¡å®ç°ã€‚</span></span><br><span class="line"><span class="comment">    è¯·æ±‚åºåˆ—åŒ–å™¨ï¼ˆRequest serializerï¼‰å¯ä»¥ç¼–ç æŸ¥è¯¢è¯­å¥ã€HTTPè¯·æ±‚ä½“ï¼Œå¦‚æœå¿…é¡»çš„è¯ï¼Œå¯ä»¥è‡ªè¡Œè®¾ç½®åˆé€‚çš„HTTPè¯·æ±‚ä½“å†…å®¹ï¼ˆå¦‚ï¼šAgent:iOSï¼‰ã€‚</span></span><br><span class="line"><span class="comment">    ä¾‹å¦‚ï¼Œä¸€ä¸ªJSONè¯·æ±‚åºåˆ—åŒ–å™¨ä¼šæŠŠè¯·æ±‚ä½“Content-Typeè®¾ç½®ä¸ºapplication/jsonã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">@protocol</span> <span class="title">AFURLRequestSerialization</span> &lt;<span class="title">NSObject</span>, <span class="title">NSSecureCoding</span>, <span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è¿”å›ä¸€ä¸ªä½¿ç”¨äº†æŒ‡å®šå‚æ•°ç¼–ç çš„è¯·æ±‚çš„æ‹·è´ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                        withParameters:(<span class="keyword">nullable</span> <span class="keyword">id</span>)parameters</span><br><span class="line">                                                 error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error <span class="built_in">NS_SWIFT_NOTHROW</span>;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h3 id="AFHTTPRequestSerializer"><a href="#AFHTTPRequestSerializer" class="headerlink" title="AFHTTPRequestSerializer"></a>AFHTTPRequestSerializer</h3><h4 id="ç¼“å­˜ç­–ç•¥"><a href="#ç¼“å­˜ç­–ç•¥" class="headerlink" title="ç¼“å­˜ç­–ç•¥"></a>ç¼“å­˜ç­–ç•¥</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, <span class="built_in">NSURLRequestCachePolicy</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        é»˜è®¤ç¼“å­˜ç­–ç•¥ã€‚å…·ä½“å·¥ä½œï¼šå¦‚æœä¸€ä¸ªNSCachedURLResponseå¯¹äºè¯·æ±‚å¹¶ä¸å­˜åœ¨ï¼Œæ•°æ®å°†ä¼šä»æºç«¯è·å–ã€‚å¦‚æœè¯·æ±‚æ‹¥æœ‰ä¸€ä¸ªç¼“å­˜çš„å“åº”ï¼Œé‚£ä¹ˆURLåŠ è½½ç³»ç»Ÿä¼šæ£€æŸ¥è¿™ä¸ªå“åº”æ¥å†³å®šï¼Œå¦‚æœå®ƒæŒ‡å®šå†…å®¹å¿…é¡»é‡æ–°ç”Ÿæ•ˆçš„è¯ã€‚å‡å¦‚å†…å®¹å¿…é¡»é‡æ–°ç”Ÿæ•ˆï¼Œå°†å»ºç«‹ä¸€ä¸ªè¿å‘æºç«¯çš„è¿æ¥æ¥æŸ¥çœ‹å†…å®¹æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚å‡å¦‚å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆå“åº”å°±ä»æœ¬åœ°ç¼“å­˜è¿”å›æ•°æ®ã€‚å¦‚æœå†…å®¹å˜åŒ–äº†ï¼Œé‚£ä¹ˆæ•°æ®å°†ä»æºç«¯è·å–</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestUseProtocolCachePolicy</span> = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        URLåº”è¯¥åŠ è½½æºç«¯æ•°æ®ï¼Œä¸ä½¿ç”¨æœ¬åœ°ç¼“å­˜æ•°æ®</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span> = <span class="number">1</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æœ¬åœ°ç¼“å­˜æ•°æ®ã€ä»£ç†å’Œå…¶ä»–ä¸­ä»‹éƒ½è¦å¿½è§†ä»–ä»¬çš„ç¼“å­˜ï¼Œç›´æ¥åŠ è½½æºæ•°æ®</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadIgnoringLocalAndRemoteCacheData</span> = <span class="number">4</span>, <span class="comment">// Unimplemented</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadIgnoringCacheData</span> = <span class="built_in">NSURLRequestReloadIgnoringLocalCacheData</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æŒ‡å®šå·²å­˜çš„ç¼“å­˜æ•°æ®åº”è¯¥ç”¨æ¥å“åº”è¯·æ±‚ï¼Œä¸ç®¡å®ƒçš„ç”Ÿå‘½æ—¶é•¿å’Œè¿‡æœŸæ—¶é—´ã€‚å¦‚æœåœ¨ç¼“å­˜ä¸­æ²¡æœ‰å·²å­˜æ•°æ®æ¥å“åº”è¯·æ±‚çš„è¯ï¼Œæ•°æ®ä»æºç«¯åŠ è½½ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReturnCacheDataElseLoad</span> = <span class="number">2</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æŒ‡å®šå·²å­˜çš„ç¼“å­˜æ•°æ®ç”¨æ¥æ»¡è¶³è¯·æ±‚ï¼Œä¸ç®¡ç”Ÿå‘½æ—¶é•¿å’Œè¿‡æœŸæ—¶é—´ã€‚å¦‚æœåœ¨ç¼“å­˜ä¸­æ²¡æœ‰å·²å­˜æ•°æ®æ¥å“åº”URLåŠ è½½è¯·æ±‚çš„è¯ï¼Œä¸å»å°è¯•ä»æºæ®µåŠ è½½æ•°æ®ï¼Œæ­¤æ—¶è®¤ä¸ºåŠ è½½è¯·æ±‚å¤±è´¥ã€‚è¿™ä¸ªå¸¸é‡æŒ‡å®šäº†ä¸€ä¸ªç±»ä¼¼äºç¦»çº¿æ¨¡å¼çš„è¡Œä¸º</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReturnCacheDataDontLoad</span> = <span class="number">3</span>,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        æŒ‡å®šå¦‚æœå·²å­˜çš„ç¼“å­˜æ•°æ®è¢«æä¾›å®ƒçš„æºæ®µç¡®è®¤ä¸ºæœ‰æ•ˆåˆ™å…è®¸ä½¿ç”¨ç¼“å­˜æ•°æ®å“åº”è¯·æ±‚ï¼Œå¦åˆ™ä»æºæ®µåŠ è½½æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">NSURLRequestReloadRevalidatingCacheData</span> = <span class="number">5</span>, <span class="comment">// Unimplemented</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>NSURLRequestReturnCacheDataDontLoadæ˜¯ç”¨äºç¦»çº¿æ¨¡å¼çš„ï¼Œæˆ‘ä¸ºäº†èƒ½è®©ç”¨æˆ·åœ¨ç¦»çº¿ä¸‹é¢é˜…è¯»ï¼Œæˆ‘å°±è®¾è®¡äº†å½“æ²¡æœ‰ç½‘ç»œçš„æ—¶å€™çš„ç­–ç•¥ä¸ºNSURLRequestReturnCacheDataDontLoadã€‚</p><h4 id="åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜"><a href="#åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜" class="headerlink" title="åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜"></a>åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å£°æ˜</h4><p>HTTPåºåˆ—åŒ–å™¨ç±»AFHTTPRequestSerializerï¼Œå®ç°äº†AFURLRequestSerializationåè®®ï¼Œå¹¶å‚è€ƒäº†NSMutableURLRequestç±»å£°æ˜äº†å¾ˆå¤šè¯·æ±‚è®¾ç½®ç›¸å…³å±æ€§ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    AFHTTPRequestSerializerå®ç°äº†AFURLRequestSerializationåè®®ï¼Œä¸ºæŸ¥è¯¢è¯­å¥ã€URLè¡¨å•ç¼–ç å‚æ•°çš„åºåˆ—åŒ–æä¾›ä¸€ä¸ªå…·ä½“çš„å®ç°å’Œé»˜è®¤çš„è¯·æ±‚å¤´ï¼Œä»¥åŠçŠ¶æ€ç å’Œå†…å®¹ç±»å‹çš„æ ¡éªŒã€‚</span></span><br><span class="line"><span class="comment">    æ‰€æœ‰çš„requestå’Œresponseéƒ½è¢«é¼“åŠ±å»ç»§æ‰¿AFHTTPRequestSerializerç±»ï¼Œä»¥ç¡®ä¿é»˜è®¤æ–¹æ³•å’Œå±æ€§çš„ä¸€è‡´æ€§ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPRequestSerializer</span> : <span class="title">NSObject</span> &lt;<span class="title">AFURLRequestSerialization</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    å­—ç¬¦ä¸²ç¼–ç æ–¹å¼ï¼Œé»˜è®¤ä¸ºNSUTF8StringEncoding</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    æ˜¯å¦å…è®¸æ‰‹æœºè®¿é—®ï¼Œé»˜è®¤ä¸ºYES</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> allowsCellularAccess;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ç¼“å­˜ç­–ç•¥ã€‚é»˜è®¤ä¸ºNSURLRequestUseProtocolCachePolicy</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setCachePolicy:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSURLRequestCachePolicy</span> cachePolicy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    æ˜¯å¦ç”¨cookieæ¥å¤„ç†åˆ›å»ºçš„è¯·æ±‚ã€‚é»˜è®¤ä¸ºYES</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setHTTPShouldHandleCookies</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> HTTPShouldHandleCookies;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    åˆ›å»ºçš„è¯·æ±‚åœ¨æ”¶åˆ°ä¸Šä¸ªä¼ è¾“ï¼ˆtransmissionï¼‰å“åº”ä¹‹å‰æ˜¯å¦ç»§ç»­å‘é€æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">    é»˜è®¤ä¸ºNO(å³ç­‰å¾…ä¸Šæ¬¡ä¼ è¾“å®Œæˆåå†è¯·æ±‚)</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setHTTPShouldUsePipelining:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> HTTPShouldUsePipelining;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è¯·æ±‚çš„ç½‘ç»œæœåŠ¡ç±»å‹ã€‚</span></span><br><span class="line"><span class="comment">    è¿™ä¸ªæœåŠ¡ç±»å‹å‘æ•´ä¸ªç½‘ç»œä¼ è¾“å±‚æ¬¡æä¾›äº†ä¸€ä¸ªå…³äºè¯¥è¯·æ±‚ç›®çš„çš„æç¤ºã€‚</span></span><br><span class="line"><span class="comment">    ï¼ˆThe service type is used to provide the networking layers a hint of the purpose of the request.ï¼‰</span></span><br><span class="line"><span class="comment">    é»˜è®¤ä¸ºNSURLNetworkServiceTypeDefault</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setNetworkServiceType:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSURLRequestNetworkServiceType</span> networkServiceType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è¯·æ±‚çš„è¶…æ—¶é—´éš”ï¼Œå•ä½ç§’ã€‚é»˜è®¤ä¸º60ç§’</span></span><br><span class="line"><span class="comment">    å‚è€ƒNSMutableURLRequest -setTimeoutInterval:</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> timeoutInterval;</span><br><span class="line"></span><br><span class="line"><span class="comment">///---------------------------------------</span></span><br><span class="line"><span class="comment">/// @name Configuring HTTP Request Headers</span></span><br><span class="line"><span class="comment">///---------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    åºåˆ—è¯·æ±‚çš„é»˜è®¤è¯·æ±‚å¤´ã€‚é»˜è®¤å€¼åŒ…æ‹¬</span></span><br><span class="line"><span class="comment">    'Accept-Languageâ€™  å†…å®¹ä¸º 'NSLocale +preferredLanguagesâ€™ æ–¹æ³•è·å–çš„è¯­éŸ³</span></span><br><span class="line"><span class="comment">    'User-Agentâ€™  å†…å®¹ä¸ºå„ç§bundleçš„æ ‡å¿—å·²ç»ç³»ç»Ÿä¿¡æ¯</span></span><br><span class="line"><span class="comment">    å¯ä»¥ä½¿ç”¨'setValue:forHTTPHeaderField:â€™æ–¹æ³•æ·»åŠ æˆ–åˆ é™¤è¯·æ±‚å¤´</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *HTTPRequestHeaders;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ç±»æ–¹æ³•åˆ›å»ºå®ä¾‹å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)serializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è®¾ç½®HTTPHeader</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)value forHTTPHeaderField:(<span class="built_in">NSString</span> *)field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è·å–HTTPHeader fieldå¯¹åº”çš„ä¿¡æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)valueForHTTPHeaderField:(<span class="built_in">NSString</span> *)field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è®¾ç½®èº«ä»½ä¿¡æ¯header</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setAuthorizationHeaderFieldWithUsername:(<span class="built_in">NSString</span> *)username</span><br><span class="line">                                       password:(<span class="built_in">NSString</span> *)password;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    æ¸…é™¤èº«ä»½è®¤è¯ä¿¡æ¯header</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)clearAuthorizationHeader;</span><br><span class="line"></span><br><span class="line"><span class="comment">///-------------------------------------------------------</span></span><br><span class="line"><span class="comment">/// @name Configuring Query String Parameter Serialization</span></span><br><span class="line"><span class="comment">///-------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    å“ªäº›HTTPè¯·æ±‚æ–¹æ³•ä¼šå°†å‚æ•°ç¼–ç æˆæŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆå¦‚:name=xgb&amp;gender=1ï¼‰ã€‚é»˜è®¤ä¸ºGET, HEADå’ŒDELETEã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSSet</span> &lt;<span class="built_in">NSString</span> *&gt; *HTTPMethodsEncodingParametersInURI;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    æŸ¥è¯¢å‚æ•°çš„è½¬ä¹‰æ ·å¼.(ç›®å‰åªæœ‰ä¸€ç§)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setQueryStringSerializationWithStyle:(AFHTTPRequestQueryStringSerializationStyle)style;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    è‡ªå®šä¹‰å‚æ•°çš„è½¬ä¹‰æ–¹å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setQueryStringSerializationWithBlock:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> * (^)(<span class="built_in">NSURLRequest</span> *request, <span class="keyword">id</span> parameters, <span class="built_in">NSError</span> * __autoreleasing *error))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">///-------------------------------</span></span><br><span class="line"><span class="comment">/// @name Creating Request Objects</span></span><br><span class="line"><span class="comment">///-------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    å¦‚æœè¯·æ±‚æ–¹å¼ä¸ºGET`, `HEAD`, or `DELETEæ—¶ã€å‚æ•°ä¼šè¢«æ‹¼æ¥åˆ°URLä¸­ã€å¦åˆ™å½“åšbodyå¤„ç†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                 URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                parameters:(<span class="keyword">nullable</span> <span class="keyword">id</span>)parameters</span><br><span class="line">                                     error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><h4 id="åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°"><a href="#åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°" class="headerlink" title="åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°"></a>åˆ›å»ºæ™®é€šNSMutableURLRequestè¯·æ±‚å¯¹è±¡å®ç°</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * AFHTTPRequestSerializerObservedKeyPaths() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSArray</span> *_AFHTTPRequestSerializerObservedKeyPaths = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        _AFHTTPRequestSerializerObservedKeyPaths = @[<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowsCellularAccess)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldHandleCookies)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldUsePipelining)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(networkServiceType)), <span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(timeoutInterval))];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _AFHTTPRequestSerializerObservedKeyPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AFHTTPRequestSerializerObservedKeyPathsæ–¹æ³•å®šä¹‰å¯ä»¥éœ€è¦è¢«è§‚å¯Ÿçš„å±æ€§ï¼ˆè¿™äº›å±æ€§ä¸ºå…¬å¼€çš„å±æ€§ï¼Œå¯èƒ½è¢«ç”¨æˆ·ä¿®æ”¹ï¼‰ï¼ŒåŒ…æ‹¬cachePolicyã€HTTPShouldHandleCookiesã€HTTPShouldUsePipeliningã€networkServiceTypeå’ŒtimeoutIntervalã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPRequestSerializer</span> ()</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ä¿å­˜ç”¨æˆ·ä¿®æ”¹è¿‡çš„å±æ€§ï¼ŒåŒ…æ‹¬AFHTTPRequestSerializerObservedKeyPathsåŒ…å«çš„å±æ€§ã€‚</span></span><br><span class="line"><span class="comment">    å½“ç”¨æˆ·ä¿®æ”¹è¿™äº›å±æ€§å€¼æ—¶è®°å½•èµ·æ¥ï¼Œåˆ›å»ºRequestæ—¶ä½¿ç”¨ï¼Œæ²¡ä¿®æ”¹çš„ä½¿ç”¨é»˜è®¤å€¼ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableSet</span> *mutableObservedChangedKeyPaths;</span><br><span class="line"><span class="comment">/** çœŸæ­£å­˜å‚¨Headerçš„å±æ€§ã€‚ */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span> *mutableHTTPRequestHeaders;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ç”¨ä¸€ä¸ªä¸²è¡Œçº¿ç¨‹æ¥ç»Ÿä¸€å¤„ç†Headerçš„ä¿®æ”¹ï¼Œé¿å…å¤šçº¿ç¨‹é€ æˆçš„çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">dispatch_queue_t</span> requestHeaderModificationQueue;</span><br><span class="line"><span class="comment">/** ç›®å‰åªæœ‰ä¸€ä¸ªå€¼ */</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AFHTTPRequestQueryStringSerializationStyle queryStringSerializationStyle;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    ç”¨äºè‡ªå®šä¹‰æŸ¥è¯¢å­—ç¬¦ä¸²çš„æ‹¼æ¥ã€‚</span></span><br><span class="line"><span class="comment">    å› ä¸ºAFURLRequestSerializationåè®®å®šä¹‰çš„æ–¹æ³•-requestBySerializingRequest:withParameters:error:ä¼ å…¥çš„parametersæ˜¯ä»¥å­—å…¸çš„å½¢å¼ä¼ å…¥ï¼Œæ‰€ä»¥éœ€è¦å°†å­—å…¸æ‹¼æ¥æˆæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨AFQueryStringFromParametersæ–¹æ³•æ‹¼æ¥ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFQueryStringSerializationBlock queryStringSerialization;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFHTTPRequestSerializer</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)serializer &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    åˆå§‹åŒ–æ–¹æ³•ä¸»è¦æ˜¯å¯¹ä¸€äº›å±æ€§åˆå§‹åŒ–ï¼Œä»¥åŠå°†HTTPå¤´éƒ¨æŒ‰ç…§w3cæ ‡å‡†è¿›è¡Œäº†å°è£…ï¼Œæ ¹æ®AFHTTPRequestSerializerObservedKeyPathsæ–¹æ³•å¯¹ä¸€äº›å¿…è¦çš„å±æ€§ä½¿ç”¨KVOè¿›è¡Œäº†ç›‘å¬ã€‚åœ¨è¿™äº›è¢«ç›‘å¬çš„å±æ€§çš„setteré‡Œé¢æ‰‹åŠ¨åœ°å‘é€é€šçŸ¥ï¼Œé¿å…å‡ºç°å¥‡æ€ªçš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.stringEncoding = <span class="built_in">NSUTF8StringEncoding</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.mutableHTTPRequestHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    <span class="keyword">self</span>.requestHeaderModificationQueue = dispatch_queue_create(<span class="string">"requestHeaderModificationQueue"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Accept-Language HTTP Header; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.4</span></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *acceptLanguagesComponents = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    [[<span class="built_in">NSLocale</span> preferredLanguages] enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj, <span class="built_in">NSUInteger</span> idx, <span class="built_in">BOOL</span> *stop) &#123;</span><br><span class="line">        <span class="keyword">float</span> q = <span class="number">1.0</span>f - (idx * <span class="number">0.1</span>f);</span><br><span class="line">        [acceptLanguagesComponents addObject:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@;q=%0.1g"</span>, obj, q]];</span><br><span class="line">        *stop = q &lt;= <span class="number">0.5</span>f;</span><br><span class="line">    &#125;];</span><br><span class="line">    [<span class="keyword">self</span> setValue:[acceptLanguagesComponents componentsJoinedByString:<span class="string">@", "</span>] forHTTPHeaderField:<span class="string">@"Accept-Language"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *userAgent = <span class="literal">nil</span>;</span><br><span class="line"><span class="meta">#if TARGET_OS_IOS</span></span><br><span class="line">    <span class="comment">// User-Agent Header; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.43</span></span><br><span class="line">    userAgent = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@/%@ (%@; iOS %@; Scale/%0.2f)"</span>, [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleExecutableKey] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleIdentifierKey], [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][<span class="string">@"CFBundleShortVersionString"</span>] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleVersionKey], [[<span class="built_in">UIDevice</span> currentDevice] model], [[<span class="built_in">UIDevice</span> currentDevice] systemVersion], [[<span class="built_in">UIScreen</span> mainScreen] scale]];</span><br><span class="line"><span class="meta">#elif TARGET_OS_WATCH</span></span><br><span class="line">    <span class="comment">// User-Agent Header; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.43</span></span><br><span class="line">    userAgent = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@/%@ (%@; watchOS %@; Scale/%0.2f)"</span>, [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleExecutableKey] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleIdentifierKey], [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][<span class="string">@"CFBundleShortVersionString"</span>] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleVersionKey], [[<span class="built_in">WKInterfaceDevice</span> currentDevice] model], [[<span class="built_in">WKInterfaceDevice</span> currentDevice] systemVersion], [[<span class="built_in">WKInterfaceDevice</span> currentDevice] screenScale]];</span><br><span class="line"><span class="meta">#elif defined(__MAC_OS_X_VERSION_MIN_REQUIRED)</span></span><br><span class="line">    userAgent = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@/%@ (Mac OS X %@)"</span>, [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleExecutableKey] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleIdentifierKey], [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][<span class="string">@"CFBundleShortVersionString"</span>] ?: [[<span class="built_in">NSBundle</span> mainBundle] infoDictionary][(__bridge <span class="built_in">NSString</span> *)kCFBundleVersionKey], [[<span class="built_in">NSProcessInfo</span> processInfo] operatingSystemVersionString]];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="keyword">if</span> (userAgent) &#123;</span><br><span class="line">        <span class="keyword">if</span> (![userAgent canBeConvertedToEncoding:<span class="built_in">NSASCIIStringEncoding</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSMutableString</span> *mutableUserAgent = [userAgent mutableCopy];</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">CFStringTransform</span>((__bridge <span class="built_in">CFMutableStringRef</span>)(mutableUserAgent), <span class="literal">NULL</span>, (__bridge <span class="built_in">CFStringRef</span>)<span class="string">@"Any-Latin; Latin-ASCII; [:^ASCII:] Remove"</span>, <span class="literal">false</span>)) &#123;</span><br><span class="line">                userAgent = mutableUserAgent;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        [<span class="keyword">self</span> setValue:userAgent forHTTPHeaderField:<span class="string">@"User-Agent"</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// HTTP Method Definitions; see http://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html</span></span><br><span class="line">    <span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI = [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"GET"</span>, <span class="string">@"HEAD"</span>, <span class="string">@"DELETE"</span>, <span class="literal">nil</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.mutableObservedChangedKeyPaths = [<span class="built_in">NSMutableSet</span> set];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="built_in">NSSelectorFromString</span>(keyPath)]) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addObserver:<span class="keyword">self</span> forKeyPath:keyPath options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:AFHTTPRequestSerializerObserverContext];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="built_in">NSSelectorFromString</span>(keyPath)]) &#123;</span><br><span class="line">            [<span class="keyword">self</span> removeObserver:<span class="keyword">self</span> forKeyPath:keyPath context:AFHTTPRequestSerializerObserverContext];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Workarounds for crashing behavior using Key-Value Observing with XCTest</span></span><br><span class="line"><span class="comment">// See https://github.com/AFNetworking/AFNetworking/issues/2523</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setAllowsCellularAccess:(<span class="built_in">BOOL</span>)allowsCellularAccess &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowsCellularAccess))];</span><br><span class="line">    _allowsCellularAccess = allowsCellularAccess;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowsCellularAccess))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setCachePolicy:(<span class="built_in">NSURLRequestCachePolicy</span>)cachePolicy &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy))];</span><br><span class="line">    _cachePolicy = cachePolicy;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(cachePolicy))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setHTTPShouldHandleCookies:(<span class="built_in">BOOL</span>)HTTPShouldHandleCookies &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldHandleCookies))];</span><br><span class="line">    _HTTPShouldHandleCookies = HTTPShouldHandleCookies;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldHandleCookies))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setHTTPShouldUsePipelining:(<span class="built_in">BOOL</span>)HTTPShouldUsePipelining &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldUsePipelining))];</span><br><span class="line">    _HTTPShouldUsePipelining = HTTPShouldUsePipelining;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(HTTPShouldUsePipelining))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setNetworkServiceType:(<span class="built_in">NSURLRequestNetworkServiceType</span>)networkServiceType &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(networkServiceType))];</span><br><span class="line">    _networkServiceType = networkServiceType;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(networkServiceType))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setTimeoutInterval:(<span class="built_in">NSTimeInterval</span>)timeoutInterval &#123;</span><br><span class="line">    [<span class="keyword">self</span> willChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(timeoutInterval))];</span><br><span class="line">    _timeoutInterval = timeoutInterval;</span><br><span class="line">    [<span class="keyword">self</span> didChangeValueForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(timeoutInterval))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSDictionary</span> *)HTTPRequestHeaders &#123;</span><br><span class="line">    <span class="built_in">NSDictionary</span> __block *value;</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        value = [<span class="built_in">NSDictionary</span> dictionaryWithDictionary:<span class="keyword">self</span>.mutableHTTPRequestHeaders];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="built_in">NSString</span> *)value</span><br><span class="line">forHTTPHeaderField:(<span class="built_in">NSString</span> *)field</span><br><span class="line">&#123;</span><br><span class="line">    dispatch_barrier_async(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span>.mutableHTTPRequestHeaders setValue:value forKey:field];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span> *)valueForHTTPHeaderField:(<span class="built_in">NSString</span> *)field &#123;</span><br><span class="line">    <span class="built_in">NSString</span> __block *value;</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        value = [<span class="keyword">self</span>.mutableHTTPRequestHeaders valueForKey:field];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//é€šè¿‡è´¦å·å¯†ç è®¾ç½®æˆæƒè¯·æ±‚å¤´</span></span><br><span class="line">- (<span class="keyword">void</span>)setAuthorizationHeaderFieldWithUsername:(<span class="built_in">NSString</span> *)username</span><br><span class="line">                                       password:(<span class="built_in">NSString</span> *)password</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSData</span> *basicAuthCredentials = [[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@:%@"</span>, username, password] dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="built_in">NSString</span> *base64AuthCredentials = [basicAuthCredentials base64EncodedStringWithOptions:(<span class="built_in">NSDataBase64EncodingOptions</span>)<span class="number">0</span>];</span><br><span class="line">    [<span class="keyword">self</span> setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"Basic %@"</span>, base64AuthCredentials] forHTTPHeaderField:<span class="string">@"Authorization"</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ¸…é™¤æˆæƒç”¨è¯·æ±‚å¤´</span></span><br><span class="line">- (<span class="keyword">void</span>)clearAuthorizationHeader &#123;</span><br><span class="line">    dispatch_barrier_async(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        [<span class="keyword">self</span>.mutableHTTPRequestHeaders removeObjectForKey:<span class="string">@"Authorization"</span>];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">//è®¾ç½®æŸ¥è¯¢å‚æ•°çš„ç¼–ç æ–¹å¼</span></span><br><span class="line">- (<span class="keyword">void</span>)setQueryStringSerializationWithStyle:(AFHTTPRequestQueryStringSerializationStyle)style &#123;</span><br><span class="line">    <span class="keyword">self</span>.queryStringSerializationStyle = style;</span><br><span class="line">    <span class="keyword">self</span>.queryStringSerialization = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è®¾ç½®æŸ¥è¯¢å‚æ•°è‡ªå®šä¹‰ç¼–ç çš„block</span></span><br><span class="line">- (<span class="keyword">void</span>)setQueryStringSerializationWithBlock:(<span class="built_in">NSString</span> *(^)(<span class="built_in">NSURLRequest</span> *, <span class="keyword">id</span>, <span class="built_in">NSError</span> *__autoreleasing *))block &#123;</span><br><span class="line">    <span class="keyword">self</span>.queryStringSerialization = block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">//é€šè¿‡è¯·æ±‚æ–¹å¼ã€URLã€å‚æ•°å­—å…¸ç”Ÿæˆè¯·æ±‚</span></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                 URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                parameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                     error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(method);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(URLString);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:URLString];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(url);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [[<span class="built_in">NSMutableURLRequest</span> alloc] initWithURL:url];</span><br><span class="line">    mutableRequest.HTTPMethod = method;</span><br><span class="line">    <span class="comment">//å¦‚æœæŸä¸ªå…³é”®å±æ€§è¢«è‡ªä¸»è®¾ç½®è¿‡ã€åˆ™ç”¨æ–°çš„ã€‚ä¸ç„¶ç›´æ¥ç”¨æ¨¡æ¿ç”Ÿæˆçš„`NSMutableURLRequest`å³å¯</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *keyPath <span class="keyword">in</span> AFHTTPRequestSerializerObservedKeyPaths()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</span><br><span class="line">            [mutableRequest setValue:[<span class="keyword">self</span> valueForKeyPath:keyPath] forKey:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¯¹reqè¿›ä¸€æ­¥è®¾ç½®(æ‹¼æ¥URLã€è¯·æ±‚ä½“ã€è¯·æ±‚å¤´)</span></span><br><span class="line">    mutableRequest = [[<span class="keyword">self</span> requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> mutableRequest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - AFURLRequestSerialization</span></span><br><span class="line">- (<span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               withParameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                        error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(request);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [request mutableCopy];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®è¯·æ±‚å¤´</span></span><br><span class="line">    [<span class="keyword">self</span>.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> field, <span class="keyword">id</span> value, <span class="built_in">BOOL</span> * __unused stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ ¹æ®å‚æ•°parametersè®¾ç½®æŸ¥è¯¢å­—æ®µ</span></span><br><span class="line">    <span class="built_in">NSString</span> *query = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (parameters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.queryStringSerialization) &#123;</span><br><span class="line">            <span class="built_in">NSError</span> *serializationError;</span><br><span class="line">            query = <span class="keyword">self</span>.queryStringSerialization(request, parameters, &amp;serializationError);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">                <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                    *error = serializationError;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (<span class="keyword">self</span>.queryStringSerializationStyle) &#123;</span><br><span class="line">                <span class="keyword">case</span> AFHTTPRequestQueryStringDefaultStyle:</span><br><span class="line">                    query = AFQueryStringFromParameters(parameters);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å‚æ•°æ˜¯æ‹¼åˆ°urlè¿˜æ˜¯æ”¾åˆ°HTTPBody</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (query &amp;&amp; query.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mutableRequest.URL = [<span class="built_in">NSURL</span> URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? <span class="string">@"&amp;%@"</span> : <span class="string">@"?%@"</span>, query]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// #2864: an empty string is a valid x-www-form-urlencoded payload</span></span><br><span class="line">        <span class="keyword">if</span> (!query) &#123;</span><br><span class="line">            query = <span class="string">@""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) &#123;</span><br><span class="line">            [mutableRequest setValue:<span class="string">@"application/x-www-form-urlencoded"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        [mutableRequest setHTTPBody:[query dataUsingEncoding:<span class="keyword">self</span>.stringEncoding]];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mutableRequest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSKeyValueObserving</span></span><br><span class="line"><span class="comment">// å¯ä»¥å†³å®šæ˜¯å¦å‘é€KVOé€šçŸ¥</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([AFHTTPRequestSerializerObservedKeyPaths() containsObject:key]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath</span><br><span class="line">                      ofObject:(__unused <span class="keyword">id</span>)object</span><br><span class="line">                        change:(<span class="built_in">NSDictionary</span> *)change</span><br><span class="line">                       context:(<span class="keyword">void</span> *)context</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (context == AFHTTPRequestSerializerObserverContext) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([change[<span class="built_in">NSKeyValueChangeNewKey</span>] isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰æ–°å€¼ã€åˆ™æ¸…ç©ºæ‰€å±ç›‘å¬</span></span><br><span class="line">            [<span class="keyword">self</span>.mutableObservedChangedKeyPaths removeObject:keyPath];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [<span class="keyword">self</span>.mutableObservedChangedKeyPaths addObject:keyPath];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSSecureCoding</span></span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)supportsSecureCoding &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)decoder &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">self</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.mutableHTTPRequestHeaders = [[decoder decodeObjectOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>] forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(mutableHTTPRequestHeaders))] mutableCopy];</span><br><span class="line">    <span class="keyword">self</span>.queryStringSerializationStyle = (AFHTTPRequestQueryStringSerializationStyle)[[decoder decodeObjectOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>] forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(queryStringSerializationStyle))] unsignedIntegerValue];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder &#123;</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        [coder encodeObject:<span class="keyword">self</span>.mutableHTTPRequestHeaders forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(mutableHTTPRequestHeaders))];</span><br><span class="line">    &#125;);</span><br><span class="line">    [coder encodeInteger:<span class="keyword">self</span>.queryStringSerializationStyle forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(queryStringSerializationStyle))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSCopying</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFHTTPRequestSerializer *serializer = [[[<span class="keyword">self</span> <span class="keyword">class</span>] allocWithZone:zone] init];</span><br><span class="line">    <span class="built_in">dispatch_sync</span>(<span class="keyword">self</span>.requestHeaderModificationQueue, ^&#123;</span><br><span class="line">        serializer.mutableHTTPRequestHeaders = [<span class="keyword">self</span>.mutableHTTPRequestHeaders mutableCopyWithZone:zone];</span><br><span class="line">    &#125;);</span><br><span class="line">    serializer.queryStringSerializationStyle = <span class="keyword">self</span>.queryStringSerializationStyle;</span><br><span class="line">    serializer.queryStringSerialization = <span class="keyword">self</span>.queryStringSerialization;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> serializer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å®ç°é‡Œé¢ç”¨åˆ°äº† KVO å’Œ GCD<br>KVOå¾ˆå·§å¦™çš„æŠŠå‡ ä¸ªå±æ€§å€¼çš„æ›´æ”¹ç»Ÿä¸€å¤„ç†ï¼Œä»£ç æ¸…æ™°ã€ç®€æ´<br>GCDæ …æ å‡½æ•°</p><h4 id="AFMultipartFormDataåè®®"><a href="#AFMultipartFormDataåè®®" class="headerlink" title="AFMultipartFormDataåè®®"></a>AFMultipartFormDataåè®®</h4><p>ä¸Šä¼ å›¾ç‰‡æˆ–è€…å…¶ä»–æ–‡ä»¶çš„</p><ol><li>åˆå§‹åŒ–è¾¹ç•Œ</li><li>bodyå¤´</li><li>body</li><li>ç»“æŸè¾¹ç•Œ</li></ol><p>åè®®ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                         name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                        error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                         name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                     fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                     mimeType:(<span class="built_in">NSString</span> *)mimeType</span><br><span class="line">                        error:(<span class="built_in">NSError</span> * _Nullable __autoreleasing *)error;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithInputStream:(<span class="keyword">nullable</span> <span class="built_in">NSInputStream</span> *)inputStream</span><br><span class="line">                             name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                         fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                           length:(int64_t)length</span><br><span class="line">                         mimeType:(<span class="built_in">NSString</span> *)mimeType;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithFileData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                      fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                      mimeType:(<span class="built_in">NSString</span> *)mimeType;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithFormData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          name:(<span class="built_in">NSString</span> *)name;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithHeaders:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span> &lt;<span class="built_in">NSString</span> *, <span class="built_in">NSString</span> *&gt; *)headers</span><br><span class="line">                         body:(<span class="built_in">NSData</span> *)body;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)throttleBandwidthWithPacketSize:(<span class="built_in">NSUInteger</span>)numberOfBytes</span><br><span class="line">                                  delay:(<span class="built_in">NSTimeInterval</span>)delay;</span><br></pre></td></tr></table></figure><p>Bodyéƒ¨åˆ†ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPBodyPart</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="comment">// ç¼–ç æ–¹å¼</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</span><br><span class="line"><span class="comment">// å¤´</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSDictionary</span> *headers;</span><br><span class="line"><span class="comment">// è¾¹ç•Œ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *boundary;</span><br><span class="line"><span class="comment">// ä¸»ä½“</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> body;</span><br><span class="line"><span class="comment">// ä¸»é¢˜å†…å®¹é•¿åº¦</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> bodyContentLength;</span><br><span class="line"><span class="comment">// æµ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSInputStream</span> *inputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦æœ‰åˆå§‹è¾¹ç•Œ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> hasInitialBoundary;</span><br><span class="line"><span class="comment">// æ˜¯å¦æœ‰ç»“æŸè¾¹ç•Œ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> hasFinalBoundary;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦æœ‰å¯ç”¨å­—èŠ‚ï¼Œæ˜¯å¦ä¸ºnil</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span> = hasBytesAvailable) <span class="built_in">BOOL</span> bytesAvailable;</span><br><span class="line"><span class="comment">// é•¿åº¦</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> contentLength;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer</span><br><span class="line">        maxLength:(<span class="built_in">NSUInteger</span>)length;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>AFHTTPBodyPartç±»å±æ€§å¯ä»¥çœ‹å‡ºï¼Œå·²ç»åŒ…å«äº†å››å¤§ç»„æˆéƒ¨åˆ†</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> &#123;</span><br><span class="line">    AFEncapsulationBoundaryPhase = <span class="number">1</span>,</span><br><span class="line">    AFHeaderPhase                = <span class="number">2</span>,</span><br><span class="line">    AFBodyPhase                  = <span class="number">3</span>,</span><br><span class="line">    AFFinalBoundaryPhase         = <span class="number">4</span>,</span><br><span class="line">&#125; AFHTTPBodyPartReadPhase;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFHTTPBodyPart</span> () &lt;<span class="title">NSCopying</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨æšä¸¾ åŒ…è£…body4å¤§ç»„æˆéƒ¨åˆ†</span></span><br><span class="line">    AFHTTPBodyPartReadPhase _phase;</span><br><span class="line">    <span class="comment">// è¾“å…¥æµ</span></span><br><span class="line">    <span class="built_in">NSInputStream</span> *_inputStream;</span><br><span class="line">    <span class="comment">// æ¯ä¸ªç»„æˆéƒ¨åˆ†çš„ä½ç½®</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> _phaseReadOffset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªé˜¶æ®µ</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)transitionToNextPhase;</span><br><span class="line"><span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)readData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">           intoBuffer:(uint8_t *)buffer</span><br><span class="line">            maxLength:(<span class="built_in">NSUInteger</span>)length;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å¯¹AFHTTPBodyPartçš„æ‰©å±•éƒ¨åˆ†ï¼Œå¯ä»¥çœ‹å‡ºæ›¾åŠ äº†ä¸‰ä¸ªå±æ€§ã€ä¸¤ä¸ªæ–¹æ³•</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AFHTTPBodyPart å®ç°éƒ¨åˆ†</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFHTTPBodyPart</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> transitionToNextPhase];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="keyword">if</span> (_inputStream) &#123;</span><br><span class="line">        [_inputStream close];</span><br><span class="line">        _inputStream = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bodyå¯èƒ½æœ‰å¥½å‡ ç§ç±»å‹ï¼Œæ ¹æ®ä¸åŒçš„ç±»å‹è¿”å›ä¸åŒæ–¹æ³•åˆ›å»ºçš„NSInputStream ã€‚</span></span><br><span class="line">- (<span class="built_in">NSInputStream</span> *)inputStream &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_inputStream) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([<span class="keyword">self</span>.body isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            _inputStream = [<span class="built_in">NSInputStream</span> inputStreamWithData:<span class="keyword">self</span>.body];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.body isKindOfClass:[<span class="built_in">NSURL</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            _inputStream = [<span class="built_in">NSInputStream</span> inputStreamWithURL:<span class="keyword">self</span>.body];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="keyword">self</span>.body isKindOfClass:[<span class="built_in">NSInputStream</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">            _inputStream = <span class="keyword">self</span>.body;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _inputStream = [<span class="built_in">NSInputStream</span> inputStreamWithData:[<span class="built_in">NSData</span> data]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _inputStream;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®headerå­—å…¸æ‹¼bodyå¤´</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)stringForHeaders &#123;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *headerString = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *field <span class="keyword">in</span> [<span class="keyword">self</span>.headers allKeys]) &#123;</span><br><span class="line">        [headerString appendString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@: %@%@"</span>, field, [<span class="keyword">self</span>.headers valueForKey:field], kAFMultipartFormCRLF]];</span><br><span class="line">    &#125;</span><br><span class="line">    [headerString appendString:kAFMultipartFormCRLF];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithString:headerString];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–bodyçš„å¤§å°  ç”¨åˆ°å‡ ä¸ªå‡½æ•°</span></span><br><span class="line">- (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)contentLength &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> length = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–è¾¹ç•Œ</span></span><br><span class="line">    <span class="built_in">NSData</span> *encapsulationBoundaryData = [([<span class="keyword">self</span> hasInitialBoundary] ? AFMultipartFormInitialBoundary(<span class="keyword">self</span>.boundary) : AFMultipartFormEncapsulationBoundary(<span class="keyword">self</span>.boundary)) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">    length += [encapsulationBoundaryData length];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤´</span></span><br><span class="line">    <span class="built_in">NSData</span> *headersData = [[<span class="keyword">self</span> stringForHeaders] dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">    length += [headersData length];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸»ä½“</span></span><br><span class="line">    length += _bodyContentLength;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»“æŸè¾¹ç•Œ</span></span><br><span class="line">    <span class="built_in">NSData</span> *closingBoundaryData = ([<span class="keyword">self</span> hasFinalBoundary] ? [AFMultipartFormFinalBoundary(<span class="keyword">self</span>.boundary) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding] : [<span class="built_in">NSData</span> data]);</span><br><span class="line">    length += [closingBoundaryData length];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ•°æ®</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)hasBytesAvailable &#123;</span><br><span class="line">    <span class="comment">// Allows `read:maxLength:` to be called again if `AFMultipartFormFinalBoundary` doesn't fit into the available buffer</span></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFFinalBoundaryPhase) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.inputStream.streamStatus) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusNotOpen</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusOpening</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusOpen</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusReading</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusWriting</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusAtEnd</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusClosed</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="built_in">NSStreamStatusError</span>:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢è¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯æŠŠbodyæ•°æ®å†™å…¥åˆ°bufferä¸­ã€‚é€šè¿‡è§‚å¯Ÿç€è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯å¾—çŸ¥ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•è‚¯å®šåœ¨å…¶ä»–çš„ä»£ç ä¸­çš„æŸä¸ªå¾ªç¯ä¸­è¢«è°ƒç”¨ï¼Œç›®çš„æ˜¯å¾—åˆ°æƒ³è¦çš„æ•°æ®æ ¼å¼</span></span><br><span class="line">- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer</span><br><span class="line">        maxLength:(<span class="built_in">NSUInteger</span>)length</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSInteger</span> totalNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFEncapsulationBoundaryPhase) &#123;</span><br><span class="line">        <span class="built_in">NSData</span> *encapsulationBoundaryData = [([<span class="keyword">self</span> hasInitialBoundary] ? AFMultipartFormInitialBoundary(<span class="keyword">self</span>.boundary) : AFMultipartFormEncapsulationBoundary(<span class="keyword">self</span>.boundary)) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:encapsulationBoundaryData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFHeaderPhase) &#123;</span><br><span class="line">        <span class="built_in">NSData</span> *headersData = [[<span class="keyword">self</span> stringForHeaders] dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:headersData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFBodyPhase) &#123;</span><br><span class="line">        <span class="built_in">NSInteger</span> numberOfBytesRead = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        numberOfBytesRead = [<span class="keyword">self</span>.inputStream read:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</span><br><span class="line">        <span class="keyword">if</span> (numberOfBytesRead == <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            totalNumberOfBytesRead += numberOfBytesRead;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span>.inputStream streamStatus] &gt;= <span class="built_in">NSStreamStatusAtEnd</span>) &#123;</span><br><span class="line">                [<span class="keyword">self</span> transitionToNextPhase];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_phase == AFFinalBoundaryPhase) &#123;</span><br><span class="line">        <span class="built_in">NSData</span> *closingBoundaryData = ([<span class="keyword">self</span> hasFinalBoundary] ? [AFMultipartFormFinalBoundary(<span class="keyword">self</span>.boundary) dataUsingEncoding:<span class="keyword">self</span>.stringEncoding] : [<span class="built_in">NSData</span> data]);</span><br><span class="line">        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:closingBoundaryData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalNumberOfBytesRead;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)readData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">           intoBuffer:(uint8_t *)buffer</span><br><span class="line">            maxLength:(<span class="built_in">NSUInteger</span>)length</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// æ¯”è¾ƒæ•°æ®å’Œå…è®¸çš„æœ€å¤§é•¿åº¦ é€‰å–æ¯”è¾ƒå°çš„é‚£ä¸ª</span></span><br><span class="line">    <span class="built_in">NSRange</span> range = <span class="built_in">NSMakeRange</span>((<span class="built_in">NSUInteger</span>)_phaseReadOffset, MIN([data length] - ((<span class="built_in">NSUInteger</span>)_phaseReadOffset), length));</span><br><span class="line">    <span class="comment">// copy dataä¸­rangeçš„æ•°æ®åˆ°buffer</span></span><br><span class="line">    [data getBytes:buffer range:range];</span><br><span class="line"></span><br><span class="line">    _phaseReadOffset += range.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((<span class="built_in">NSUInteger</span>)_phaseReadOffset) &gt;= [data length]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> transitionToNextPhase];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">NSInteger</span>)range.length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)transitionToNextPhase &#123;</span><br><span class="line">    <span class="comment">// ä¿è¯ä¸»çº¿ç¨‹æ‰§è¡Œä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> (![[<span class="built_in">NSThread</span> currentThread] isMainThread]) &#123;</span><br><span class="line">        <span class="built_in">dispatch_sync</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [<span class="keyword">self</span> transitionToNextPhase];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (_phase) &#123;</span><br><span class="line">        <span class="keyword">case</span> AFEncapsulationBoundaryPhase:</span><br><span class="line">            _phase = AFHeaderPhase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AFHeaderPhase: <span class="comment">// æ‰“å¼€æµï¼Œå‡†å¤‡æ¥æ”¶æ•°æ®</span></span><br><span class="line">            [<span class="keyword">self</span>.inputStream scheduleInRunLoop:[<span class="built_in">NSRunLoop</span> currentRunLoop] forMode:<span class="built_in">NSRunLoopCommonModes</span>];</span><br><span class="line">            [<span class="keyword">self</span>.inputStream open];</span><br><span class="line">            _phase = AFBodyPhase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AFBodyPhase: <span class="comment">// å…³é—­æµ</span></span><br><span class="line">            [<span class="keyword">self</span>.inputStream close];</span><br><span class="line">            _phase = AFFinalBoundaryPhase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AFFinalBoundaryPhase:</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            _phase = AFEncapsulationBoundaryPhase;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡ç½®offset</span></span><br><span class="line">    _phaseReadOffset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSCopying</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFHTTPBodyPart *bodyPart = [[[<span class="keyword">self</span> <span class="keyword">class</span>] allocWithZone:zone] init];</span><br><span class="line"></span><br><span class="line">    bodyPart.stringEncoding = <span class="keyword">self</span>.stringEncoding;</span><br><span class="line">    bodyPart.headers = <span class="keyword">self</span>.headers;</span><br><span class="line">    bodyPart.bodyContentLength = <span class="keyword">self</span>.bodyContentLength;</span><br><span class="line">    bodyPart.body = <span class="keyword">self</span>.body;</span><br><span class="line">    bodyPart.boundary = <span class="keyword">self</span>.boundary;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bodyPart;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å…¶å®AFHTTPBodyPartå°±åƒæ˜¯ä¸€ä¸ªä¸ªå…·ä½“çš„æ•°æ®ä¸€æ ·ï¼Œè€ŒAFMultipartBodyStreamæ›´åƒæ˜¯ä¸€ä¸ªç®¡é“ï¼Œå’Œbodyç›¸è¿ï¼Œæ•°æ®ä»bodyæ²¿ç€ç®¡é“æµå…¥requestä¸­å»ã€‚</p><p>è¿™å±‚æŠ½è±¡çš„æ¦‚å¿µè¿˜æ˜¯è›®é‡è¦çš„ã€‚å†è®¾è®¡ä¹‹åˆï¼Œè¿™ä¸¤ä¸ªæŠ½è±¡ç±»å°±åº”è¯¥å„è‡ªå®Œæˆå„è‡ªçš„ä»»åŠ¡ï¼Œå³ä½¿bodyä¸­ä¹Ÿæœ‰stream ä½†é‚£ä¹Ÿåªå±äºbodyè‡ªèº«çš„ä¸šåŠ¡ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AFHTTPBodyPartå°±åƒæ˜¯ä¸€ä¸ªä¸ªå…·ä½“çš„æ•°æ®ä¸€æ ·ï¼Œè€ŒAFMultipartBodyStreamæ›´åƒæ˜¯ä¸€ä¸ªç®¡é“</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFMultipartBodyStream</span> : <span class="title">NSInputStream</span> &lt;<span class="title">NSStreamDelegate</span>&gt;</span></span><br><span class="line"><span class="comment">// è¯»å–åŒ…çš„å¤§å°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSUInteger</span> numberOfBytesInPacket;</span><br><span class="line"><span class="comment">// å»¶æ—¶</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSTimeInterval</span> delay;</span><br><span class="line"><span class="comment">// è¾“å…¥æµ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSInputStream</span> *inputStream;</span><br><span class="line"><span class="comment">// å†…å®¹å¤§å°</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> contentLength;</span><br><span class="line"><span class="comment">// æ˜¯å¦ä¸ºç©º</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>, <span class="keyword">getter</span> = isEmpty) <span class="built_in">BOOL</span> empty;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithStringEncoding:(<span class="built_in">NSStringEncoding</span>)encoding;</span><br><span class="line">- (<span class="keyword">void</span>)setInitialAndFinalBoundaries;</span><br><span class="line">- (<span class="keyword">void</span>)appendHTTPBodyPart:(AFHTTPBodyPart *)bodyPart;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å®ƒæ˜¯ç»§æ‰¿è‡ªNSInputStreamçš„ï¼Œæ•°æ®æœ€ç»ˆæ˜¯é€šè¿‡setHTTPBodySteamæ–¹æ³•ä¼ é€’ç»™Requestçš„ã€‚æ˜¯ä¸€ä¸ªNSInputStreamç±»å‹ï¼Œå› æ­¤AFMultipartBodyStream ç»§æ‰¿è‡ªNSInputStream</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#pragma mark - NSInputStream</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer</span><br><span class="line">        maxLength:(<span class="built_in">NSUInteger</span>)length</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span> streamStatus] == <span class="built_in">NSStreamStatusClosed</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSInteger</span> totalNumberOfBytesRead = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// éå†è¯»å–æ•°æ®</span></span><br><span class="line">    <span class="keyword">while</span> ((<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead &lt; MIN(length, <span class="keyword">self</span>.numberOfBytesInPacket)) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰è¯»å–çš„bodyä¸å­˜åœ¨æˆ–è€…bodyæ²¡æœ‰å¯è¯»å­—èŠ‚</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">self</span>.currentHTTPBodyPart || ![<span class="keyword">self</span>.currentHTTPBodyPart hasBytesAvailable]) &#123;</span><br><span class="line">            <span class="comment">// æŠŠä¸‹ä¸€ä¸ªbodyèµ‹å€¼ç»™å½“å‰çš„body å¦‚æœä¸‹ä¸€ä¸ªä¸ºnil å°±é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (!(<span class="keyword">self</span>.currentHTTPBodyPart = [<span class="keyword">self</span>.HTTPBodyPartEnumerator nextObject])) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// å½“å‰bodyå­˜åœ¨</span></span><br><span class="line">            <span class="comment">// å‰©ä½™å¯è¯»æ–‡ä»¶çš„å¤§å°</span></span><br><span class="line">            <span class="built_in">NSUInteger</span> maxLength = MIN(length, <span class="keyword">self</span>.numberOfBytesInPacket) - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead;</span><br><span class="line">            <span class="comment">// æŠŠå½“å‰çš„bodyçš„æ•°æ®è¯»å…¥åˆ°bufferä¸­</span></span><br><span class="line">            <span class="built_in">NSInteger</span> numberOfBytesRead = [<span class="keyword">self</span>.currentHTTPBodyPart read:&amp;buffer[totalNumberOfBytesRead] maxLength:maxLength];</span><br><span class="line">            <span class="keyword">if</span> (numberOfBytesRead == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">self</span>.streamError = <span class="keyword">self</span>.currentHTTPBodyPart.inputStream.streamError;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                totalNumberOfBytesRead += numberOfBytesRead;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.delay &gt; <span class="number">0.0</span>f) &#123;</span><br><span class="line">                    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="keyword">self</span>.delay];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> totalNumberOfBytesRead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•æ˜¯AFMultipartBodyStreamé€šè¿‡bodyè¯»å–æ•°æ®çš„æ ¸å¿ƒæ–¹æ³•ã€‚ä¸‹é¢é€šè¿‡ä¸¾ä¸€ä¸ªä¾‹å­æ¥çœ‹çœ‹è¿™ä¸ªæ–¹æ³•ç©¶ç«Ÿæ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Ÿ</p><ol><li>å‡å¦‚æˆ‘ä»¬ä¸Šä¼ ä¸€å¼ å›¾ç‰‡img.png ä»–çš„å¤§å°ä¸º80000ï¼Œä¹Ÿå°±æ˜¯å·®ä¸å¤š80kå§ã€‚</li><li>é€šè¿‡AFMultipartBodyStreamè¯»å–æ•°æ®ï¼Œä¼šé¦–å…ˆè°ƒç”¨ä¸Šè¾¹çš„æ–¹æ³•ã€‚è¯»å–æ•°æ®å¹¶ä¸æ˜¯ä¸€æ¬¡æ€§è¯»å–çš„ï¼Œè€Œæ˜¯åˆ†æ‰¹åˆ†æ¬¡è¯»å–çš„ï¼Œè¿™è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæ¯æ¬¡è¯»å–çš„å¤§å°ä¸º32kï¼Œä¹Ÿå°±æ˜¯32*1024 = 32768çš„å¤§å°ã€‚</li><li>ç¬¬ä¸€æ¬¡è°ƒç”¨åself.currentHTTPBodyPart æŒ‡å‘æˆ‘ä»¬çš„img.png é€šè¿‡NSInteger numberOfBytesRead = [self.currentHTTPBodyPart read:&amp;buffer[totalNumberOfBytesRead] maxLength:maxLength]; æ–¹æ³•åœ¨bodyä¸­è¯»å–äº†32768å¤§å°çš„æ•°æ®ä¿å­˜åˆ°äº†ç¼“å­˜bufferä¸­ã€‚</li><li>ç”±äºæ•´ä¸ªå›¾ç‰‡å¤§å°æ˜¯80000 ä¸€æ¬¡è°ƒç”¨åªè¯»å–äº†32768 è¿˜æœ‰æ•°æ®æ²¡è¯»å®Œï¼Œä¸€æ¬¡è¿™ä¸ªæ–¹æ³•è¿˜ä¼šå†æ¬¡è¢«è°ƒç”¨ã€‚</li><li>ç¬¬äºŒæ¬¡è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œç”±äº[self.currentHTTPBodyPart hasBytesAvailable]è¿˜æœ‰æ•°æ®ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šèµ°åˆ°elseçš„æ–¹æ³•ä¸­ï¼Œself.currentHTTPBodyPartå¹¶æ²¡æœ‰æŒ‡å‘åˆ«çš„bodyã€‚å› æ­¤ç»§ç»­æ‰§è¡Œ 3.çš„æ–¹æ³•ã€‚</li><li>è‡³äºä¸ºä»€ä¹ˆèƒ½æ¥ç€ä»ä¸Šæ¬¡çš„å·²è¯»å–çš„æ•°æ®å¼€å§‹è¯»æ•°æ®ï¼Œè¿™ä¸ªæ˜¯bodyå†…éƒ¨å°è£…å®ç°çš„ï¼Œå¯å‚è€ƒæœ¬æ–‡ä¸Šè¾¹å…³äºbodyçš„ä»‹ç»ã€‚</li><li>é‡å¤ 3 4 5 çš„æ­¥éª¤ï¼Œç›´åˆ°æ²¡æœ‰æ•°æ®å¯è¯»æ—¶ï¼Œstreamå°±ä¼šå…³é—­æµã€‚åˆ°æ­¤æˆ‘ä»¬çš„çªå˜æ•°æ®å°±ä»¥æµçš„å½¢å¼ä¸Šä¼ åˆ°æœåŠ¡å™¨äº†ã€‚</li></ol><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)multipartFormRequestWithMethod:(<span class="built_in">NSString</span> *)method</span><br><span class="line">                                              URLString:(<span class="built_in">NSString</span> *)URLString</span><br><span class="line">                                             parameters:(<span class="built_in">NSDictionary</span> *)parameters</span><br><span class="line">                              constructingBodyWithBlock:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> &lt;AFMultipartFormData&gt; formData))block</span><br><span class="line">                                                  error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(method);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(![method isEqualToString:<span class="string">@"GET"</span>] &amp;&amp; ![method isEqualToString:<span class="string">@"HEAD"</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [<span class="keyword">self</span> requestWithMethod:method URLString:URLString parameters:<span class="literal">nil</span> error:error];</span><br><span class="line"></span><br><span class="line">    __block AFStreamingMultipartFormData *formData = [[AFStreamingMultipartFormData alloc] initWithURLRequest:mutableRequest stringEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (parameters) &#123;</span><br><span class="line">        <span class="keyword">for</span> (AFQueryStringPair *pair <span class="keyword">in</span> AFQueryStringPairsFromDictionary(parameters)) &#123;</span><br><span class="line">            <span class="built_in">NSData</span> *data = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">if</span> ([pair.value isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                data = pair.value;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([pair.value isEqual:[<span class="built_in">NSNull</span> null]]) &#123;</span><br><span class="line">                data = [<span class="built_in">NSData</span> data];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                data = [[pair.value description] dataUsingEncoding:<span class="keyword">self</span>.stringEncoding];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (data) &#123;</span><br><span class="line">                [formData appendPartWithFormData:data name:[pair.field description]];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (block) &#123;</span><br><span class="line">        block(formData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [formData requestByFinalizingMultipartFormData];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// setHTTPBodyStreamæ–¹æ³•  éœ€è¦è®¾ç½®NSInputStreamç±»å‹çš„å¯¹è±¡</span></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestByFinalizingMultipartFormData &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.bodyStream isEmpty]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the initial and final boundaries to ensure correct Content-Length</span></span><br><span class="line">    [<span class="keyword">self</span>.bodyStream setInitialAndFinalBoundaries];</span><br><span class="line">    [<span class="keyword">self</span>.request setHTTPBodyStream:<span class="keyword">self</span>.bodyStream];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.request setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"multipart/form-data; boundary=%@"</span>, <span class="keyword">self</span>.boundary] forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">    [<span class="keyword">self</span>.request setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%llu"</span>, [<span class="keyword">self</span>.bodyStream contentLength]] forHTTPHeaderField:<span class="string">@"Content-Length"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šä¼ å¤šä¸ªæ–‡ä»¶çš„æ—¶å€™å›ç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œé‡Œé¢æœ‰ä¸€ä¸ªæ¥å—AFMultipartFormDataåè®®çš„å¯¹è±¡ï¼ŒAFNæ²¡æœ‰è®©AFMultipartBodyStreamæ¥å—è¿™ä¸ªåè®®æ¥å¤„ç†ã€‚è€Œæ˜¯ç”¨å¦å¤–ä¸€ä¸ªç±»AFStreamingMultipartFormDataæ¥æ¥å—è¿™ä¸ªåè®®ï¼Œå°±æ˜¯ä¸ºäº†æŠŠåŠŸèƒ½å’Œä¸šåŠ¡ä»£ç é€»è¾‘åˆ†å¼€ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFStreamingMultipartFormData</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSMutableURLRequest</span> *request;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">NSStringEncoding</span> stringEncoding;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *boundary;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFMultipartBodyStream *bodyStream;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFStreamingMultipartFormData</span> : <span class="title">NSObject</span> &lt;<span class="title">AFMultipartFormData</span>&gt;</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithURLRequest:(<span class="built_in">NSMutableURLRequest</span> *)urlRequest</span><br><span class="line">                    stringEncoding:(<span class="built_in">NSStringEncoding</span>)encoding;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestByFinalizingMultipartFormData;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFStreamingMultipartFormData</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithURLRequest:(<span class="built_in">NSMutableURLRequest</span> *)urlRequest</span><br><span class="line">                    stringEncoding:(<span class="built_in">NSStringEncoding</span>)encoding</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.request = urlRequest;</span><br><span class="line">    <span class="keyword">self</span>.stringEncoding = encoding;</span><br><span class="line">    <span class="keyword">self</span>.boundary = AFCreateMultipartFormBoundary();</span><br><span class="line">    <span class="keyword">self</span>.bodyStream = [[AFMultipartBodyStream alloc] initWithStringEncoding:encoding];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setRequest:(<span class="built_in">NSMutableURLRequest</span> *)request</span><br><span class="line">&#123;</span><br><span class="line">    _request = [request mutableCopy];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                         name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                        error:(<span class="built_in">NSError</span> * __autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileURL);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *fileName = [fileURL lastPathComponent];</span><br><span class="line">    <span class="built_in">NSString</span> *mimeType = AFContentTypeForPathExtension([fileURL pathExtension]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> appendPartWithFileURL:fileURL name:name fileName:fileName mimeType:mimeType error:error];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                         name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                     fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                     mimeType:(<span class="built_in">NSString</span> *)mimeType</span><br><span class="line">                        error:(<span class="built_in">NSError</span> * __autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileURL);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileName);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(mimeType);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (![fileURL isFileURL]) &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *userInfo = @&#123;<span class="built_in">NSLocalizedFailureReasonErrorKey</span>: <span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"Expected URL to be a file URL"</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>)&#125;;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            *error = [[<span class="built_in">NSError</span> alloc] initWithDomain:AFURLRequestSerializationErrorDomain code:<span class="built_in">NSURLErrorBadURL</span> userInfo:userInfo];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([fileURL checkResourceIsReachableAndReturnError:error] == <span class="literal">NO</span>) &#123;</span><br><span class="line">        <span class="built_in">NSDictionary</span> *userInfo = @&#123;<span class="built_in">NSLocalizedFailureReasonErrorKey</span>: <span class="built_in">NSLocalizedStringFromTable</span>(<span class="string">@"File URL not reachable."</span>, <span class="string">@"AFNetworking"</span>, <span class="literal">nil</span>)&#125;;</span><br><span class="line">        <span class="keyword">if</span> (error) &#123;</span><br><span class="line">            *error = [[<span class="built_in">NSError</span> alloc] initWithDomain:AFURLRequestSerializationErrorDomain code:<span class="built_in">NSURLErrorBadURL</span> userInfo:userInfo];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSDictionary</span> *fileAttributes = [[<span class="built_in">NSFileManager</span> defaultManager] attributesOfItemAtPath:[fileURL path] error:error];</span><br><span class="line">    <span class="keyword">if</span> (!fileAttributes) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mutableHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    [mutableHeaders setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"form-data; name=\"%@\"; filename=\"%@\""</span>, name, fileName] forKey:<span class="string">@"Content-Disposition"</span>];</span><br><span class="line">    [mutableHeaders setValue:mimeType forKey:<span class="string">@"Content-Type"</span>];</span><br><span class="line"></span><br><span class="line">    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];</span><br><span class="line">    bodyPart.stringEncoding = <span class="keyword">self</span>.stringEncoding;</span><br><span class="line">    bodyPart.headers = mutableHeaders;</span><br><span class="line">    bodyPart.boundary = <span class="keyword">self</span>.boundary;</span><br><span class="line">    bodyPart.body = fileURL;</span><br><span class="line">    bodyPart.bodyContentLength = [fileAttributes[<span class="built_in">NSFileSize</span>] unsignedLongLongValue];</span><br><span class="line">    [<span class="keyword">self</span>.bodyStream appendHTTPBodyPart:bodyPart];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithInputStream:(<span class="built_in">NSInputStream</span> *)inputStream</span><br><span class="line">                             name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                         fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                           length:(int64_t)length</span><br><span class="line">                         mimeType:(<span class="built_in">NSString</span> *)mimeType</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileName);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(mimeType);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mutableHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    [mutableHeaders setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"form-data; name=\"%@\"; filename=\"%@\""</span>, name, fileName] forKey:<span class="string">@"Content-Disposition"</span>];</span><br><span class="line">    [mutableHeaders setValue:mimeType forKey:<span class="string">@"Content-Type"</span>];</span><br><span class="line"></span><br><span class="line">    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];</span><br><span class="line">    bodyPart.stringEncoding = <span class="keyword">self</span>.stringEncoding;</span><br><span class="line">    bodyPart.headers = mutableHeaders;</span><br><span class="line">    bodyPart.boundary = <span class="keyword">self</span>.boundary;</span><br><span class="line">    bodyPart.body = inputStream;</span><br><span class="line"></span><br><span class="line">    bodyPart.bodyContentLength = (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)length;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.bodyStream appendHTTPBodyPart:bodyPart];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithFileData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">                      fileName:(<span class="built_in">NSString</span> *)fileName</span><br><span class="line">                      mimeType:(<span class="built_in">NSString</span> *)mimeType</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(fileName);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(mimeType);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mutableHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    [mutableHeaders setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"form-data; name=\"%@\"; filename=\"%@\""</span>, name, fileName] forKey:<span class="string">@"Content-Disposition"</span>];</span><br><span class="line">    [mutableHeaders setValue:mimeType forKey:<span class="string">@"Content-Type"</span>];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> appendPartWithHeaders:mutableHeaders body:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithFormData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">                          name:(<span class="built_in">NSString</span> *)name</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(name);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *mutableHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    [mutableHeaders setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"form-data; name=\"%@\""</span>, name] forKey:<span class="string">@"Content-Disposition"</span>];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> appendPartWithHeaders:mutableHeaders body:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)appendPartWithHeaders:(<span class="built_in">NSDictionary</span> *)headers</span><br><span class="line">                         body:(<span class="built_in">NSData</span> *)body</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(body);</span><br><span class="line"></span><br><span class="line">    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];</span><br><span class="line">    bodyPart.stringEncoding = <span class="keyword">self</span>.stringEncoding;</span><br><span class="line">    bodyPart.headers = headers;</span><br><span class="line">    bodyPart.boundary = <span class="keyword">self</span>.boundary;</span><br><span class="line">    bodyPart.bodyContentLength = [body length];</span><br><span class="line">    bodyPart.body = body;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.bodyStream appendHTTPBodyPart:bodyPart];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)throttleBandwidthWithPacketSize:(<span class="built_in">NSUInteger</span>)numberOfBytes</span><br><span class="line">                                  delay:(<span class="built_in">NSTimeInterval</span>)delay</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span>.bodyStream.numberOfBytesInPacket = numberOfBytes;</span><br><span class="line">    <span class="keyword">self</span>.bodyStream.delay = delay;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableURLRequest</span> *)requestByFinalizingMultipartFormData &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.bodyStream isEmpty]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.request;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Reset the initial and final boundaries to ensure correct Content-Length</span></span><br><span class="line">    [<span class="keyword">self</span>.bodyStream setInitialAndFinalBoundaries];</span><br><span class="line">    [<span class="keyword">self</span>.request setHTTPBodyStream:<span class="keyword">self</span>.bodyStream];</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.request setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"multipart/form-data; boundary=%@"</span>, <span class="keyword">self</span>.boundary] forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">    [<span class="keyword">self</span>.request setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%llu"</span>, [<span class="keyword">self</span>.bodyStream contentLength]] forHTTPHeaderField:<span class="string">@"Content-Length"</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.request;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰AFStreamingMultipartFormDataï¼Œæ¥å—AFMultipartFormDataï¼Œå®ç°åè®®æ–¹æ³•ï¼ŒæŠŠæ–‡ä»¶å°è£…æˆbodyPartå¯¹è±¡å­˜å‚¨åˆ°AFStreamingMultipartFormDataå¯¹è±¡çš„å±æ€§bodyStreamçš„æ•°ç»„ä¸­ã€‚é€šè¿‡read maxLengthè¯»å–æ•°æ®ã€‚</p><h3 id="AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer"><a href="#AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer" class="headerlink" title="AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer"></a>AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializer</h3><p>è¿™ä¸¤ä¸ªç±»ç»§æ‰¿è‡ªAFHTTPRequestSerializerã€‚ä»–ä»¬çš„åŸºæœ¬å®ç°éƒ½æ˜¯ç»§æ‰¿è‡ªçˆ¶ç±»ã€‚ä½†æ˜¯ä¹Ÿæ ¹æ®è‡ªèº«ä¸åŒæƒ…å†µï¼Œåšäº†å¤„ç†ã€‚<br>å¯¹äºAFJSONRequestSerializerã€‚éœ€è¦æŠŠContent-TypeæŒ‡å®šä¸ºâ€application/jsonã€‚åŒæ—¶HTTPBody<br>éœ€è¦ä½¿ç”¨JSONåºåˆ—åŒ–ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request</span><br><span class="line">                               withParameters:(id)parameters</span><br><span class="line">                                        error:(NSError *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    NSParameterAssert(request);</span><br><span class="line">    /*</span><br><span class="line">     å¯¹äº`GET`,`HEAD`,`DELETE`ç­‰æ–¹æ³•ä¸­ã€‚ç›´æ¥ä½¿ç”¨çˆ¶ç±»çš„å¤„ç†æ–¹å¼</span><br><span class="line">     */</span><br><span class="line">    if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line">        return [super requestBySerializingRequest:request withParameters:parameters error:error];</span><br><span class="line">    &#125;</span><br><span class="line">    NSMutableURLRequest *mutableRequest = [request mutableCopy];</span><br><span class="line">    //æŠŠ`HTTPRequestHeaders`ä¸­çš„å€¼æ·»åŠ è¿›å…¥è¯·æ±‚å¤´ä¸­ã€‚</span><br><span class="line">    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) &#123;</span><br><span class="line">        if (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    if (parameters) &#123;</span><br><span class="line">        //è®¾ç½®è¯·æ±‚å¤´çš„`Content-Type`ç±»å‹</span><br><span class="line">        if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) &#123;</span><br><span class="line">            [mutableRequest setValue:@&quot;application/json&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (![NSJSONSerialization isValidJSONObject:parameters]) &#123;</span><br><span class="line">            if (error) &#123;</span><br><span class="line">                NSDictionary *userInfo = @&#123;NSLocalizedFailureReasonErrorKey: NSLocalizedStringFromTable(@&quot;The `parameters` argument is not valid JSON.&quot;, @&quot;AFNetworking&quot;, nil)&#125;;</span><br><span class="line">                *error = [[NSError alloc] initWithDomain:AFURLRequestSerializationErrorDomain code:NSURLErrorCannotDecodeContentData userInfo:userInfo];</span><br><span class="line">            &#125;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        //æŠŠparametersè½¬æ¢ä¸ºJSONåºåˆ—åŒ–çš„data</span><br><span class="line">        NSData *jsonData = [NSJSONSerialization dataWithJSONObject:parameters options:self.writingOptions error:error];</span><br><span class="line">        if (!jsonData) &#123;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        //JSONåºåˆ—åŒ–çš„æ•°æ®è®¾ç½®ä¸ºhttpbody</span><br><span class="line">        [mutableRequest setHTTPBody:jsonData];</span><br><span class="line">    &#125;</span><br><span class="line">    return mutableRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºAFPropertyListRequestSerializerä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               withParameters:(<span class="keyword">id</span>)parameters</span><br><span class="line">                                        error:(<span class="built_in">NSError</span> *__autoreleasing *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(request);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     å¯¹äº`GET`,`HEAD`,`DELETE`ç­‰æ–¹æ³•ä¸­ã€‚ç›´æ¥ä½¿ç”¨çˆ¶ç±»çš„å¤„ç†æ–¹å¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> ([<span class="keyword">self</span>.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> requestBySerializingRequest:request withParameters:parameters error:error];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [request mutableCopy];</span><br><span class="line">    <span class="comment">//æŠŠ`HTTPRequestHeaders`ä¸­çš„å€¼æ·»åŠ è¿›å…¥è¯·æ±‚å¤´ä¸­ã€‚</span></span><br><span class="line">    [<span class="keyword">self</span>.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(<span class="keyword">id</span> field, <span class="keyword">id</span> value, <span class="built_in">BOOL</span> * __unused stop) &#123;</span><br><span class="line">        <span class="keyword">if</span> (![request valueForHTTPHeaderField:field]) &#123;</span><br><span class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">if</span> (parameters) &#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®è¯·æ±‚å¤´çš„`Content-Type`ç±»å‹</span></span><br><span class="line">        <span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) &#123;</span><br><span class="line">            [mutableRequest setValue:<span class="string">@"application/x-plist"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//æŠŠparametersè½¬æ¢ä¸ºPliståºåˆ—åŒ–çš„data</span></span><br><span class="line">        <span class="built_in">NSData</span> *plistData = [<span class="built_in">NSPropertyListSerialization</span> dataWithPropertyList:parameters format:<span class="keyword">self</span>.format options:<span class="keyword">self</span>.writeOptions error:error];</span><br><span class="line">        <span class="keyword">if</span> (!plistData) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//Pliståºåˆ—åŒ–çš„æ•°æ®è®¾ç½®ä¸ºhttpbody</span></span><br><span class="line">        [mutableRequest setHTTPBody:plistData];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mutableRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;AFURLRequestSerializationåŒ…å«äº†å››ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å…¨å±€æ–¹æ³•:AFPercentEscapedStringFromStringå’ŒAFQueryStringFromParametersã€‚&lt;/li&gt;
&lt;li&gt;åè®®AFURLRequestSerializationæä¾›äº†ä¸€ä¸ªåºåˆ—åŒ–parameterså‚æ•°çš„æ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥æŠŠå‚æ•°è½¬æ¢ä¸ºæŸ¥è¯¢å­—ç¬¦ä¸²ã€HTTPè¯·æ±‚ä½“ã€è®¾ç½®æ°å½“çš„è¯·æ±‚å¤´ç­‰ã€‚&lt;/li&gt;
&lt;li&gt;AFHTTPRequestSerializerç»§æ‰¿è‡ªAFURLRequestSerializationåè®®ã€‚æä¾›äº†æŸ¥è¯¢å­—ç¬¦ä¸²/URLæ ¼å¼çš„å‚æ•°åºåˆ—åŒ–ã€é»˜è®¤è¯·æ±‚å¤´å¤„ç†ã€‚åŒæ—¶ä»¥æä¾›HTTPçŠ¶æ€ç å’Œè¿”å›æ•°æ®çš„éªŒè¯ç­‰å·¥ä½œã€‚&lt;br&gt;_ AFMultipartFormDataåè®®ã€‚ä¸»è¦ç”¨äºæ·»åŠ multipart/form-dataè¯·æ±‚çš„Content-Disposition: file; filename=#{generated filename}; name=#{name}â€ å’Œ Content-Type: #{generated mimeType}çš„è¯·æ±‚ä½“åŸŸã€‚&lt;/li&gt;
&lt;li&gt;ç±»å‹AFJSONRequestSerializerå’ŒAFPropertyListRequestSerializerã€‚ä¸»è¦é’ˆå¯¹JSONå’ŒPlistç±»å‹çš„åºåˆ—åŒ–ä¼˜åŒ–ã€‚&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://nixzhang5.github.io/categories/iOS/"/>
    
    
      <category term="AFNetWorkingåŸç†" scheme="https://nixzhang5.github.io/tags/AFNetWorking%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Appç­¾ååŸç†</title>
    <link href="https://nixzhang5.github.io/App%E7%AD%BE%E5%90%8D%E5%8E%9F%E7%90%86.html"/>
    <id>https://nixzhang5.github.io/Appç­¾ååŸç†.html</id>
    <published>2019-06-26T03:29:11.000Z</published>
    <updated>2019-06-27T03:24:35.971Z</updated>
    
    <content type="html"><![CDATA[<p>Appç­¾åæ˜¯ä¸ºäº†ä¿è¯æ¯ä¸ªAppéƒ½æ˜¯ç»è¿‡è‹¹æœå…¬å¸å®˜æ–¹è®¤è¯çš„ã€‚iPhoneå’Œç³»ç»Ÿéƒ½æ˜¯è‹¹æœå…¬å¸ç”Ÿäº§çš„ï¼Œæ‰€ä»¥è‹¹æœå…¬å¸å¯ä»¥åœ¨æ‰‹æœºä¸Šå†…ç½®å…¬é’¥ï¼ŒApp Storeä¸Šå†…ç½®ç§é’¥ã€‚</p><a id="more"></a><p>è‹¹æœç­¾åéœ€æ±‚ï¼š</p><ul><li>ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œæ‰€æœ‰iPhoneä¸Šå®‰è£…çš„åº”ç”¨å¿…é¡»æ˜¯ç»è¿‡è‹¹æœæˆæƒçš„</li><li>å®‰è£…åŒ…ä¸éœ€è¦ä¸Šä¼ åˆ°App Storeä¹Ÿèƒ½è¢«å®‰è£… ï¼ˆå¼€å‘è°ƒè¯• ä¼ä¸šç°åº¦ï¼‰</li><li>é˜²æ­¢è¯ä¹¦æƒé™æ»¥ç”¨ï¼šè®¾å¤‡é™åˆ¶ã€æŒ‡å®šAPPã€iCloud/PUSH/åå°è¿è¡Œç­‰é™„åŠ æƒé™æ§åˆ¶</li></ul><h3 id="ä¸‹è½½Appç­¾å"><a href="#ä¸‹è½½Appç­¾å" class="headerlink" title="ä¸‹è½½Appç­¾å"></a>ä¸‹è½½Appç­¾å</h3><p>ç­¾ååŸç†ï¼š</p><ol><li>Appä¸Šä¼ åˆ°App Storeæ—¶ï¼Œè‹¹æœå…¬å¸æ‹¿åˆ°Appçš„HASH(MD5,SHAç­‰)å€¼ï¼Œç„¶åç”¨ç§é’¥è¿›è¡ŒåŠ å¯†(ç­¾å)ï¼Œè¿™æ—¶å€™åªæœ‰æ‰‹æœºä¸Šçš„å…¬é’¥æ‰å¯ä»¥è§£å¯†ï¼›</li><li>æ‰‹æœºä¸‹è½½åº”ç”¨å®‰è£…Appæ—¶ï¼Œå…ˆç”¨å…¬é’¥è§£å¯†(éªŒè¯ç­¾å)ï¼Œæ‹¿åˆ°HASHå€¼ï¼Œç„¶åå°†æ­¤HASHå€¼ï¼Œä¸è¦å®‰è£…çš„Appçš„HASHå€¼è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœAppæœ‰è¢«ä¿®æ”¹è¿‡ï¼Œåˆ™æ ¡éªŒå¤±è´¥ã€‚è¿™æ ·å°±å¯ä»¥æœ‰æ•ˆçš„ä¿è¯æ¯ä¸ªAppéƒ½æ˜¯ç»è¿‡è‹¹æœå…¬å¸å®˜æ–¹è®¤è¯çš„ã€‚</li></ol><h3 id="åŒå±‚ç­¾å"><a href="#åŒå±‚ç­¾å" class="headerlink" title="åŒå±‚ç­¾å"></a>åŒå±‚ç­¾å</h3><p>çœŸæœºè°ƒè¯•ï¼Œä¼ä¸šåŒ…ä¸Šé¢çš„ç­¾åæ–¹å¼å°±ä¸é€‚åˆäº†ã€‚è¿™æ—¶å€™éœ€è¦åŒå±‚ç­¾åï¼š</p><ol><li>åœ¨Macç³»ç»Ÿä¸­ç”Ÿæˆä¸€å¯¹éå¯¹ç§°åŠ å¯†ç®—æ³•çš„å…¬ç§é’¥Mï¼ˆkeychain é‡Œçš„ <code>ä»è¯ä¹¦é¢å‘æœºæ„è¯·æ±‚è¯ä¹¦</code>ï¼Œä¿å­˜çš„CertificateSigningRequestå°±åŒ…å«å…¬é’¥Mï¼Œç§é’¥ä¿å­˜åœ¨æœ¬åœ°ï¼‰ã€‚</li><li>è‹¹æœè‡ªå·±æœ‰å›ºå®šçš„ä¸€å¯¹å…¬ç§é’¥ï¼šç§é’¥Aåœ¨è‹¹æœåå°ï¼Œå…¬é’¥Aåœ¨æ¯ä¸ªiOSç³»ç»Ÿçš„æ‰‹æœºä¸­ã€‚</li><li>ç”³è¯·è¯ä¹¦ï¼ŒæŠŠCertificateSigningRequest.certSigningRequestæ–‡ä»¶ï¼ˆåŒ…å«å…¬é’¥Mï¼Œä»¥åŠä¸€äº›å¼€å‘è€…ä¿¡æ¯ï¼‰å‘é€ç»™è‹¹æœåå°ï¼Œç”¨è‹¹æœåå°çš„ç§é’¥Aå¯¹å…¬é’¥Mç­¾åï¼Œå¾—åˆ°ä¸€ä»½åŒ…å«å…¬é’¥Mä»¥åŠå…¶ç­¾åç»“æœçš„æ•°æ®å°±æ˜¯è¯ä¹¦ã€‚<ul><li>ç”Ÿæˆçš„è¯ä¹¦ä¸‹è½½ä¸‹æ¥ï¼Œkeychainä¼šæŠŠè¿™ä¸¤ä¸ªè¯ä¹¦å…³è”èµ·æ¥ï¼Œå› ä¸ºå…¬ç§é’¥æ˜¯å¯¹åº”çš„ã€‚è¿™ä¸ªç§é’¥åªæœ‰è¿™å°ç”µè„‘æœ‰ï¼Œå›¢é˜Ÿå¼€å‘éœ€è¦æŠŠè¿™ä¸ªç§é’¥å¯¼å‡º.p12ç»™å…¶ä»–Mac.</li></ul></li><li>é…ç½® AppID / æƒé™ / è®¾å¤‡ç­‰ï¼Œæœ€åä¸‹è½½ Provisioning Profile æ–‡ä»¶ï¼ˆåŒ…å«è®¾å¤‡IDs,AppID,Entitlements(æƒåŠ›æ–‡ä»¶åŒ…å«æ˜¯å¦å¯è°ƒè¯•ï¼Œæ¨é€ï¼Œåå°è¿è¡Œç­‰ä¿¡æ¯)ï¼‰ã€‚</li><li>XCode ä¼šé€šè¿‡ç¬¬3æ­¥ä¸‹è½½å›æ¥çš„è¯ä¹¦ï¼ˆå­˜ç€å…¬é’¥ï¼‰ï¼Œåœ¨æœ¬åœ°æ‰¾åˆ°å¯¹åº”çš„ç§é’¥ï¼ˆç¬¬1æ­¥ç”Ÿæˆçš„ï¼‰ï¼Œç”¨æœ¬åœ°ç§é’¥å»ç­¾å Appï¼Œå¹¶æŠŠ Provisioning Profile æ–‡ä»¶å‘½åä¸º embedded.mobileprovision ä¸€èµ·æ‰“åŒ…è¿›å»ã€‚<ul><li>æ‰“åŒ…è¿‡ç¨‹ç”¨ç§é’¥Må¯¹Appçš„HASHå€¼è¿›è¡ŒåŠ å¯†(ç­¾å)ï¼Œè¿™æ—¶çš„APPå†…éƒ¨å®é™…åŒ…å«äº†APPçš„ç­¾å(ç§é’¥MåŠ å¯†Appçš„HASHå€¼)ã€ç¬¬3æ­¥ç”Ÿæˆçš„è¯ä¹¦æ–‡ä»¶(åŒ…å«å…¬é’¥Må’Œå…¬é’¥Mçš„HASHå€¼)ã€Provision Profile(æè¿°æ–‡ä»¶)ï¼ŒAppå¯æ‰§è¡Œæ–‡ä»¶ä»¥åŠå…¶ä»–ä¿¡æ¯</li></ul></li><li>è§£å¯†ï¼š<ol><li>iPhoneæ‰‹æœºæ‹¿åˆ°è¯ä¹¦æ–‡ä»¶(åŒ…å«å…¬é’¥Må’Œå…¬é’¥Mçš„HASHå€¼)ï¼Œå› ä¸ºæ‰‹æœºé‡Œæœ‰å…¬é’¥Aï¼Œæ‰€ä»¥èƒ½è§£å¯†è¯ä¹¦æ–‡ä»¶ï¼Œå¾—åˆ°å…¬é’¥Må’Œå…¬é’¥Mçš„HASHå€¼ï¼Œå…ˆéªŒè¯å…¬é’¥Mç”Ÿæˆçš„HASHå€¼(MD5,SHAç­‰)æ˜¯ä¸æ˜¯å’Œè¯ä¹¦æ–‡ä»¶é‡Œçš„å…¬é’¥Mçš„HASHå€¼ä¸€è‡´ï¼Œç¡®ä¿è¯ä¹¦æ²¡æœ‰è¢«ä¿®æ”¹ï¼›</li><li>éªŒè¯ä¸€è‡´åï¼Œå°±å¯ä»¥ç”¨å…¬é’¥Mæ¥è§£å¯†ç¬¬2æ­¥çš„APPçš„ç­¾åï¼ŒåŒæ ·é“ç†å¯ä»¥éªŒè¯Appæ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚ å› ä¸ºåœ¨å¼€å‘é˜¶æ®µAppä¼šç»å¸¸ä¿®æ”¹ï¼Œæ‰€ä»¥Appå°±ç®—æ˜¯ä¿®æ”¹è¿‡ï¼Œä¹Ÿèƒ½å®‰è£…ã€‚ç¬¬4æ­¥ä¸»è¦æ˜¯éªŒè¯è¯ä¹¦æ˜¯ä¸æ˜¯è‹¹æœè®¤è¯çš„ï¼Œåªè¦è¯ä¹¦å¯¹å°±å¯ä»¥å®‰è£…è¿è¡Œã€‚</li></ol></li></ol><p>åŠ å¯†è§£å¯†ï¼š</p><ul><li>macç”µè„‘ï¼šç§é’¥Må’Œå…¬é’¥M(ç”µè„‘ç”Ÿæˆ)</li><li>è‹¹æœæœåŠ¡å™¨ï¼šç§é’¥A</li><li>iPhoneæ‰‹æœºï¼šå…¬é’¥A</li></ul><p>.ipaåŒ…å«çš„ä¿¡æ¯ï¼š</p><ol><li>èµ„æºæ–‡ä»¶ï¼Œä¾‹å¦‚å›¾ç‰‡ã€htmlã€ç­‰ç­‰ã€‚</li><li>_CodeSignature/CodeResourcesã€‚è¿™æ˜¯ä¸€ä¸ªplistæ–‡ä»¶ï¼Œå¯ç”¨æ–‡æœ¬æŸ¥çœ‹ï¼Œå…¶ä¸­çš„å†…å®¹å°±æ˜¯æ˜¯ç¨‹åºåŒ…ä¸­ï¼ˆä¸åŒ…æ‹¬Frameworksï¼‰æ‰€æœ‰æ–‡ä»¶çš„ç­¾åã€‚æ³¨æ„è¿™é‡Œæ˜¯æ‰€æœ‰æ–‡ä»¶ã€‚æ„å‘³ç€ä½ çš„ç¨‹åºä¸€æ—¦ç­¾åï¼Œå°±ä¸èƒ½æ›´æ”¹å…¶ä¸­ä»»ä½•çš„ä¸œè¥¿ï¼ŒåŒ…æ‹¬èµ„æºæ–‡ä»¶å’Œå¯æ‰§è¡Œæ–‡ä»¶æœ¬èº«ã€‚iOSç³»ç»Ÿä¼šæ£€æŸ¥è¿™äº›ç­¾åã€‚</li><li>å¯æ‰§è¡Œæ–‡ä»¶ã€‚æ­¤æ–‡ä»¶è·Ÿèµ„æºæ–‡ä»¶ä¸€æ ·éœ€è¦ç­¾åã€‚</li><li>ä¸€ä¸ªmobileprovisionæ–‡ä»¶.æ‰“åŒ…çš„æ—¶å€™ä½¿ç”¨çš„ï¼Œä»MCä¸Šç”Ÿæˆçš„ã€‚</li><li>Frameworksã€‚ç¨‹åºå¼•ç”¨çš„éç³»ç»Ÿè‡ªå¸¦çš„Frameworksï¼Œæ¯ä¸ªFrameworkså…¶å®å°±æ˜¯ä¸€ä¸ªappï¼Œå…¶ä¸­çš„ç»“æ„åº”è¯¥å’Œappå·®ä¸å¤šï¼Œä¹ŸåŒ…å«ç­¾åä¿¡æ¯CodeResourcesæ–‡ä»¶ã€‚</li></ol><h3 id="ç­¾ååŸç†å›¾ï¼š"><a href="#ç­¾ååŸç†å›¾ï¼š" class="headerlink" title="ç­¾ååŸç†å›¾ï¼š"></a>ç­¾ååŸç†å›¾ï¼š</h3><figure class="image-bubble">                <div class="img-lightbox">                    <div class="overlay"></div>                    <img src="//nixzhang5.github.io/sign.png" alt="ç­¾ååŸç†å›¾" title>                </div>                <div class="image-caption">ç­¾ååŸç†å›¾</div>            </figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Appç­¾åæ˜¯ä¸ºäº†ä¿è¯æ¯ä¸ªAppéƒ½æ˜¯ç»è¿‡è‹¹æœå…¬å¸å®˜æ–¹è®¤è¯çš„ã€‚iPhoneå’Œç³»ç»Ÿéƒ½æ˜¯è‹¹æœå…¬å¸ç”Ÿäº§çš„ï¼Œæ‰€ä»¥è‹¹æœå…¬å¸å¯ä»¥åœ¨æ‰‹æœºä¸Šå†…ç½®å…¬é’¥ï¼ŒApp Storeä¸Šå†…ç½®ç§é’¥ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://nixzhang5.github.io/categories/iOS/"/>
    
    
      <category term="Encryption" scheme="https://nixzhang5.github.io/tags/Encryption/"/>
    
  </entry>
  
  <entry>
    <title>åŠ å¯†</title>
    <link href="https://nixzhang5.github.io/%E5%8A%A0%E5%AF%86.html"/>
    <id>https://nixzhang5.github.io/åŠ å¯†.html</id>
    <published>2019-06-26T02:27:44.000Z</published>
    <updated>2019-06-26T03:25:10.730Z</updated>
    
    <content type="html"><![CDATA[<p>åŠ å¯†æ˜¯ä¸ºäº†ä¿è¯æˆ‘ä»¬çš„æ•°æ®å®‰å…¨ï¼Œå³ä¸è¢«ä»–äººç¯¡æ”¹æˆ–æˆªå–åˆ°æœ‰ç”¨çš„ä¿¡æ¯çš„æ“ä½œã€‚iOSä¸€ç›´ä»¥å®‰å…¨è‘—ç§°ï¼Œä½†æ˜¯ä»Xcodeçš„Ghostäº‹ä»¶ä¹‹åï¼ŒiOSå®‰å…¨ä¸å¯æ‘§çš„ç¥è¯ä¼¼ä¹å·²ç»è¢«æ‰“ç ´ã€‚äº‹å®è¯æ˜ï¼Œæ— è®ºæ˜¯Androidè¿˜æ˜¯iOSï¼Œè¯¥åŠ å¯†å¤„ç†çš„è¿˜æ˜¯éœ€è¦åŠ å¯†å¤„ç†ï¼Œè°ä¹Ÿä¸èƒ½ä¿è¯è‡ªå·±ä¸€å®šæ˜¯å®‰å…¨çš„ã€‚</p><a id="more"></a><h3 id="å¯¹ç§°åŠ å¯†"><a href="#å¯¹ç§°åŠ å¯†" class="headerlink" title="å¯¹ç§°åŠ å¯†"></a>å¯¹ç§°åŠ å¯†</h3><p>Aä¸ B ä¹‹é—´ä¹‹é—´çš„é€šè®¯æ•°æ®éƒ½ç”¨åŒä¸€å¥—çš„å¯†é’¥æ¥è¿›è¡ŒåŠ å¯†è§£å¯†ã€‚</p><ul><li>ä¼˜ç‚¹<br>ç®€å•å¿«æ·ï¼Œå¯†é’¥è¾ƒçŸ­ï¼Œä¸”ç ´è¯‘å›°éš¾ã€‚</li><li>ç¼ºç‚¹<br>å¦‚æœç”¨æˆ·ä¸€æ—¦å¤šçš„è¯ï¼Œç®¡ç†å¯†é’¥ä¹Ÿæ˜¯ä¸€ç§å›°éš¾ã€‚ä¸æ–¹ä¾¿ç›´æ¥æ²Ÿé€šçš„ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´æ€ä¹ˆç¡®å®šå¯†é’¥ä¹Ÿéœ€è¦è€ƒè™‘ï¼Œè¿™å…¶ä¸­å°±ä¼šæœ‰å¯†é’¥æ³„éœ²çš„é£é™©ï¼Œä»¥åŠå­˜åœ¨æ›´æ¢å¯†é’¥çš„éœ€æ±‚ã€‚</li></ul><p>å¯¹ç§°åŠ å¯†é€šå¸¸æœ‰ AES, DES, IDEA, 3DES åŠ å¯†ç®—æ³•ã€‚</p><h3 id="éå¯¹ç§°åŠ å¯†"><a href="#éå¯¹ç§°åŠ å¯†" class="headerlink" title="éå¯¹ç§°åŠ å¯†"></a>éå¯¹ç§°åŠ å¯†</h3><p>ç”¨å…¬é’¥å’Œç§é’¥æ¥åŠ è§£å¯†çš„ç®—æ³•ã€‚æ‰“ä¸ªæ¯”æ–¹ï¼ŒA çš„å…¬é’¥åŠ å¯†è¿‡çš„ä¸œè¥¿åªèƒ½é€šè¿‡ A çš„ç§é’¥æ¥è§£å¯†ï¼›åŒç†ï¼ŒA çš„ç§é’¥åŠ å¯†è¿‡çš„ä¸œè¥¿åªèƒ½é€šè¿‡ A çš„å…¬é’¥æ¥è§£å¯†ã€‚é¡¾åæ€ä¹‰ï¼Œå…¬é’¥æ˜¯å…¬å¼€çš„ï¼Œåˆ«äººå¯ä»¥è·å–çš„åˆ°ï¼›ç§é’¥æ˜¯ç§æœ‰çš„ï¼Œåªèƒ½è‡ªå·±æ‹¥æœ‰ã€‚</p><ul><li>ç¼ºç‚¹<br>åŠ è§£å¯†æ¯”å¯¹ç§°åŠ å¯†è€—æ—¶.</li><li>ä¼˜ç‚¹<br>æ¯”å¯¹ç§°åŠ å¯†å®‰å…¨.</li></ul><p>ä½†æ˜¯éå¯¹ç§°åŠ å¯†ä¹Ÿæ˜¯å­˜åœ¨æ¼æ´ï¼Œå› ä¸ºå…¬é’¥æ˜¯å…¬å¼€çš„ï¼Œå¦‚æœæœ‰ C å†’å…… B çš„èº«ä»½åˆ©ç”¨ A çš„å…¬é’¥ç»™ A å‘æ¶ˆæ¯ï¼Œè¿™æ ·å°±ä¹±å¥—äº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥å°±é‡‡ç”¨<code>éå¯¹ç§°åŠ å¯†+æ‘˜è¦ç®—æ³•+æ•°å­—ç­¾åçš„æœºåˆ¶</code>æ¥ç¡®ä¿ä¼ è¾“å®‰å…¨ã€‚</p><p>å¸¸è§çš„éå¯¹ç§°åŠ å¯†ç®—æ³•æœ‰ï¼šRSAã€ECCï¼ˆç§»åŠ¨è®¾å¤‡ç”¨ï¼‰ã€Diffie-Hellmanã€El Gamalã€DSAï¼ˆæ•°å­—ç­¾åç”¨ï¼‰</p><h3 id="Hashç®—æ³•ï¼ˆæ‘˜è¦ç®—æ³•ï¼‰"><a href="#Hashç®—æ³•ï¼ˆæ‘˜è¦ç®—æ³•ï¼‰" class="headerlink" title="Hashç®—æ³•ï¼ˆæ‘˜è¦ç®—æ³•ï¼‰"></a>Hashç®—æ³•ï¼ˆæ‘˜è¦ç®—æ³•ï¼‰</h3><p>Hashç®—æ³•çš„ç‰¹ç‚¹æ˜¯å•å‘ä¸å¯è¿˜åŸï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡hashç®—æ³•å¯¹ç›®æ ‡ä¿¡æ¯ç”Ÿæˆä¸€æ®µç‰¹å®šé•¿åº¦çš„å”¯ä¸€hashå€¼ï¼Œå´ä¸èƒ½é€šè¿‡è¿™ä¸ªhashå€¼é‡æ–°è·å¾—ç›®æ ‡ä¿¡æ¯ã€‚å› æ­¤Hashç®—æ³•å¸¸ç”¨åœ¨ä¸å¯è¿˜åŸçš„å¯†ç å­˜å‚¨ã€ä¿¡æ¯å®Œæ•´æ€§æ ¡éªŒç­‰ã€‚åªè¦æºæ•°æ®ä¸åŒï¼Œç®—æ³•å¾—åˆ°çš„æ‘˜è¦å¿…å®šä¸åŒã€‚</p><p>å¸¸è§çš„Hashç®—æ³•æœ‰MD2ã€MD4ã€MD5ã€HAVALã€SHA</p><h3 id="æ•°å­—ç­¾å"><a href="#æ•°å­—ç­¾å" class="headerlink" title="æ•°å­—ç­¾å"></a>æ•°å­—ç­¾å</h3><p>æ•°å­—ç­¾åç”¨æ¥ï¼Œä¿è¯ä¿¡æ¯ä¼ è¾“çš„å®Œæ•´æ€§ã€å‘é€è€…çš„èº«ä»½è®¤è¯ã€é˜²æ­¢äº¤æ˜“ä¸­çš„æŠµèµ–å‘ç”Ÿã€‚</p><p>æ•°å­—ç­¾åæ˜¯ Aå°†åŸå§‹æ˜æ–‡é€šè¿‡ hash ç®—æ³•å¾—åˆ°æ‘˜è¦ï¼Œè¿™ä¸ªæ‘˜è¦æ˜¯ä¸å¯é€†çš„ï¼›å°†æ˜æ–‡åŠ å¯†ï¼Œè¿åŒæ‘˜è¦ä¸€èµ·å‘é€ç»™Bï¼›Bæ¥æ”¶åˆ°åè§£å¯†ï¼Œå¾—åˆ°è¿™ä¸ªæ‘˜è¦ a å’ŒåŠ å¯†çš„æ˜æ–‡ï¼Œå†å°†åŠ å¯†æ˜æ–‡è§£å¯†å¾—åˆ°åŸå§‹æ˜æ–‡ï¼Œç„¶åé€šè¿‡åŒä¸€ hash ç®—æ³•å¾—åˆ°æ–°çš„æ‘˜è¦ bï¼Œæ¯”è¾ƒ a ä¸ b å°±å¯å¾—çŸ¥åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦è¢«æ›´æ”¹è¿‡ã€‚</p><p>å› æ­¤æ•°å­—ç­¾åèƒ½å¤ŸéªŒè¯ä¿¡æ¯çš„å®Œæ•´æ€§ã€‚å¦‚æœä¸­é€”æ•°æ®è¢«çº‚æ”¹æˆ–è€…ä¸¢å¤±ã€‚é‚£ä¹ˆå¯¹æ–¹å°±å¯ä»¥æ ¹æ®æ•°å­—ç­¾åæ¥è¾¨åˆ«æ˜¯å¦æ˜¯æ¥è‡ªå¯¹æ–¹çš„ç¬¬ä¸€æ‰‹ä¿¡æ¯æ•°æ®ã€‚</p><h3 id="å®Œæ•´çš„éå¯¹ç§°åŠ å¯†è¿‡ç¨‹"><a href="#å®Œæ•´çš„éå¯¹ç§°åŠ å¯†è¿‡ç¨‹" class="headerlink" title="å®Œæ•´çš„éå¯¹ç§°åŠ å¯†è¿‡ç¨‹"></a>å®Œæ•´çš„éå¯¹ç§°åŠ å¯†è¿‡ç¨‹</h3><p>å‡å¦‚ç°åœ¨ ä½ å‘æ”¯ä»˜å® è½¬è´¦ï¼ˆæœ¯è¯­æ•°æ®ä¿¡æ¯ï¼‰ï¼Œä¸ºäº†ä¿è¯ä¿¡æ¯ä¼ é€çš„ä¿å¯†æ€§ã€çœŸå®æ€§ã€å®Œæ•´æ€§å’Œä¸å¯å¦è®¤æ€§ï¼Œéœ€è¦å¯¹ä¼ é€çš„ä¿¡æ¯è¿›è¡Œæ•°å­—åŠ å¯†å’Œç­¾åï¼Œå…¶ä¼ é€è¿‡ç¨‹ä¸ºï¼š</p><ol><li>é¦–å…ˆä½ è¦ç¡®è®¤æ˜¯å¦æ˜¯æ”¯ä»˜å®çš„æ•°å­—è¯ä¹¦ï¼Œå¦‚æœç¡®è®¤ä¸ºæ”¯ä»˜å®èº«ä»½åï¼Œåˆ™å¯¹æ–¹çœŸå®å¯ä¿¡ã€‚å¯ä»¥å‘å¯¹æ–¹ä¼ é€ä¿¡æ¯ï¼Œ</li><li>ä½ å‡†å¤‡å¥½è¦ä¼ é€çš„æ•°å­—ä¿¡æ¯ï¼ˆæ˜æ–‡ï¼‰è®¡ç®—è¦è½¬çš„å¤šå°‘é’±ï¼Œå¯¹æ–¹æ”¯ä»˜å®è´¦å·ç­‰ï¼›</li><li>ä½  å¯¹æ•°å­—ä¿¡æ¯è¿›è¡Œå“ˆå¸Œè¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªä¿¡æ¯æ‘˜è¦ï¼ˆå®¢æˆ·ç«¯ä¸»è¦èŒè´£ï¼‰ï¼›</li><li>ä½  ç”¨è‡ªå·±çš„ç§é’¥å¯¹ä¿¡æ¯æ‘˜è¦è¿›è¡ŒåŠ å¯†å¾—åˆ° ä½  çš„æ•°å­—ç­¾åï¼Œå¹¶å°†å…¶é™„åœ¨æ•°å­—ä¿¡æ¯ä¸Šï¼›</li><li>ä½  éšæœºäº§ç”Ÿä¸€ä¸ªåŠ å¯†å¯†é’¥ï¼Œå¹¶ç”¨æ­¤å¯†ç å¯¹è¦å‘é€çš„ä¿¡æ¯è¿›è¡ŒåŠ å¯†ï¼ˆå¯†æ–‡ï¼‰ï¼›</li><li>ä½ ç”¨ æ”¯ä»˜å®çš„å…¬é’¥å¯¹åˆšæ‰éšæœºäº§ç”Ÿçš„åŠ å¯†å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œå°†åŠ å¯†åçš„ DES å¯†é’¥è¿åŒå¯†æ–‡ä¸€èµ·ä¼ é€ç»™æ”¯ä»˜å®ï¼›</li><li>æ”¯ä»˜å®æ”¶åˆ° ä½  ä¼ é€æ¥çš„å¯†æ–‡å’ŒåŠ å¯†è¿‡çš„ DES å¯†é’¥ï¼Œå…ˆç”¨è‡ªå·±çš„ç§é’¥å¯¹åŠ å¯†çš„ DES å¯†é’¥è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ° ä½ éšæœºäº§ç”Ÿçš„åŠ å¯†å¯†é’¥ï¼›</li><li>æ”¯ä»˜å® ç„¶åç”¨éšæœºå¯†é’¥å¯¹æ”¶åˆ°çš„å¯†æ–‡è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°æ˜æ–‡çš„æ•°å­—ä¿¡æ¯ï¼Œç„¶åå°†éšæœºå¯†é’¥æŠ›å¼ƒï¼›</li><li>æ”¯ä»˜å® ç”¨ä½  çš„å…¬é’¥å¯¹ ä½ çš„çš„æ•°å­—ç­¾åè¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°ä¿¡æ¯æ‘˜è¦ï¼›</li><li>æ”¯ä»˜å®ç”¨ç›¸åŒçš„å“ˆå¸Œç®—æ³•å¯¹æ”¶åˆ°çš„æ˜æ–‡å†è¿›è¡Œä¸€æ¬¡å“ˆå¸Œè¿ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ä¿¡æ¯æ‘˜è¦ï¼›</li><li>æ”¯ä»˜å®å°†æ”¶åˆ°çš„ä¿¡æ¯æ‘˜è¦å’Œæ–°äº§ç”Ÿçš„ä¿¡æ¯æ‘˜è¦è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸€è‡´ï¼Œè¯´æ˜æ”¶åˆ°çš„ä¿¡æ¯æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚</li><li>ç¡®å®šæ”¶åˆ°ä¿¡æ¯ï¼Œç„¶åè¿›è¡Œå‘å¯¹æ–¹è¿›è¡Œä»˜æ¬¾äº¤æ˜“ï¼Œä¸€æ¬¡éå¯¹ç§°å¯†è¿‡ç¨‹ç»“æŸã€‚åœ¨è¿™åé¢çš„æµç¨‹å°±ä¸å±äºæœ¬æ¬¡éå¯¹ç§°åŠ å¯†çš„èŒƒç•´ï¼Œç®—æ”¯ä»˜å®ä¸ªäººçš„è‡ªæˆ‘æµç¨‹ï¼Œä¹Ÿå°±æ˜¯å¾ªç¯ä»¥ä¸Šè¿‡ç¨‹ã€‚</li></ol><h3 id="iOSå¸¸ç”¨çš„åŠ å¯†æ–¹å¼"><a href="#iOSå¸¸ç”¨çš„åŠ å¯†æ–¹å¼" class="headerlink" title="iOSå¸¸ç”¨çš„åŠ å¯†æ–¹å¼"></a>iOSå¸¸ç”¨çš„åŠ å¯†æ–¹å¼</h3><p>Base64åŠ å¯†ã€MD5åŠ å¯†ã€AESåŠ å¯†ã€RSAåŠ å¯†</p><h4 id="Base64åŠ å¯†"><a href="#Base64åŠ å¯†" class="headerlink" title="Base64åŠ å¯†"></a>Base64åŠ å¯†</h4><p>Base64ç¼–ç çš„æ€æƒ³æ˜¯ï¼šé‡‡ç”¨64ä¸ªåŸºæœ¬çš„ASCIIç å­—ç¬¦å¯¹æ•°æ®è¿›è¡Œé‡æ–°ç¼–ç ã€‚å®ƒå°†éœ€è¦ç¼–ç çš„æ•°æ®æ‹†åˆ†æˆå­—èŠ‚æ•°ç»„ï¼Œä»¥3ä¸ªå­—èŠ‚ä¸ºä¸€ç»„ï¼ŒæŒ‰é¡ºåºæ’åˆ—24ä½æ•°æ®ï¼Œå†æŠŠè¿™24ä½æ•°æ®åˆ†æˆ4ç»„ï¼Œå³æ¯ç»„6ä½ï¼›å†åœ¨æ¯ç»„çš„çš„æœ€é«˜ä½å‰è¡¥ä¸¤ä¸ª0å‡‘è¶³ä¸€ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±æŠŠä¸€ä¸ª3å­—èŠ‚ä¸ºä¸€ç»„çš„æ•°æ®é‡æ–°ç¼–ç æˆäº†4ä¸ªå­—èŠ‚ï¼›å½“æ‰€è¦ç¼–ç çš„æ•°æ®çš„å­—èŠ‚æ•°ä¸æ˜¯3çš„æ•´å€æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åˆ†ç»„æ—¶æœ€åä¸€ç»„ä¸å¤Ÿ3ä¸ªå­—èŠ‚ï¼Œè¿™æ—¶åœ¨æœ€åä¸€ç»„å¡«å……1åˆ°2ä¸ª0å­—èŠ‚ï¼Œå¹¶åœ¨æœ€åç¼–ç å®Œæˆååœ¨ç»“å°¾æ·»åŠ 1åˆ°2ä¸ª=å·ã€‚ä¾‹å¦‚ï¼šå°†å¯¹ABCè¿›è¡ŒBase64ç¼–ç é¦–å…ˆå–ABCå¯¹åº”çš„ASCIIç å€¼ï¼ŒA : 65ã€B : 66ã€C : 67ï¼Œå†å–äºŒè¿›åˆ¶å€¼A : 01000001ã€B : 01000010ã€C : 01000011ï¼Œç„¶åæŠŠè¿™ä¸‰ä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶ç æ¥èµ·æ¥010000010100001001000011ï¼Œå†ä»¥6ä½ä¸ºå•ä½åˆ†æˆ4ä¸ªæ•°æ®å—å¹¶åœ¨æœ€é«˜ä½å¡«å……ä¸¤ä¸ª0åå½¢æˆ4ä¸ªå­—èŠ‚çš„ç¼–ç åçš„å€¼00010000ã€00010100ã€00001001ã€00000011ï¼›å†æŠŠè¿™4ä¸ªå­—èŠ‚æ•°æ®è½¬åŒ–æˆ10è¿›åˆ¶æ•°å¾—16ã€20ã€19ã€3ï¼›æœ€åæ ¹æ®Base64ç»™å‡ºçš„64ä¸ªåŸºæœ¬å­—ç¬¦è¡¨ï¼ŒæŸ¥å‡ºå¯¹åº”çš„ASCIIç å­—ç¬¦Qã€Uã€Jã€Dï¼Œè¿™é‡Œçš„å€¼å®é™…å°±æ˜¯æ•°æ®åœ¨å­—ç¬¦è¡¨ä¸­çš„ç´¢å¼•ã€‚è§£ç è¿‡ç¨‹å°±æ˜¯æŠŠ4ä¸ªå­—èŠ‚å†è¿˜åŸæˆ3ä¸ªå­—èŠ‚å†æ ¹æ®ä¸åŒçš„æ•°æ®å½¢å¼æŠŠå­—èŠ‚æ•°ç»„é‡æ–°æ•´ç†æˆæ•°æ®ã€‚æ³¨ï¼šBase64å­—ç¬¦è¡¨ï¼ŒåŒ…æ‹¬å¤§å†™A-Zå°å†™a-zæ•°å­—0-9å’Œ+ä»¥åŠ/ã€‚<br>Base64åŠ å¯†åŸåˆ™ï¼š6bitï¼ˆåŸ8bitï¼‰ä¸€ä¸ªå­—èŠ‚ï¼Œä¸è¶³çš„ä½æ•°ç”¨0è¡¥é½ï¼Œä¸¤ä¸ª0ç”¨ä¸€ä¸ª=è¡¨ç¤ºã€‚<br>Base64åŠ å¯†ç‰¹ç‚¹ï¼š</p><ul><li>æ•°æ®åŠ å¯†ä¹‹åï¼Œæ•°æ®é‡ä¼šå˜å¤§ï¼Œå˜å¤§1/3å·¦å³ã€‚</li><li>å¯è¿›è¡Œåå‘è§£å¯†ã€‚</li><li>ç¼–ç åæœ‰ä¸ªéå¸¸æ˜¾è‘—çš„ç‰¹ç‚¹ï¼Œæœ«å°¾æœ‰ä¸ª=å·ã€‚</li></ul><p>å…¶å®Base64ä¸ç®—æ˜¯åŠ å¯†ï¼Œåªæ˜¯ä¸€ç§ç¼–ç æ ¼å¼ã€‚</p><p>åœ¨iOSä¸­Base64åŠ è§£å¯†ä½¿ç”¨æ–¹æ³•ä»‹ç»ï¼ˆæœ¬ä¾‹ä½¿ç”¨ç³»ç»ŸAPIï¼Œä»…æ”¯æŒiOS7åŠä»¥åçš„ç³»ç»Ÿç‰ˆæœ¬ï¼‰</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************************Base64.mç±»å®ç°æ–‡ä»¶å†…å®¹****************************/</span></span><br><span class="line">+ (<span class="built_in">NSString</span> *)base64EncodedStringWithData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦ä¼ å…¥éœ€è¦åŠ å¯†æ•°æ®å‚æ•°</span></span><br><span class="line">    <span class="keyword">if</span> ((data == <span class="literal">nil</span>) || (data == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![data isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­è®¾å¤‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> ([[[<span class="built_in">UIDevice</span> currentDevice] systemVersion] doubleValue] &lt;= <span class="number">6.9</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä½¿ç”¨ç³»ç»Ÿçš„APIè¿›è¡ŒBase64åŠ å¯†æ“ä½œ</span></span><br><span class="line">    <span class="built_in">NSDataBase64EncodingOptions</span> options;</span><br><span class="line">    options = <span class="built_in">NSDataBase64EncodingEndLineWithLineFeed</span>;</span><br><span class="line">    <span class="keyword">return</span> [data base64EncodedStringWithOptions:options];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSData</span> *)base64DecodeDataWithString:(<span class="built_in">NSString</span> *)string</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­æ˜¯å¦ä¼ å…¥éœ€è¦åŠ å¯†æ•°æ®å‚æ•°</span></span><br><span class="line">    <span class="keyword">if</span> ((string == <span class="literal">nil</span>) || (string == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![string isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­è®¾å¤‡ç³»ç»Ÿæ˜¯å¦æ»¡è¶³æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> ([[[<span class="built_in">UIDevice</span> currentDevice] systemVersion] doubleValue] &lt;= <span class="number">6.9</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä½¿ç”¨ç³»ç»Ÿçš„APIè¿›è¡ŒBase64è§£å¯†æ“ä½œ</span></span><br><span class="line">    <span class="built_in">NSDataBase64DecodingOptions</span> options;</span><br><span class="line">    options = <span class="built_in">NSDataBase64DecodingIgnoreUnknownCharacters</span>;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="built_in">NSData</span> alloc] initWithBase64EncodedString:string options:options];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*****************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨Base64æ–‡ä»¶è¿›è¡ŒBase64åŠ å¯†å’Œè§£å¯†</span></span><br><span class="line"><span class="comment">/*********************************ä½¿ç”¨Base64ç±»*********************************/</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨Base64æ‰§è¡ŒåŠ å¯†æ“ä½œ</span></span><br><span class="line"><span class="built_in">NSString</span> *string = <span class="string">@"abcdefghijklmnopqrstuvwxyz"</span>;</span><br><span class="line"><span class="built_in">NSData</span> *data = [string dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"><span class="built_in">NSString</span> *encodeString = [Base64 base64EncodedStringWithData:data];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"encodeString : %@"</span>, encodeString);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨Base64æ‰§è¡Œè§£å¯†æ“ä½œ</span></span><br><span class="line"><span class="built_in">NSString</span> *decodeString = <span class="literal">nil</span>;</span><br><span class="line"><span class="built_in">NSData</span> *decodeData = [Base64 base64DecodeDataWithString:encodeString];</span><br><span class="line">decodeString = [[<span class="built_in">NSString</span> alloc] initWithData:decodeData</span><br><span class="line">                                     encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"decodeString : %@"</span>, decodeString);</span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br></pre></td></tr></table></figure><h4 id="MD5åŠ å¯†ï¼ˆMD5æ˜¯ä¸€ç§æ‘˜è¦ï¼Œè€ŒéåŠ å¯†ï¼Œåªæ˜¯ç»å¸¸ä¸åŠ å¯†é…åˆä½¿ç”¨ï¼‰"><a href="#MD5åŠ å¯†ï¼ˆMD5æ˜¯ä¸€ç§æ‘˜è¦ï¼Œè€ŒéåŠ å¯†ï¼Œåªæ˜¯ç»å¸¸ä¸åŠ å¯†é…åˆä½¿ç”¨ï¼‰" class="headerlink" title="MD5åŠ å¯†ï¼ˆMD5æ˜¯ä¸€ç§æ‘˜è¦ï¼Œè€ŒéåŠ å¯†ï¼Œåªæ˜¯ç»å¸¸ä¸åŠ å¯†é…åˆä½¿ç”¨ï¼‰"></a>MD5åŠ å¯†ï¼ˆMD5æ˜¯ä¸€ç§æ‘˜è¦ï¼Œè€ŒéåŠ å¯†ï¼Œåªæ˜¯ç»å¸¸ä¸åŠ å¯†é…åˆä½¿ç”¨ï¼‰</h4><p>MD5çš„å…¨ç§°æ˜¯Message-DigestAlgorithm 5ï¼ŒMessage-Digestæ³›æŒ‡å­—èŠ‚ä¸²(Message)çš„Hashå˜æ¢ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªä»»æ„é•¿åº¦çš„å­—èŠ‚ä¸²å˜æ¢æˆä¸€å®šé•¿çš„å¤§æ•´æ•°ã€‚è¯·æ³¨æ„æˆ‘ä½¿ç”¨äº†å­—èŠ‚ä¸²è€Œä¸æ˜¯å­—ç¬¦ä¸²è¿™ä¸ªè¯ï¼Œæ˜¯å› ä¸ºè¿™ç§å˜æ¢åªä¸å­—èŠ‚çš„å€¼æœ‰å…³ï¼Œä¸å­—ç¬¦é›†æˆ–ç¼–ç æ–¹å¼æ— å…³ã€‚MD5å°†ä»»æ„é•¿åº¦çš„å­—èŠ‚ä¸²å˜æ¢æˆä¸€ä¸ª128bitçš„å¤§æ•´æ•°ï¼Œå¹¶ä¸”å®ƒæ˜¯ä¸€ä¸ªä¸å¯é€†çš„å­—ç¬¦ä¸²å˜æ¢ç®—æ³•ï¼Œæ¢å¥è¯è¯´å°±æ˜¯ï¼Œå³ä½¿ä½ çœ‹åˆ°æºç¨‹åºå’Œç®—æ³•æè¿°ï¼Œä¹Ÿæ— æ³•å°†ä¸€ä¸ªMD5çš„å€¼å˜æ¢å›åŸå§‹çš„å­—ç¬¦ä¸²ï¼Œä»æ•°å­¦åŸç†ä¸Šè¯´ï¼Œæ˜¯å› ä¸ºåŸå§‹çš„å­—ç¬¦ä¸²æœ‰æ— ç©·å¤šä¸ªï¼Œè¿™æœ‰ç‚¹è±¡ä¸å­˜åœ¨åå‡½æ•°çš„æ•°å­¦å‡½æ•°ã€‚MD5çš„å…¸å‹åº”ç”¨æ˜¯å¯¹ä¸€æ®µMessage(å­—èŠ‚ä¸²)äº§ç”Ÿfingerprint(æŒ‡çº¹)ï¼Œä»¥é˜²æ­¢è¢«â€ç¯¡æ”¹â€ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä½ å°†ä¸€æ®µè¯å†™åœ¨ä¸€ä¸ªå«readme.txtæ–‡ä»¶ä¸­ï¼Œå¹¶å¯¹è¿™ä¸ªreadme.txtäº§ç”Ÿä¸€ä¸ªMD5çš„å€¼å¹¶è®°å½•åœ¨æ¡ˆï¼Œç„¶åä½ å¯ä»¥ä¼ æ’­è¿™ä¸ªæ–‡ä»¶ç»™åˆ«äººï¼Œåˆ«äººå¦‚æœä¿®æ”¹äº†æ–‡ä»¶ä¸­çš„ä»»ä½•å†…å®¹ï¼Œä½ å¯¹è¿™ä¸ªæ–‡ä»¶é‡æ–°è®¡ç®—MD5æ—¶å°±ä¼šå‘ç°ã€‚å¦‚æœå†æœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„è®¤è¯æœºæ„ï¼Œç”¨MD5è¿˜å¯ä»¥é˜²æ­¢æ–‡ä»¶ä½œè€…çš„â€æŠµèµ–â€ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„æ•°å­—ç­¾ååº”ç”¨ã€‚MD5è¿˜å¹¿æ³›ç”¨äºåŠ å¯†å’Œè§£å¯†æŠ€æœ¯ä¸Šï¼Œåœ¨å¾ˆå¤šæ“ä½œç³»ç»Ÿä¸­ï¼Œç”¨æˆ·çš„å¯†ç æ˜¯ä»¥MD5å€¼ï¼ˆæˆ–ç±»ä¼¼çš„å…¶å®ƒç®—æ³•ï¼‰çš„æ–¹å¼ä¿å­˜çš„ï¼Œç”¨æˆ·Loginçš„æ—¶å€™ï¼Œç³»ç»Ÿæ˜¯æŠŠç”¨æˆ·è¾“å…¥çš„å¯†ç è®¡ç®—æˆMD5å€¼ï¼Œç„¶åå†å»å’Œç³»ç»Ÿä¸­ä¿å­˜çš„MD5å€¼è¿›è¡Œæ¯”è¾ƒï¼Œè€Œç³»ç»Ÿå¹¶â€ä¸çŸ¥é“â€ç”¨æˆ·çš„å¯†ç æ˜¯ä»€ä¹ˆã€‚MD5åŠ å¯†å¤§ä½“éƒ½åº”ç”¨åœ¨ï¼šéªŒè¯æ•°æ®æˆ–æ–‡ä»¶ä¸€è‡´æ€§ã€æ•°å­—ç­¾åã€å®‰å…¨è®¿é—®è®¤è¯ç­‰ç­‰ã€‚å¤§æ¦‚å¯æ¯”å–»ä¸ºï¼šäººçš„æŒ‡çº¹æ¥ç†è§£ã€‚<br>æ³¨ï¼šMD5åŠ å¯†æ˜¯ä¸å¯é€†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒMD5åŠ å¯†åæ˜¯ä¸èƒ½è§£å¯†çš„ï¼Œæ‰€è°“çš„è§£å¯†åªæ˜¯ç”¨å¤§æ•°æ®çš„â€è¯•ç”¨â€ï¼Œæ¥æµ‹å‡ºç»“æœçš„ã€‚<br>MD5ç‰¹ç‚¹:</p><ul><li>å‹ç¼©æ€§ : ä»»æ„é•¿åº¦çš„æ•°æ®,ç®—å‡ºçš„MD5å€¼é•¿åº¦éƒ½æ˜¯å›ºå®šçš„ã€‚</li><li>å®¹æ˜“è®¡ç®— : ä»åŸæ•°æ®è®¡ç®—å‡ºMD5å€¼å¾ˆå®¹æ˜“ã€‚</li><li>æŠ—ä¿®æ”¹æ€§ : å¯¹åŸæ•°æ®è¿›è¡Œä»»ä½•æ”¹åŠ¨ï¼Œå“ªæ€•åªä¿®æ”¹ä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€å¾—åˆ°çš„MD5å€¼éƒ½æœ‰å¾ˆå¤§åŒºåˆ«ã€‚</li><li>å¼±æŠ—ç¢°æ’ : å·²çŸ¥åŸæ•°æ®å’Œå…¶MD5å€¼ï¼Œæƒ³æ‰¾åˆ°ä¸€ä¸ªå…·æœ‰ç›¸åŒMD5å€¼çš„æ•°æ®ï¼ˆå³ä¼ªé€ æ•°æ®ï¼‰æ˜¯éå¸¸å›°éš¾çš„ã€‚</li><li>å¼ºæŠ—ç¢°æ’ : æƒ³æ‰¾åˆ°ä¸¤ä¸ªä¸åŒæ•°æ®ï¼Œä½¿ä»–ä»¬å…·æœ‰ç›¸åŒçš„MD5å€¼ï¼Œæ˜¯éå¸¸å›°éš¾çš„ã€‚</li></ul><p>åœ¨iOSä¸­MD5åŠ å¯†å’ŒéªŒç­¾ä½¿ç”¨æ–¹æ³•ä»‹ç»</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************************MD5.mç±»å®ç°æ–‡ä»¶å†…å®¹****************************/</span></span><br><span class="line"><span class="comment">//å¯¹å­—ç¬¦ä¸²æ•°æ®è¿›è¡ŒMD5çš„ç­¾å</span></span><br><span class="line">+ (<span class="built_in">NSString</span> *)md5SignWithString:(<span class="built_in">NSString</span> *)string</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *object = [string UTF8String];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> result[CC_MD5_DIGEST_LENGTH];</span><br><span class="line">    CC_MD5(object,(CC_LONG)strlen(object),result);</span><br><span class="line">    <span class="built_in">NSMutableString</span> *hash = [<span class="built_in">NSMutableString</span> string];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; i ++) &#123;</span><br><span class="line">        [hash appendFormat:<span class="string">@"%02X"</span>, result[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [hash lowercaseString];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¯¹äºŒè¿›åˆ¶æ•°æ®è¿›è¡ŒMD5çš„ç­¾å</span></span><br><span class="line">+ (<span class="built_in">NSData</span> *)md5SignWithData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">&#123;</span><br><span class="line">    Byte byte[CC_MD5_DIGEST_LENGTH];    <span class="comment">//å®šä¹‰ä¸€ä¸ªå­—èŠ‚æ•°ç»„æ¥æ¥æ”¶ç»“æœ</span></span><br><span class="line">    CC_MD5((<span class="keyword">const</span> <span class="keyword">void</span>*)([data bytes]), (CC_LONG)[data length], byte);</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSData</span> dataWithBytes:byte length:CC_MD5_DIGEST_LENGTH];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨MD5æ–‡ä»¶è¿›è¡ŒMD5åŠ å¯†å’ŒéªŒç­¾</span></span><br><span class="line"><span class="comment">/*********************************ä½¿ç”¨MD5ç±»*********************************/</span></span><br><span class="line"><span class="comment">//ä½¿ç”¨MD5æ‰§è¡ŒåŠ å¯†æ“ä½œ</span></span><br><span class="line"><span class="built_in">NSString</span> *string2 = <span class="string">@"abcdefghijklmnopqrstuvwxyz"</span>;</span><br><span class="line"><span class="built_in">NSString</span> *encodeString2 = [MD5 md5SignWithString:string2];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"encodeString2 : %@"</span>, encodeString2);</span><br><span class="line"></span><br><span class="line"><span class="comment">//MD5ä¸ºä¸å¯é€†çš„æ“ä½œï¼Œä½¿ç”¨MD5æ‰§è¡ŒéªŒç­¾æ“ä½œ</span></span><br><span class="line"><span class="built_in">NSString</span> *verifyString2 = [MD5 md5SignWithString:string2];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"verifyString2 : %@"</span>, verifyString2);</span><br><span class="line"><span class="keyword">if</span> ([verifyString2 isEqualToString:encodeString2]) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"md5 verify sign success"</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"md5 verify sign failed"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br></pre></td></tr></table></figure><h4 id="AESåŠ å¯†ï¼ˆå¯¹ç§°åŠ å¯†çš„ä¸€ç§ï¼‰"><a href="#AESåŠ å¯†ï¼ˆå¯¹ç§°åŠ å¯†çš„ä¸€ç§ï¼‰" class="headerlink" title="AESåŠ å¯†ï¼ˆå¯¹ç§°åŠ å¯†çš„ä¸€ç§ï¼‰"></a>AESåŠ å¯†ï¼ˆå¯¹ç§°åŠ å¯†çš„ä¸€ç§ï¼‰</h4><p>é«˜çº§åŠ å¯†æ ‡å‡†Advanced Encryption Standardç®€ç§°ï¼šAESï¼Œåœ¨å¯†ç å­¦ä¸­åˆç§°RijndaelåŠ å¯†æ³•ï¼Œæ˜¯ç¾å›½è”é‚¦æ”¿åºœé‡‡ç”¨çš„ä¸€ç§åŒºå—åŠ å¯†æ ‡å‡†ã€‚å®ƒæ˜¯ä¸€ç§å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œè¿™ä¸ªæ ‡å‡†ä¹Ÿæ›¿ä»£åŸå…ˆçš„DESæ ‡å‡†ï¼Œå·²ç»è¢«å¤šæ–¹åˆ†æä¸”å¹¿ä¸ºå…¨ä¸–ç•Œæ‰€ä½¿ç”¨ã€‚AESè®¾è®¡æœ‰ä¸‰ä¸ªå¯†é’¥é•¿åº¦:128ã€192ã€256ä½ï¼Œç›¸å¯¹è€Œè¨€ï¼ŒAESçš„128å¯†é’¥æ¯”DESçš„56å¯†é’¥å¼º1021å€ã€‚AESç®—æ³•ä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢ï¼šè½®å˜åŒ–ã€åœˆæ•°å’Œå¯†é’¥æ‰©å±•ã€‚æ€»ä½“æ¥è¯´ï¼ŒAESä½œä¸ºæ–°ä¸€ä»£çš„æ•°æ®åŠ å¯†æ ‡å‡†æ±‡èšäº†å¼ºå®‰å…¨æ€§ã€é«˜æ€§èƒ½ã€é«˜æ•ˆç‡ã€æ˜“ç”¨å’Œçµæ´»ï¼Œåœ¨è½¯ä»¶åŠç¡¬ä»¶ä¸Šéƒ½èƒ½å¿«é€Ÿåœ°åŠ è§£å¯†ä¸”åªéœ€è¦å¾ˆå°‘çš„å­˜å‚¨èµ„æºç­‰ä¼˜ç‚¹ã€‚</p><p>AESåŠ è§£å¯†ç‰¹ç‚¹ï¼š</p><ul><li>AESå¼ºå®‰å…¨æ€§ã€é«˜æ€§èƒ½ã€é«˜æ•ˆç‡ã€æ˜“ç”¨å’Œçµæ´»ã€‚</li><li>åœ¨è½¯ä»¶åŠç¡¬ä»¶ä¸Šéƒ½èƒ½å¿«é€Ÿåœ°åŠ è§£å¯†ä¸”åªéœ€è¦å¾ˆå°‘çš„å­˜å‚¨èµ„æºã€‚</li></ul><p>AESåŠ å¯†éœ€è¦çš„å‚æ•°ï¼š</p><ul><li><strong>å¯†é’¥é•¿åº¦ï¼ˆKey Sizeï¼‰</strong><br>AESç®—æ³•ä¸‹ï¼Œkeyçš„é•¿åº¦æœ‰ä¸‰ç§ï¼š128ã€192å’Œ256 bitsã€‚ç”±äºå†å²åŸå› ï¼ŒJDKé»˜è®¤åªæ”¯æŒä¸å¤§äº128 bitsçš„å¯†é’¥ï¼Œè€Œ128 bitsçš„keyå·²èƒ½å¤Ÿæ»¡è¶³å•†ç”¨å®‰å…¨éœ€æ±‚ã€‚å› æ­¤æœ¬ä¾‹å…ˆä½¿ç”¨AES-128ã€‚ï¼ˆJavaä½¿ç”¨å¤§äº128 bitsçš„keyæ–¹æ³•åœ¨æ–‡æœ«æåŠï¼‰</li><li><strong>åŠ å¯†æ¨¡å¼ï¼ˆCipher Modeï¼‰</strong><br>AESå±äºå—åŠ å¯†ï¼ˆBlock Cipherï¼‰ï¼Œå—åŠ å¯†ä¸­æœ‰CBCã€ECBã€CTRã€OFBã€CFBç­‰å‡ ç§å·¥ä½œæ¨¡å¼ã€‚æœ¬ä¾‹ç»Ÿä¸€ä½¿ç”¨CBCæ¨¡å¼ã€‚</li><li><strong>å¡«å……æ–¹å¼ï¼ˆPaddingï¼‰</strong><br>ç”±äºå—åŠ å¯†åªèƒ½å¯¹ç‰¹å®šé•¿åº¦çš„æ•°æ®å—è¿›è¡ŒåŠ å¯†ï¼Œå› æ­¤CBCã€ECBæ¨¡å¼éœ€è¦åœ¨æœ€åä¸€æ•°æ®å—åŠ å¯†å‰è¿›è¡Œæ•°æ®å¡«å……ã€‚ï¼ˆCFBï¼ŒOFBå’ŒCTRæ¨¡å¼ç”±äºä¸keyè¿›è¡ŒåŠ å¯†æ“ä½œçš„æ˜¯ä¸Šä¸€å—åŠ å¯†åçš„å¯†æ–‡ï¼Œå› æ­¤ä¸éœ€è¦å¯¹æœ€åä¸€æ®µæ˜æ–‡è¿›è¡Œå¡«å……ï¼‰<br>åœ¨iOS SDKä¸­æä¾›äº†PKCS7Paddingï¼Œè€ŒJDKåˆ™æä¾›äº†PKCS5Paddingã€‚åŸåˆ™ä¸ŠPKCS5Paddingé™åˆ¶äº†å¡«å……çš„Block Sizeä¸º8 bytesï¼Œè€ŒJavaå®é™…ä¸Šå½“å—å¤§äºè¯¥å€¼æ—¶ï¼Œå…¶PKCS5Paddingä¸PKCS7Paddingæ˜¯ç›¸ç­‰çš„ï¼šæ¯éœ€è¦å¡«å……Ï‡ä¸ªå­—èŠ‚ï¼Œå¡«å……çš„å€¼å°±æ˜¯Ï‡ã€‚</li><li><strong>åˆå§‹å‘é‡ï¼ˆInitialization Vectorï¼‰</strong><br>ä½¿ç”¨é™¤ECBä»¥å¤–çš„å…¶ä»–åŠ å¯†æ¨¡å¼å‡éœ€è¦ä¼ å…¥ä¸€ä¸ªåˆå§‹å‘é‡ï¼Œå…¶å¤§å°ä¸Block Sizeç›¸ç­‰ï¼ˆAESçš„Block Sizeä¸º128 bitsï¼‰ï¼Œè€Œä¸¤ä¸ªå¹³å°çš„APIæ–‡æ¡£å‡æŒ‡æ˜å½“ä¸ä¼ å…¥åˆå§‹å‘é‡æ—¶ï¼Œç³»ç»Ÿå°†é»˜è®¤ä½¿ç”¨ä¸€ä¸ªå…¨0çš„åˆå§‹å‘é‡ã€‚<br>æœ‰äº†ä¸Šè¿°çš„åŸºç¡€ä¹‹åï¼Œå¯ä»¥å¼€å§‹åˆ†åˆ«åœ¨ä¸¤ä¸ªå¹³å°è¿›è¡Œå®ç°äº†ã€‚</li></ul><p>åœ¨iOSä¸­AESåŠ è§£å¯†çš„å®ç°ä»‹ç»</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//éœ€è¦å¯¼å…¥ï¼š#import &lt;CommonCrypto/CommonCrypto.h&gt;åº“æ‰èƒ½ä½¿ç”¨</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  AES128 + ECB + PKCS7</span></span><br><span class="line"><span class="comment"> *  @param data è¦åŠ å¯†çš„åŸå§‹æ•°æ®</span></span><br><span class="line"><span class="comment"> *  @param key  åŠ å¯† key</span></span><br><span class="line"><span class="comment"> *  @return  åŠ å¯†åæ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="built_in">NSData</span> *)encryptData:(<span class="built_in">NSData</span> *)data key:(<span class="built_in">NSData</span> *)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è§£å¯†çš„æµæ•°æ®æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> ((data == <span class="literal">nil</span>) || (data == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![data isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([data length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­è§£å¯†çš„Keyæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> ((key == <span class="literal">nil</span>) || (key == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![key isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([key length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//setup key</span></span><br><span class="line">    <span class="built_in">NSData</span> *result = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> cKey[kCCKeySizeAES128];</span><br><span class="line">    bzero(cKey, <span class="keyword">sizeof</span>(cKey));</span><br><span class="line">    [key getBytes:cKey length:kCCKeySizeAES128];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//setup output buffer</span></span><br><span class="line">    size_t bufferSize = [data length] + kCCBlockSizeAES128;</span><br><span class="line">    <span class="keyword">void</span> *buffer = malloc(bufferSize);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//do encrypt</span></span><br><span class="line">    size_t encryptedSize = <span class="number">0</span>;</span><br><span class="line">    CCCryptorStatus cryptStatus = CCCrypt(kCCEncrypt,</span><br><span class="line">                                          kCCAlgorithmAES128,</span><br><span class="line">                                          kCCOptionECBMode|kCCOptionPKCS7Padding,</span><br><span class="line">                                          cKey,</span><br><span class="line">                                          kCCKeySizeAES128,</span><br><span class="line">                                          <span class="literal">nil</span>,</span><br><span class="line">                                          [data bytes],</span><br><span class="line">                                          [data length],</span><br><span class="line">                                          buffer,</span><br><span class="line">                                          bufferSize,</span><br><span class="line">                                          &amp;encryptedSize);</span><br><span class="line">    <span class="keyword">if</span> (cryptStatus == kCCSuccess) &#123;</span><br><span class="line">        result = [<span class="built_in">NSData</span> dataWithBytesNoCopy:buffer length:encryptedSize];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        free(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  AES128 + ECB + PKCS7</span></span><br><span class="line"><span class="comment"> *  @param data è¦è§£å¯†çš„åŸå§‹æ•°æ®</span></span><br><span class="line"><span class="comment"> *  @param key  è§£å¯† key</span></span><br><span class="line"><span class="comment"> *  @return  è§£å¯†åæ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="built_in">NSData</span> *)decryptData:(<span class="built_in">NSData</span> *)data key:(<span class="built_in">NSData</span> *)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è§£å¯†çš„æµæ•°æ®æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> ((data == <span class="literal">nil</span>) || (data == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![data isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([data length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­è§£å¯†çš„Keyæ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> ((key == <span class="literal">nil</span>) || (key == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![key isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([key length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//setup key</span></span><br><span class="line">    <span class="built_in">NSData</span> *result = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> cKey[kCCKeySizeAES128];</span><br><span class="line">    bzero(cKey, <span class="keyword">sizeof</span>(cKey));</span><br><span class="line">    [key getBytes:cKey length:kCCKeySizeAES128];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//setup output buffer</span></span><br><span class="line">    size_t bufferSize = [data length] + kCCBlockSizeAES128;</span><br><span class="line">    <span class="keyword">void</span> *buffer = malloc(bufferSize);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//do decrypt</span></span><br><span class="line">    size_t decryptedSize = <span class="number">0</span>;</span><br><span class="line">    CCCryptorStatus cryptStatus = CCCrypt(kCCDecrypt,</span><br><span class="line">                                          kCCAlgorithmAES128,</span><br><span class="line">                                          kCCOptionECBMode|kCCOptionPKCS7Padding,</span><br><span class="line">                                          cKey,</span><br><span class="line">                                          kCCKeySizeAES128,</span><br><span class="line">                                          <span class="literal">nil</span>,</span><br><span class="line">                                          [data bytes],</span><br><span class="line">                                          [data length],</span><br><span class="line">                                          buffer,</span><br><span class="line">                                          bufferSize,</span><br><span class="line">                                          &amp;decryptedSize);</span><br><span class="line">    <span class="keyword">if</span> (cryptStatus == kCCSuccess) &#123;</span><br><span class="line">        result = [<span class="built_in">NSData</span> dataWithBytesNoCopy:buffer length:decryptedSize];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        free(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨iOSä¸­AESåŠ è§£å¯†ä½¿ç”¨æ–¹æ³•ä»‹ç»</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨AESæ‰§è¡ŒåŠ å¯†æ“ä½œ</span></span><br><span class="line"><span class="built_in">NSString</span> *aesKey = <span class="string">@"a1b2c3d4e5f6g7h8"</span>;</span><br><span class="line"><span class="built_in">NSString</span> *string3 = <span class="string">@"abcdefghijklmnopqrstuvwxyz"</span>;</span><br><span class="line"><span class="built_in">NSData</span> *keyData3 = [aesKey dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"><span class="built_in">NSData</span> *sourceData3 = [string3 dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"><span class="built_in">NSData</span> *encodeData3 = [AESEncrypt encryptData:sourceData3 key:keyData3];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"encodeData3 : %@"</span>, encodeData3);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨AESæ‰§è¡Œè§£å¯†æ“ä½œ</span></span><br><span class="line"><span class="built_in">NSString</span> *decodeString3 = <span class="literal">nil</span>;</span><br><span class="line"><span class="built_in">NSData</span> *decodeData3 = [AESEncrypt decryptData:encodeData3</span><br><span class="line">                                          key:keyData3];</span><br><span class="line">decodeString3 = [[<span class="built_in">NSString</span> alloc] initWithData:decodeData3</span><br><span class="line">                                      encoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"decodeString3 : %@"</span>, decodeString3);</span><br></pre></td></tr></table></figure><h4 id="RSAåŠ å¯†ï¼ˆéå¯¹ç§°åŠ å¯†çš„ä¸€ç§ï¼‰"><a href="#RSAåŠ å¯†ï¼ˆéå¯¹ç§°åŠ å¯†çš„ä¸€ç§ï¼‰" class="headerlink" title="RSAåŠ å¯†ï¼ˆéå¯¹ç§°åŠ å¯†çš„ä¸€ç§ï¼‰"></a>RSAåŠ å¯†ï¼ˆéå¯¹ç§°åŠ å¯†çš„ä¸€ç§ï¼‰</h4><p>RSAæ˜¯ç›®å‰æœ€æœ‰å½±å“åŠ›çš„å…¬é’¥åŠ å¯†ç®—æ³•ï¼Œå®ƒèƒ½å¤ŸæŠµæŠ—åˆ°ç›®å‰ä¸ºæ­¢å·²çŸ¥çš„ç»å¤§å¤šæ•°å¯†ç æ”»å‡»ï¼Œå·²è¢«ISOæ¨èä¸ºå…¬é’¥æ•°æ®åŠ å¯†æ ‡å‡†ã€‚RSAçš„å…¬å¼€å¯†é’¥å¯†ç ä½“åˆ¶å°±æ˜¯ä½¿ç”¨ä¸åŒçš„åŠ å¯†å¯†é’¥ä¸è§£å¯†å¯†é’¥ï¼Œæ˜¯ä¸€ç§â€œç”±å·²çŸ¥åŠ å¯†å¯†é’¥æ¨å¯¼å‡ºè§£å¯†å¯†é’¥åœ¨è®¡ç®—ä¸Šæ˜¯ä¸å¯è¡Œçš„â€å¯†ç ä½“åˆ¶ã€‚é€šå¸¸æ˜¯å…ˆç”Ÿæˆä¸€å¯¹RSAå¯†é’¥ï¼Œå…¶ä¸­ä¹‹ä¸€æ˜¯ä¿å¯†å¯†é’¥ï¼Œç”±ç”¨æˆ·ä¿å­˜ï¼›å¦ä¸€ä¸ªä¸ºå…¬å¼€å¯†é’¥ï¼Œå¯å¯¹å¤–å…¬å¼€ï¼Œç”šè‡³å¯åœ¨ç½‘ç»œæœåŠ¡å™¨ä¸­æ³¨å†Œã€‚ä¸ºæé«˜ä¿å¯†å¼ºåº¦ï¼ŒRSAå¯†é’¥è‡³å°‘ä¸º500ä½é•¿ï¼Œä¸€èˆ¬æ¨èä½¿ç”¨1024ä½ï¼Œè¿™å°±ä½¿åŠ å¯†çš„è®¡ç®—é‡å¾ˆå¤§ã€‚ä¸ºå‡å°‘è®¡ç®—é‡ï¼Œåœ¨ä¼ é€ä¿¡æ¯æ—¶ï¼Œå¸¸é‡‡ç”¨ä¼ ç»ŸåŠ å¯†æ–¹æ³•ä¸å…¬å¼€å¯†é’¥åŠ å¯†æ–¹æ³•ç›¸ç»“åˆçš„æ–¹å¼ï¼Œå³ä¿¡æ¯é‡‡ç”¨æ”¹è¿›çš„DESæˆ–IDEAå¯¹è¯å¯†é’¥åŠ å¯†ï¼Œç„¶åä½¿ç”¨RSAå¯†é’¥åŠ å¯†å¯¹è¯å¯†é’¥å’Œä¿¡æ¯æ‘˜è¦ï¼Œå¯¹æ–¹æ”¶åˆ°ä¿¡æ¯åï¼Œç”¨ä¸åŒçš„å¯†é’¥è§£å¯†å¹¶å¯æ ¸å¯¹ä¿¡æ¯æ‘˜è¦ã€‚RSAç®—æ³•æ˜¯ç¬¬ä¸€ä¸ªèƒ½åŒæ—¶ç”¨äºåŠ å¯†å’Œæ•°å­—ç­¾åçš„ç®—æ³•ï¼Œä¹Ÿæ˜“äºç†è§£å’Œæ“ä½œï¼ŒRSAæ˜¯è¢«ç ”ç©¶å¾—æœ€å¹¿æ³›çš„å…¬é’¥ç®—æ³•ã€‚RSAç®—æ³•æ˜¯ä¸€ç§éå¯¹ç§°å¯†ç ç®—æ³•ï¼Œæ‰€è°“éå¯¹ç§°ï¼Œå°±æ˜¯æŒ‡è¯¥ç®—æ³•éœ€è¦ä¸€å¯¹å¯†é’¥ï¼Œä½¿ç”¨å…¶ä¸­ä¸€ä¸ªåŠ å¯†ï¼Œåˆ™éœ€è¦ç”¨å¦ä¸€ä¸ªæ‰èƒ½è§£å¯†ã€‚RSAåŠ å¯†å¤§ä½“éƒ½åº”ç”¨åœ¨ï¼šæœ¬åœ°æ•°æ®åŠ å¯†ã€ç½‘ç»œä¼ è¾“æ•°æ®åŠ å¯†ã€æ–¹æ³•ä½“å’Œæ–¹æ³•åé«˜çº§æ··æ·†ä»¥åŠç¨‹åºç»“æ„æ··æ’åŠ å¯†ã€‚ä¾‹å¦‚ï¼šå¯¹å®¢æˆ·ç«¯ä¼ è¾“æ•°æ®æä¾›åŠ å¯†æ–¹æ¡ˆï¼Œæœ‰æ•ˆé˜²æ­¢é€šè¿‡ç½‘ç»œæ¥å£çš„æ‹¦æˆªè·å–ã€‚</p><p>RSAçš„ç®—æ³•æ¶‰åŠä¸‰ä¸ªå‚æ•°ï¼Œnã€e1ã€e2ã€‚å…¶ä¸­ï¼Œnæ˜¯ä¸¤ä¸ªå¤§è´¨æ•°pã€qçš„ç§¯ï¼Œnçš„äºŒè¿›åˆ¶è¡¨ç¤ºæ—¶æ‰€å ç”¨çš„ä½æ•°ï¼Œå°±æ˜¯æ‰€è°“çš„å¯†é’¥é•¿åº¦ã€‚e1å’Œe2æ˜¯ä¸€å¯¹ç›¸å…³çš„å€¼ï¼Œe1å¯ä»¥ä»»æ„å–ï¼Œä½†è¦æ±‚e1ä¸(p-1)(q-1)äº’è´¨ï¼›å†é€‰æ‹©e2ï¼Œè¦æ±‚(e2e1)mod((p-1)*(q-1))=1ã€‚(nï¼Œe1)ï¼Œ(nï¼Œe2)å°±æ˜¯å¯†é’¥å¯¹ã€‚å…¶ä¸­(nï¼Œe1)ä¸ºå…¬é’¥ï¼Œ(nï¼Œe2)ä¸ºç§é’¥ï¼›RSAåŠ è§£å¯†çš„ç®—æ³•å®Œå…¨ç›¸åŒï¼Œå…¬é’¥åŠ å¯†ä½“åˆ¶ä¸­ï¼Œä¸€èˆ¬ç”¨å…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ã€‚å‡è®¾Aä¸ºæ˜æ–‡ï¼ŒBä¸ºå¯†æ–‡ï¼Œåˆ™ï¼šA=B^e2 mod nï¼›B=A^e1 mod nï¼›e1å’Œe2å¯ä»¥äº’æ¢ä½¿ç”¨ï¼Œå³ç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†ï¼Œå…¬å¼ï¼šA=B^e1 mod nï¼›B=A^e2 mod n;</p><p>RSAåŠ è§£å¯†ç‰¹ç‚¹ï¼š</p><ul><li>RSAå¯†é’¥ç®¡ç†çš„æ–¹ä¾¿ï¼Œè®¡ç®—é‡å¾ˆå¤§é€Ÿåº¦ç›¸å¯¹æ¯”è¾ƒæ…¢ã€‚</li><li>RSAå®‰å…¨æ€§å¾ˆé«˜ï¼Œèƒ½å¤ŸæŠµæŠ—åˆ°ç›®å‰ä¸ºæ­¢å·²çŸ¥çš„ç»å¤§å¤šæ•°å¯†ç æ”»å‡»ã€‚<br>åœ¨çº¿ç”ŸæˆRSAå¯†é’¥å¯¹çš„ç½‘å€ï¼šåœ¨çº¿ç”Ÿæˆéå¯¹ç§°åŠ å¯†å…¬é’¥ç§é’¥å¯¹ç­‰ï¼ŒRSAå¯†é’¥æ ¼å¼è¯·ä½¿ç”¨PKCS#8æ ¼å¼ã€‚PKCS#1ä¸PKCS#8çš„åŒºåˆ«è¿˜å¾…åç»­æŸ¥é˜…èµ„æ–™ï¼Œå†è¿›è¡Œè¡¥å……è®°å½•ã€‚</li></ul><p>åœ¨iOSä¸­RSAåŠ è§£å¯†çš„å®ç°ä»‹ç»ï¼ˆæ”¯æŒå¯†é’¥æ–‡ä»¶&lt;.pem&gt;å’Œå­—ç¬¦ä¸²å¯†é’¥ï¼‰</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/****************************RSAEncrypt.mç±»å®ç°æ–‡ä»¶å†…å®¹****************************/</span></span><br><span class="line"><span class="meta">#pragma mark - Class Utils Method</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)isEmptyKeyRef:(<span class="keyword">id</span>)object</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (object == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (object == [<span class="built_in">NSNull</span> null]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - Private Method</span></span><br><span class="line">+ (SecKeyRef)getPrivateKeyRefWithFilePath:(<span class="built_in">NSString</span> *)filePath keyPassword:(<span class="built_in">NSString</span> *)keyPassword</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è¯»å–ç§é’¥è¯ä¹¦æ–‡ä»¶çš„å†…å®¹</span></span><br><span class="line">    <span class="built_in">NSData</span> *certificateData = [<span class="built_in">NSData</span> dataWithContentsOfFile:filePath];</span><br><span class="line">    <span class="keyword">if</span> ((certificateData == <span class="literal">nil</span>) || (certificateData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![certificateData isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([certificateData length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ‹¼æ¥å¯†ç å‚æ•°åˆ°å­—å…¸ä¸­</span></span><br><span class="line">    <span class="built_in">NSString</span> *passwordKey = (__bridge <span class="keyword">id</span>)kSecImportExportPassphrase;</span><br><span class="line">    <span class="built_in">NSString</span> *passwordValue = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,keyPassword];</span><br><span class="line">    <span class="keyword">if</span> ((keyPassword == <span class="literal">nil</span>) || (keyPassword == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        passwordValue = <span class="string">@""</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![keyPassword isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        passwordValue = <span class="string">@""</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPassword length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        passwordValue = <span class="string">@""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *optionInfo = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</span><br><span class="line">    [optionInfo setObject:passwordValue forKey:passwordKey];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–ç§é’¥å¯¹è±¡</span></span><br><span class="line">    SecKeyRef privateKeyRef = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">CFArrayRef</span> items = <span class="built_in">CFArrayCreate</span>(<span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">CFDataRef</span> pkcs12Data = (__bridge <span class="built_in">CFDataRef</span>)certificateData;</span><br><span class="line">    <span class="built_in">CFDictionaryRef</span> options = (__bridge <span class="built_in">CFDictionaryRef</span>)optionInfo;</span><br><span class="line">    OSStatus securityStatus = SecPKCS12Import(pkcs12Data, options, &amp;items);</span><br><span class="line">    <span class="keyword">if</span> (securityStatus == noErr &amp;&amp; <span class="built_in">CFArrayGetCount</span>(items) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        SecIdentityRef identity;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">void</span> *secpkey = kSecImportItemIdentity;</span><br><span class="line">        <span class="built_in">CFDictionaryRef</span> identityDict = <span class="built_in">CFArrayGetValueAtIndex</span>(items, <span class="number">0</span>);</span><br><span class="line">        identity = (SecIdentityRef)<span class="built_in">CFDictionaryGetValue</span>(identityDict,secpkey);</span><br><span class="line">        securityStatus = SecIdentityCopyPrivateKey(identity, &amp;privateKeyRef);</span><br><span class="line">        <span class="keyword">if</span> (securityStatus != noErr)</span><br><span class="line">        &#123;</span><br><span class="line">            privateKeyRef = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CFRelease</span>(items);</span><br><span class="line">    <span class="keyword">return</span> privateKeyRef;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (SecKeyRef)privateKeyRefWithPrivateKey:(<span class="built_in">NSString</span> *)privateKey</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((privateKey == <span class="literal">nil</span>) || (privateKey == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![privateKey isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([privateKey length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è§£æç§é’¥å¯¹è±¡å†…å®¹</span></span><br><span class="line">    <span class="built_in">NSString</span> *pKey = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,privateKey];</span><br><span class="line">    <span class="built_in">NSRange</span> sposition = [pKey rangeOfString:<span class="string">@"-----BEGIN RSA PRIVATE KEY-----"</span>];</span><br><span class="line">    <span class="built_in">NSRange</span> eposition = [pKey rangeOfString:<span class="string">@"-----END RSA PRIVATE KEY-----"</span>];</span><br><span class="line">    <span class="keyword">if</span> (sposition.location != <span class="built_in">NSNotFound</span> &amp;&amp; eposition.location != <span class="built_in">NSNotFound</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">NSUInteger</span> endposition = eposition.location;</span><br><span class="line">        <span class="built_in">NSUInteger</span> startposition = sposition.location + sposition.length;</span><br><span class="line">        <span class="built_in">NSRange</span> range = <span class="built_in">NSMakeRange</span>(startposition, endposition-startposition);</span><br><span class="line">        pKey = [pKey substringWithRange:range];</span><br><span class="line">    &#125;</span><br><span class="line">    pKey = [pKey stringByReplacingOccurrencesOfString:<span class="string">@"\r"</span> withString:<span class="string">@""</span>];</span><br><span class="line">    pKey = [pKey stringByReplacingOccurrencesOfString:<span class="string">@"\n"</span> withString:<span class="string">@""</span>];</span><br><span class="line">    pKey = [pKey stringByReplacingOccurrencesOfString:<span class="string">@"\t"</span> withString:<span class="string">@""</span>];</span><br><span class="line">    pKey = [pKey stringByReplacingOccurrencesOfString:<span class="string">@" "</span>  withString:<span class="string">@""</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//This will be base64 encoded, decode it.</span></span><br><span class="line">    <span class="built_in">NSData</span> *keyData = [Base64 base64DecodeDataWithString:pKey];</span><br><span class="line">    keyData = [<span class="keyword">self</span> stripPrivateKeyHeader:keyData];</span><br><span class="line">    <span class="keyword">if</span> ((keyData == <span class="literal">nil</span>) || (keyData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![keyData isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyData length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//a tag to read/write keychain storage</span></span><br><span class="line">    <span class="built_in">NSString</span> *tag = <span class="string">@"RSAUtil_PrivKey"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *bytes = [tag UTF8String];</span><br><span class="line">    <span class="built_in">NSData</span> *tagData = [<span class="built_in">NSData</span> dataWithBytes:bytes length:[tag length]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Delete any old lingering key with the same tag</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *attributes = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</span><br><span class="line">    [attributes setObject:(__bridge <span class="keyword">id</span>)kSecClassKey</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecClass];</span><br><span class="line">    [attributes setObject:(__bridge <span class="keyword">id</span>)kSecAttrKeyTypeRSA</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecAttrKeyType];</span><br><span class="line">    [attributes setObject:tagData</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecAttrApplicationTag];</span><br><span class="line">    SecItemDelete((__bridge <span class="built_in">CFDictionaryRef</span>)attributes);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Add persistent version of the key to system keychain</span></span><br><span class="line">    [attributes setObject:keyData forKey:(__bridge <span class="keyword">id</span>)kSecValueData];</span><br><span class="line">    [attributes setObject:(__bridge <span class="keyword">id</span>)kSecAttrKeyClassPrivate</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecAttrKeyClass];</span><br><span class="line">    [attributes setObject:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>]</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecReturnPersistentRef];</span><br><span class="line">    </span><br><span class="line">    OSStatus status = noErr;</span><br><span class="line">    <span class="built_in">CFTypeRef</span> persistKey = <span class="literal">nil</span>;</span><br><span class="line">    status = SecItemAdd((__bridge <span class="built_in">CFDictionaryRef</span>)attributes, &amp;persistKey);</span><br><span class="line">    <span class="keyword">if</span> (persistKey != <span class="literal">nil</span>) &#123;<span class="built_in">CFRelease</span>(persistKey);&#125;</span><br><span class="line">    <span class="keyword">if</span> ((status != noErr) &amp;&amp; (status != errSecDuplicateItem))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [attributes removeObjectForKey:(__bridge <span class="keyword">id</span>)kSecValueData];</span><br><span class="line">    [attributes removeObjectForKey:(__bridge <span class="keyword">id</span>)kSecReturnPersistentRef];</span><br><span class="line">    [attributes setObject:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>]</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecReturnRef];</span><br><span class="line">    [attributes setObject:(__bridge <span class="keyword">id</span>)kSecAttrKeyTypeRSA</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecAttrKeyType];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Now fetch the SecKeyRef version of the key</span></span><br><span class="line">    SecKeyRef keyRef = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">CFDictionaryRef</span> query = (__bridge <span class="built_in">CFDictionaryRef</span>)attributes;</span><br><span class="line">    status = SecItemCopyMatching(query, (<span class="built_in">CFTypeRef</span> *)&amp;keyRef);</span><br><span class="line">    <span class="keyword">if</span> (status != noErr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keyRef;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSData</span> *)stripPrivateKeyHeader:(<span class="built_in">NSData</span> *)d_key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Skip ASN.1 private key header</span></span><br><span class="line">    <span class="keyword">if</span> (d_key == <span class="literal">nil</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len = [d_key length];</span><br><span class="line">    <span class="keyword">if</span> (!len) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *c_key = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)[d_key bytes];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = <span class="number">22</span>; <span class="comment">//magic byte at offset 22</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0x04</span> != c_key[idx++]) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//calculate length of the key</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> c_len = c_key[idx++];</span><br><span class="line">    <span class="keyword">if</span> (!(c_len &amp; <span class="number">0x80</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        c_len = c_len &amp; <span class="number">0x7f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> byteCount = c_len &amp; <span class="number">0x7f</span>;</span><br><span class="line">        <span class="keyword">if</span> (byteCount + idx &gt; len) &#123;</span><br><span class="line">            <span class="comment">//rsa length field longer than buffer</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> accum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">char</span> *ptr = &amp;c_key[idx];</span><br><span class="line">        idx += byteCount;</span><br><span class="line">        <span class="keyword">while</span> (byteCount) &#123;</span><br><span class="line">            accum = (accum &lt;&lt; <span class="number">8</span>) + *ptr;</span><br><span class="line">            ptr++;</span><br><span class="line">            byteCount--;</span><br><span class="line">        &#125;</span><br><span class="line">        c_len = accum;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Now make a new NSData from this buffer</span></span><br><span class="line">    <span class="keyword">return</span> [d_key subdataWithRange:<span class="built_in">NSMakeRange</span>(idx, c_len)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (SecKeyRef)getPublicKeyRefWithFilePath:(<span class="built_in">NSString</span> *)filePath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è¯»å–å…¬é’¥è¯ä¹¦æ–‡ä»¶çš„å†…å®¹</span></span><br><span class="line">    <span class="built_in">NSData</span> *certificateData = [<span class="built_in">NSData</span> dataWithContentsOfFile:filePath];</span><br><span class="line">    <span class="keyword">if</span> ((certificateData == <span class="literal">nil</span>) || (certificateData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![certificateData isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([certificateData length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å°†å…¬é’¥è¯ä¹¦åˆ¶ä½œæˆè¯ä¹¦å¯¹è±¡</span></span><br><span class="line">    <span class="built_in">CFDataRef</span> data = (__bridge <span class="built_in">CFDataRef</span>)certificateData;</span><br><span class="line">    SecCertificateRef certificateRef = SecCertificateCreateWithData(<span class="literal">NULL</span>, data);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–å…¬é’¥å¯¹è±¡</span></span><br><span class="line">    SecTrustRef trust = <span class="literal">NULL</span>;</span><br><span class="line">    SecKeyRef publicKey = <span class="literal">NULL</span>;</span><br><span class="line">    SecPolicyRef policies = SecPolicyCreateBasicX509();</span><br><span class="line">    <span class="keyword">if</span> (![[<span class="keyword">self</span> <span class="keyword">class</span>] isEmptyKeyRef:(__bridge <span class="keyword">id</span>)(certificateRef)]</span><br><span class="line">        &amp;&amp; ![[<span class="keyword">self</span> <span class="keyword">class</span>] isEmptyKeyRef:(__bridge <span class="keyword">id</span>)(policies)])</span><br><span class="line">    &#123;</span><br><span class="line">        OSStatus status;</span><br><span class="line">        status = SecTrustCreateWithCertificates((<span class="built_in">CFTypeRef</span>)certificateRef,</span><br><span class="line">                                                policies, &amp;trust);</span><br><span class="line">        <span class="keyword">if</span> (status == noErr)</span><br><span class="line">        &#123;</span><br><span class="line">            SecTrustResultType result;</span><br><span class="line">            <span class="keyword">if</span> (SecTrustEvaluate(trust, &amp;result) == noErr)</span><br><span class="line">            &#123;</span><br><span class="line">                publicKey = SecTrustCopyPublicKey(trust);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (certificateRef != <span class="literal">NULL</span>) <span class="built_in">CFRelease</span>(certificateRef);</span><br><span class="line">    <span class="keyword">if</span> (policies != <span class="literal">NULL</span>) <span class="built_in">CFRelease</span>(policies);</span><br><span class="line">    <span class="keyword">if</span> (trust != <span class="literal">NULL</span>) <span class="built_in">CFRelease</span>(trust);</span><br><span class="line">    <span class="keyword">return</span> publicKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (SecKeyRef)publicKeyRefWithPublicKey:(<span class="built_in">NSString</span> *)publicKey</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­å‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((publicKey == <span class="literal">nil</span>) || (publicKey == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![publicKey isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([publicKey length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è§£æå…¬é’¥å¯¹è±¡å†…å®¹</span></span><br><span class="line">    <span class="built_in">NSString</span> *pKey = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,publicKey];</span><br><span class="line">    <span class="built_in">NSRange</span> sposition = [pKey rangeOfString:<span class="string">@"-----BEGIN PUBLIC KEY-----"</span>];</span><br><span class="line">    <span class="built_in">NSRange</span> eposition = [pKey rangeOfString:<span class="string">@"-----END PUBLIC KEY-----"</span>];</span><br><span class="line">    <span class="keyword">if</span> (sposition.location != <span class="built_in">NSNotFound</span> &amp;&amp; eposition.location != <span class="built_in">NSNotFound</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">NSUInteger</span> startposition = eposition.location;</span><br><span class="line">        <span class="built_in">NSUInteger</span> endposition = sposition.location + sposition.length;</span><br><span class="line">        <span class="built_in">NSRange</span> range = <span class="built_in">NSMakeRange</span>(endposition, startposition-endposition);</span><br><span class="line">        pKey = [pKey substringWithRange:range];</span><br><span class="line">    &#125;</span><br><span class="line">    pKey = [pKey stringByReplacingOccurrencesOfString:<span class="string">@"\r"</span> withString:<span class="string">@""</span>];</span><br><span class="line">    pKey = [pKey stringByReplacingOccurrencesOfString:<span class="string">@"\n"</span> withString:<span class="string">@""</span>];</span><br><span class="line">    pKey = [pKey stringByReplacingOccurrencesOfString:<span class="string">@"\t"</span> withString:<span class="string">@""</span>];</span><br><span class="line">    pKey = [pKey stringByReplacingOccurrencesOfString:<span class="string">@" "</span>  withString:<span class="string">@""</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//This will be base64 encoded, decode it.</span></span><br><span class="line">    <span class="built_in">NSData</span> *keyData = [[<span class="keyword">self</span> <span class="keyword">class</span>] base64DecodeDataWithString:pKey];</span><br><span class="line">    keyData = [<span class="keyword">self</span> stripPublicKeyHeader:keyData];</span><br><span class="line">    <span class="keyword">if</span> ((keyData == <span class="literal">nil</span>) || (keyData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![keyData isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyData length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//a tag to read/write keychain storage</span></span><br><span class="line">    <span class="built_in">NSString</span> *tag = <span class="string">@"RSAUtil_PubKey"</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *bytes = [tag UTF8String];</span><br><span class="line">    <span class="built_in">NSData</span> *tagData = [<span class="built_in">NSData</span> dataWithBytes:bytes length:[tag length]];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Delete any old lingering key with the same tag</span></span><br><span class="line">    <span class="built_in">NSMutableDictionary</span> *attributes = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</span><br><span class="line">    [attributes setObject:(__bridge <span class="keyword">id</span>)kSecClassKey</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecClass];</span><br><span class="line">    [attributes setObject:(__bridge <span class="keyword">id</span>)kSecAttrKeyTypeRSA</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecAttrKeyType];</span><br><span class="line">    [attributes setObject:tagData</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecAttrApplicationTag];</span><br><span class="line">    SecItemDelete((__bridge <span class="built_in">CFDictionaryRef</span>)attributes);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Add persistent version of the key to system keychain</span></span><br><span class="line">    [attributes setObject:keyData</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecValueData];</span><br><span class="line">    [attributes setObject:(__bridge <span class="keyword">id</span>)kSecAttrKeyClassPublic</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecAttrKeyClass];</span><br><span class="line">    [attributes setObject:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>]</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecReturnPersistentRef];</span><br><span class="line">    </span><br><span class="line">    OSStatus status = noErr;</span><br><span class="line">    <span class="built_in">CFTypeRef</span> persistKey = <span class="literal">nil</span>;</span><br><span class="line">    status = SecItemAdd((__bridge <span class="built_in">CFDictionaryRef</span>)attributes, &amp;persistKey);</span><br><span class="line">    <span class="keyword">if</span> (persistKey != <span class="literal">nil</span>) <span class="built_in">CFRelease</span>(persistKey);</span><br><span class="line">    <span class="keyword">if</span> ((status != noErr) &amp;&amp; (status != errSecDuplicateItem))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    [attributes removeObjectForKey:(__bridge <span class="keyword">id</span>)kSecValueData];</span><br><span class="line">    [attributes removeObjectForKey:(__bridge <span class="keyword">id</span>)kSecReturnPersistentRef];</span><br><span class="line">    [attributes setObject:[<span class="built_in">NSNumber</span> numberWithBool:<span class="literal">YES</span>]</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecReturnRef];</span><br><span class="line">    [attributes setObject:(__bridge <span class="keyword">id</span>)kSecAttrKeyTypeRSA</span><br><span class="line">                   forKey:(__bridge <span class="keyword">id</span>)kSecAttrKeyType];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Now fetch the SecKeyRef version of the key</span></span><br><span class="line">    SecKeyRef publicKeyRef = <span class="literal">nil</span>;</span><br><span class="line">    <span class="built_in">CFDictionaryRef</span> query = (__bridge <span class="built_in">CFDictionaryRef</span>)attributes;</span><br><span class="line">    status = SecItemCopyMatching(query, (<span class="built_in">CFTypeRef</span> *)&amp;publicKeyRef);</span><br><span class="line">    <span class="keyword">if</span> (status != noErr)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> publicKeyRef;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSData</span> *)stripPublicKeyHeader:(<span class="built_in">NSData</span> *)d_key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Skip ASN.1 public key header</span></span><br><span class="line">    <span class="keyword">if</span> (d_key == <span class="literal">nil</span>) &#123;<span class="keyword">return</span> <span class="literal">nil</span>;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len = [d_key length];</span><br><span class="line">    <span class="keyword">if</span> (!len) <span class="keyword">return</span>(<span class="literal">nil</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *c_key = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)[d_key bytes];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (c_key[idx++] != <span class="number">0x30</span>) &#123;<span class="keyword">return</span> <span class="literal">nil</span>;&#125;</span><br><span class="line">    <span class="keyword">if</span> (c_key[idx] &gt; <span class="number">0x80</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        idx += c_key[idx] - <span class="number">0x80</span> + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        idx++;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//PKCS #1 rsaEncryption szOID_RSA_RSA</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> seqiod[] = &#123;<span class="number">0x30</span>, <span class="number">0x0d</span>, <span class="number">0x06</span>, <span class="number">0x09</span>, <span class="number">0x2a</span>,</span><br><span class="line">        <span class="number">0x86</span>, <span class="number">0x48</span>, <span class="number">0x86</span>, <span class="number">0xf7</span>, <span class="number">0x0d</span>,</span><br><span class="line">        <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x05</span>, <span class="number">0x00</span>&#125;;</span><br><span class="line">    <span class="keyword">if</span> (memcmp(&amp;c_key[idx], seqiod, <span class="number">15</span>)) &#123;<span class="keyword">return</span> <span class="literal">nil</span>;&#125;</span><br><span class="line">    idx += <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">if</span> (c_key[idx++] != <span class="number">0x03</span>) &#123;<span class="keyword">return</span> <span class="literal">nil</span>;&#125;</span><br><span class="line">    <span class="keyword">if</span> (c_key[idx] &gt; <span class="number">0x80</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        idx += c_key[idx] - <span class="number">0x80</span> + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        idx ++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c_key[idx++] != <span class="string">'\0'</span>) &#123;<span class="keyword">return</span> <span class="literal">nil</span>;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Now make a new NSData from this buffer</span></span><br><span class="line">    <span class="keyword">return</span> ([<span class="built_in">NSData</span> dataWithBytes:&amp;c_key[idx] length:len - idx]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSData</span> *)encryptData:(<span class="built_in">NSData</span> *)data withKeyRef:(SecKeyRef)keyRef</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> uint8_t *srcbuf = (<span class="keyword">const</span> uint8_t *)[data bytes];</span><br><span class="line">    size_t srclen = (size_t)data.length;</span><br><span class="line">    </span><br><span class="line">    size_t block_size = SecKeyGetBlockSize(keyRef) * <span class="keyword">sizeof</span>(uint8_t);</span><br><span class="line">    <span class="keyword">void</span> *outbuf = malloc(block_size);</span><br><span class="line">    size_t src_block_size = block_size - <span class="number">11</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableData</span> *ret = [[<span class="built_in">NSMutableData</span> alloc] init];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; srclen; idx += src_block_size)</span><br><span class="line">    &#123;</span><br><span class="line">        size_t data_len = srclen - idx;</span><br><span class="line">        <span class="keyword">if</span>(data_len &gt; src_block_size)&#123;</span><br><span class="line">            data_len = src_block_size;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        size_t outlen = block_size;</span><br><span class="line">        OSStatus status = noErr;</span><br><span class="line">        status = SecKeyEncrypt(keyRef, kSecPaddingPKCS1,</span><br><span class="line">                               srcbuf + idx, data_len,</span><br><span class="line">                               outbuf, &amp;outlen);</span><br><span class="line">        <span class="keyword">if</span> (status != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"SecKeyEncrypt fail. Error Code: %d"</span>, (<span class="keyword">int</span>)status);</span><br><span class="line">            ret = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            [ret appendBytes:outbuf length:outlen];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(outbuf);</span><br><span class="line">    <span class="built_in">CFRelease</span>(keyRef);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSData</span> *)decryptData:(<span class="built_in">NSData</span> *)data withKeyRef:(SecKeyRef)keyRef</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">const</span> uint8_t *srcbuf = (<span class="keyword">const</span> uint8_t *)[data bytes];</span><br><span class="line">    size_t srclen = (size_t)data.length;</span><br><span class="line">    </span><br><span class="line">    size_t block_size = SecKeyGetBlockSize(keyRef) * <span class="keyword">sizeof</span>(uint8_t);</span><br><span class="line">    <span class="built_in">UInt8</span> *outbuf = malloc(block_size);</span><br><span class="line">    size_t src_block_size = block_size;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableData</span> *ret = [[<span class="built_in">NSMutableData</span> alloc] init];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; srclen; idx += src_block_size)</span><br><span class="line">    &#123;</span><br><span class="line">        size_t data_len = srclen - idx;</span><br><span class="line">        <span class="keyword">if</span>(data_len &gt; src_block_size)</span><br><span class="line">        &#123;</span><br><span class="line">            data_len = src_block_size;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        size_t outlen = block_size;</span><br><span class="line">        OSStatus status = noErr;</span><br><span class="line">        status = SecKeyDecrypt(keyRef, kSecPaddingNone,</span><br><span class="line">                               srcbuf + idx, data_len,</span><br><span class="line">                               outbuf, &amp;outlen);</span><br><span class="line">        <span class="keyword">if</span> (status != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"SecKeyEncrypt fail. Error Code: %d"</span>, (<span class="keyword">int</span>)status);</span><br><span class="line">            ret = <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> idxFirstZero = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">int</span> idxNextZero = (<span class="keyword">int</span>)outlen;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; outlen; i ++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (outbuf[i] == <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (idxFirstZero &lt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        idxFirstZero = i;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        idxNextZero = i;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">NSUInteger</span> length = idxNextZero-idxFirstZero<span class="number">-1</span>;</span><br><span class="line">            [ret appendBytes:&amp;outbuf[idxFirstZero+<span class="number">1</span>] length:length];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(outbuf);</span><br><span class="line">    <span class="built_in">CFRelease</span>(keyRef);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - RSA Key File Encrypt/Decrypt Public Method</span></span><br><span class="line">+ (<span class="built_in">NSString</span> *)encryptString:(<span class="built_in">NSString</span> *)originString publicKeyPath:(<span class="built_in">NSString</span> *)publicKeyPath</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­originStringå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((originString == <span class="literal">nil</span>) || (originString == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![originString isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([originString length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­publicKeyPathå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((publicKeyPath == <span class="literal">nil</span>) || (publicKeyPath == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![publicKeyPath isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([publicKeyPath length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–å…¬é’¥å¯¹è±¡å’Œéœ€è¦åŠ å¯†çš„å­—ç¬¦ä¸²å†…å®¹ç¼–ç æ•°æ®æµ</span></span><br><span class="line">    SecKeyRef publicKeyRef = [<span class="keyword">self</span> getPublicKeyRefWithFilePath:publicKeyPath];</span><br><span class="line">    <span class="built_in">NSData</span> *originData = [originString dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">if</span> ([[<span class="keyword">self</span> <span class="keyword">class</span>] isEmptyKeyRef:(__bridge <span class="keyword">id</span>)(publicKeyRef)]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((originData == <span class="literal">nil</span>) || (originData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![originData isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([originData length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åŠ å¯†æºå­—ç¬¦ä¸²å†…å®¹ç¼–ç æ•°æ®æµçš„æ•°æ®</span></span><br><span class="line">    <span class="built_in">NSData</span> *resultData = <span class="literal">nil</span>;</span><br><span class="line">    resultData = [<span class="keyword">self</span> encryptData:originData withKeyRef:publicKeyRef];</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> <span class="keyword">class</span>] base64EncodedStringWithData:resultData];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSString</span> *)decryptString:(<span class="built_in">NSString</span> *)encryptString privateKeyPath:(<span class="built_in">NSString</span> *)privateKeyPath privateKeyPwd:(<span class="built_in">NSString</span> *)privateKeyPwd</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­encryptStringå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((encryptString == <span class="literal">nil</span>) || (encryptString == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![encryptString isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([encryptString length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­publicKeyPathå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((privateKeyPath == <span class="literal">nil</span>) || (privateKeyPath == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![privateKeyPath isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([privateKeyPath length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­å¯†ç æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="built_in">NSString</span> *keyPassword = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@"</span>,privateKeyPwd];</span><br><span class="line">    <span class="keyword">if</span> ((privateKeyPwd == <span class="literal">nil</span>) || (privateKeyPwd == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        keyPassword = <span class="string">@""</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![privateKeyPwd isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        keyPassword = <span class="string">@""</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([privateKeyPwd length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        keyPassword = <span class="string">@""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–ç§é’¥å¯¹è±¡å’Œéœ€è¦åŠ å¯†çš„å­—ç¬¦ä¸²å†…å®¹ç¼–ç æ•°æ®æµ</span></span><br><span class="line">    <span class="built_in">NSData</span> *encryptData = <span class="literal">nil</span>, *decryptData = <span class="literal">nil</span>;</span><br><span class="line">    SecKeyRef privateKeyRef = [<span class="keyword">self</span> getPrivateKeyRefWithFilePath:privateKeyPath</span><br><span class="line">                                                     keyPassword:privateKeyPwd];</span><br><span class="line">    encryptData = [[<span class="keyword">self</span> <span class="keyword">class</span>] base64DecodeDataWithString:encryptString];</span><br><span class="line">    <span class="keyword">if</span> ([[<span class="keyword">self</span> <span class="keyword">class</span>] isEmptyKeyRef:(__bridge <span class="keyword">id</span>)(privateKeyRef)]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((encryptData == <span class="literal">nil</span>) || (encryptData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![encryptData isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([encryptData length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSStringEncoding</span> encoding = <span class="built_in">NSUTF8StringEncoding</span>;</span><br><span class="line">    decryptData = [<span class="keyword">self</span> decryptData:encryptData withKeyRef:privateKeyRef];</span><br><span class="line">    <span class="keyword">return</span> [[<span class="built_in">NSString</span> alloc] initWithData:decryptData encoding:encoding];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - RSA Key String Encrypt/Decrypt Public Method</span></span><br><span class="line">+ (<span class="built_in">NSData</span> *)encryptData:(<span class="built_in">NSData</span> *)originData publicKey:(<span class="built_in">NSString</span> *)publicKey</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­originDataå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((originData == <span class="literal">nil</span>) || (originData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![originData isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([originData length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­publicKeyPathå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((publicKey == <span class="literal">nil</span>) || (publicKey == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![publicKey isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([publicKey length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–éœ€è¦åŠ å¯†çš„å­—ç¬¦ä¸²å†…å®¹ç¼–ç æ•°æ®æµ</span></span><br><span class="line">    SecKeyRef publicKeyRef = [<span class="keyword">self</span> publicKeyRefWithPublicKey:publicKey];</span><br><span class="line">    <span class="keyword">if</span>([[<span class="keyword">self</span> <span class="keyword">class</span>] isEmptyKeyRef:(__bridge <span class="keyword">id</span>)(publicKeyRef)])&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> encryptData:originData withKeyRef:publicKeyRef];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSString</span> *)encryptString:(<span class="built_in">NSString</span> *)originString publicKey:(<span class="built_in">NSString</span> *)publicKey</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­publicKeyå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((publicKey == <span class="literal">nil</span>) || (publicKey == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![publicKey isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([publicKey length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­originStringå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((originString == <span class="literal">nil</span>) || (originString == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![originString isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([originString length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–éœ€è¦åŠ å¯†çš„å­—ç¬¦ä¸²å†…å®¹ç¼–ç æ•°æ®æµ</span></span><br><span class="line">    <span class="built_in">NSData</span> *originData = <span class="literal">nil</span>, *encryptData = <span class="literal">nil</span>;</span><br><span class="line">    SecKeyRef publicKeyRef = [<span class="keyword">self</span> publicKeyRefWithPublicKey:publicKey];</span><br><span class="line">    originData = [originString dataUsingEncoding:<span class="built_in">NSUTF8StringEncoding</span>];</span><br><span class="line">    <span class="keyword">if</span>([[<span class="keyword">self</span> <span class="keyword">class</span>] isEmptyKeyRef:(__bridge <span class="keyword">id</span>)(publicKeyRef)])&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((originData == <span class="literal">nil</span>) || (originData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![originData isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([originData length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    encryptData = [<span class="keyword">self</span> encryptData:originData withKeyRef:publicKeyRef];</span><br><span class="line">    <span class="keyword">return</span> [[<span class="keyword">self</span> <span class="keyword">class</span>] base64EncodedStringWithData:encryptData];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSString</span> *)decryptString:(<span class="built_in">NSString</span> *)encryptString privateKey:(<span class="built_in">NSString</span> *)privateKey</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­publicKeyå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((privateKey == <span class="literal">nil</span>) || (privateKey == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![privateKey isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([privateKey length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//åˆ¤æ–­originStringå‚æ•°æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">    <span class="keyword">if</span> ((encryptString == <span class="literal">nil</span>) || (encryptString == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![encryptString isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([encryptString length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//è·å–ç§é’¥å¯¹è±¡å’Œéœ€è¦åŠ å¯†çš„å­—ç¬¦ä¸²å†…å®¹ç¼–ç æ•°æ®æµ</span></span><br><span class="line">    SecKeyRef privateKeyRef;</span><br><span class="line">    <span class="built_in">NSData</span> *encryptData = <span class="literal">nil</span>, *decryptData = <span class="literal">nil</span>;</span><br><span class="line">    privateKeyRef = [[<span class="keyword">self</span> <span class="keyword">class</span>] privateKeyRefWithPrivateKey:privateKey];</span><br><span class="line">    encryptData = [[<span class="keyword">self</span> <span class="keyword">class</span>] base64DecodeDataWithString:encryptString];</span><br><span class="line">    <span class="keyword">if</span> ([[<span class="keyword">self</span> <span class="keyword">class</span>] isEmptyKeyRef:(__bridge <span class="keyword">id</span>)(privateKeyRef)]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((encryptData == <span class="literal">nil</span>) || (encryptData == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (![encryptData isKindOfClass:[<span class="built_in">NSData</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([encryptData length] &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSStringEncoding</span> encoding = <span class="built_in">NSUTF8StringEncoding</span>;</span><br><span class="line">    decryptData = [<span class="keyword">self</span> decryptData:encryptData withKeyRef:privateKeyRef];</span><br><span class="line">    <span class="keyword">return</span> [[<span class="built_in">NSString</span> alloc] initWithData:decryptData encoding:encoding];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/******************************************************************************/</span></span><br></pre></td></tr></table></figure><p>åœ¨iOSä¸­RSAåŠ è§£å¯†ä½¿ç”¨æ–¹æ³•ä»‹ç»ï¼ˆRSAå¯†é’¥æ ¼å¼è¯·ä½¿ç”¨PKCS#8æ ¼å¼ï¼‰</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨RSAæ‰§è¡ŒåŠ å¯†æ“ä½œ</span></span><br><span class="line"><span class="built_in">NSString</span> *string4 = <span class="string">@"abcdefghijklmnopqrstuvwxyz"</span>;</span><br><span class="line"><span class="built_in">NSString</span> *encodeString4 = [RSAEncrypt encryptString:string4</span><br><span class="line">                                          publicKey:mPublicKey];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"encodeString4 : %@"</span>, encodeString4);</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨RSAæ‰§è¡Œè§£å¯†æ“ä½œ</span></span><br><span class="line"><span class="built_in">NSString</span> *decodeString4 = [RSAEncrypt decryptString:encodeString4</span><br><span class="line">                                         privateKey:mPrivateKey];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"decodeString4 : %@"</span>, decodeString4);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åŠ å¯†æ˜¯ä¸ºäº†ä¿è¯æˆ‘ä»¬çš„æ•°æ®å®‰å…¨ï¼Œå³ä¸è¢«ä»–äººç¯¡æ”¹æˆ–æˆªå–åˆ°æœ‰ç”¨çš„ä¿¡æ¯çš„æ“ä½œã€‚iOSä¸€ç›´ä»¥å®‰å…¨è‘—ç§°ï¼Œä½†æ˜¯ä»Xcodeçš„Ghostäº‹ä»¶ä¹‹åï¼ŒiOSå®‰å…¨ä¸å¯æ‘§çš„ç¥è¯ä¼¼ä¹å·²ç»è¢«æ‰“ç ´ã€‚äº‹å®è¯æ˜ï¼Œæ— è®ºæ˜¯Androidè¿˜æ˜¯iOSï¼Œè¯¥åŠ å¯†å¤„ç†çš„è¿˜æ˜¯éœ€è¦åŠ å¯†å¤„ç†ï¼Œè°ä¹Ÿä¸èƒ½ä¿è¯è‡ªå·±ä¸€å®šæ˜¯å®‰å…¨çš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://nixzhang5.github.io/categories/iOS/"/>
    
    
      <category term="Encryption" scheme="https://nixzhang5.github.io/tags/Encryption/"/>
    
  </entry>
  
  <entry>
    <title>AFNetWorkingåŸç†(äºŒ) AFSecurityPolicy</title>
    <link href="https://nixzhang5.github.io/AFNetWorking%E5%8E%9F%E7%90%86%E4%BA%8C.html"/>
    <id>https://nixzhang5.github.io/AFNetWorkingåŸç†äºŒ.html</id>
    <published>2019-06-25T03:31:07.000Z</published>
    <updated>2019-06-25T10:49:12.251Z</updated>
    
    <content type="html"><![CDATA[<p>AFNetWorking æ˜¯é ç€ AFSecurityPolicy è¿™ä¸ªç±»ä¿è¯æ•°æ®å®‰å…¨çš„ï¼ŒAFSecurityPolicy å…¶å®å°±æ˜¯éªŒè¯è¯ä¹¦æ˜¯å¦æ­£ç¡®çš„ã€‚</p><a id="more"></a><p>AFSecurityPolicy çš„æ ¡éªŒé€‰é¡¹ AFSSLPinningMode æœ‰ä¸‰ç§ï¼š</p><ol><li>AFSSLPinningModeNone åœ¨ä¸æœåŠ¡å™¨å»ºç«‹å®‰å…¨è¿æ¥æ—¶ï¼Œå¹¶ä¸ä¼šä½¿ç”¨åº”ç”¨ä¸­å·²æœ‰çš„è¯ä¹¦ï¼ˆä¹Ÿå¯èƒ½æœ¬å°±æ²¡æœ‰ï¼‰å¯¹æœåŠ¡å™¨ä¼ é€’çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒï¼Œæ­¤ä¸ºé»˜è®¤é€‰é¡¹</li><li>AFSSLPinningModePublicKey ä½¿ç”¨åº”ç”¨ä¸­å·²æœ‰çš„å…¬é’¥å¯¹æœåŠ¡å™¨ä¼ é€’çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒ</li><li>AFSSLPinningModeCertificate ä½¿ç”¨åº”ç”¨ä¸­å·²æœ‰çš„æ•°å­—è¯ä¹¦å¯¹æœåŠ¡å™¨ä¼ é€’çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒ</li></ol><h3 id="HTPPS"><a href="#HTPPS" class="headerlink" title="HTPPS"></a>HTPPS</h3><p>HTTPSï¼ˆå…¨ç§°ï¼šHyper Text Transfer Protocol over Secure Socket Layerï¼‰ï¼Œæ˜¯ä»¥å®‰å…¨ä¸ºç›®æ ‡çš„HTTPé€šé“ï¼Œç®€å•è®²æ˜¯HTTPçš„å®‰å…¨ç‰ˆã€‚å³HTTPä¸‹åŠ å…¥SSLå±‚ï¼ŒHTTPSçš„å®‰å…¨åŸºç¡€æ˜¯SSLï¼Œå› æ­¤åŠ å¯†çš„è¯¦ç»†å†…å®¹å°±éœ€è¦SSLã€‚ å®ƒæ˜¯ä¸€ä¸ªURI schemeï¼ˆæŠ½è±¡æ ‡è¯†ç¬¦ä½“ç³»ï¼‰ï¼Œå¥æ³•ç±»åŒhttp:ä½“ç³»ã€‚ç”¨äºå®‰å…¨çš„HTTPæ•°æ®ä¼ è¾“ã€‚https:URLè¡¨æ˜å®ƒä½¿ç”¨äº†HTTPï¼Œä½†HTTPSå­˜åœ¨ä¸åŒäºHTTPçš„é»˜è®¤ç«¯å£åŠä¸€ä¸ªåŠ å¯†/èº«ä»½éªŒè¯å±‚ï¼ˆåœ¨HTTPä¸TCPä¹‹é—´ï¼‰ã€‚è¿™ä¸ªç³»ç»Ÿçš„æœ€åˆç ”å‘ç”±ç½‘æ™¯å…¬å¸(Netscape)è¿›è¡Œï¼Œå¹¶å†…ç½®äºå…¶æµè§ˆå™¨Netscape Navigatorä¸­ï¼Œæä¾›äº†èº«ä»½éªŒè¯ä¸åŠ å¯†é€šè®¯æ–¹æ³•ã€‚</p><p>HTTPSè¿æ¥å»ºç«‹ éå¯¹ç§°åŠ å¯†ã€å¯¹ç§°åŠ å¯†ï¼š<br>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼ŒæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªè¯ä¹¦ï¼Œå®¢æˆ·ç«¯é‡Œå­˜æœ‰ï¼ˆå„ä¸ªå—ä¿¡ä»»çš„è¯ä¹¦æœºæ„ï¼‰æ ¹è¯ä¹¦ï¼Œç”¨è¿™äº›æ ¹è¯ä¹¦å¯¹<strong>æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦</strong>è¿›è¡ŒéªŒè¯ï¼Œç»éªŒè¯å¦‚æœè¯ä¹¦ï¼ˆæœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦ï¼‰æ˜¯å¯ä¿¡ä»»çš„ï¼Œå°±ç”Ÿæˆä¸€ä¸ªpre-master  secretï¼Œç”¨è¿™ä¸ªè¯ä¹¦ï¼ˆæœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦ï¼‰çš„å…¬é’¥åŠ å¯†åå‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯ç”¨ç§é’¥è§£å¯†åå¾—åˆ°pre-master secretï¼Œå†æ ¹æ®æŸç§ç®—æ³•ç”Ÿæˆmaster  secretï¼Œå®¢æˆ·ç«¯ä¹ŸåŒæ ·æ ¹æ®è¿™ç§ç®—æ³•ä»pre-master secretç”Ÿæˆmaster secretï¼ˆéå¯¹ç§°åŠ å¯†ï¼‰ï¼ŒéšååŒæ–¹çš„é€šä¿¡éƒ½ç”¨è¿™ä¸ªmaster  secretå¯¹ä¼ è¾“æ•°æ®è¿›è¡ŒåŠ å¯†è§£å¯†ï¼ˆå¯¹ç§°åŠ å¯†ï¼‰ã€‚</p><p>éå¯¹ç§°åŠ å¯†ï¼š d(c(x))=x</p><h3 id="HTTPå’ŒHTTPSåŒºåˆ«"><a href="#HTTPå’ŒHTTPSåŒºåˆ«" class="headerlink" title="HTTPå’ŒHTTPSåŒºåˆ«"></a>HTTPå’ŒHTTPSåŒºåˆ«</h3><p>è¶…æ–‡æœ¬ä¼ è¾“åè®®HTTPåè®®è¢«ç”¨äºåœ¨Webæµè§ˆå™¨å’Œç½‘ç«™æœåŠ¡å™¨ä¹‹é—´ä¼ é€’ä¿¡æ¯ã€‚HTTPåè®®ä»¥æ˜æ–‡æ–¹å¼å‘é€å†…å®¹ï¼Œä¸æä¾›ä»»ä½•æ–¹å¼çš„æ•°æ®åŠ å¯†ï¼Œå¦‚æœæ”»å‡»è€…æˆªå–äº†Webæµè§ˆå™¨å’Œç½‘ç«™æœåŠ¡å™¨ä¹‹é—´çš„ä¼ è¾“æŠ¥æ–‡ï¼Œå°±å¯ä»¥ç›´æ¥è¯»æ‡‚å…¶ä¸­çš„ä¿¡æ¯ï¼Œå› æ­¤HTTPåè®®ä¸é€‚åˆä¼ è¾“ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚ä¿¡ç”¨å¡å·ã€å¯†ç ç­‰ã€‚<br>ä¸ºäº†è§£å†³HTTPåè®®çš„è¿™ä¸€ç¼ºé™·ï¼Œéœ€è¦ä½¿ç”¨å¦ä¸€ç§åè®®ï¼šå®‰å…¨å¥—æ¥å­—å±‚è¶…æ–‡æœ¬ä¼ è¾“åè®®HTTPSã€‚ä¸ºäº†æ•°æ®ä¼ è¾“çš„å®‰å…¨ï¼ŒHTTPSåœ¨HTTPçš„åŸºç¡€ä¸ŠåŠ å…¥äº†SSLåè®®ï¼ŒSSLä¾é è¯ä¹¦æ¥éªŒè¯æœåŠ¡å™¨çš„èº«ä»½ï¼Œå¹¶ä¸ºæµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡åŠ å¯†ã€‚</p><p>HTTPSå’ŒHTTPçš„åŒºåˆ«ä¸»è¦ä¸ºä»¥ä¸‹å››ç‚¹ï¼š</p><ol><li>httpsåè®®éœ€è¦åˆ°caç”³è¯·è¯ä¹¦ï¼Œä¸€èˆ¬å…è´¹è¯ä¹¦å¾ˆå°‘ï¼Œéœ€è¦äº¤è´¹ã€‚</li><li>httpæ˜¯è¶…æ–‡æœ¬ä¼ è¾“åè®®ï¼Œä¿¡æ¯æ˜¯æ˜æ–‡ä¼ è¾“ï¼Œhttps åˆ™æ˜¯å…·æœ‰å®‰å…¨æ€§çš„sslåŠ å¯†ä¼ è¾“åè®®ã€‚</li><li>httpå’Œhttpsä½¿ç”¨çš„æ˜¯å®Œå…¨ä¸åŒçš„è¿æ¥æ–¹å¼ï¼Œç”¨çš„ç«¯å£ä¹Ÿä¸ä¸€æ ·ï¼Œå‰è€…æ˜¯80ï¼Œåè€…æ˜¯443ã€‚</li><li>httpçš„è¿æ¥å¾ˆç®€å•ï¼Œæ˜¯æ— çŠ¶æ€çš„ï¼›HTTPSåè®®æ˜¯ç”±SSL+HTTPåè®®æ„å»ºçš„å¯è¿›è¡ŒåŠ å¯†ä¼ è¾“ã€èº«ä»½è®¤è¯çš„ç½‘ç»œåè®®ï¼Œæ¯”httpåè®®å®‰å…¨ã€‚</li></ol><h3 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h3><p>SSL(Secure Sockets Layerå®‰å…¨å¥—æ¥å±‚),åŠå…¶ç»§ä»»è€…ä¼ è¾“å±‚å®‰å…¨(Transport Layer Securityï¼ŒTLS)æ˜¯ä¸ºç½‘ç»œé€šä¿¡æä¾›å®‰å…¨åŠæ•°æ®å®Œæ•´æ€§çš„ä¸€ç§å®‰å…¨åè®®ã€‚TLSä¸SSLåœ¨ä¼ è¾“å±‚å¯¹ç½‘ç»œè¿æ¥è¿›è¡ŒåŠ å¯†ã€‚</p><p>SSL (Secure Socket Layer)ä¸ºNetscapeæ‰€ç ”å‘ï¼Œç”¨ä»¥ä¿éšœåœ¨Internetä¸Šæ•°æ®ä¼ è¾“ä¹‹å®‰å…¨ï¼Œåˆ©ç”¨æ•°æ®åŠ å¯†(Encryption)æŠ€æœ¯ï¼Œå¯ç¡®ä¿æ•°æ®åœ¨ç½‘ç»œä¸Šä¹‹ä¼ è¾“è¿‡ç¨‹ä¸­ä¸ä¼šè¢«æˆªå–åŠçªƒå¬ã€‚</p><p>SSLåè®®ä½äºTCP/IPåè®®ä¸å„ç§åº”ç”¨å±‚åè®®ä¹‹é—´ï¼Œä¸ºæ•°æ®é€šè®¯æä¾›å®‰å…¨æ”¯æŒã€‚</p><p>SSLåè®®å¯åˆ†ä¸ºä¸¤å±‚ï¼š</p><ol><li>SSLè®°å½•åè®®ï¼ˆSSL Record Protocolï¼‰ï¼šå®ƒå»ºç«‹åœ¨å¯é çš„ä¼ è¾“åè®®ï¼ˆå¦‚TCPï¼‰ä¹‹ä¸Šï¼Œä¸ºé«˜å±‚åè®®æä¾›æ•°æ®å°è£…ã€å‹ç¼©ã€åŠ å¯†ç­‰åŸºæœ¬åŠŸèƒ½çš„æ”¯æŒã€‚</li><li>SSLæ¡æ‰‹åè®®ï¼ˆSSL Handshake Protocolï¼‰ï¼šå®ƒå»ºç«‹åœ¨SSLè®°å½•åè®®ä¹‹ä¸Šï¼Œç”¨äºåœ¨å®é™…çš„æ•°æ®ä¼ è¾“å¼€å§‹å‰ï¼Œé€šè®¯åŒæ–¹è¿›è¡Œèº«ä»½è®¤è¯ã€åå•†åŠ å¯†ç®—æ³•ã€äº¤æ¢åŠ å¯†å¯†é’¥ç­‰ã€‚</li></ol><p>SSLåè®®æä¾›çš„æœåŠ¡ä¸»è¦æœ‰å“ªäº›</p><ul><li>è®¤è¯ç”¨æˆ·å’ŒæœåŠ¡å™¨ï¼Œç¡®ä¿æ•°æ®å‘é€åˆ°æ­£ç¡®çš„å®¢æˆ·æœºå’ŒæœåŠ¡å™¨</li><li>åŠ å¯†æ•°æ®ä»¥é˜²æ­¢æ•°æ®ä¸­é€”è¢«çªƒå–</li><li>ç»´æŠ¤æ•°æ®çš„å®Œæ•´æ€§ï¼Œç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸è¢«æ”¹å˜ã€‚</li></ul><p>SSLåè®®çš„å·¥ä½œæµç¨‹</p><ul><li><p>æœåŠ¡å™¨è®¤è¯é˜¶æ®µï¼š<br>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€ä¸€ä¸ªå¼€å§‹ä¿¡æ¯â€œHelloâ€ä»¥ä¾¿å¼€å§‹ä¸€ä¸ªæ–°çš„ä¼šè¯è¿æ¥ï¼›<br>æœåŠ¡å™¨æ ¹æ®å®¢æˆ·çš„ä¿¡æ¯ç¡®å®šæ˜¯å¦éœ€è¦ç”Ÿæˆæ–°çš„ä¸»å¯†é’¥ï¼Œå¦‚éœ€è¦åˆ™æœåŠ¡å™¨åœ¨å“åº”å®¢æˆ·çš„â€œHelloâ€ä¿¡æ¯æ—¶å°†åŒ…å«ç”Ÿæˆä¸»å¯†é’¥æ‰€éœ€çš„ä¿¡æ¯ï¼›<br>å®¢æˆ·æ ¹æ®æ”¶åˆ°çš„æœåŠ¡å™¨å“åº”ä¿¡æ¯ï¼Œäº§ç”Ÿä¸€ä¸ªä¸»å¯†é’¥ï¼Œå¹¶ç”¨æœåŠ¡å™¨çš„å…¬å¼€å¯†é’¥åŠ å¯†åä¼ ç»™æœåŠ¡å™¨ï¼›<br>æœåŠ¡å™¨æ¢å¤è¯¥ä¸»å¯†é’¥ï¼Œå¹¶è¿”å›ç»™å®¢æˆ·ä¸€ä¸ªç”¨ä¸»å¯†é’¥è®¤è¯çš„ä¿¡æ¯ï¼Œä»¥æ­¤è®©å®¢æˆ·è®¤è¯æœåŠ¡å™¨ã€‚</p></li><li><p>ç”¨æˆ·è®¤è¯é˜¶æ®µï¼š<br>åœ¨æ­¤ä¹‹å‰ï¼ŒæœåŠ¡å™¨å·²ç»é€šè¿‡äº†å®¢æˆ·è®¤è¯ï¼Œè¿™ä¸€é˜¶æ®µä¸»è¦å®Œæˆå¯¹å®¢æˆ·çš„è®¤è¯ã€‚ç»è®¤è¯çš„æœåŠ¡å™¨å‘é€ä¸€ä¸ªæé—®ç»™å®¢æˆ·ï¼Œå®¢æˆ·åˆ™è¿”å›ï¼ˆæ•°å­—ï¼‰ç­¾ååçš„æé—®å’Œå…¶å…¬å¼€å¯†é’¥ï¼Œä»è€Œå‘æœåŠ¡å™¨æä¾›è®¤è¯ã€‚</p></li></ul><p>ä»SSL åè®®æ‰€æä¾›çš„æœåŠ¡åŠå…¶å·¥ä½œæµç¨‹å¯ä»¥çœ‹å‡ºï¼ŒSSLåè®®è¿è¡Œçš„åŸºç¡€æ˜¯å•†å®¶å¯¹æ¶ˆè´¹è€…ä¿¡æ¯ä¿å¯†çš„æ‰¿è¯ºï¼Œè¿™å°±æœ‰åˆ©äºå•†å®¶è€Œä¸åˆ©äºæ¶ˆè´¹è€…ã€‚åœ¨ç”µå­å•†åŠ¡åˆçº§é˜¶æ®µï¼Œç”±äºè¿ä½œç”µå­å•†åŠ¡çš„ä¼ä¸šå¤§å¤šæ˜¯ä¿¡èª‰è¾ƒé«˜çš„å¤§å…¬å¸ï¼Œå› æ­¤è¿™é—®é¢˜è¿˜æ²¡æœ‰å……åˆ†æš´éœ²å‡ºæ¥ã€‚ä½†éšç€ç”µå­å•†åŠ¡çš„å‘å±•ï¼Œå„ä¸­å°å‹å…¬å¸ä¹Ÿå‚ä¸è¿›æ¥ï¼Œè¿™æ ·åœ¨ç”µå­æ”¯ä»˜è¿‡ç¨‹ä¸­çš„å•ä¸€è®¤è¯é—®é¢˜å°±è¶Šæ¥è¶Šçªå‡ºã€‚è™½ç„¶åœ¨SSL3.0ä¸­é€šè¿‡æ•°å­—ç­¾åå’Œæ•°å­—è¯ä¹¦å¯å®ç°æµè§ˆå™¨å’ŒWebæœåŠ¡å™¨åŒæ–¹çš„èº«ä»½éªŒè¯ï¼Œä½†æ˜¯SSLåè®®ä»å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ï¼Œåªèƒ½æä¾›äº¤æ˜“ä¸­å®¢æˆ·ä¸æœåŠ¡å™¨é—´çš„åŒæ–¹è®¤è¯ï¼Œåœ¨æ¶‰åŠå¤šæ–¹çš„ç”µå­äº¤æ˜“ä¸­ï¼ŒSSLåè®®å¹¶ä¸èƒ½åè°ƒå„æ–¹é—´çš„å®‰å…¨ä¼ è¾“å’Œä¿¡ä»»å…³ç³»ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒVisaå’ŒMasterCardä¸¤å¤§ä¿¡ç”¨å¡å…¬ç»„ç»‡åˆ¶å®šäº†SETåè®®ï¼Œä¸ºç½‘ä¸Šä¿¡ç”¨å¡æ”¯ä»˜æä¾›äº†å…¨çƒæ€§çš„æ ‡å‡†ã€‚</p><h3 id="SSLåè®®åŠ å¯†æ–¹å¼"><a href="#SSLåè®®åŠ å¯†æ–¹å¼" class="headerlink" title="SSLåè®®åŠ å¯†æ–¹å¼"></a>SSLåè®®åŠ å¯†æ–¹å¼</h3><p>SSLåè®®å³ç”¨åˆ°äº†å¯¹ç§°åŠ å¯†ä¹Ÿç”¨åˆ°äº†éå¯¹ç§°åŠ å¯†(å…¬é’¥åŠ å¯†)ï¼Œåœ¨å»ºç«‹ä¼ è¾“é“¾è·¯æ—¶ï¼ŒSSLé¦–å…ˆå¯¹å¯¹ç§°åŠ å¯†çš„å¯†é’¥ä½¿ç”¨å…¬é’¥è¿›è¡Œéå¯¹ç§°åŠ å¯†ï¼Œé“¾è·¯å»ºç«‹å¥½ä¹‹åï¼ŒSSLå¯¹ä¼ è¾“å†…å®¹ä½¿ç”¨å¯¹ç§°åŠ å¯†ã€‚</p><ol><li><p>å¯¹ç§°åŠ å¯†<br>é€Ÿåº¦é«˜ï¼Œå¯åŠ å¯†å†…å®¹è¾ƒå¤§ï¼Œç”¨æ¥åŠ å¯†ä¼šè¯è¿‡ç¨‹ä¸­çš„æ¶ˆæ¯</p></li><li><p>å…¬é’¥åŠ å¯†<br>åŠ å¯†é€Ÿåº¦è¾ƒæ…¢ï¼Œä½†èƒ½æä¾›æ›´å¥½çš„èº«ä»½è®¤è¯æŠ€æœ¯ï¼Œç”¨æ¥åŠ å¯†å¯¹ç§°åŠ å¯†çš„å¯†é’¥</p></li></ol><h3 id="SSLè¯ä¹¦åŒ…å«çš„ä¿¡æ¯"><a href="#SSLè¯ä¹¦åŒ…å«çš„ä¿¡æ¯" class="headerlink" title="SSLè¯ä¹¦åŒ…å«çš„ä¿¡æ¯"></a>SSLè¯ä¹¦åŒ…å«çš„ä¿¡æ¯</h3><ul><li><p>è¯ä¹¦ç‰ˆæœ¬å·ï¼Œä¸åŒç‰ˆæœ¬çš„è¯ä¹¦æ ¼å¼ä¸åŒ</p></li><li><p>Serial Numberã€€åºåˆ—å·ï¼ŒåŒä¸€èº«ä»½éªŒè¯æœºæ„ç­¾å‘çš„è¯ä¹¦åºåˆ—å·å”¯ä¸€</p></li><li><p>Algorithm Identifier ã€€ç­¾åç®—æ³•ï¼ŒåŒ…æ‹¬å¿…è¦çš„å‚æ•°Issuer èº«ä»½éªŒè¯æœºæ„çš„æ ‡è¯†ä¿¡æ¯</p></li><li><p>Period of Validity ã€€æœ‰æ•ˆæœŸ</p></li><li><p>Subjectã€€è¯ä¹¦æŒæœ‰äººçš„æ ‡è¯†ä¿¡æ¯</p></li><li><p>Subjectâ€™s Public Keyã€€è¯ä¹¦æŒæœ‰äººçš„å…¬é’¥</p></li><li><p>Signatureã€€èº«ä»½éªŒè¯æœºæ„å¯¹è¯ä¹¦çš„ç­¾å</p></li><li><p>è¯ä¹¦çš„æ ¼å¼ã€€ è®¤è¯ä¸­å¿ƒæ‰€å‘æ”¾çš„è¯ä¹¦å‡éµå¾ªX.509 V3 æ ‡å‡†ï¼Œå…¶åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p></li><li><p>è¯ä¹¦ç‰ˆæœ¬å·ï¼ˆCertificate Format Versionï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šè¯ä¹¦æ ¼å¼é‡‡ç”¨çš„X.509 ç‰ˆæœ¬å·ã€‚</p></li><li><p>è¯ä¹¦åºåˆ—å·ï¼ˆCertificate Serial Numberï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šè¯ä¹¦çš„å”¯ä¸€åºåˆ—å·ï¼Œä»¥æ ‡è¯†CA å‘å‡ºçš„æ‰€æœ‰å…¬é’¥è¯ä¹¦ã€‚</p></li><li><p>ç­¾åï¼ˆSignatureï¼‰ç®—æ³•æ ‡è¯†ï¼ˆAlgorithm Identifierï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®š CA ç­¾å‘è¯ä¹¦æ‰€ç”¨çš„ç­¾åç®—æ³•ã€‚</p></li><li><p>ç­¾å‘æ­¤è¯ä¹¦çš„ CA åç§°ï¼ˆIssuer ï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šç­¾å‘è¯ä¹¦çš„ CA çš„X.500 å”¯ä¸€åç§°ï¼ˆDNï¼ŒDistinguished Nameï¼‰ã€‚</p></li><li><p>è¯ä¹¦æœ‰æ•ˆæœŸï¼ˆValidity Periodï¼‰èµ·å§‹æ—¥æœŸï¼ˆnotBeforeï¼‰ ç»ˆæ­¢æ—¥æœŸï¼ˆnotAfterï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šè¯ä¹¦èµ·å§‹æ—¥æœŸå’Œç»ˆæ­¢æ—¥æœŸã€‚</p></li><li><p>ç”¨æˆ·åç§°ï¼ˆSubjectï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šè¯ä¹¦ç”¨æˆ·çš„X.500 å”¯ä¸€åç§°ï¼ˆDNï¼ŒDistinguished Nameï¼‰ã€‚</p></li><li><p>ç”¨æˆ·å…¬é’¥ä¿¡æ¯ï¼ˆSubject Public Key Informationï¼‰ç®—æ³•ï¼ˆalgorithmï¼‰ ç®—æ³•æ ‡è¯†ï¼ˆAlgorithmã€€Identifierï¼‰ç”¨æˆ·å…¬é’¥ï¼ˆsubjectã€€Publicã€€Keyï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æ ‡è¯†å…¬é’¥ä½¿ç”¨çš„ç®—æ³•ï¼Œå¹¶åŒ…å«å…¬é’¥æœ¬èº«ã€‚</p></li><li><p>è¯ä¹¦æ‰©å……éƒ¨åˆ†ï¼ˆæ‰©å±•åŸŸï¼‰ï¼ˆExtensionsï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šé¢å¤–ä¿¡æ¯ã€‚</p></li><li><p>X.509 V3 è¯ä¹¦çš„æ‰©å……éƒ¨åˆ†ï¼ˆæ‰©å±•åŸŸï¼‰åŠå®ç°æ–¹æ³•å¦‚ä¸‹ï¼š</p></li><li><p>CA çš„å…¬é’¥æ ‡è¯†ï¼ˆAuthorityã€€Keyã€€Identifierï¼‰</p></li><li><p>å…¬é’¥æ ‡è¯†ï¼ˆSET æœªä½¿ç”¨ï¼‰ï¼ˆKeyã€€Identifierï¼‰</p></li><li><p>ç­¾å‘è¯ä¹¦è€…è¯ä¹¦çš„ç­¾å‘è€…çš„ç”„åˆ«åï¼ˆCertificateã€€Issuerï¼‰</p></li><li><p>ç­¾å‘è¯ä¹¦è€…è¯ä¹¦çš„åºåˆ—å·ï¼ˆCertificate Serial Numberï¼‰</p></li><li><p>X.509 V3 è¯ä¹¦çš„æ‰©å……éƒ¨åˆ†ï¼ˆæ‰©å±•åŸŸï¼‰åŠå®ç°CA çš„å…¬é’¥æ ‡è¯†ï¼ˆAuthorityã€€Keyã€€Identifierï¼‰</p></li><li><p>å…¬é’¥æ ‡è¯†ï¼ˆSET æœªä½¿ç”¨ï¼‰ï¼ˆKeyã€€Identifierï¼‰</p></li><li><p>ç­¾å‘è¯ä¹¦è€…è¯ä¹¦çš„ç­¾å‘è€…çš„ç”„åˆ«åï¼ˆCertificatç­¾å‘è¯ä¹¦è€…è¯ä¹¦çš„åºåˆ—å·ï¼ˆCertificate Serial Numberï¼‰<br>å«ä¹‰ï¼šCA ç­¾åè¯ä¹¦æ‰€ç”¨çš„å¯†é’¥å¯¹çš„å”¯ä¸€æ ‡è¯†ç”¨æˆ·çš„å…¬é’¥æ ‡è¯†ï¼ˆSubjectã€€Keyã€€Identifierï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æ ‡è¯†ä¸è¯ä¹¦ä¸­å…¬é’¥ç›¸å…³çš„ç‰¹å®šå¯†é’¥è¿›è¡Œè§£å¯†ã€‚</p></li><li><p>è¯ä¹¦ä¸­çš„å…¬é’¥ç”¨é€”ï¼ˆKeyã€€Usageï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šå…¬é’¥ç”¨é€”ã€‚</p></li><li><p>ç”¨æˆ·çš„ç§é’¥æœ‰æ•ˆæœŸï¼ˆPrivateã€€Keyã€€Usageã€€Periodï¼‰èµ·å§‹æ—¥æœŸï¼ˆNoteã€€Beforeï¼‰ ç»ˆæ­¢æ—¥æœŸï¼ˆNoteã€€Afterï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šç”¨æˆ·ç­¾åç§é’¥çš„èµ·å§‹æ—¥æœŸå’Œç»ˆæ­¢æ—¥æœŸã€‚</p></li><li><p>CA æ‰¿è®¤çš„è¯ä¹¦æ”¿ç­–åˆ—è¡¨ï¼ˆCertificate Policiesï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šç”¨æˆ·è¯ä¹¦æ‰€é€‚ç”¨çš„æ”¿ç­–ï¼Œè¯ä¹¦æ”¿ç­–å¯ç”±å¯¹è±¡æ ‡è¯†ç¬¦è¡¨ç¤ºã€‚</p></li><li><p>ç”¨æˆ·çš„ä»£ç”¨åï¼ˆSubstitutionalã€€Nameï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®šç”¨æˆ·çš„ä»£ç”¨åã€‚</p></li><li><p>CA çš„ä»£ç”¨åï¼ˆIssuerã€€Altã€€Nameï¼‰<br>å«ä¹‰ï¼šç”¨æ¥æŒ‡å®š CA çš„ä»£ç”¨åã€‚</p></li><li><p>åŸºæœ¬åˆ¶çº¦ï¼ˆBasicã€€Constraintsï¼‰<br>å«ä¹‰ï¼šç”¨æ¥è¡¨æ˜è¯ä¹¦ç”¨æˆ·æ˜¯æœ€ç»ˆç”¨æˆ·è¿˜æ˜¯CAã€‚ åœ¨SET ç³»ç»Ÿä¸­æœ‰ä¸€äº›ç§æœ‰æ‰©å……éƒ¨åˆ†ï¼ˆæ‰©å±•åŸŸï¼‰Hashedã€€Rootã€€Key å«ä¹‰ï¼šåªåœ¨æ ¹è¯ä¹¦ä¸­ä½¿ç”¨ï¼Œç”¨äºè¯ä¹¦æ›´æ–°æ—¶è¿›è¡Œå›æº¯ã€‚</p></li><li><p>è¯ä¹¦ç±»å‹ï¼ˆCertificateã€€Typeï¼‰<br>å«ä¹‰ï¼šç”¨æ¥åŒºåˆ«ä¸åŒçš„å®ä½“ã€‚è¯¥é¡¹æ˜¯å¿…é€‰çš„ã€‚</p></li><li><p>å•†æˆ·æ•°æ®ï¼ˆMerchantã€€Dataï¼‰<br>å«ä¹‰ï¼šåŒ…å«æ”¯ä»˜ç½‘å…³éœ€è¦çš„æ‰€æœ‰å•†æˆ·ä¿¡æ¯ã€‚</p></li><li><p>æŒå¡äººè¯ä¹¦éœ€æ±‚ï¼ˆCardã€€Certã€€Requiredï¼‰<br>å«ä¹‰ï¼šæ˜¾ç¤ºæ”¯ä»˜ç½‘å…³æ˜¯å¦æ”¯æŒä¸æ²¡æœ‰è¯ä¹¦çš„æŒå¡äººè¿›è¡Œäº¤æ˜“ã€‚</p></li><li><p>SET æ‰©å±•ï¼ˆSETExtensionsï¼‰<br>å«ä¹‰ï¼šåˆ—å‡ºæ”¯ä»˜ç½‘å…³æ”¯æŒçš„æ”¯ä»˜å‘½ä»¤çš„ SET ä¿¡æ¯æ‰©å±•ã€‚</p></li><li><p>CRL æ•°æ®å®šä¹‰ç‰ˆæœ¬ï¼ˆVersionï¼‰<br>å«ä¹‰ï¼šæ˜¾ç¤º CRL çš„ç‰ˆæœ¬å·ã€‚</p></li><li><p>CRL çš„ç­¾å‘è€…ï¼ˆIssuerï¼‰<br>å«ä¹‰ï¼šæŒ‡æ˜ç­¾å‘ CRL çš„CA çš„ç”„åˆ«åã€‚</p></li></ul><p>CRL å‘å¸ƒæ—¶é—´ï¼ˆthisã€€Updateï¼‰é¢„è®¡ä¸‹ä¸€ä¸ª CRL æ›´æ–°æ—¶é—´ï¼ˆNextã€€Updateï¼‰æ’¤é”€è¯ä¹¦ä¿¡æ¯ç›®å½•ï¼ˆRevokedã€€Certificatesï¼‰CRL æ‰©å±•ï¼ˆCRLã€€Extensionï¼‰CA çš„å…¬é’¥æ ‡è¯†ï¼ˆAuthorityã€€Keyã€€Identifierï¼‰CRL å·ï¼ˆCRLã€€Numberï¼‰</p><p>SSLè¯ä¹¦ç§ç±»ï¼š<br>CFCAï¼ŒGlobalSignï¼ŒVeriSign ï¼ŒGeotrust ï¼ŒThawteã€‚</p><ul><li>åŸŸåå‹ https è¯ä¹¦ï¼ˆDVSSLï¼‰ï¼šä¿¡ä»»ç­‰çº§ä¸€èˆ¬ï¼Œåªéœ€éªŒè¯ç½‘ç«™çš„çœŸå®æ€§ä¾¿å¯é¢å‘è¯ä¹¦ä¿æŠ¤ç½‘ç«™ï¼›</li><li>ä¼ä¸šå‹ https è¯ä¹¦ï¼ˆOVSSLï¼‰ï¼šä¿¡ä»»ç­‰çº§å¼ºï¼Œé¡»è¦éªŒè¯ä¼ä¸šçš„èº«ä»½ï¼Œå®¡æ ¸ä¸¥æ ¼ï¼Œå®‰å…¨æ€§æ›´é«˜ï¼›</li><li>å¢å¼ºå‹ https è¯ä¹¦ï¼ˆEVSSLï¼‰ï¼šä¿¡ä»»ç­‰çº§æœ€é«˜ï¼Œä¸€èˆ¬ç”¨äºé“¶è¡Œè¯åˆ¸ç­‰é‡‘èæœºæ„ï¼Œå®¡æ ¸ä¸¥æ ¼ï¼Œå®‰å…¨æ€§æœ€é«˜ï¼ŒåŒæ—¶å¯ä»¥æ¿€æ´»ç»¿è‰²ç½‘å€æ ã€‚</li></ul><h3 id="æ¡æ‰‹è¿‡ç¨‹"><a href="#æ¡æ‰‹è¿‡ç¨‹" class="headerlink" title="æ¡æ‰‹è¿‡ç¨‹"></a>æ¡æ‰‹è¿‡ç¨‹</h3><p>ä¸ºäº†ä¾¿äºæ›´å¥½çš„è®¤è¯†å’Œç†è§£SSL åè®®ï¼Œè¿™é‡Œç€é‡ä»‹ç»SSL åè®®çš„æ¡æ‰‹åè®®ã€‚SSL åè®®æ—¢ç”¨åˆ°äº†å…¬é’¥åŠ å¯†æŠ€æœ¯åˆç”¨åˆ°äº†å¯¹ç§°åŠ å¯†æŠ€æœ¯ï¼Œå¯¹ç§°åŠ å¯†æŠ€æœ¯è™½ç„¶æ¯”å…¬é’¥åŠ å¯†æŠ€æœ¯çš„é€Ÿåº¦å¿«ï¼Œå¯æ˜¯å…¬é’¥åŠ å¯†æŠ€æœ¯æä¾›äº†æ›´å¥½çš„èº«ä»½è®¤è¯æŠ€æœ¯ã€‚SSL çš„æ¡æ‰‹åè®®éå¸¸æœ‰æ•ˆçš„è®©å®¢æˆ·å’ŒæœåŠ¡å™¨ä¹‹é—´å®Œæˆç›¸äº’ä¹‹é—´çš„èº«ä»½è®¤è¯ï¼Œå…¶ä¸»è¦è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å®¢æˆ·ç«¯çš„æµè§ˆå™¨å‘æœåŠ¡å™¨ä¼ é€å®¢æˆ·ç«¯SSL åè®®çš„ç‰ˆæœ¬å·ï¼ŒåŠ å¯†ç®—æ³•çš„ç§ç±»ï¼Œäº§ç”Ÿçš„éšæœºæ•°ï¼Œä»¥åŠå…¶ä»–æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´é€šè®¯æ‰€éœ€è¦çš„å„ç§ä¿¡æ¯ã€‚</li><li>æœåŠ¡å™¨å‘å®¢æˆ·ç«¯ä¼ é€SSL åè®®çš„ç‰ˆæœ¬å·ï¼ŒåŠ å¯†ç®—æ³•çš„ç§ç±»ï¼Œéšæœºæ•°ä»¥åŠå…¶ä»–ç›¸å…³ä¿¡æ¯ï¼ŒåŒæ—¶æœåŠ¡å™¨è¿˜å°†å‘å®¢æˆ·ç«¯ä¼ é€è‡ªå·±çš„è¯ä¹¦ã€‚</li><li>å®¢æˆ·åˆ©ç”¨æœåŠ¡å™¨ä¼ è¿‡æ¥çš„ä¿¡æ¯éªŒè¯æœåŠ¡å™¨çš„åˆæ³•æ€§ï¼ŒæœåŠ¡å™¨çš„åˆæ³•æ€§åŒ…æ‹¬ï¼šè¯ä¹¦æ˜¯å¦è¿‡æœŸï¼Œå‘è¡ŒæœåŠ¡å™¨è¯ä¹¦çš„CA æ˜¯å¦å¯é ï¼Œå‘è¡Œè€…è¯ä¹¦çš„å…¬é’¥èƒ½å¦æ­£ç¡®è§£å¼€æœåŠ¡å™¨è¯ä¹¦çš„â€œå‘è¡Œè€…çš„æ•°å­—ç­¾åâ€ï¼ŒæœåŠ¡å™¨è¯ä¹¦ä¸Šçš„åŸŸåæ˜¯å¦å’ŒæœåŠ¡å™¨çš„å®é™…åŸŸåç›¸åŒ¹é…ã€‚å¦‚æœåˆæ³•æ€§éªŒè¯æ²¡æœ‰é€šè¿‡ï¼Œé€šè®¯å°†æ–­å¼€ï¼›å¦‚æœåˆæ³•æ€§éªŒè¯é€šè¿‡ï¼Œå°†ç»§ç»­è¿›è¡Œç¬¬å››æ­¥ã€‚</li><li>ç”¨æˆ·ç«¯éšæœºäº§ç”Ÿä¸€ä¸ªç”¨äºåé¢é€šè®¯çš„â€œå¯¹ç§°å¯†ç â€ï¼Œç„¶åç”¨æœåŠ¡å™¨çš„å…¬é’¥ï¼ˆæœåŠ¡å™¨çš„å…¬é’¥ä»æ­¥éª¤â‘¡ä¸­çš„æœåŠ¡å™¨çš„è¯ä¹¦ä¸­è·å¾—ï¼‰å¯¹å…¶åŠ å¯†ï¼Œç„¶åå°†åŠ å¯†åçš„â€œé¢„ä¸»å¯†ç â€ä¼ ç»™æœåŠ¡å™¨ã€‚</li><li>å¦‚æœæœåŠ¡å™¨è¦æ±‚å®¢æˆ·çš„èº«ä»½è®¤è¯ï¼ˆåœ¨æ¡æ‰‹è¿‡ç¨‹ä¸­ä¸ºå¯é€‰ï¼‰ï¼Œç”¨æˆ·å¯ä»¥å»ºç«‹ä¸€ä¸ªéšæœºæ•°ç„¶åå¯¹å…¶è¿›è¡Œæ•°æ®ç­¾åï¼Œå°†è¿™ä¸ªå«æœ‰ç­¾åçš„éšæœºæ•°å’Œå®¢æˆ·è‡ªå·±çš„è¯ä¹¦ä»¥åŠåŠ å¯†è¿‡çš„â€œé¢„ä¸»å¯†ç â€ä¸€èµ·ä¼ ç»™æœåŠ¡å™¨ã€‚</li><li>å¦‚æœæœåŠ¡å™¨è¦æ±‚å®¢æˆ·çš„èº«ä»½è®¤è¯ï¼ŒæœåŠ¡å™¨å¿…é¡»æ£€éªŒå®¢æˆ·è¯ä¹¦å’Œç­¾åéšæœºæ•°çš„åˆæ³•æ€§ï¼Œå…·ä½“çš„åˆæ³•æ€§éªŒè¯è¿‡ç¨‹åŒ…æ‹¬ï¼šå®¢æˆ·çš„è¯ä¹¦ä½¿ç”¨æ—¥æœŸæ˜¯å¦æœ‰æ•ˆï¼Œä¸ºå®¢æˆ·æä¾›è¯ä¹¦çš„CA æ˜¯å¦å¯é ï¼Œå‘è¡ŒCA çš„å…¬é’¥èƒ½å¦æ­£ç¡®è§£å¼€å®¢æˆ·è¯ä¹¦çš„å‘è¡ŒCA çš„æ•°å­—ç­¾åï¼Œæ£€æŸ¥å®¢æˆ·çš„è¯ä¹¦æ˜¯å¦åœ¨è¯ä¹¦åºŸæ­¢åˆ—è¡¨ï¼ˆCRLï¼‰ä¸­ã€‚æ£€éªŒå¦‚æœæ²¡æœ‰é€šè¿‡ï¼Œé€šè®¯ç«‹åˆ»ä¸­æ–­ï¼›å¦‚æœéªŒè¯é€šè¿‡ï¼ŒæœåŠ¡å™¨å°†ç”¨è‡ªå·±çš„ç§é’¥è§£å¼€åŠ å¯†çš„â€œé¢„ä¸»å¯†ç â€ï¼Œç„¶åæ‰§è¡Œä¸€ç³»åˆ—æ­¥éª¤æ¥äº§ç”Ÿä¸»é€šè®¯å¯†ç ï¼ˆå®¢æˆ·ç«¯ä¹Ÿå°†é€šè¿‡åŒæ ·çš„æ–¹æ³•äº§ç”Ÿç›¸åŒçš„ä¸»é€šè®¯å¯†ç ï¼‰ã€‚</li><li>æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç”¨ç›¸åŒçš„ä¸»å¯†ç å³â€œé€šè¯å¯†ç â€ï¼Œä¸€ä¸ªå¯¹ç§°å¯†é’¥ç”¨äºSSL åè®®çš„å®‰å…¨æ•°æ®é€šè®¯çš„åŠ è§£å¯†é€šè®¯ã€‚åŒæ—¶åœ¨SSL é€šè®¯è¿‡ç¨‹ä¸­è¿˜è¦å®Œæˆæ•°æ®é€šè®¯çš„å®Œæ•´æ€§ï¼Œé˜²æ­¢æ•°æ®é€šè®¯ä¸­çš„ä»»ä½•å˜åŒ–ã€‚</li><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯å‘å‡ºä¿¡æ¯ï¼ŒæŒ‡æ˜åé¢çš„æ•°æ®é€šè®¯å°†ä½¿ç”¨çš„æ­¥éª¤â‘¦ä¸­çš„ä¸»å¯†ç ä¸ºå¯¹ç§°å¯†é’¥ï¼ŒåŒæ—¶é€šçŸ¥æœåŠ¡å™¨å®¢æˆ·ç«¯çš„æ¡æ‰‹è¿‡ç¨‹ç»“æŸã€‚</li><li>æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘å‡ºä¿¡æ¯ï¼ŒæŒ‡æ˜åé¢çš„æ•°æ®é€šè®¯å°†ä½¿ç”¨çš„æ­¥éª¤â‘¦ä¸­çš„ä¸»å¯†ç ä¸ºå¯¹ç§°å¯†é’¥ï¼ŒåŒæ—¶é€šçŸ¥å®¢æˆ·ç«¯æœåŠ¡å™¨ç«¯çš„æ¡æ‰‹è¿‡ç¨‹ç»“æŸã€‚</li><li>SSL çš„æ¡æ‰‹éƒ¨åˆ†ç»“æŸï¼ŒSSL å®‰å…¨é€šé“çš„æ•°æ®é€šè®¯å¼€å§‹ï¼Œå®¢æˆ·å’ŒæœåŠ¡å™¨å¼€å§‹ä½¿ç”¨ç›¸åŒçš„å¯¹ç§°å¯†é’¥è¿›è¡Œæ•°æ®é€šè®¯ï¼ŒåŒæ—¶è¿›è¡Œé€šè®¯å®Œæ•´æ€§çš„æ£€éªŒã€‚</li></ol><h3 id="HTTPSçš„è®¤è¯è¿‡ç¨‹"><a href="#HTTPSçš„è®¤è¯è¿‡ç¨‹" class="headerlink" title="HTTPSçš„è®¤è¯è¿‡ç¨‹"></a>HTTPSçš„è®¤è¯è¿‡ç¨‹</h3><h4 id="å•å‘è®¤è¯"><a href="#å•å‘è®¤è¯" class="headerlink" title="å•å‘è®¤è¯"></a>å•å‘è®¤è¯</h4><p>Httpsåœ¨å»ºç«‹Socketè¿æ¥ä¹‹å‰ï¼Œéœ€è¦è¿›è¡Œæ¡æ‰‹ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€SSLåè®®ç‰ˆæœ¬å·ã€åŠ å¯†ç®—æ³•ç§ç±»ã€éšæœºæ•°ç­‰ä¿¡æ¯ã€‚</li><li>æœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯è¿”å›SSLåè®®ç‰ˆæœ¬å·ã€åŠ å¯†ç®—æ³•ç§ç±»ã€éšæœºæ•°ç­‰ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿè¿”å›æœåŠ¡å™¨ç«¯çš„è¯ä¹¦ï¼Œå³å…¬é’¥è¯ä¹¦</li><li>å®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡ç«¯è¿”å›çš„ä¿¡æ¯éªŒè¯æœåŠ¡å™¨çš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬ï¼š<ol><li>è¯ä¹¦æ˜¯å¦è¿‡æœŸ</li><li>å‘å‹æœåŠ¡å™¨è¯ä¹¦çš„CAæ˜¯å¦å¯é </li><li>è¿”å›çš„å…¬é’¥æ˜¯å¦èƒ½æ­£ç¡®è§£å¼€è¿”å›è¯ä¹¦ä¸­çš„æ•°å­—ç­¾å</li><li>æœåŠ¡å™¨è¯ä¹¦ä¸Šçš„åŸŸåæ˜¯å¦å’ŒæœåŠ¡å™¨çš„å®é™…åŸŸåç›¸åŒ¹é…</li><li>éªŒè¯é€šè¿‡åï¼Œå°†ç»§ç»­è¿›è¡Œé€šä¿¡ï¼Œå¦åˆ™ï¼Œç»ˆæ­¢é€šä¿¡</li></ol></li><li>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è‡ªå·±æ‰€èƒ½æ”¯æŒçš„å¯¹ç§°åŠ å¯†æ–¹æ¡ˆï¼Œä¾›æœåŠ¡å™¨ç«¯è¿›è¡Œé€‰æ‹©</li><li>æœåŠ¡å™¨ç«¯åœ¨å®¢æˆ·ç«¯æä¾›çš„åŠ å¯†æ–¹æ¡ˆä¸­é€‰æ‹©åŠ å¯†ç¨‹åº¦æœ€é«˜çš„åŠ å¯†æ–¹å¼ã€‚</li><li>æœåŠ¡å™¨å°†é€‰æ‹©å¥½çš„åŠ å¯†æ–¹æ¡ˆé€šè¿‡æ˜æ–‡æ–¹å¼è¿”å›ç»™å®¢æˆ·ç«¯</li><li>å®¢æˆ·ç«¯æ¥æ”¶åˆ°æœåŠ¡ç«¯è¿”å›çš„åŠ å¯†æ–¹å¼åï¼Œä½¿ç”¨è¯¥åŠ å¯†æ–¹å¼ç”Ÿæˆäº§ç”Ÿéšæœºç ï¼Œç”¨ä½œé€šä¿¡è¿‡ç¨‹ä¸­å¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œä½¿ç”¨æœåŠ¡ç«¯è¿”å›çš„å…¬é’¥è¿›è¡ŒåŠ å¯†ï¼Œå°†åŠ å¯†åçš„éšæœºç å‘é€è‡³æœåŠ¡å™¨</li><li>æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯è¿”å›çš„åŠ å¯†ä¿¡æ¯åï¼Œä½¿ç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œè·å–å¯¹ç§°åŠ å¯†å¯†é’¥ã€‚åœ¨æ¥ä¸‹æ¥çš„ä¼šè¯ä¸­ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å°†ä¼šä½¿ç”¨è¯¥å¯†ç è¿›è¡Œå¯¹ç§°åŠ å¯†ï¼Œä¿è¯é€šä¿¡è¿‡ç¨‹ä¸­ä¿¡æ¯çš„å®‰å…¨ã€‚</li></ol><h4 id="åŒå‘è®¤è¯"><a href="#åŒå‘è®¤è¯" class="headerlink" title="åŒå‘è®¤è¯"></a>åŒå‘è®¤è¯</h4><p>åŒå‘è®¤è¯å’Œå•å‘è®¤è¯åŸç†åŸºæœ¬å·®ä¸å¤šï¼Œåªæ˜¯é™¤äº†å®¢æˆ·ç«¯éœ€è¦è®¤è¯æœåŠ¡ç«¯ä»¥å¤–ï¼Œå¢åŠ äº†æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ï¼Œå…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€SSLåè®®ç‰ˆæœ¬å·ã€åŠ å¯†ç®—æ³•ç§ç±»ã€éšæœºæ•°ç­‰ä¿¡æ¯ã€‚</li><li>æœåŠ¡ç«¯ç»™å®¢æˆ·ç«¯è¿”å›SSLåè®®ç‰ˆæœ¬å·ã€åŠ å¯†ç®—æ³•ç§ç±»ã€éšæœºæ•°ç­‰ä¿¡æ¯ï¼ŒåŒæ—¶ä¹Ÿè¿”å›æœåŠ¡å™¨ç«¯çš„è¯ä¹¦ï¼Œå³å…¬é’¥è¯ä¹¦</li><li>å®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡ç«¯è¿”å›çš„ä¿¡æ¯éªŒè¯æœåŠ¡å™¨çš„åˆæ³•æ€§ï¼ŒåŒ…æ‹¬ï¼š<ol><li>è¯ä¹¦æ˜¯å¦è¿‡æœŸ</li><li>å‘å‹æœåŠ¡å™¨è¯ä¹¦çš„CAæ˜¯å¦å¯é </li><li>è¿”å›çš„å…¬é’¥æ˜¯å¦èƒ½æ­£ç¡®è§£å¼€è¿”å›è¯ä¹¦ä¸­çš„æ•°å­—ç­¾å</li><li>æœåŠ¡å™¨è¯ä¹¦ä¸Šçš„åŸŸåæ˜¯å¦å’ŒæœåŠ¡å™¨çš„å®é™…åŸŸåç›¸åŒ¹é…</li><li>éªŒè¯é€šè¿‡åï¼Œå°†ç»§ç»­è¿›è¡Œé€šä¿¡ï¼Œå¦åˆ™ï¼Œç»ˆæ­¢é€šä¿¡</li></ol></li><li>æœåŠ¡ç«¯è¦æ±‚å®¢æˆ·ç«¯å‘é€å®¢æˆ·ç«¯çš„è¯ä¹¦ï¼Œå®¢æˆ·ç«¯ä¼šå°†è‡ªå·±çš„è¯ä¹¦å‘é€è‡³æœåŠ¡ç«¯</li><li>éªŒè¯å®¢æˆ·ç«¯çš„è¯ä¹¦ï¼Œé€šè¿‡éªŒè¯åï¼Œä¼šè·å¾—å®¢æˆ·ç«¯çš„å…¬é’¥</li><li>å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è‡ªå·±æ‰€èƒ½æ”¯æŒçš„å¯¹ç§°åŠ å¯†æ–¹æ¡ˆï¼Œä¾›æœåŠ¡å™¨ç«¯è¿›è¡Œé€‰æ‹©</li><li>æœåŠ¡å™¨ç«¯åœ¨å®¢æˆ·ç«¯æä¾›çš„åŠ å¯†æ–¹æ¡ˆä¸­é€‰æ‹©åŠ å¯†ç¨‹åº¦æœ€é«˜çš„åŠ å¯†æ–¹å¼</li><li>å°†åŠ å¯†æ–¹æ¡ˆé€šè¿‡ä½¿ç”¨ä¹‹å‰è·å–åˆ°çš„å…¬é’¥è¿›è¡ŒåŠ å¯†ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯</li><li>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯è¿”å›çš„åŠ å¯†æ–¹æ¡ˆå¯†æ–‡åï¼Œä½¿ç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œè·å–å…·ä½“åŠ å¯†æ–¹å¼ï¼Œè€Œåï¼Œäº§ç”Ÿè¯¥åŠ å¯†æ–¹å¼çš„éšæœºç ï¼Œç”¨ä½œåŠ å¯†è¿‡ç¨‹ä¸­çš„å¯†é’¥ï¼Œä½¿ç”¨ä¹‹å‰ä»æœåŠ¡ç«¯è¯ä¹¦ä¸­è·å–åˆ°çš„å…¬é’¥è¿›è¡ŒåŠ å¯†åï¼Œå‘é€ç»™æœåŠ¡ç«¯</li><li>æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯åï¼Œä½¿ç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œè§£å¯†ï¼Œè·å–å¯¹ç§°åŠ å¯†çš„å¯†é’¥ï¼Œåœ¨æ¥ä¸‹æ¥çš„ä¼šè¯ä¸­ï¼ŒæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å°†ä¼šä½¿ç”¨è¯¥å¯†ç è¿›è¡Œå¯¹ç§°åŠ å¯†ï¼Œä¿è¯é€šä¿¡è¿‡ç¨‹ä¸­ä¿¡æ¯çš„å®‰å…¨ã€‚</li></ol><h3 id="AFSecurityPolicyå’Œè®¤è¯"><a href="#AFSecurityPolicyå’Œè®¤è¯" class="headerlink" title="AFSecurityPolicyå’Œè®¤è¯"></a>AFSecurityPolicyå’Œè®¤è¯</h3><h4 id="è®¤è¯è¿‡ç¨‹å’ŒåŸç†"><a href="#è®¤è¯è¿‡ç¨‹å’ŒåŸç†" class="headerlink" title="è®¤è¯è¿‡ç¨‹å’ŒåŸç†"></a>è®¤è¯è¿‡ç¨‹å’ŒåŸç†</h4><p>AFNæ˜¯é ç€AFSecurityPolicyè¿™ä¸ªç±»ä¿è¯æ•°æ®å®‰å…¨çš„ï¼Œè°ƒç”¨ä¸‹é¢æ–¹æ³•ç”¨æ¥éªŒè¯æ˜¯å¦ä¿¡ä»»æœåŠ¡å™¨ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="keyword">self</span>.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]</span><br></pre></td></tr></table></figure><p>çœ‹ä¸€ä¸‹AFNä¸­çš„æ¥å£</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment">    @typedef SecTrustRef</span></span><br><span class="line"><span class="comment">    @abstract CFType used for performing X.509 certificate trust evaluations.</span></span><br><span class="line"><span class="comment">    // æ‰§è¡ŒX.509è¯ä¹¦ä¿¡ä»»è¯„ä¼°ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œè£…äº†æœåŠ¡å™¨ç«¯éœ€è¦éªŒè¯çš„è¯ä¹¦çš„åŸºæœ¬ä¿¡æ¯ã€</span></span><br><span class="line"><span class="comment">    å…¬é’¥ç­‰ç­‰ï¼Œä¸ä»…å¦‚æ­¤ï¼Œå®ƒè¿˜å¯ä»¥è£…ä¸€äº›è¯„ä¼°ç­–ç•¥ï¼Œè¿˜æœ‰å®¢æˆ·ç«¯çš„é”šç‚¹è¯ä¹¦ï¼Œ</span></span><br><span class="line"><span class="comment">    è¿™ä¸ªå®¢æˆ·ç«¯çš„è¯ä¹¦ï¼Œå¯ä»¥ç”¨æ¥å’ŒæœåŠ¡ç«¯çš„è¯ä¹¦å»åŒ¹é…éªŒè¯çš„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="built_in">CF_BRIDGED_TYPE</span>(<span class="keyword">id</span>) __SecTrust *SecTrustRef;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Whether or not the specified server trust should be accepted, based on the security policy.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> This method should be used when responding to an authentication challenge from a server.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param serverTrust The X.509 certificate trust of the server.</span></span><br><span class="line"><span class="comment"> @param domain The domain of serverTrust. If `nil`, the domain will not be validated. // æœåŠ¡å™¨åŸŸå</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return Whether or not to trust the server.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)evaluateServerTrust:(SecTrustRef)serverTrust</span><br><span class="line">                  forDomain:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)domain;</span><br></pre></td></tr></table></figure><p>æ ¹æ®å®‰å…¨ç­–ç•¥æ˜¯å¦æ¥å—æŒ‡å®šçš„æœåŠ¡å™¨ä¿¡ä»»ã€‚ å“åº”æ¥è‡ªæœåŠ¡å™¨çš„èº«ä»½éªŒè¯è´¨è¯¢æ—¶åº”ä½¿ç”¨æ­¤æ–¹æ³•ã€‚</p><p>å¤§å®¶è¿˜è®°å¾—è¿™ä¸ªä»£ç†æ–¹æ³•å—ï¼Ÿ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">didReceiveChallenge:(<span class="built_in">NSURLAuthenticationChallenge</span> *)challenge</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition, <span class="built_in">NSURLCredential</span> *credential))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//æŒ‘æˆ˜å¤„ç†ç±»å‹ä¸º é»˜è®¤</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     NSURLSessionAuthChallengePerformDefaultHandlingï¼šé»˜è®¤æ–¹å¼å¤„ç†</span></span><br><span class="line"><span class="comment">     NSURLSessionAuthChallengeUseCredentialï¼šä½¿ç”¨æŒ‡å®šçš„è¯ä¹¦</span></span><br><span class="line"><span class="comment">     NSURLSessionAuthChallengeCancelAuthenticationChallengeï¼šå–æ¶ˆæŒ‘æˆ˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">    __block <span class="built_in">NSURLCredential</span> *credential = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sessionDidReceiveAuthenticationChallengeæ˜¯è‡ªå®šä¹‰æ–¹æ³•ï¼Œç”¨æ¥å¦‚ä½•åº”å¯¹æœåŠ¡å™¨ç«¯çš„è®¤è¯æŒ‘æˆ˜</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.sessionDidReceiveAuthenticationChallenge) &#123;</span><br><span class="line">        disposition = <span class="keyword">self</span>.sessionDidReceiveAuthenticationChallenge(session, challenge, &amp;credential);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// æ­¤å¤„æœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯çš„æ¥æ”¶è®¤è¯æŒ‘æˆ˜æ–¹æ³•æ˜¯NSURLAuthenticationMethodServerTrust</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå°±æ˜¯è¯´æœåŠ¡å™¨ç«¯éœ€è¦å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªæ ¹æ®è®¤è¯æŒ‘æˆ˜çš„ä¿æŠ¤ç©ºé—´æä¾›çš„ä¿¡ä»»ï¼ˆå³challenge.protectionSpace.serverTrustï¼‰äº§ç”Ÿçš„æŒ‘æˆ˜è¯ä¹¦ã€‚</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">// è€Œè¿™ä¸ªè¯ä¹¦å°±éœ€è¦ä½¿ç”¨credentialForTrust:æ¥åˆ›å»ºä¸€ä¸ªNSURLCredentialå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> ([challenge.protectionSpace.authenticationMethod isEqualToString:<span class="built_in">NSURLAuthenticationMethodServerTrust</span>]) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// åŸºäºå®¢æˆ·ç«¯çš„å®‰å…¨ç­–ç•¥æ¥å†³å®šæ˜¯å¦ä¿¡ä»»è¯¥æœåŠ¡å™¨ï¼Œä¸ä¿¡ä»»çš„è¯ï¼Œä¹Ÿå°±æ²¡å¿…è¦å“åº”æŒ‘æˆ˜</span></span><br><span class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span>.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]) &#123;</span><br><span class="line">                <span class="comment">// åˆ›å»ºæŒ‘æˆ˜è¯ä¹¦ï¼ˆæ³¨ï¼šæŒ‘æˆ˜æ–¹å¼ä¸ºUseCredentialå’ŒPerformDefaultHandlingéƒ½éœ€è¦æ–°å»ºæŒ‘æˆ˜è¯ä¹¦ï¼‰</span></span><br><span class="line">                credential = [<span class="built_in">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];</span><br><span class="line">                <span class="comment">// ç¡®å®šæŒ‘æˆ˜çš„æ–¹å¼</span></span><br><span class="line">                <span class="keyword">if</span> (credential) &#123;</span><br><span class="line">                    <span class="comment">//è¯ä¹¦æŒ‘æˆ˜  è®¾è®¡policy,noneï¼Œåˆ™è·‘åˆ°è¿™é‡Œ</span></span><br><span class="line">                    disposition = <span class="built_in">NSURLSessionAuthChallengeUseCredential</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//å–æ¶ˆæŒ‘æˆ˜</span></span><br><span class="line">                disposition = <span class="built_in">NSURLSessionAuthChallengeCancelAuthenticationChallenge</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//é»˜è®¤æŒ‘æˆ˜æ–¹å¼</span></span><br><span class="line">            disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å®ŒæˆæŒ‘æˆ˜</span></span><br><span class="line">    <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">        completionHandler(disposition, credential);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•è¿›è¡Œæ¥å—æŒ‘æˆ˜çš„</p><ul><li>é¦–å…ˆæŒ‡å®šäº†HTTPSä¸ºé»˜è®¤çš„è®¤è¯æ–¹å¼ã€‚</li><li>åˆ¤æ–­æœ‰æ²¡æœ‰è‡ªå®šä¹‰Block:sessionDidReceiveAuthenticationChallengeï¼Œæœ‰çš„è¯ï¼Œä½¿ç”¨æˆ‘ä»¬è‡ªå®šä¹‰Block,ç”Ÿæˆä¸€ä¸ªè®¤è¯æ–¹å¼ï¼Œå¹¶ä¸”å¯ä»¥ç»™credentialèµ‹å€¼ï¼Œå³æˆ‘ä»¬éœ€è¦æ¥å—è®¤è¯çš„è¯ä¹¦ã€‚ç„¶åç›´æ¥è°ƒç”¨completionHandlerï¼Œå»æ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°ï¼Œæ‰§è¡Œç³»ç»Ÿçš„è®¤è¯ã€‚</li><li>å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰Blockï¼Œæˆ‘ä»¬åˆ¤æ–­å¦‚æœæœåŠ¡ç«¯çš„è®¤è¯æ–¹æ³•è¦æ±‚æ˜¯NSURLAuthenticationMethodServerTrustï¼Œåˆ™åªéœ€è¦éªŒè¯æœåŠ¡ç«¯è¯ä¹¦æ˜¯å¦å®‰å…¨ï¼ˆå³httpsçš„å•å‘è®¤è¯ï¼Œè¿™æ˜¯AFé»˜è®¤å¤„ç†çš„è®¤è¯æ–¹å¼ï¼Œå…¶ä»–çš„è®¤è¯æ–¹å¼ï¼Œåªèƒ½ç”±æˆ‘ä»¬è‡ªå®šä¹‰Blockçš„å®ç°ï¼‰</li><li>æ¥ç€æˆ‘ä»¬å°±æ‰§è¡Œäº†AFSecurityPolicyç›¸å…³çš„ä¸Šé¢çš„æ–¹æ³•- (BOOL)evaluateServerTrust:(SecTrustRef)serverTrust forDomain:(nullable NSString *)domainï¼Œå…³äºè¿™ä¸ªæ–¹æ³•ï¼ŒAFé»˜è®¤çš„å¤„ç†æ˜¯ï¼Œå¦‚æœè¿™è¡Œè¿”å›NOã€è¯´æ˜AFå†…éƒ¨è®¤è¯å¤±è´¥ï¼Œåˆ™å–æ¶ˆHTTPSè®¤è¯ï¼Œå³å–æ¶ˆè¯·æ±‚ã€‚è¿”å›YESåˆ™è¿›å…¥ifå—ï¼Œç”¨æœåŠ¡å™¨è¿”å›çš„ä¸€ä¸ªserverTrustå»ç”Ÿæˆäº†ä¸€ä¸ªè®¤è¯è¯ä¹¦ã€‚ï¼ˆæ³¨ï¼šè¿™ä¸ªserverTrustæ˜¯æœåŠ¡å™¨ä¼ è¿‡æ¥çš„ï¼Œé‡Œé¢åŒ…å«äº†æœåŠ¡å™¨çš„è¯ä¹¦ä¿¡æ¯ï¼Œæ˜¯ç”¨æ¥æˆ‘ä»¬æœ¬åœ°å®¢æˆ·ç«¯å»éªŒè¯è¯¥è¯ä¹¦æ˜¯å¦åˆæ³•ç”¨çš„ï¼Œåé¢ä¼šæ›´è¯¦ç»†çš„å»è®²è¿™ä¸ªå‚æ•°ï¼‰ç„¶åå¦‚æœæœ‰è¯ä¹¦ï¼Œåˆ™ç”¨è¯ä¹¦è®¤è¯æ–¹å¼ï¼Œå¦åˆ™è¿˜æ˜¯ç”¨é»˜è®¤çš„éªŒè¯æ–¹å¼ã€‚æœ€åè°ƒç”¨completionHandlerä¼ é€’è®¤è¯æ–¹å¼å’Œè¦è®¤è¯çš„è¯ä¹¦ï¼Œå»åšç³»ç»Ÿæ ¹è¯ä¹¦éªŒè¯ã€‚ä¹Ÿå¯ä»¥è¿™ä¹ˆç†è§£ï¼šè¿™é‡ŒsecurityPolicyå­˜åœ¨çš„ä½œç”¨å°±æ˜¯ï¼Œä½¿å¾—åœ¨ç³»ç»Ÿåº•å±‚è‡ªå·±å»éªŒè¯ä¹‹å‰ï¼ŒAFå¯ä»¥å…ˆå»éªŒè¯æœåŠ¡ç«¯çš„è¯ä¹¦ã€‚å¦‚æœé€šä¸è¿‡ï¼Œåˆ™ç›´æ¥è¶Šè¿‡ç³»ç»Ÿçš„éªŒè¯ï¼Œå–æ¶ˆHTTPSçš„ç½‘ç»œè¯·æ±‚ã€‚å¦åˆ™ï¼Œç»§ç»­å»èµ°ç³»ç»Ÿæ ¹è¯ä¹¦çš„éªŒè¯ã€‚</li></ul><h4 id="AFSecurityPolicyå®ä¾‹åŒ–"><a href="#AFSecurityPolicyå®ä¾‹åŒ–" class="headerlink" title="AFSecurityPolicyå®ä¾‹åŒ–"></a>AFSecurityPolicyå®ä¾‹åŒ–</h4><p>å…ˆçœ‹ä¸€ä¸‹è¯¥ç±»çš„å®ä¾‹åŒ–</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">AFSecurityPolicy *policy = [AFSecurityPolicy defaultPolicy];</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)defaultPolicy &#123;</span><br><span class="line">    AFSecurityPolicy *securityPolicy = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    securityPolicy.SSLPinningMode = AFSSLPinningModeNone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> securityPolicy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„å±æ€§å°±æ˜¯SSLPinningModeï¼Œå…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæšä¸¾</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, AFSSLPinningMode) &#123;</span><br><span class="line">    AFSSLPinningModeNone,    <span class="comment">//ä¸éªŒè¯</span></span><br><span class="line">    AFSSLPinningModePublicKey,  <span class="comment">//åªéªŒè¯å…¬é’¥</span></span><br><span class="line">    AFSSLPinningModeCertificate,  <span class="comment">// éªŒè¯è¯ä¹¦</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ç±»AFSecurityPolicyçš„å‡ ä¸ªå±æ€§</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> The criteria by which server trust should be evaluated against the pinned SSL certificates. Defaults to `AFSSLPinningModeNone`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// éªŒè¯æ¨¡å¼ è¿™ä¸ªæšä¸¾å€¼ä¸Šé¢è®²è¿°è¿‡</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AFSSLPinningMode SSLPinningMode;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> The certificates used to evaluate server trust according to the SSL pinning mode. </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  By default, this property is set to any (`.cer`) certificates included in the target compiling AFNetworking. Note that if you are using AFNetworking as embedded framework, no certificates will be pinned by default. Use `certificatesInBundle` to load certificates from your target, and then create a new policy by calling `policyWithPinningMode:withPinnedCertificates`.</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> Note that if pinning is enabled, `evaluateServerTrust:forDomain:` will return true if any pinned certificate matches.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// å¯ä»¥å»åŒ¹é…æœåŠ¡ç«¯è¯ä¹¦éªŒè¯çš„è¯ä¹¦</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">NSSet</span> &lt;<span class="built_in">NSData</span> *&gt; *pinnedCertificates;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Whether or not to trust servers with an invalid or expired SSL certificates. Defaults to `NO`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// æ˜¯å¦æ”¯æŒéæ³•çš„è¯ä¹¦ï¼ˆä¾‹å¦‚è‡ªç­¾åè¯ä¹¦ï¼‰</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> allowInvalidCertificates;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> Whether or not to validate the domain name in the certificate's CN field. Defaults to `YES`.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// æ˜¯å¦å»éªŒè¯è¯ä¹¦åŸŸåæ˜¯å¦åŒ¹é…</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> validatesDomainName;</span><br></pre></td></tr></table></figure><h3 id="AFNetWorking-HTTPSè¯·æ±‚ç¤ºä¾‹"><a href="#AFNetWorking-HTTPSè¯·æ±‚ç¤ºä¾‹" class="headerlink" title="AFNetWorking HTTPSè¯·æ±‚ç¤ºä¾‹"></a>AFNetWorking HTTPSè¯·æ±‚ç¤ºä¾‹</h3><h4 id="è‡ªç­¾åè¯ä¹¦"><a href="#è‡ªç­¾åè¯ä¹¦" class="headerlink" title="è‡ªç­¾åè¯ä¹¦"></a>è‡ªç­¾åè¯ä¹¦</h4><p>æˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šsecurityPolicyè®¤è¯å±æ€§ã€‚é€šè¿‡12306è¯ä¹¦æ¥å®ç°ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è‡ªå»ºè¯ä¹¦è®¤è¯</span></span><br><span class="line">- (<span class="keyword">IBAction</span>)buttion1:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://kyfw.12306.cn/otn/leftTicket/init"</span>];</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url];</span><br><span class="line">   <span class="comment">// [request setValue:@"text/html" forHTTPHeaderField:@"Accept"];</span></span><br><span class="line">    AFURLSessionManager *manager = [[AFURLSessionManager alloc]initWithSessionConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration]];</span><br><span class="line">    <span class="comment">//æŒ‡å®šå®‰å…¨ç­–ç•¥</span></span><br><span class="line">    manager.securityPolicy = [<span class="keyword">self</span> ticketSecurityPolicy];</span><br><span class="line">    <span class="comment">//æŒ‡å®šè¿”å›æ•°æ®ç±»å‹,é»˜è®¤æ˜¯AFJSONResponseSerializerç±»å‹ï¼ŒçŠ¹è±«è¿™é‡Œä¸æ˜¯JSONç±»å‹çš„è¿”å›æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨æŒ‡å®šè¿”å›ç±»å‹</span></span><br><span class="line">    AFHTTPResponseSerializer *responseSerializer = [AFHTTPResponseSerializer serializer];</span><br><span class="line">    responseSerializer.acceptableContentTypes = [<span class="built_in">NSSet</span> setWithObject:<span class="string">@"text/html"</span>];</span><br><span class="line">    manager.responseSerializer = responseSerializer;</span><br><span class="line">    <span class="built_in">NSURLSessionDataTask</span> *dataTask = [manager dataTaskWithRequest:request uploadProgress:<span class="literal">nil</span> downloadProgress:<span class="literal">nil</span> completionHandler:^(<span class="built_in">NSURLResponse</span> * _Nonnull response, <span class="keyword">id</span>  _Nullable responseObject, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@-----%@"</span>,[[<span class="built_in">NSString</span> alloc] initWithData:responseObject encoding:<span class="built_in">NSUTF8StringEncoding</span>],error);</span><br><span class="line">    &#125;];</span><br><span class="line">    [dataTask resume];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 12306çš„è®¤è¯è¯ä¹¦ï¼Œä»–çš„è®¤è¯è¯ä¹¦æ˜¯è‡ªç­¾åçš„</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return è¿”å›æŒ‡å®šçš„è®¤è¯ç­–ç•¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">-(AFSecurityPolicy*)ticketSecurityPolicy &#123;</span><br><span class="line">    <span class="comment">// /å…ˆå¯¼å…¥è¯ä¹¦</span></span><br><span class="line">    <span class="built_in">NSString</span> *cerPath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"12306"</span> ofType:<span class="string">@"cer"</span>];<span class="comment">//è¯ä¹¦çš„è·¯å¾„</span></span><br><span class="line">    <span class="built_in">NSData</span> *certData = [<span class="built_in">NSData</span> dataWithContentsOfFile:cerPath];</span><br><span class="line">    <span class="built_in">NSSet</span> *set = [<span class="built_in">NSSet</span> setWithObject:certData];</span><br><span class="line"></span><br><span class="line">    AFSecurityPolicy *securityPolicy;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeCertificate withPinnedCertificates:set];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// AFSSLPinningModeCertificate ä½¿ç”¨è¯ä¹¦éªŒè¯æ¨¡å¼ã€‚ä¸‹é¢è¿™ä¸ªæ–¹æ³•ä¼šé»˜è®¤ä½¿ç”¨é¡¹ç›®é‡Œé¢çš„æ‰€æœ‰è¯ä¹¦</span></span><br><span class="line">        securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeCertificate];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// allowInvalidCertificates æ˜¯å¦å…è®¸æ— æ•ˆè¯ä¹¦ï¼ˆä¹Ÿå°±æ˜¯è‡ªå»ºçš„è¯ä¹¦ï¼‰ï¼Œé»˜è®¤ä¸ºNO</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯éœ€è¦éªŒè¯è‡ªå»ºè¯ä¹¦ï¼Œéœ€è¦è®¾ç½®ä¸ºYES</span></span><br><span class="line">    securityPolicy.allowInvalidCertificates = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//validatesDomainName æ˜¯å¦éœ€è¦éªŒè¯åŸŸåï¼Œé»˜è®¤ä¸ºYESï¼›</span></span><br><span class="line">    <span class="comment">//å‡å¦‚è¯ä¹¦çš„åŸŸåä¸ä½ è¯·æ±‚çš„åŸŸåä¸ä¸€è‡´ï¼Œéœ€æŠŠè¯¥é¡¹è®¾ç½®ä¸ºNOï¼›å¦‚è®¾æˆNOçš„è¯ï¼Œå³æœåŠ¡å™¨ä½¿ç”¨å…¶ä»–å¯ä¿¡ä»»æœºæ„é¢å‘çš„è¯ä¹¦ï¼Œä¹Ÿå¯ä»¥å»ºç«‹è¿æ¥ï¼Œè¿™ä¸ªéå¸¸å±é™©ï¼Œå»ºè®®æ‰“å¼€ã€‚</span></span><br><span class="line">    <span class="comment">//ç½®ä¸ºNOï¼Œä¸»è¦ç”¨äºè¿™ç§æƒ…å†µï¼šå®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯å­åŸŸåï¼Œè€Œè¯ä¹¦ä¸Šçš„æ˜¯å¦å¤–ä¸€ä¸ªåŸŸåã€‚å› ä¸ºSSLè¯ä¹¦ä¸Šçš„åŸŸåæ˜¯ç‹¬ç«‹çš„ï¼Œå‡å¦‚è¯ä¹¦ä¸Šæ³¨å†Œçš„åŸŸåæ˜¯www.google.comï¼Œé‚£ä¹ˆmail.google.comæ˜¯æ— æ³•éªŒè¯é€šè¿‡çš„ï¼›å½“ç„¶ï¼Œæœ‰é’±å¯ä»¥æ³¨å†Œé€šé…ç¬¦çš„åŸŸå*.google.comï¼Œä½†è¿™ä¸ªè¿˜æ˜¯æ¯”è¾ƒè´µçš„ã€‚</span></span><br><span class="line">    <span class="comment">//å¦‚ç½®ä¸ºNOï¼Œå»ºè®®è‡ªå·±æ·»åŠ å¯¹åº”åŸŸåçš„æ ¡éªŒé€»è¾‘ã€‚</span></span><br><span class="line">    securityPolicy.validatesDomainName = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> securityPolicy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SSLä¿¡ä»»è¯ä¹¦"><a href="#SSLä¿¡ä»»è¯ä¹¦" class="headerlink" title="SSLä¿¡ä»»è¯ä¹¦"></a>SSLä¿¡ä»»è¯ä¹¦</h4><p>æˆ‘ä»¬æ‰‹åŠ¨æŒ‡å®šsecurityPolicyè®¤è¯å±æ€§ã€‚é€šè¿‡ç™¾åº¦è¯ä¹¦æ¥å®ç°ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¤è¯è¯ä¹¦è®¤è¯</span></span><br><span class="line">- (<span class="keyword">IBAction</span>)button2:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://www.baidu.com"</span>];</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url];</span><br><span class="line">    <span class="comment">//[request setValue:@"text/html" forHTTPHeaderField:@"Accept"];</span></span><br><span class="line">    AFURLSessionManager *manager = [[AFURLSessionManager alloc]initWithSessionConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration]];</span><br><span class="line">    <span class="comment">//æŒ‡å®šå®‰å…¨ç­–ç•¥</span></span><br><span class="line">    manager.securityPolicy = [<span class="keyword">self</span> baiduSecurityPolicy];</span><br><span class="line">    <span class="comment">//æŒ‡å®šè¿”å›æ•°æ®ç±»å‹,é»˜è®¤æ˜¯AFJSONResponseSerializerç±»å‹ï¼ŒçŠ¹è±«è¿™é‡Œä¸æ˜¯JSONç±»å‹çš„è¿”å›æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨æŒ‡å®šè¿”å›ç±»å‹</span></span><br><span class="line">    AFHTTPResponseSerializer *responseSerializer = [AFHTTPResponseSerializer serializer];</span><br><span class="line">    responseSerializer.acceptableContentTypes = [<span class="built_in">NSSet</span> setWithObject:<span class="string">@"text/html"</span>];</span><br><span class="line">    manager.responseSerializer = responseSerializer;</span><br><span class="line">    <span class="built_in">NSURLSessionDataTask</span> *dataTask = [manager dataTaskWithRequest:request uploadProgress:<span class="literal">nil</span> downloadProgress:<span class="literal">nil</span> completionHandler:^(<span class="built_in">NSURLResponse</span> * _Nonnull response, <span class="keyword">id</span>  _Nullable responseObject, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@-----%@"</span>,[[<span class="built_in">NSString</span> alloc] initWithData:responseObject encoding:<span class="built_in">NSUTF8StringEncoding</span>],error);</span><br><span class="line">    &#125;];</span><br><span class="line">    [dataTask resume];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">ç™¾åº¦çš„çš„è®¤è¯è¯ä¹¦ï¼Œä»–çš„è®¤è¯è¯ä¹¦æ˜¯èŠ±é’±ä¹°çš„ï¼Œä¹Ÿå°±æ˜¯ä¸æ˜¯è‡ªç­¾åçš„è¯ä¹¦ã€‚è¿™ç§è¯ä¹¦ï¼Œå¦‚æœæˆ‘ä»¬è¦æ‰‹åŠ¨æŒ‡å®šï¼Œpinmodeåªèƒ½æ˜¯`AFSSLPinningModeNone`</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return è¿”å›æŒ‡å®šçš„è®¤è¯ç­–ç•¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">-(AFSecurityPolicy*)baiduSecurityPolicy &#123;</span><br><span class="line">    <span class="comment">// /å…ˆå¯¼å…¥è¯ä¹¦</span></span><br><span class="line">    <span class="built_in">NSString</span> *cerPath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@"baidu"</span> ofType:<span class="string">@"cer"</span>];<span class="comment">//è¯ä¹¦çš„è·¯å¾„</span></span><br><span class="line">    <span class="built_in">NSData</span> *certData = [<span class="built_in">NSData</span> dataWithContentsOfFile:cerPath];</span><br><span class="line">    <span class="built_in">NSSet</span> *set = [<span class="built_in">NSSet</span> setWithObject:certData];</span><br><span class="line"></span><br><span class="line">    AFSecurityPolicy *securityPolicy;</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">//è¿™é‡Œåªèƒ½ç”¨AFSSLPinningModeNoneæ‰èƒ½æˆåŠŸï¼Œè€Œä¸”æˆ‘ç³»ç»Ÿçš„è¯ä¹¦åˆ—è¡¨é‡Œé¢å·²ç»æœ‰ç™¾åº¦çš„è¯ä¹¦äº†</span></span><br><span class="line">        securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeNone withPinnedCertificates:set];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// AFSSLPinningModeCertificate ä½¿ç”¨è¯ä¹¦éªŒè¯æ¨¡å¼ã€‚ä¸‹é¢è¿™ä¸ªæ–¹æ³•ä¼šé»˜è®¤ä½¿ç”¨é¡¹ç›®é‡Œé¢çš„æ‰€æœ‰è¯ä¹¦</span></span><br><span class="line">        securityPolicy = [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeNone];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// allowInvalidCertificates æ˜¯å¦å…è®¸æ— æ•ˆè¯ä¹¦ï¼ˆä¹Ÿå°±æ˜¯è‡ªå»ºçš„è¯ä¹¦ï¼‰ï¼Œé»˜è®¤ä¸ºNO</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯éœ€è¦éªŒè¯è‡ªå»ºè¯ä¹¦ï¼Œéœ€è¦è®¾ç½®ä¸ºYES</span></span><br><span class="line">    securityPolicy.allowInvalidCertificates = <span class="literal">NO</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//validatesDomainName æ˜¯å¦éœ€è¦éªŒè¯åŸŸåï¼Œé»˜è®¤ä¸ºYESï¼›</span></span><br><span class="line">    <span class="comment">//å‡å¦‚è¯ä¹¦çš„åŸŸåä¸ä½ è¯·æ±‚çš„åŸŸåä¸ä¸€è‡´ï¼Œéœ€æŠŠè¯¥é¡¹è®¾ç½®ä¸ºNOï¼›å¦‚è®¾æˆNOçš„è¯ï¼Œå³æœåŠ¡å™¨ä½¿ç”¨å…¶ä»–å¯ä¿¡ä»»æœºæ„é¢å‘çš„è¯ä¹¦ï¼Œä¹Ÿå¯ä»¥å»ºç«‹è¿æ¥ï¼Œè¿™ä¸ªéå¸¸å±é™©ï¼Œå»ºè®®æ‰“å¼€ã€‚</span></span><br><span class="line">    <span class="comment">//ç½®ä¸ºNOï¼Œä¸»è¦ç”¨äºè¿™ç§æƒ…å†µï¼šå®¢æˆ·ç«¯è¯·æ±‚çš„æ˜¯å­åŸŸåï¼Œè€Œè¯ä¹¦ä¸Šçš„æ˜¯å¦å¤–ä¸€ä¸ªåŸŸåã€‚å› ä¸ºSSLè¯ä¹¦ä¸Šçš„åŸŸåæ˜¯ç‹¬ç«‹çš„ï¼Œå‡å¦‚è¯ä¹¦ä¸Šæ³¨å†Œçš„åŸŸåæ˜¯www.google.comï¼Œé‚£ä¹ˆmail.google.comæ˜¯æ— æ³•éªŒè¯é€šè¿‡çš„ï¼›å½“ç„¶ï¼Œæœ‰é’±å¯ä»¥æ³¨å†Œé€šé…ç¬¦çš„åŸŸå*.google.comï¼Œä½†è¿™ä¸ªè¿˜æ˜¯æ¯”è¾ƒè´µçš„ã€‚</span></span><br><span class="line">    <span class="comment">//å¦‚ç½®ä¸ºNOï¼Œå»ºè®®è‡ªå·±æ·»åŠ å¯¹åº”åŸŸåçš„æ ¡éªŒé€»è¾‘ã€‚</span></span><br><span class="line">    securityPolicy.validatesDomainName = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> securityPolicy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="SSLè¯ä¹¦AFNé»˜è®¤å¤„ç†"><a href="#SSLè¯ä¹¦AFNé»˜è®¤å¤„ç†" class="headerlink" title="SSLè¯ä¹¦AFNé»˜è®¤å¤„ç†"></a>SSLè¯ä¹¦AFNé»˜è®¤å¤„ç†</h4><p>è¿™é‡Œæˆ‘ä»¬ä¸åšä»»ä½•é¢å¤–çš„å¤„ç†ï¼Œç›´æ¥ä½¿ç”¨AFNçš„é»˜è®¤è¯ä¹¦å¤„ç†æœºåˆ¶ã€‚é€šè¿‡AFURLSessionManagerçš„securityPolicyé»˜è®¤å®ç°ã€‚å®ƒä¼šå’Œå­˜åœ¨ç³»ç»Ÿä¸­çš„åšå¯¹æ¯”æ¥éªŒè¯è¯ä¹¦ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç³»ç»Ÿè¯ä¹¦è®¤è¯</span></span><br><span class="line">- (<span class="keyword">IBAction</span>)button3:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="built_in">NSURL</span> *url = [<span class="built_in">NSURL</span> URLWithString:<span class="string">@"https://www.apple.com/"</span>];</span><br><span class="line">    <span class="built_in">NSMutableURLRequest</span> *request = [<span class="built_in">NSMutableURLRequest</span> requestWithURL:url];</span><br><span class="line">    AFURLSessionManager *manager = [[AFURLSessionManager alloc]initWithSessionConfiguration:[<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration]];</span><br><span class="line">    <span class="comment">//æŒ‡å®šè¿”å›æ•°æ®ç±»å‹,é»˜è®¤æ˜¯AFJSONResponseSerializerç±»å‹ï¼ŒçŠ¹è±«è¿™é‡Œä¸æ˜¯JSONç±»å‹çš„è¿”å›æ•°æ®ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨æŒ‡å®šè¿”å›ç±»å‹</span></span><br><span class="line">    AFHTTPResponseSerializer *responseSerializer = [AFHTTPResponseSerializer serializer];</span><br><span class="line">    responseSerializer.acceptableContentTypes = [<span class="built_in">NSSet</span> setWithObject:<span class="string">@"text/html"</span>];</span><br><span class="line">    manager.responseSerializer = responseSerializer;</span><br><span class="line">    <span class="built_in">NSURLSessionDataTask</span> *dataTask = [manager dataTaskWithRequest:request uploadProgress:<span class="literal">nil</span> downloadProgress:<span class="literal">nil</span> completionHandler:^(<span class="built_in">NSURLResponse</span> * _Nonnull response, <span class="keyword">id</span>  _Nullable responseObject, <span class="built_in">NSError</span> * _Nullable error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@-----%@"</span>,[[<span class="built_in">NSString</span> alloc] initWithData:responseObject encoding:<span class="built_in">NSUTF8StringEncoding</span>],error);</span><br><span class="line">    &#125;];</span><br><span class="line">    [dataTask resume];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="AFSecurityPolicyæºç è§£æ"><a href="#AFSecurityPolicyæºç è§£æ" class="headerlink" title="AFSecurityPolicyæºç è§£æ"></a>AFSecurityPolicyæºç è§£æ</h3><p>AFSecurityPolicyåˆ†ä¸‰ç§éªŒè¯æ¨¡å¼</p><ol><li>AFSSLPinningModeNone:<br>è¿™ä¸ªæ¨¡å¼è¡¨ç¤ºä¸åšSSL pinningï¼Œåªè·Ÿæµè§ˆå™¨ä¸€æ ·åœ¨ç³»ç»Ÿçš„ä¿¡ä»»æœºæ„åˆ—è¡¨é‡ŒéªŒè¯æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦ã€‚è‹¥è¯ä¹¦æ˜¯ä¿¡ä»»æœºæ„ç­¾å‘çš„å°±ä¼šé€šè¿‡ï¼Œè‹¥æ˜¯è‡ªå·±æœåŠ¡å™¨ç”Ÿæˆçš„è¯ä¹¦ï¼Œè¿™é‡Œæ˜¯ä¸ä¼šé€šè¿‡çš„ã€‚</li><li>AFSSLPinningModeCertificate:<br>è¿™ä¸ªæ¨¡å¼è¡¨ç¤ºç”¨è¯ä¹¦ç»‘å®šæ–¹å¼éªŒè¯è¯ä¹¦ï¼Œéœ€è¦å®¢æˆ·ç«¯ä¿å­˜æœ‰æœåŠ¡ç«¯çš„è¯ä¹¦æ‹·è´ï¼Œè¿™é‡ŒéªŒè¯åˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥éªŒè¯è¯ä¹¦çš„åŸŸå/æœ‰æ•ˆæœŸç­‰ä¿¡æ¯ï¼Œç¬¬äºŒæ­¥æ˜¯å¯¹æ¯”æœåŠ¡ç«¯è¿”å›çš„è¯ä¹¦è·Ÿå®¢æˆ·ç«¯è¿”å›çš„æ˜¯å¦ä¸€è‡´ã€‚è¿™é‡Œè¿˜æ²¡å¼„æ˜ç™½ç¬¬ä¸€æ­¥çš„éªŒè¯æ˜¯æ€ä¹ˆè¿›è¡Œçš„ï¼Œä»£ç ä¸Šè·Ÿå»ç³»ç»Ÿä¿¡ä»»æœºæ„åˆ—è¡¨é‡ŒéªŒè¯ä¸€æ ·è°ƒç”¨äº†SecTrustEvaluateï¼Œåªæ˜¯è¿™é‡Œçš„åˆ—è¡¨æ¢æˆäº†å®¢æˆ·ç«¯ä¿å­˜çš„é‚£äº›è¯ä¹¦åˆ—è¡¨ã€‚è‹¥è¦éªŒè¯è¿™ä¸ªï¼Œæ˜¯å¦åº”è¯¥æŠŠæœåŠ¡ç«¯è¯ä¹¦çš„é¢å‘æœºæ„æ ¹è¯ä¹¦ä¹Ÿæ”¾åˆ°å®¢æˆ·ç«¯é‡Œï¼Ÿ</li><li>AFSSLPinningModePublicKey:<br>è¿™ä¸ªæ¨¡å¼åŒæ ·æ˜¯ç”¨è¯ä¹¦ç»‘å®šæ–¹å¼éªŒè¯ï¼Œå®¢æˆ·ç«¯è¦æœ‰æœåŠ¡ç«¯çš„è¯ä¹¦æ‹·è´ï¼Œåªæ˜¯éªŒè¯æ—¶åªéªŒè¯è¯ä¹¦é‡Œçš„å…¬é’¥ï¼Œä¸éªŒè¯è¯ä¹¦çš„æœ‰æ•ˆæœŸç­‰ä¿¡æ¯ã€‚åªè¦å…¬é’¥æ˜¯æ­£ç¡®çš„ï¼Œå°±èƒ½ä¿è¯é€šä¿¡ä¸ä¼šè¢«çªƒå¬ï¼Œå› ä¸ºä¸­é—´äººæ²¡æœ‰ç§é’¥ï¼Œæ— æ³•è§£å¼€é€šè¿‡å…¬é’¥åŠ å¯†çš„æ•°æ®ã€‚</li></ol><p><strong>SecTrustRef</strong><br>è¿™æ˜¯ä¸€ä¸ªéœ€è¦éªŒè¯çš„ä¿¡ä»»å¯¹è±¡,åŒ…å«å¾…éªŒè¯çš„è¯ä¹¦å’Œæ”¯æŒçš„éªŒè¯æ–¹æ³•ç­‰ã€‚</p><p><strong>SecTrustResultType</strong><br>è¡¨ç¤ºéªŒè¯ç»“æœã€‚å…¶ä¸­ kSecTrustResultProceedè¡¨ç¤ºserverTrustéªŒè¯æˆåŠŸï¼Œä¸”è¯¥éªŒè¯å¾—åˆ°äº†ç”¨æˆ·è®¤å¯(ä¾‹å¦‚åœ¨å¼¹å‡ºçš„æ˜¯å¦ä¿¡ä»»çš„alertæ¡†ä¸­é€‰æ‹©always trust)ã€‚ kSecTrustResultUnspecifiedè¡¨ç¤º serverTrustéªŒè¯æˆåŠŸï¼Œæ­¤è¯ä¹¦ä¹Ÿè¢«æš—ä¸­ä¿¡ä»»äº†ï¼Œä½†æ˜¯ç”¨æˆ·å¹¶æ²¡æœ‰æ˜¾ç¤ºåœ°å†³å®šä¿¡ä»»è¯¥è¯ä¹¦ã€‚ ä¸¤è€…å–å…¶ä¸€å°±å¯ä»¥è®¤ä¸ºå¯¹serverTrustéªŒè¯æˆåŠŸã€‚</p><p><strong>SecTrustEvaluate</strong><br>è¯ä¹¦æ ¡éªŒå‡½æ•°,åœ¨å‡½æ•°çš„å†…éƒ¨é€’å½’åœ°ä»å¶èŠ‚ç‚¹è¯ä¹¦åˆ°æ ¹è¯ä¹¦éªŒè¯ã€‚éœ€è¦éªŒè¯è¯ä¹¦æœ¬èº«çš„åˆæ³•æ€§ï¼ˆéªŒè¯ç­¾åå®Œæ•´æ€§ï¼ŒéªŒè¯è¯ä¹¦æœ‰æ•ˆæœŸç­‰);éªŒè¯è¯ä¹¦é¢å‘è€…çš„åˆæ³•æ€§ï¼ˆæŸ¥æ‰¾é¢å‘è€…çš„è¯ä¹¦å¹¶æ£€æŸ¥å…¶åˆæ³•æ€§ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é€’å½’çš„).è€Œé€’å½’çš„ç»ˆæ­¢æ¡ä»¶æ˜¯è¯ä¹¦éªŒè¯è¿‡ç¨‹ä¸­é‡åˆ°äº†é”šç‚¹è¯ä¹¦(é”šç‚¹è¯ä¹¦:åµŒå…¥åˆ°æ“ä½œç³»ç»Ÿä¸­çš„æ ¹è¯ä¹¦,è¿™ä¸ªæ ¹è¯ä¹¦æ˜¯æƒå¨è¯ä¹¦é¢å‘æœºæ„é¢å‘çš„è‡ªç­¾åè¯ä¹¦)ã€‚</p><p>AFSecurityPolicyçš„æºç ç»†èŠ‚å¦‚ä¸‹ï¼š</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è¯ä¹¦çš„éªŒè¯ç±»å‹</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> - AFSSLPinningModeNone: ä¸ä½¿ç”¨`pinned certificates`æ¥éªŒè¯è¯ä¹¦</span></span><br><span class="line"><span class="comment"> - AFSSLPinningModePublicKey: ä½¿ç”¨`pinned certificates`æ¥éªŒè¯è¯ä¹¦çš„å…¬é’¥</span></span><br><span class="line"><span class="comment"> - AFSSLPinningModeCertificate: ä½¿ç”¨`pinned certificates`æ¥éªŒè¯æ•´ä¸ªè¯ä¹¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NS_ENUM</span>(<span class="built_in">NSUInteger</span>, AFSSLPinningMode) &#123;</span><br><span class="line">    AFSSLPinningModeNone,</span><br><span class="line">    AFSSLPinningModePublicKey,</span><br><span class="line">    AFSSLPinningModeCertificate,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è·å–æŒ‡å®šè¯ä¹¦çš„å…¬é’¥</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param certificate è¯ä¹¦æ•°æ®</span></span><br><span class="line"><span class="comment"> @return å…¬é’¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> AFPublicKeyForCertificate(<span class="built_in">NSData</span> *certificate) &#123;</span><br><span class="line">    <span class="keyword">id</span> allowedPublicKey = <span class="literal">nil</span>;</span><br><span class="line">    SecCertificateRef allowedCertificate;</span><br><span class="line">    SecPolicyRef policy = <span class="literal">nil</span>;</span><br><span class="line">    SecTrustRef allowedTrust = <span class="literal">nil</span>;</span><br><span class="line">    SecTrustResultType result;</span><br><span class="line">    <span class="comment">//è·å–è¯ä¹¦å¯¹è±¡</span></span><br><span class="line">    allowedCertificate = SecCertificateCreateWithData(<span class="literal">NULL</span>, (__bridge <span class="built_in">CFDataRef</span>)certificate);</span><br><span class="line">    __Require_Quiet(allowedCertificate != <span class="literal">NULL</span>, _<span class="keyword">out</span>);</span><br><span class="line">    <span class="comment">//è·å–X.509çš„è®¤è¯ç­–ç•¥</span></span><br><span class="line">    policy = SecPolicyCreateBasicX509();</span><br><span class="line">    <span class="comment">//è·å–allowedTrustå¯¹è±¡çš„å€¼</span></span><br><span class="line">    __Require_noErr_Quiet(SecTrustCreateWithCertificates(allowedCertificate, policy, &amp;allowedTrust), _<span class="keyword">out</span>);</span><br><span class="line">    __Require_noErr_Quiet(SecTrustEvaluate(allowedTrust, &amp;result), _<span class="keyword">out</span>);</span><br><span class="line">    <span class="comment">//æ ¹æ®allowedTrustè·å–å¯¹åº”çš„å…¬é’¥</span></span><br><span class="line">    allowedPublicKey = (__bridge_transfer <span class="keyword">id</span>)SecTrustCopyPublicKey(allowedTrust);</span><br><span class="line"><span class="comment">//C++çš„gumptoè·³è½¬ï¼Œå½“å‰é¢çš„æ“ä½œå‡ºé”™ä»¥åï¼Œç›´æ¥è·³å…¥_outæ‰§è¡Œ</span></span><br><span class="line">_<span class="keyword">out</span>:</span><br><span class="line">    <span class="keyword">if</span> (allowedTrust) &#123;</span><br><span class="line">        <span class="built_in">CFRelease</span>(allowedTrust);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (policy) &#123;</span><br><span class="line">        <span class="built_in">CFRelease</span>(policy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (allowedCertificate) &#123;</span><br><span class="line">        <span class="built_in">CFRelease</span>(allowedCertificate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›å…¬é’¥</span></span><br><span class="line">    <span class="keyword">return</span> allowedPublicKey;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> åœ¨æŒ‡å®šçš„è¯ä¹¦å’Œè®¤è¯ç­–ç•¥ä¸‹ï¼ŒéªŒè¯SecTrustRefå¯¹è±¡æ˜¯å¦æ˜¯å—ä¿¡ä»»çš„ã€åˆæ³•çš„ã€‚</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param serverTrust SecTrustRefå¯¹è±¡</span></span><br><span class="line"><span class="comment"> @return ç»“æœ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">BOOL</span> AFServerTrustIsValid(SecTrustRef serverTrust) &#123;</span><br><span class="line">    <span class="built_in">BOOL</span> isValid = <span class="literal">NO</span>;</span><br><span class="line">    SecTrustResultType result;</span><br><span class="line">    <span class="comment">//è·å–serverTrustçš„è®¤è¯ç»“æœï¼Œè°ƒç”¨`SecTrustEvaluate`è¡¨ç¤ºé€šè¿‡ç³»ç»Ÿçš„è¯ä¹¦æ¥æ¯”è¾ƒè®¤è¯</span></span><br><span class="line">    __Require_noErr_Quiet(SecTrustEvaluate(serverTrust, &amp;result), _<span class="keyword">out</span>);</span><br><span class="line">    isValid = (result == kSecTrustResultUnspecified || result == kSecTrustResultProceed);</span><br><span class="line"></span><br><span class="line">_<span class="keyword">out</span>:</span><br><span class="line">    <span class="keyword">return</span> isValid;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ ¹æ®`serverTrust`è·å–è®¤è¯çš„è¯ä¹¦é“¾</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param serverTrust serverTrustå¯¹è±¡</span></span><br><span class="line"><span class="comment"> @return è®¤è¯è¯ä¹¦é“¾</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * AFCertificateTrustChainForServerTrust(SecTrustRef serverTrust) &#123;</span><br><span class="line">    <span class="comment">//è·å–è®¤è¯é“¾çš„æ€»å±‚æ¬¡</span></span><br><span class="line">    <span class="built_in">CFIndex</span> certificateCount = SecTrustGetCertificateCount(serverTrust);</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *trustChain = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:(<span class="built_in">NSUInteger</span>)certificateCount];</span><br><span class="line">    <span class="comment">//è·å–æ¯ä¸€çº§è®¤è¯é“¾ï¼ŒæŠŠè·å–çš„è¯ä¹¦æ•°æ®å­˜å…¥æ•°ç»„ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">CFIndex</span> i = <span class="number">0</span>; i &lt; certificateCount; i++) &#123;</span><br><span class="line">        SecCertificateRef certificate = SecTrustGetCertificateAtIndex(serverTrust, i);</span><br><span class="line">        [trustChain addObject:(__bridge_transfer <span class="built_in">NSData</span> *)SecCertificateCopyData(certificate)];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›è¯ä¹¦é“¾æ•°ç»„</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSArray</span> arrayWithArray:trustChain];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è·å–serverTrustå¯¹è±¡çš„è®¤è¯é“¾çš„å…¬é’¥æ•°ç»„</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param serverTrust serverTrustå¯¹è±¡</span></span><br><span class="line"><span class="comment"> @return å…¬é’¥æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSArray</span> * AFPublicKeyTrustChainForServerTrust(SecTrustRef serverTrust) &#123;</span><br><span class="line">    <span class="comment">//X.509æ ‡å‡†çš„å®‰å…¨ç­–ç•¥</span></span><br><span class="line">    SecPolicyRef policy = SecPolicyCreateBasicX509();</span><br><span class="line">    <span class="comment">//è·å–è¯ä¹¦é“¾çš„è¯ä¹¦æ•°é‡</span></span><br><span class="line">    <span class="built_in">CFIndex</span> certificateCount = SecTrustGetCertificateCount(serverTrust);</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *trustChain = [<span class="built_in">NSMutableArray</span> arrayWithCapacity:(<span class="built_in">NSUInteger</span>)certificateCount];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">CFIndex</span> i = <span class="number">0</span>; i &lt; certificateCount; i++) &#123;</span><br><span class="line">        SecCertificateRef certificate = SecTrustGetCertificateAtIndex(serverTrust, i);</span><br><span class="line"></span><br><span class="line">        SecCertificateRef someCertificates[] = &#123;certificate&#125;;</span><br><span class="line">        <span class="built_in">CFArrayRef</span> certificates = <span class="built_in">CFArrayCreate</span>(<span class="literal">NULL</span>, (<span class="keyword">const</span> <span class="keyword">void</span> **)someCertificates, <span class="number">1</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        SecTrustRef trust;</span><br><span class="line">        <span class="comment">//é€šè¿‡ä¸€ä¸ªè¯ä¹¦ã€è®¤è¯ç­–ç•¥æ–°å»ºä¸€ä¸ªSecTrustRefå¯¹è±¡</span></span><br><span class="line">        __Require_noErr_Quiet(SecTrustCreateWithCertificates(certificates, policy, &amp;trust), _<span class="keyword">out</span>);</span><br><span class="line"></span><br><span class="line">        SecTrustResultType result;</span><br><span class="line">        <span class="comment">//éªŒè¯SecTrustRefå¯¹è±¡æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">        __Require_noErr_Quiet(SecTrustEvaluate(trust, &amp;result), _<span class="keyword">out</span>);</span><br><span class="line">        <span class="comment">//æŠŠSecTrustRefå¯¹åº”çš„å…¬é’¥åŠ å…¥æ•°ç»„ä¸­</span></span><br><span class="line">        [trustChain addObject:(__bridge_transfer <span class="keyword">id</span>)SecTrustCopyPublicKey(trust)];</span><br><span class="line"></span><br><span class="line">    _<span class="keyword">out</span>:</span><br><span class="line">        <span class="keyword">if</span> (trust) &#123;</span><br><span class="line">            <span class="built_in">CFRelease</span>(trust);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (certificates) &#123;</span><br><span class="line">            <span class="built_in">CFRelease</span>(certificates);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CFRelease</span>(policy);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSArray</span> arrayWithArray:trustChain];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFSecurityPolicy</span>()</span></span><br><span class="line"><span class="comment">//è®¤è¯ç­–ç•¥</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) AFSSLPinningMode SSLPinningMode;</span><br><span class="line"><span class="comment">//å…¬é’¥é›†åˆ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSSet</span> *pinnedPublicKeys;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFSecurityPolicy</span></span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ä»MainBundleä¸­è·å–æ‰€æœ‰è¯ä¹¦</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param bundle è¿”å›åŒ…å«åœ¨bundleä¸­çš„è¯ä¹¦é›†åˆã€‚å¦‚æœAFNetworkingä½¿ç”¨çš„æ˜¯é™æ€åº“ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥åŠ è½½è¯ä¹¦ã€‚å¹¶ä¸”é€šè¿‡`policyWithPinningMode:withPinnedCertificates`æ–¹æ³•æ¥æŒ‡å®šè®¤è¯ç±»å‹ã€‚</span></span><br><span class="line"><span class="comment"> @return è¿”å›bundleé‡Œé¢çš„è¯ä¹¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="built_in">NSSet</span> *)certificatesInBundle:(<span class="built_in">NSBundle</span> *)bundle &#123;</span><br><span class="line">    <span class="comment">//è·å–é¡¹ç›®é‡Œçš„æ‰€æœ‰.cerè¯ä¹¦</span></span><br><span class="line">    <span class="built_in">NSArray</span> *paths = [bundle pathsForResourcesOfType:<span class="string">@"cer"</span> inDirectory:<span class="string">@"."</span>];</span><br><span class="line">    <span class="built_in">NSMutableSet</span> *certificates = [<span class="built_in">NSMutableSet</span> setWithCapacity:[paths count]];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSString</span> *path <span class="keyword">in</span> paths) &#123;</span><br><span class="line">        <span class="comment">//è·å–è¯ä¹¦å¯¹åº”çš„NSDataï¼Œå¹¶ä¸”åŠ å…¥é›†åˆä¸­</span></span><br><span class="line">        <span class="built_in">NSData</span> *certificateData = [<span class="built_in">NSData</span> dataWithContentsOfFile:path];</span><br><span class="line">        [certificates addObject:certificateData];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¿”å›è¯ä¹¦é›†åˆ</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithSet:certificates];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è¿”å›å½“å‰ç±»æ‰€åœ¨bundleæ‰€åœ¨çš„è¯ä¹¦é›†åˆ</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return è¯ä¹¦é›†åˆ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="built_in">NSSet</span> *)defaultPinnedCertificates &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSSet</span> *_defaultPinnedCertificates = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        <span class="comment">//è·å–å½“å‰ç±»æ‰€åœ¨bundle</span></span><br><span class="line">        <span class="built_in">NSBundle</span> *bundle = [<span class="built_in">NSBundle</span> bundleForClass:[<span class="keyword">self</span> <span class="keyword">class</span>]];</span><br><span class="line">        _defaultPinnedCertificates = [<span class="keyword">self</span> certificatesInBundle:bundle];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> _defaultPinnedCertificates;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> è¿”å›é»˜è®¤çš„å®‰å…¨è®¤è¯ç­–ç•¥,åœ¨è¿™é‡Œæ˜¯éªŒè¯ç³»ç»Ÿçš„è¯ä¹¦ã€‚è¿™ä¸ªç­–ç•¥ä¸å…è®¸éæ³•è¯ä¹¦ã€éªŒè¯ä¸»æœºåã€ä¸éªŒè¯è¯ä¹¦å†…å®¹å’Œå…¬é’¥</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @return è¿”å›è®¤è¯ç­–ç•¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)defaultPolicy &#123;</span><br><span class="line">    AFSecurityPolicy *securityPolicy = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    securityPolicy.SSLPinningMode = AFSSLPinningModeNone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> securityPolicy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> æ ¹æ®æŒ‡å®šçš„è®¤è¯ç­–ç•¥å’Œé»˜è®¤çš„è¯ä¹¦åˆ—è¡¨åˆå§‹åŒ–ä¸€ä¸ª`AFSecurityPolicy`å¯¹è±¡</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param pinningMode è®¤è¯ç­–ç•¥</span></span><br><span class="line"><span class="comment"> @return `AFSecurityPolicy`å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)policyWithPinningMode:(AFSSLPinningMode)pinningMode &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> policyWithPinningMode:pinningMode withPinnedCertificates:[<span class="keyword">self</span> defaultPinnedCertificates]];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> é€šè¿‡åˆ¶å®šçš„è®¤è¯ç­–ç•¥`pinningMode`å’Œè¯ä¹¦é›†åˆ`pinnedCertificates`æ¥åˆå§‹åŒ–ä¸€ä¸ª`AFSecurityPolicy`å¯¹è±¡</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param pinningMode è®¤è¯æ¨¡å‹</span></span><br><span class="line"><span class="comment"> @param pinnedCertificates è¯ä¹¦é›†åˆ</span></span><br><span class="line"><span class="comment"> @return AFSecurityPolicyå¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="keyword">instancetype</span>)policyWithPinningMode:(AFSSLPinningMode)pinningMode withPinnedCertificates:(<span class="built_in">NSSet</span> *)pinnedCertificates &#123;</span><br><span class="line">    AFSecurityPolicy *securityPolicy = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    securityPolicy.SSLPinningMode = pinningMode;</span><br><span class="line">    <span class="comment">//è®¾ç½®`_pinnedCertificates`å’Œ`pinnedPublicKeys`å±æ€§ï¼Œåˆ†åˆ«å¯¹åº”è¯ä¹¦é›†åˆå’Œå…¬é’¥é›†åˆ</span></span><br><span class="line">    [securityPolicy setPinnedCertificates:pinnedCertificates];</span><br><span class="line">    <span class="comment">//è¿”å›åˆå§‹åŒ–æˆåŠŸçš„`AFSecurityPolicy`</span></span><br><span class="line">    <span class="keyword">return</span> securityPolicy;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//é»˜è®¤æ˜¯è¦è®¤è¯ä¸»æœºåç§°</span></span><br><span class="line">    <span class="keyword">self</span>.validatesDomainName = <span class="literal">YES</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">é€šè¿‡æŒ‡å®šçš„è¯ä¹¦ç»“åˆè·å–åˆ°å¯¹åº”çš„å…¬é’¥é›†åˆã€‚ç„¶åèµ‹å€¼ç»™`pinnedPublicKeys`å±æ€§</span></span><br><span class="line"><span class="comment"> @param pinnedCertificates è¯ä¹¦é›†åˆ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)setPinnedCertificates:(<span class="built_in">NSSet</span> *)pinnedCertificates &#123;</span><br><span class="line">    _pinnedCertificates = pinnedCertificates;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.pinnedCertificates) &#123;</span><br><span class="line">        <span class="built_in">NSMutableSet</span> *mutablePinnedPublicKeys = [<span class="built_in">NSMutableSet</span> setWithCapacity:[<span class="keyword">self</span>.pinnedCertificates count]];</span><br><span class="line">        <span class="comment">//è¿­ä»£æ¯ä¸€ä¸ªè¯ä¹¦</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSData</span> *certificate <span class="keyword">in</span> <span class="keyword">self</span>.pinnedCertificates) &#123;</span><br><span class="line">            <span class="comment">//è·å–è¯ä¹¦å¯¹åº”çš„å…¬é’¥</span></span><br><span class="line">            <span class="keyword">id</span> publicKey = AFPublicKeyForCertificate(certificate);</span><br><span class="line">            <span class="keyword">if</span> (!publicKey) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            [mutablePinnedPublicKeys addObject:publicKey];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//èµ‹å€¼ç»™å¯¹åº”çš„å±æ€§</span></span><br><span class="line">        <span class="keyword">self</span>.pinnedPublicKeys = [<span class="built_in">NSSet</span> setWithSet:mutablePinnedPublicKeys];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.pinnedPublicKeys = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> ä¸ºserverTrustå¯¹è±¡æŒ‡å®šè®¤è¯ç­–ç•¥ï¼Œå¦‚æœdomainä¸ä¸ºnil,åˆ™åŒ…æ‹¬å¯¹ä¸»æœºåçš„è®¤è¯ã€‚è¿™ä¸ªæ–¹æ³•å¿…é¡»åœ¨æ¥å—åˆ°`authentication challenge`è¿”å›çš„æ—¶å€™è°ƒç”¨ã€‚</span></span><br><span class="line"><span class="comment"> SecTrustRefå¯ä»¥ç†è§£ä¸ºæ¡¥æ¥è¯ä¹¦ä¸è®¤è¯ç­–ç•¥çš„å¯¹è±¡ï¼Œä»–å…³è”æŒ‡å®šçš„è¯ä¹¦ä¸è®¤è¯ç­–ç•¥</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> @param serverTrust æœåŠ¡å™¨çš„X.509æ ‡å‡†çš„è¯ä¹¦æ•°æ®</span></span><br><span class="line"><span class="comment"> @param domain è®¤è¯æœåŠ¡å™¨çš„ä¸»æœºåã€‚å¦‚æœæ˜¯nil,åˆ™ä¸ä¼šå¯¹ä¸»æœºåè¿›è¡Œè®¤è¯ã€‚</span></span><br><span class="line"><span class="comment"> @return serverTrustæ˜¯å¦é€šè¿‡è®¤è¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)evaluateServerTrust:(SecTrustRef)serverTrust</span><br><span class="line">                  forDomain:(<span class="built_in">NSString</span> *)domain</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (domain &amp;&amp; <span class="keyword">self</span>.allowInvalidCertificates &amp;&amp; <span class="keyword">self</span>.validatesDomainName &amp;&amp; (<span class="keyword">self</span>.SSLPinningMode == AFSSLPinningModeNone || [<span class="keyword">self</span>.pinnedCertificates count] == <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// https://developer.apple.com/library/mac/documentation/NetworkingInternet/Conceptual/NetworkingTopics/Articles/OverridingSSLChainValidationCorrectly.html</span></span><br><span class="line">        <span class="comment">//  According to the docs, you should only trust your provided certs for evaluation.</span></span><br><span class="line">        <span class="comment">//  Pinned certificates are added to the trust. Without pinned certificates,</span></span><br><span class="line">        <span class="comment">//  there is nothing to evaluate against.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//  From Apple Docs:</span></span><br><span class="line">        <span class="comment">//          "Do not implicitly trust self-signed certificates as anchors (kSecTrustOptionImplicitAnchors).</span></span><br><span class="line">        <span class="comment">//           Instead, add your own (self-signed) CA certificate to the list of trusted anchors."</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"In order to validate a domain name for self signed certificates, you MUST use pinning."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSMutableArray</span> *policies = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.validatesDomainName) &#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨éœ€è¦è®¤è¯ä¸»æœºåçš„è®¤è¯ç­–ç•¥</span></span><br><span class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateSSL(<span class="literal">true</span>, (__bridge <span class="built_in">CFStringRef</span>)domain)];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨é»˜è®¤çš„è®¤è¯ç­–ç•¥</span></span><br><span class="line">        [policies addObject:(__bridge_transfer <span class="keyword">id</span>)SecPolicyCreateBasicX509()];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//ç»™serverTrustå¯¹è±¡æŒ‡å®šè®¤è¯ç­–ç•¥</span></span><br><span class="line">    SecTrustSetPolicies(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)policies);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.SSLPinningMode == AFSSLPinningModeNone) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>.allowInvalidCertificates || AFServerTrustIsValid(serverTrust);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust) &amp;&amp; !<span class="keyword">self</span>.allowInvalidCertificates) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ ¹æ®è¯ä¹¦éªŒè¯ç­–ç•¥ã€æ•°å­—ç­¾åè®¤è¯ç­–ç•¥ã€å…¶ä»–è®¤è¯ç­–ç•¥æ¥å¤„ç†ä¸åŒæƒ…å†µ</span></span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">self</span>.SSLPinningMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModeNone:<span class="comment">//ä¸éªŒè¯å…¬é’¥å’Œè¯ä¹¦</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModeCertificate: &#123;<span class="comment">//éªŒè¯æ•´ä¸ªè¯ä¹¦</span></span><br><span class="line">            <span class="built_in">NSMutableArray</span> *pinnedCertificates = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">            <span class="comment">//æ ¹æ®æŒ‡å®šè¯ä¹¦è·å–ï¼Œè·å–å¯¹åº”çš„è¯ä¹¦å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *certificateData <span class="keyword">in</span> <span class="keyword">self</span>.pinnedCertificates) &#123;</span><br><span class="line">                [pinnedCertificates addObject:(__bridge_transfer <span class="keyword">id</span>)SecCertificateCreateWithData(<span class="literal">NULL</span>, (__bridge <span class="built_in">CFDataRef</span>)certificateData)];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æŠŠè¯ä¹¦ä¸serverTrustå…³è”èµ·æ¥</span></span><br><span class="line">            SecTrustSetAnchorCertificates(serverTrust, (__bridge <span class="built_in">CFArrayRef</span>)pinnedCertificates);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!AFServerTrustIsValid(serverTrust)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// obtain the chain after being validated, which *should* contain the pinned certificate in the last position (if it's the Root CA)</span></span><br><span class="line">            <span class="comment">//è·å–serverTrustè¯ä¹¦é“¾ã€‚ç›´åˆ°æ ¹è¯ä¹¦ã€‚</span></span><br><span class="line">            <span class="built_in">NSArray</span> *serverCertificates = AFCertificateTrustChainForServerTrust(serverTrust);</span><br><span class="line">            <span class="comment">//å¦‚æœ`pinnedCertificates`åŒ…å«`serverTrust`å¯¹è±¡å¯¹åº”çš„è¯ä¹¦é“¾çš„æ ¹è¯ä¹¦ã€‚åˆ™è¿”å›true</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">NSData</span> *trustChainCertificate <span class="keyword">in</span> [serverCertificates reverseObjectEnumerator]) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([<span class="keyword">self</span>.pinnedCertificates containsObject:trustChainCertificate]) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">case</span> AFSSLPinningModePublicKey: &#123;<span class="comment">//åªéªŒè¯è¯ä¹¦é‡Œé¢çš„æ•°å­—ç­¾å</span></span><br><span class="line">            <span class="built_in">NSUInteger</span> trustedPublicKeyCount = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//æ ¹æ®serverTrustå¯¹è±¡å’ŒSecPolicyCreateBasicX509è®¤è¯ç­–ç•¥ï¼Œè·å–å¯¹åº”çš„å…¬é’¥é›†åˆ</span></span><br><span class="line">            <span class="built_in">NSArray</span> *publicKeys = AFPublicKeyTrustChainForServerTrust(serverTrust);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">id</span> trustChainPublicKey <span class="keyword">in</span> publicKeys) &#123;</span><br><span class="line">                <span class="comment">//æŠŠè·å–çš„å…¬é’¥å’Œç³»ç»Ÿè·å–çš„é»˜è®¤å…¬é’¥æ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™é€šè¿‡è®¤è¯</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">id</span> pinnedPublicKey <span class="keyword">in</span> <span class="keyword">self</span>.pinnedPublicKeys) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (AFSecKeyIsEqualToKey((__bridge SecKeyRef)trustChainPublicKey, (__bridge SecKeyRef)pinnedPublicKey)) &#123;</span><br><span class="line">                        trustedPublicKeyCount += <span class="number">1</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> trustedPublicKeyCount &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSKeyValueObserving</span></span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSSet</span> *)keyPathsForValuesAffectingPinnedPublicKeys &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithObject:<span class="string">@"pinnedCertificates"</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSSecureCoding</span></span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">BOOL</span>)supportsSecureCoding &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)decoder &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">self</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.SSLPinningMode = [[decoder decodeObjectOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>] forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(SSLPinningMode))] unsignedIntegerValue];</span><br><span class="line">    <span class="keyword">self</span>.allowInvalidCertificates = [decoder decodeBoolForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowInvalidCertificates))];</span><br><span class="line">    <span class="keyword">self</span>.validatesDomainName = [decoder decodeBoolForKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(validatesDomainName))];</span><br><span class="line">    <span class="keyword">self</span>.pinnedCertificates = [decoder decodeObjectOfClass:[<span class="built_in">NSArray</span> <span class="keyword">class</span>] forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(pinnedCertificates))];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)coder &#123;</span><br><span class="line">    [coder encodeObject:[<span class="built_in">NSNumber</span> numberWithUnsignedInteger:<span class="keyword">self</span>.SSLPinningMode] forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(SSLPinningMode))];</span><br><span class="line">    [coder encodeBool:<span class="keyword">self</span>.allowInvalidCertificates forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(allowInvalidCertificates))];</span><br><span class="line">    [coder encodeBool:<span class="keyword">self</span>.validatesDomainName forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(validatesDomainName))];</span><br><span class="line">    [coder encodeObject:<span class="keyword">self</span>.pinnedCertificates forKey:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(pinnedCertificates))];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#pragma mark - NSCopying</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)copyWithZone:(<span class="built_in">NSZone</span> *)zone &#123;</span><br><span class="line">    AFSecurityPolicy *securityPolicy = [[[<span class="keyword">self</span> <span class="keyword">class</span>] allocWithZone:zone] init];</span><br><span class="line">    securityPolicy.SSLPinningMode = <span class="keyword">self</span>.SSLPinningMode;</span><br><span class="line">    securityPolicy.allowInvalidCertificates = <span class="keyword">self</span>.allowInvalidCertificates;</span><br><span class="line">    securityPolicy.validatesDomainName = <span class="keyword">self</span>.validatesDomainName;</span><br><span class="line">    securityPolicy.pinnedCertificates = [<span class="keyword">self</span>.pinnedCertificates copyWithZone:zone];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> securityPolicy;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;AFNetWorking æ˜¯é ç€ AFSecurityPolicy è¿™ä¸ªç±»ä¿è¯æ•°æ®å®‰å…¨çš„ï¼ŒAFSecurityPolicy å…¶å®å°±æ˜¯éªŒè¯è¯ä¹¦æ˜¯å¦æ­£ç¡®çš„ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://nixzhang5.github.io/categories/iOS/"/>
    
    
      <category term="AFNetWorkingåŸç†" scheme="https://nixzhang5.github.io/tags/AFNetWorking%E5%8E%9F%E7%90%86/"/>
    
      <category term="Encryption" scheme="https://nixzhang5.github.io/tags/Encryption/"/>
    
  </entry>
  
  <entry>
    <title>AFNetWorkingåŸç†(ä¸€) AFURLSessionManagerè§£è¯»</title>
    <link href="https://nixzhang5.github.io/AFNetWorking%E5%8E%9F%E7%90%86.html"/>
    <id>https://nixzhang5.github.io/AFNetWorkingåŸç†.html</id>
    <published>2019-06-21T07:48:30.000Z</published>
    <updated>2019-06-25T03:19:09.896Z</updated>
    
    <content type="html"><![CDATA[<p>NSURLSession æ˜¯ iOS7 æ—¶æ¨å‡ºçš„ï¼Œä¸ºäº†å–ä»£ NSURLConnectionï¼ˆåœ¨iOS9åºŸå¼ƒï¼‰ï¼ŒAFNetWorkingä½¿ç”¨ NSURLSession ä½œä¸ºåŸºç¡€çš„ç½‘ç»œè¯·æ±‚ç±»ã€‚NSURLSession å·¥ä½œåœ¨åœ¨ OSI ä¸ƒå±‚æ¨¡å‹ çš„ä¼šè¯å±‚ï¼Œä¼šè¯å±‚ä¹‹ä¸‹çš„æ‰€æœ‰å·¥ä½œï¼Œç³»ç»Ÿéƒ½å·²ç»å¸®æˆ‘ä»¬åšå¥½äº†ï¼Œæ‰€ä»¥ NSURLSession å¯ä»¥ç†è§£ä¸ºä¼šè¯ã€‚</p><a id="more"></a><h3 id="AFNetworkingç”±5ä¸ªæ¨¡å—ç»„æˆ"><a href="#AFNetworkingç”±5ä¸ªæ¨¡å—ç»„æˆ" class="headerlink" title="AFNetworkingç”±5ä¸ªæ¨¡å—ç»„æˆ"></a>AFNetworkingç”±5ä¸ªæ¨¡å—ç»„æˆ</h3><ol><li>NSURLSessionï¼šç½‘ç»œé€šä¿¡æ¨¡å—ï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰<ol><li>AFURLSessionManager å¯¹NSURLSessionçš„å°è£…</li><li>AFHTTPSessionManager æ˜¯ç»§æ‰¿äº AFURLSessionmanager</li></ol></li><li>Securityï¼šç½‘ç»œé€šè®¯å®‰å…¨ç­–ç•¥æ¨¡å—<ol><li>AFSecurityPolicy</li></ol></li><li>Reachabilityï¼šç½‘ç»œçŠ¶æ€ç›‘å¬æ¨¡å—<ol><li>AFNetworkReachabilityManager</li></ol></li><li>Seriaalizationï¼šç½‘ç»œé€šä¿¡ä¿¡æ¯åºåˆ—åŒ–ã€ååºåˆ—åŒ–æ¨¡å—<ol><li>AFHTTPRequestSerializer</li><li>AFURLResponseSerialization</li></ol></li><li>UIKitï¼šå¯¹äºiOS UIKitçš„æ‰©å±•åº“</li></ol><h3 id="ç½‘ç»œè¯·æ±‚ç±»-AFURLSessionManager"><a href="#ç½‘ç»œè¯·æ±‚ç±»-AFURLSessionManager" class="headerlink" title="ç½‘ç»œè¯·æ±‚ç±» AFURLSessionManager"></a>ç½‘ç»œè¯·æ±‚ç±» AFURLSessionManager</h3><h4 id="å£°æ˜-hæ–‡ä»¶"><a href="#å£°æ˜-hæ–‡ä»¶" class="headerlink" title="å£°æ˜.hæ–‡ä»¶"></a>å£°æ˜.hæ–‡ä»¶</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AFURLSessionManagerç±»å®ç°äº†NSURLSessionç›¸å…³çš„ä¼—å¤šåè®®ï¼Œç”¨äºå¸®åŠ©æˆ‘ä»¬è¿›è¡Œæ•°æ®çš„å¤„ç†</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFURLSessionManager</span> : <span class="title">NSObject</span> &lt;<span class="title">NSURLSessionDelegate</span>, <span class="title">NSURLSessionTaskDelegate</span>, <span class="title">NSURLSessionDataDelegate</span>, <span class="title">NSURLSessionDownloadDelegate</span>, <span class="title">NSSecureCoding</span>, <span class="title">NSCopying</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// NSURLSession ä½œä¸ºä¸€ä¸ªå®ä¾‹å˜é‡ï¼ŒAFNå‘èµ·çš„ç½‘ç»œè¯·æ±‚éƒ½æ˜¯é€šè¿‡è¯¥sessionåˆ›å»ºçš„taskå®ç°çš„</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSURLSession</span> *session;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSURLSession delegateæ–¹æ³•æ‰§è¡Œé˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSOperationQueue</span> *operationQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å“åº”åºåˆ—åŒ– ä¸èƒ½ä¸ºnil</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="keyword">id</span> &lt;AFURLResponseSerialization&gt; responseSerializer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®‰å…¨ç­–ç•¥ï¼Œç”¨äºhttpsç­‰éœ€è¦éªŒè¯çš„åœ°æ–¹</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFSecurityPolicy *securityPolicy;</span><br><span class="line"></span><br><span class="line"><span class="meta">#if !TARGET_OS_WATCHï¼ˆç”Ÿæˆçš„ä»£ç å°†åœ¨Apple Watchæ“ä½œç³»ç»Ÿä¸‹è¿è¡Œï¼‰</span></span><br><span class="line"><span class="comment">///--------------------------------------</span></span><br><span class="line"><span class="comment">/// @name Monitoring Network Reachability</span></span><br><span class="line"><span class="comment">///--------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘æµ‹ç½‘ç»œè¿é€šæ€§ï¼Œä½¿ç”¨AFNetworkReachabilityManager</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) AFNetworkReachabilityManager *reachabilityManager;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///----------------------------</span></span><br><span class="line"><span class="comment">/// @name Getting Session Tasks</span></span><br><span class="line"><span class="comment">///----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// sessionç®¡ç†çš„data upload download taskçš„é›†åˆ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSURLSessionTask</span> *&gt; *tasks;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sessionç®¡ç†çš„data taskçš„é›†åˆ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSURLSessionDataTask</span> *&gt; *dataTasks;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sessionç®¡ç†çš„upload taskçš„é›†åˆ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSURLSessionUploadTask</span> *&gt; *uploadTasks;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sessionç®¡ç†çš„download taskçš„é›†åˆ</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSArray</span> &lt;<span class="built_in">NSURLSessionDownloadTask</span> *&gt; *downloadTasks;</span><br><span class="line"></span><br><span class="line"><span class="comment">///-------------------------------</span></span><br><span class="line"><span class="comment">/// @name Managing Callback Queues</span></span><br><span class="line"><span class="comment">///-------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®Œæˆç½‘ç»œè¯·æ±‚åæ‰§è¡Œå›è°ƒå—çš„é˜Ÿåˆ—ï¼Œå¦‚æœä¸ºnilåˆ™ä½¿ç”¨ä¸»é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) <span class="built_in">dispatch_queue_t</span> completionQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®Œæˆç½‘ç»œè¯·æ±‚åå›è°ƒå—çš„</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">nullable</span>) dispatch_group_t completionGroup;</span><br><span class="line"></span><br><span class="line"><span class="comment">///---------------------------------</span></span><br><span class="line"><span class="comment">/// @name Working Around System Bugs</span></span><br><span class="line"><span class="comment">///---------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// backgroundç±»å‹çš„sessionæ˜¯å¦å°è¯•é‡æ–°åˆ›å»ºä¸Šä¼ ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> attemptsToRecreateUploadTasksForBackgroundSessions;</span><br><span class="line"></span><br><span class="line"><span class="comment">///---------------------</span></span><br><span class="line"><span class="comment">/// @name Initialization</span></span><br><span class="line"><span class="comment">///---------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–å‡½æ•°ï¼Œæ ¹æ®æŒ‡å®šNSURLSessionConfigurationåˆ›å»ºsession</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithSessionConfiguration:(<span class="keyword">nullable</span> <span class="built_in">NSURLSessionConfiguration</span> *)configuration <span class="built_in">NS_DESIGNATED_INITIALIZER</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®sessionæ— æ•ˆï¼ŒcancelPendingTasksæ ‡è¯†æ˜¯å¦å–æ¶ˆsessionä¸­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// å†…éƒ¨è¿˜æ˜¯è°ƒç”¨NSURLSessionçš„invalidateæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)invalidateSessionCancelingTasks:(<span class="built_in">BOOL</span>)cancelPendingTasks;</span><br><span class="line"></span><br><span class="line"><span class="comment">///-------------------------</span></span><br><span class="line"><span class="comment">/// @name Running Data Tasks</span></span><br><span class="line"><span class="comment">///-------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®æŒ‡å®šçš„requeståˆ›å»ºä¸€ä¸ªNSURLSessionDataTaskä»»åŠ¡</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                            completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject,  <span class="built_in">NSError</span> * _Nullable error))completionHandler DEPRECATED_ATTRIBUTE;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®æŒ‡å®šçš„requeståˆ›å»ºä¸€ä¸ªNSURLSessionDataTaskä»»åŠ¡</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               uploadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress))uploadProgressBlock</span><br><span class="line">                             downloadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress))downloadProgressBlock</span><br><span class="line">                            completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject,  <span class="built_in">NSError</span> * _Nullable error))completionHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">///---------------------------</span></span><br><span class="line"><span class="comment">/// @name Running Upload Tasks</span></span><br><span class="line"><span class="comment">///---------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®æŒ‡å®šrequest fileURLç­‰å‚æ•°æ„é€ ä¸€ä¸ªNSURLSessionUploadTaskä»»åŠ¡</span></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                         fromFile:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                                         progress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress))uploadProgressBlock</span><br><span class="line">                                completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject, <span class="built_in">NSError</span>  * _Nullable error))completionHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®æŒ‡å®šrequestå’Œdataç­‰å‚æ•°æ„é€ ä¸€ä¸ªä¸Šä¼ ä»»åŠ¡</span></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                         fromData:(<span class="keyword">nullable</span> <span class="built_in">NSData</span> *)bodyData</span><br><span class="line">                                         progress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress))uploadProgressBlock</span><br><span class="line">                                completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject, <span class="built_in">NSError</span> * _Nullable error))completionHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå…·æœ‰ç‰¹å®šæ•°æ®æµçš„NSURLSessionUploadTaskè¯·æ±‚ï¼Œä¸Šä¼ çš„bodyä½¿ç”¨çš„æ˜¯request.HTTPBodyStream</span></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithStreamedRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                                 progress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress))uploadProgressBlock</span><br><span class="line">                                        completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject, <span class="built_in">NSError</span> * _Nullable error))completionHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">///-----------------------------</span></span><br><span class="line"><span class="comment">/// @name Running Download Tasks</span></span><br><span class="line"><span class="comment">///-----------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ ä¸‹è½½ä»»åŠ¡</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                             progress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress))downloadProgressBlock</span><br><span class="line">                                          destination:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> * (^)(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response))destination</span><br><span class="line">                                    completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> * _Nullable filePath, <span class="built_in">NSError</span> * _Nullable error))completionHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æ„é€ ä¸‹è½½ä»»åŠ¡ æ–­ç‚¹ç»­ä¼ </span></span><br><span class="line"><span class="comment">æ ¹æ®æœªä¸‹è½½å®Œæˆçš„æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªNSURLSessionDownloadTaskå¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">resumeDataï¼šæœªå®Œæˆçš„ä¸‹è½½æ•°æ®</span></span><br><span class="line"><span class="comment">destinationï¼šå†³å®šä¸‹è½½æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„çš„blockã€‚blockä¸­æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç›®æ ‡è·¯å¾„å’ŒæœåŠ¡å™¨çš„å“åº”ã€‚åŒæ—¶è¿”å›æ–‡ä»¶ä¸‹è½½çš„URL</span></span><br><span class="line"><span class="comment">completionHandlerï¼šå½“ä»»åŠ¡å®ŒæˆåcompletionHandlerçš„blockä¼šè¢«è°ƒç”¨</span></span><br><span class="line"><span class="comment">progressï¼šä¸‹è½½è¿›åº¦blockã€‚æ¯å½“ä¸‹è½½è¿›åº¦æ›´æ–°æ—¶å°±ä¼šæ‰§è¡Œè¿™ä¸ªblock</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithResumeData:(<span class="built_in">NSData</span> *)resumeData</span><br><span class="line">                                                progress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress))downloadProgressBlock</span><br><span class="line">                                             destination:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> * (^)(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response))destination</span><br><span class="line">                                       completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> * _Nullable filePath, <span class="built_in">NSError</span> * _Nullable error))completionHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">///---------------------------------</span></span><br><span class="line"><span class="comment">/// @name Getting Progress for Tasks</span></span><br><span class="line"><span class="comment">///---------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®NSURLSessionTaskè·å–å¯¹åº”çš„ä»»åŠ¡å®Œæˆè¿›åº¦NSProgress</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSProgress</span> *)uploadProgressForTask:(<span class="built_in">NSURLSessionTask</span> *)task;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®NSURLSessionTaskè·å–å¯¹åº”ä¸‹è½½ä»»åŠ¡çš„è¿›åº¦NSProgress</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="built_in">NSProgress</span> *)downloadProgressForTask:(<span class="built_in">NSURLSessionTask</span> *)task;</span><br><span class="line"></span><br><span class="line"><span class="comment">///-----------------------------------------</span></span><br><span class="line"><span class="comment">/// @name Setting Session Delegate Callbacks</span></span><br><span class="line"><span class="comment">///-----------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®sessionæ— æ•ˆæ—¶æ‰§è¡Œçš„å›è°ƒå—</span></span><br><span class="line">- (<span class="keyword">void</span>)setSessionDidBecomeInvalidBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSError</span> *error))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®sessionæ”¶åˆ°challengeæ—¶æ‰§è¡Œçš„å›è°ƒå—</span></span><br><span class="line">- (<span class="keyword">void</span>)setSessionDidReceiveAuthenticationChallengeBlock:(<span class="keyword">nullable</span> <span class="built_in">NSURLSessionAuthChallengeDisposition</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLAuthenticationChallenge</span> *challenge, <span class="built_in">NSURLCredential</span> * _Nullable __autoreleasing * _Nullable credential))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">///--------------------------------------</span></span><br><span class="line"><span class="comment">/// @name Setting Task Delegate Callbacks</span></span><br><span class="line"><span class="comment">///--------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®sessionéœ€è¦æ–°çš„æµæ—¶æ‰§è¡Œçš„å›è°ƒå—</span></span><br><span class="line">- (<span class="keyword">void</span>)setTaskNeedNewBodyStreamBlock:(<span class="keyword">nullable</span> <span class="built_in">NSInputStream</span> * (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®sessionçš„ä»»åŠ¡éœ€è¦æ‰§è¡Œé‡å®šå‘æ—¶æ‰§è¡Œçš„å›è°ƒå—</span></span><br><span class="line">- (<span class="keyword">void</span>)setTaskWillPerformHTTPRedirectionBlock:(<span class="keyword">nullable</span> <span class="built_in">NSURLRequest</span> * _Nullable (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURLRequest</span> *request))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®Blockç”¨äºå½“ä¸€ä¸ªsessionçš„taskæ¥æ”¶åˆ°è¯ä¹¦éªŒè¯æ—¶è°ƒç”¨ã€‚å®é™…ä¸Šä¾èµ–ç”±NSURLSessionTaskDelegate çš„ URLSession:task:didReceiveChallenge:completionHandler:.æ–¹æ³•å¤„ç†</span></span><br><span class="line">- (<span class="keyword">void</span>)setTaskDidReceiveAuthenticationChallengeBlock:(<span class="keyword">nullable</span> <span class="built_in">NSURLSessionAuthChallengeDisposition</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task, <span class="built_in">NSURLAuthenticationChallenge</span> *challenge, <span class="built_in">NSURLCredential</span> * _Nullable __autoreleasing * _Nullable credential))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®Blockæ¯éš”ä¸€æ®µæ—¶é—´è°ƒç”¨ç”¨æ¥è·Ÿè¸ªä¸Šä¼ è¿›åº¦ï¼Œå®é™…ä¸Šä¾èµ–ç”±NSURLSessionTaskDelegateçš„ URLSession:task:didSendBodyData:totalBytesSent:totalBytesExpectedToSend:æ–¹æ³•å®ç°</span></span><br><span class="line">- (<span class="keyword">void</span>)setTaskDidSendBodyDataBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task, int64_t bytesSent, int64_t totalBytesSent, int64_t totalBytesExpectedToSend))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ä¸€ä¸ªå½“taskå®Œæˆæ—¶è°ƒç”¨çš„Block</span></span><br><span class="line">- (<span class="keyword">void</span>)setTaskDidCompleteBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task, <span class="built_in">NSError</span> * _Nullable error))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">///-------------------------------------------</span></span><br><span class="line"><span class="comment">/// @name Setting Data Task Delegate Callbacks</span></span><br><span class="line"><span class="comment">///-------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ä¸€ä¸ªå½“DataTaskè¯·æ±‚æ¥æ”¶åˆ°å“åº”æ—¶è°ƒç”¨çš„blockã€‚äº¤ç”±NSURLSessionDataDelegateçš„URLSession:dataTask:didReceiveResponse:completionHandler:.æ–¹æ³•å¤„ç†</span></span><br><span class="line">- (<span class="keyword">void</span>)setDataTaskDidReceiveResponseBlock:(<span class="keyword">nullable</span> <span class="built_in">NSURLSessionResponseDisposition</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDataTask</span> *dataTask, <span class="built_in">NSURLResponse</span> *response))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å½“ä¸€ä¸ªdataTaskè½¬å˜æˆdownloadTakæ—¶è°ƒç”¨çš„blockï¼Œäº¤ç”±</span></span><br><span class="line"><span class="built_in">NSURLSessionDataDelegate</span> çš„ URLSession:dataTask:didBecomeDownloadTask:.æ–¹æ³•å¤„ç†</span><br><span class="line">- (<span class="keyword">void</span>)setDataTaskDidBecomeDownloadTaskBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDataTask</span> *dataTask, <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å½“ä¸€ä¸ªdataTaskæ¥å—åˆ°æ•°æ®æ—¶å°±è°ƒç”¨çš„blockï¼Œäº¤ç”±</span></span><br><span class="line"><span class="built_in">NSURLSessionDataDelegate</span> çš„ URLSession:dataTask:didReceiveResponse:completionHandler:.æ–¹æ³•å¤„ç†</span><br><span class="line">- (<span class="keyword">void</span>)setDataTaskDidReceiveDataBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDataTask</span> *dataTask, <span class="built_in">NSData</span> *data))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å½“ä¸€ä¸ªdataTaskå¯¹è¯·æ±‚ç»“æœçš„ç¼“å†²æ—¶çš„blockã€‚äº¤ç”±NSURLSessionDataDelegate çš„ URLSession:dataTask:willCacheResponse:completionHandler:.æ–¹æ³•å¤„ç†</span></span><br><span class="line">- (<span class="keyword">void</span>)setDataTaskWillCacheResponseBlock:(<span class="keyword">nullable</span> <span class="built_in">NSCachedURLResponse</span> * (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDataTask</span> *dataTask, <span class="built_in">NSCachedURLResponse</span> *proposedResponse))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å½“sessionä¸­æ‰€æœ‰æ¶ˆæ¯éƒ½è¢«å‘é€æ—¶ï¼Œè°ƒç”¨çš„blockã€‚äº¤ç”±NSURLSessionDataDelegateçš„URLSessionDidFinishEventsForBackgroundURLSessionï¼šæ–¹æ³•å®ç°</span></span><br><span class="line">- (<span class="keyword">void</span>)setDidFinishEventsForBackgroundURLSessionBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session))block AF_API_UNAVAILABLE(macos);</span><br><span class="line"></span><br><span class="line"><span class="comment">///-----------------------------------------------</span></span><br><span class="line"><span class="comment">/// @name Setting Download Task Delegate Callbacks</span></span><br><span class="line"><span class="comment">///-----------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ä¸€ä¸ªå½“ä¸‹è½½ä»»åŠ¡å®Œæˆä¸€ä¸ªä¸‹è½½æ—¶è°ƒç”¨çš„blockã€‚æœ€ç»ˆäº¤ç”±NSURLSessionDownloadDelegate çš„ URLSession:downloadTask:didFinishDownloadingToURL:.æ–¹æ³•å¤„ç†</span></span><br><span class="line">- (<span class="keyword">void</span>)setDownloadTaskDidFinishDownloadingBlock:(<span class="keyword">nullable</span> <span class="built_in">NSURL</span> * _Nullable  (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask, <span class="built_in">NSURL</span> *location))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®æ¯æ¬¡è¿½è¸ªä¸‹è½½è¿›åº¦æ—¶è°ƒç”¨çš„blockï¼Œæœ€ç»ˆäº¤ç”±NSURLSessionDownloadDelegateçš„URLSession:downloadTask:didWriteData:totalBytesWritten:totalBytesWritten:totalBytesExpectedToWriteï¼šæ–¹æ³•å¤„ç†</span></span><br><span class="line">- (<span class="keyword">void</span>)setDownloadTaskDidWriteDataBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask, int64_t bytesWritten, int64_t totalBytesWritten, int64_t totalBytesExpectedToWrite))block;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®ä¸€ä¸ªblockï¼Œå½“ä»»åŠ¡é‡æ–°ä¸‹è½½æ—¶è°ƒç”¨ã€‚äº¤ç”±NSURLSessionDownloadDelegate çš„ URLSession:downloadTask:didResumeAtOffset:expectedTotalBytes:.æ–¹å¼</span></span><br><span class="line">- (<span class="keyword">void</span>)setDownloadTaskDidResumeBlock:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask, int64_t fileOffset, int64_t expectedTotalBytes))block;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///--------------------</span></span><br><span class="line"><span class="comment">/// @name Notifications</span></span><br><span class="line"><span class="comment">///--------------------</span></span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidResumeNotification;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteNotification;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidSuspendNotification;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFURLSessionDidInvalidateNotification;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFURLSessionDownloadTaskDidFailToMoveFileNotification;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteResponseDataKey;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteSerializedResponseKey;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteResponseSerializerKey;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteAssetPathKey;</span><br><span class="line"></span><br><span class="line">FOUNDATION_EXPORT <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteErrorKey;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NS_ASSUME_NONNULL_END</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡å¤´æ–‡ä»¶å¯ä»¥å‘ç°ï¼ŒAFURLSessionManageræ˜¯å°è£…äº†NSURLSessionå¹¶å®ç°äº†å…¶ç›¸å…³çš„æ‰€æœ‰åè®®ï¼Œæä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•ç”¨äºæ„é€ å„ç§ç½‘ç»œè¯·æ±‚ä»»åŠ¡ï¼Œå¹¶æä¾›å›è°ƒå—è¿›è¡Œå¤„ç†ï¼Œè¿˜æä¾›äº†ä¸€ç³»åˆ—è®¾ç½®ä»£ç†æ–¹æ³•æ‰§è¡Œæ—¶çš„æ‰§è¡Œå›è°ƒå—çš„æ–¹æ³•ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›‘å¬æ•´ä¸ªç½‘ç»œè¯·æ±‚çš„è¿‡ç¨‹ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å¿½ç•¥è¿™äº›ä»£ç†æ–¹æ³•æ‰§è¡Œæƒ…å†µï¼Œæä¾›äº†å„ç§é€šçŸ¥ï¼Œé€šè¿‡å¤´æ–‡ä»¶å¯ä»¥çœ‹å‡ºï¼Œä¸»è¦ç›®çš„è¿˜æ˜¯ä¸ºäº†å°è£…NSURLSessionä»è€Œæä¾›æ›´åŠ ä¾¿æ·çš„æ–¹æ³•æ¥å®ç°ç½‘ç»œè¯·æ±‚ã€‚</p><h4 id="å®ç°-mæ–‡ä»¶"><a href="#å®ç°-mæ–‡ä»¶" class="headerlink" title="å®ç°.mæ–‡ä»¶"></a>å®ç°.mæ–‡ä»¶</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#ifndef NSFoundationVersionNumber_iOS_8_0</span></span><br><span class="line"><span class="meta">#define NSFoundationVersionNumber_With_Fixed_5871104061079552_bug 1140.11</span></span><br><span class="line"><span class="meta">#else</span></span><br><span class="line"><span class="meta">#define NSFoundationVersionNumber_With_Fixed_5871104061079552_bug NSFoundationVersionNumber_iOS_8_0</span></span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//Cé™æ€å‡½æ•°ï¼ŒGCDåªæ‰§è¡Œä¸€æ¬¡ï¼Œç”¨äºåˆ›å»ºä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—æ¥æ‰§è¡Œå„ç§ç½‘ç»œè¯·æ±‚ä»»åŠ¡çš„åˆ›å»ºå·¥ä½œ</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_queue_t</span> url_session_manager_creation_queue() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_queue_t</span> af_url_session_manager_creation_queue;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        af_url_session_manager_creation_queue = dispatch_queue_create(<span class="string">"com.alamofire.networking.session.manager.creation"</span>, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> af_url_session_manager_creation_queue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Cé™æ€å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œåˆ›å»ºç½‘ç»œè¯·æ±‚ä»»åŠ¡çš„block</span></span><br><span class="line"><span class="comment">ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†è§£å†³ios8ä»¥ä¸‹å­˜åœ¨çš„ä¸€ä¸ªblockå’Œtaskä¸åŒ¹é…çš„bug</span></span><br><span class="line"><span class="comment">ä¸Šé¢é‚£ä¸ªé˜Ÿåˆ—ä¹Ÿæ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªbugæ‰åˆ›å»ºçš„</span></span><br><span class="line"><span class="comment">å…·ä½“å¯æŸ¥çœ‹</span></span><br><span class="line"><span class="comment">Open Radar:http://openradar.appspot.com/radar?id=5871104061079552 (status: Fixed in iOS8)</span></span><br><span class="line"><span class="comment">Issue about:https://github.com/AFNetworking/AFNetworking/issues/2093</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> url_session_manager_create_task_safely(dispatch_block_t block) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NSFoundationVersionNumber</span> &lt; <span class="built_in">NSFoundationVersionNumber_With_Fixed_5871104061079552_bug</span>) &#123;</span><br><span class="line">        <span class="built_in">dispatch_sync</span>(url_session_manager_creation_queue(), block);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        block();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Cé™æ€å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªå¹¶å‘é˜Ÿåˆ—ï¼Œç”¨äºåœ¨ç½‘ç»œè¯·æ±‚ä»»åŠ¡å®Œæˆåå¤„ç†æ•°æ®çš„ï¼Œå¹¶å‘é˜Ÿåˆ—å®ç°å¤šçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚å®Œæˆåçš„æ•°æ®å¤„ç†</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">dispatch_queue_t</span> url_session_manager_processing_queue() &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_queue_t</span> af_url_session_manager_processing_queue;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        af_url_session_manager_processing_queue = dispatch_queue_create(<span class="string">"com.alamofire.networking.session.manager.processing"</span>, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> af_url_session_manager_processing_queue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Cé™æ€å‡½æ•°åˆ›å»ºä¸€ä¸ªdispatchçš„ç»„</span></span><br><span class="line"><span class="comment">//ä½†åœ¨æ¥ä¸‹æ¥çš„æºç ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨è¿™ä¸ªç»„æ¥å®ç°notifyç­‰åŠŸèƒ½ï¼Œä»…ä»…æ˜¯å°†blockå’Œç»„å…³è”äº†ï¼Œä¸å¤ªæ¸…æ¥šå…·ä½“ç”¨æ„</span></span><br><span class="line"><span class="comment">//æœ‰æ˜ç™½çš„è¯»è€…è¿˜è¯·ä¸åèµæ•™</span></span><br><span class="line"><span class="keyword">static</span> dispatch_group_t url_session_manager_completion_group() &#123;</span><br><span class="line">    <span class="keyword">static</span> dispatch_group_t af_url_session_manager_completion_group;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        af_url_session_manager_completion_group = dispatch_group_create();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> af_url_session_manager_completion_group;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¸€ç³»åˆ—é€šçŸ¥åç§°çš„å®šä¹‰</span></span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidResumeNotification = <span class="string">@"com.alamofire.networking.task.resume"</span>;</span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteNotification = <span class="string">@"com.alamofire.networking.task.complete"</span>;</span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidSuspendNotification = <span class="string">@"com.alamofire.networking.task.suspend"</span>;</span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFURLSessionDidInvalidateNotification = <span class="string">@"com.alamofire.networking.session.invalidate"</span>;</span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFURLSessionDownloadTaskDidFailToMoveFileNotification = <span class="string">@"com.alamofire.networking.session.download.file-manager-error"</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteSerializedResponseKey = <span class="string">@"com.alamofire.networking.task.complete.serializedresponse"</span>;</span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteResponseSerializerKey = <span class="string">@"com.alamofire.networking.task.complete.responseserializer"</span>;</span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteResponseDataKey = <span class="string">@"com.alamofire.networking.complete.finish.responsedata"</span>;</span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteErrorKey = <span class="string">@"com.alamofire.networking.task.complete.error"</span>;</span><br><span class="line"><span class="built_in">NSString</span> * <span class="keyword">const</span> AFNetworkingTaskDidCompleteAssetPathKey = <span class="string">@"com.alamofire.networking.task.complete.assetpath"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//éœ€è¦ä½¿ç”¨çš„NSLocké”çš„åç§°</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> AFURLSessionManagerLockName = <span class="string">@"com.alamofire.networking.session.manager.lock"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//background sessioné‡è¯•åˆ›å»ºä¸Šä¼ ä»»åŠ¡æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSUInteger</span> <span class="keyword">const</span> AFMaximumNumberOfAttemptsToRecreateBackgroundSessionUploadTask = <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p>å¯¹äºurl_session_manager_create_task_safelyè¿™ä¸ªæœ‰ä»€ä¹ˆç”¨ï¼Ÿå…¶å®è¿™ä¸ªæ˜¯è¢«å½“åšæ˜¯ä¸€ä¸ªåœ¨ios8ä»¥ä¸‹ï¼ŒNSURLSessionDataTaskå‡ºç°çš„ä¸€ä¸ªBugã€‚é—®é¢˜äº§ç”Ÿçš„åŸå› å°±æ˜¯å½“é˜Ÿåˆ—æ˜¯å¹¶å‘çš„ï¼Œè¿™æ˜¯å½“ä¸¤ä¸ªä»»åŠ¡åŒæ—¶åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šåˆ›å»ºä»»åŠ¡çš„æ—¶å€™taskIdentifierå¯èƒ½æ˜¯ä¸€æ ·çš„ã€‚<br>å¤§è‡´çš„æ„æ€å°±æ˜¯å½“æˆ‘ä»¬åŒæ—¶åˆ›å»ºä¸¤ä¸ªä»»åŠ¡ï¼Œè¿”å›äº†é‡å¤çš„taskIdentifierï¼Œè¿™æ ·çš„è¯ç¬¬ä¸€ä¸ªè¢«åˆ›å»ºçš„completionHandlerå°±ä¼šè¢«æ¸…ç©ºï¼Œè¢«ç¬¬äºŒä¸ªä»»åŠ¡çš„completionHandlerç»™æ›¿æ¢ï¼Œå¦‚æœç¬¬ä¸€ä¸ªæ•°æ®æ˜¯æ—©äºç¬¬äºŒä¸ªæ•°æ®è¿”å›çš„ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªæ•°æ®è¿”å›ä¹‹åå°±ä¼šå»è°ƒç”¨ç¬¬äºŒä¸ªä»»åŠ¡çš„completionHandlerã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionDidBecomeInvalidBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSError</span> *error);</span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSURLSessionAuthChallengeDisposition</span> (^AFURLSessionDidReceiveAuthenticationChallengeBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLAuthenticationChallenge</span> *challenge, <span class="built_in">NSURLCredential</span> * __autoreleasing *credential);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSURLRequest</span> * (^AFURLSessionTaskWillPerformHTTPRedirectionBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task, <span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURLRequest</span> *request);</span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSURLSessionAuthChallengeDisposition</span> (^AFURLSessionTaskDidReceiveAuthenticationChallengeBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task, <span class="built_in">NSURLAuthenticationChallenge</span> *challenge, <span class="built_in">NSURLCredential</span> * __autoreleasing *credential);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionDidFinishEventsForBackgroundURLSessionBlock)(<span class="built_in">NSURLSession</span> *session);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSInputStream</span> * (^AFURLSessionTaskNeedNewBodyStreamBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionTaskDidSendBodyDataBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task, int64_t bytesSent, int64_t totalBytesSent, int64_t totalBytesExpectedToSend);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionTaskDidCompleteBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionTask</span> *task, <span class="built_in">NSError</span> *error);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSURLSessionResponseDisposition</span> (^AFURLSessionDataTaskDidReceiveResponseBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDataTask</span> *dataTask, <span class="built_in">NSURLResponse</span> *response);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionDataTaskDidBecomeDownloadTaskBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDataTask</span> *dataTask, <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionDataTaskDidReceiveDataBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDataTask</span> *dataTask, <span class="built_in">NSData</span> *data);</span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSCachedURLResponse</span> * (^AFURLSessionDataTaskWillCacheResponseBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDataTask</span> *dataTask, <span class="built_in">NSCachedURLResponse</span> *proposedResponse);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">NSURL</span> * (^AFURLSessionDownloadTaskDidFinishDownloadingBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask, <span class="built_in">NSURL</span> *location);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionDownloadTaskDidWriteDataBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask, int64_t bytesWritten, int64_t totalBytesWritten, int64_t totalBytesExpectedToWrite);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionDownloadTaskDidResumeBlock)(<span class="built_in">NSURLSession</span> *session, <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask, int64_t fileOffset, int64_t expectedTotalBytes);</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionTaskProgressBlock)(<span class="built_in">NSProgress</span> *);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^AFURLSessionTaskCompletionHandler)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error);</span><br></pre></td></tr></table></figure><p>å®šä¹‰ä¸€äº›å›è°ƒçš„block</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰äº†ä¸€ä¸ªç±»AFURLSessionManagerTaskDelegateå¹¶å®ç°äº†NSURLSessionTaskçš„ç›¸å…³åè®®</span></span><br><span class="line"><span class="comment">//è¿™ä¸ªç±»æ˜¯ç”¨äºå¤„ç†NSURLSessionTaskç›¸å…³ä»£ç†æ–¹æ³•çš„</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFURLSessionManagerTaskDelegate</span> : <span class="title">NSObject</span> &lt;<span class="title">NSURLSessionTaskDelegate</span>, <span class="title">NSURLSessionDataDelegate</span>, <span class="title">NSURLSessionDownloadDelegate</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æ„é€ å‡½æ•°ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªå…³è”çš„task</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTask:(<span class="built_in">NSURLSessionTask</span> *)task;</span><br><span class="line"></span><br><span class="line"><span class="comment">//weakä¿®é¥°çš„manager</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) AFURLSessionManager *manager;</span><br><span class="line"><span class="comment">//å¯å˜dataç”¨äºå­˜å‚¨è·å–åˆ°çš„ç½‘ç»œæ•°æ®</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableData</span> *mutableData;</span><br><span class="line"><span class="comment">//ä¸Šä¼ è¿›åº¦NSProgress</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSProgress</span> *uploadProgress;</span><br><span class="line"><span class="comment">//ä¸‹è½½è¿›åº¦NSProgress</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSProgress</span> *downloadProgress;</span><br><span class="line"><span class="comment">//ä¸‹è½½æ–‡ä»¶çš„NSURL</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSURL</span> *downloadFileURL;</span><br><span class="line"><span class="comment">//ä¸‹è½½å®Œæˆçš„å›è°ƒå—</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDownloadTaskDidFinishDownloadingBlock downloadTaskDidFinishDownloading;</span><br><span class="line"><span class="comment">//ä¸Šä¼ è¿›åº¦çš„å›è°ƒå—</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskProgressBlock uploadProgressBlock;</span><br><span class="line"><span class="comment">//ä¸‹è½½è¿›åº¦çš„å›è°ƒå—</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskProgressBlock downloadProgressBlock;</span><br><span class="line"><span class="comment">//ç½‘ç»œè¯·æ±‚å®Œæˆçš„å›è°ƒå—</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskCompletionHandler completionHandler;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFURLSessionManagerTaskDelegate</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æ„é€ å‡½æ•°</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithTask:(<span class="built_in">NSURLSessionTask</span> *)task &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    _mutableData = [<span class="built_in">NSMutableData</span> data];</span><br><span class="line">    _uploadProgress = [[<span class="built_in">NSProgress</span> alloc] initWithParent:<span class="literal">nil</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">    _downloadProgress = [[<span class="built_in">NSProgress</span> alloc] initWithParent:<span class="literal">nil</span> userInfo:<span class="literal">nil</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//éå†ä¸¤ä¸ªä¸Šä¼ å’Œä¸‹è½½NSProgressè®¾ç½®ä¸€äº›å±æ€§</span></span><br><span class="line">    __<span class="keyword">weak</span> __typeof__(task) weakTask = task;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSProgress</span> *progress <span class="keyword">in</span> @[ _uploadProgress, _downloadProgress ])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//åˆå§‹åŒ–progress</span></span><br><span class="line">        progress.totalUnitCount = <span class="built_in">NSURLSessionTransferSizeUnknown</span>;</span><br><span class="line">        progress.cancellable = <span class="literal">YES</span>;</span><br><span class="line">        <span class="comment">//è®¾ç½®å–æ¶ˆè¿›åº¦çš„å›è°ƒå—ï¼Œæ‰§è¡Œtaskçš„cancelæ–¹æ³•</span></span><br><span class="line">        progress.cancellationHandler = ^&#123;</span><br><span class="line">            [weakTask cancel];</span><br><span class="line">        &#125;;</span><br><span class="line">        progress.pausable = <span class="literal">YES</span>;</span><br><span class="line">        <span class="comment">//è®¾ç½®æš‚åœè¿›åº¦çš„å›è°ƒå—ï¼Œæ‰§è¡Œtaskçš„suspendæ–¹æ³•</span></span><br><span class="line">        progress.pausingHandler = ^&#123;</span><br><span class="line">            [weakTask suspend];</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//è®¾ç½®é‡æ–°å¼€å§‹çš„å›è°ƒå—ï¼Œæ‰§è¡Œtaskçš„resumeæ–¹æ³•</span></span><br><span class="line">        <span class="keyword">if</span> ([progress respondsToSelector:<span class="keyword">@selector</span>(setResumingHandler:)]) &#123;</span><br><span class="line">            progress.resumingHandler = ^&#123;</span><br><span class="line">                [weakTask resume];</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//progressæ·»åŠ kvoï¼Œç›‘å¬progressçš„è¿›åº¦fractionCompleted</span></span><br><span class="line">        [progress addObserver:<span class="keyword">self</span></span><br><span class="line">                   forKeyPath:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(fractionCompleted))</span><br><span class="line">                      options:<span class="built_in">NSKeyValueObservingOptionNew</span></span><br><span class="line">                      context:<span class="literal">NULL</span>]; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ææ„å‡½æ•°</span></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    <span class="comment">//åˆ é™¤KVO</span></span><br><span class="line">    [<span class="keyword">self</span>.downloadProgress removeObserver:<span class="keyword">self</span> forKeyPath:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(fractionCompleted))];</span><br><span class="line">    [<span class="keyword">self</span>.uploadProgress removeObserver:<span class="keyword">self</span> forKeyPath:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(fractionCompleted))];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSProgress Tracking</span></span><br><span class="line"><span class="comment">//KVOå›è°ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="comment">//ä¸Šæ¬¡æˆ–ä¸‹è½½è¿›åº¦æœ‰æ”¹å˜æ—¶ï¼Œæ‰§è¡Œä¸Šä¼ æˆ–ä¸‹è½½è¿›åº¦å›è°ƒå—</span></span><br><span class="line">   <span class="keyword">if</span> ([object isEqual:<span class="keyword">self</span>.downloadProgress]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.downloadProgressBlock) &#123;</span><br><span class="line">            <span class="keyword">self</span>.downloadProgressBlock(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ([object isEqual:<span class="keyword">self</span>.uploadProgress]) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.uploadProgressBlock) &#123;</span><br><span class="line">            <span class="keyword">self</span>.uploadProgressBlock(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSURLSessionTaskDelegate</span></span><br><span class="line"><span class="comment">//ä»£ç†æ–¹æ³•ï¼Œç½‘ç»œè¯·æ±‚å®Œæˆæˆ–å‡ºé”™</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(__unused <span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//managerç”¨weakä¿®é¥°ï¼Œè¿™é‡Œstrongä¸€ä¸‹é˜²æ­¢managerè¢«é‡Šæ”¾</span></span><br><span class="line">    __<span class="keyword">strong</span> AFURLSessionManager *manager = <span class="keyword">self</span>.manager;</span><br><span class="line"></span><br><span class="line">    __block <span class="keyword">id</span> responseObject = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    __block <span class="built_in">NSMutableDictionary</span> *userInfo = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    <span class="comment">//ä¸ºuserInfoå­—å…¸è®¾ç½®å“åº”åºåˆ—åŒ–</span></span><br><span class="line">    userInfo[AFNetworkingTaskDidCompleteResponseSerializerKey] = manager.responseSerializer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Performance Improvement from #2672</span></span><br><span class="line">    <span class="comment">//èµ‹å€¼mutableDataåˆ°dataä¸­ï¼Œå¹¶é‡Šæ”¾mutableData</span></span><br><span class="line">    <span class="built_in">NSData</span> *data = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.mutableData) &#123;</span><br><span class="line">        data = [<span class="keyword">self</span>.mutableData <span class="keyword">copy</span>];</span><br><span class="line">        <span class="comment">//We no longer need the reference, so nil it out to gain back some memory.</span></span><br><span class="line">        <span class="keyword">self</span>.mutableData = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœdownloadFileURLå­˜åœ¨ï¼Œå³æ˜¯ä¸‹è½½ä»»åŠ¡å°±è®¾ç½®ä¸‹è½½å®Œæˆåçš„æ–‡ä»¶å­˜å‚¨urlåˆ°å­—å…¸ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteAssetPathKey] = <span class="keyword">self</span>.downloadFileURL;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data) &#123;</span><br><span class="line">    <span class="comment">//å¦åˆ™å°±è®¾ç½®å¯¹åº”çš„NSDataæ•°æ®åˆ°å­—å…¸ä¸­</span></span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteResponseDataKey] = data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœç½‘ç»œè¯·æ±‚æœ‰é”™è¯¯</span></span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="comment">//è®¾ç½®errorä¿¡æ¯åˆ°å­—å…¸ä¸­</span></span><br><span class="line">        userInfo[AFNetworkingTaskDidCompleteErrorKey] = error;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        è¿™ä¸ªä¸‰ç›®è¿ç®—ç¬¦éœ€è¦è§£é‡Šä¸€ä¸‹ï¼Œåœ¨å…¶ä»–è¯­è¨€ä¸­è¿™ä¹ˆå†™å¾ˆå¯èƒ½å°±æ˜¯è¯­æ³•é”™è¯¯</span></span><br><span class="line"><span class="comment">        è¿™é‡Œçš„æ„æ€å°±æ˜¯å¦‚æœmanager.completionGroupå­˜åœ¨å°±ä½¿ç”¨å®ƒ</span></span><br><span class="line"><span class="comment">        ä¸å­˜åœ¨å°±ä½¿ç”¨url_session_manager_completion_groupå‡½æ•°è¿”å›çš„group</span></span><br><span class="line"><span class="comment">        åé¢çš„ä¸‰ç›®è¿ç®—ç¬¦åŒç†</span></span><br><span class="line"><span class="comment">        æ‰€ä»¥å¦‚æœè‡ªå·±ä¸è®¾ç½®managerçš„completionGroupæˆ–completionQueueå°±ä¼šä½¿ç”¨é»˜è®¤æä¾›çš„</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="comment">//æ‰§è¡Œå¯¹åº”çš„completionHandlerå›è°ƒå—</span></span><br><span class="line">        dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.completionHandler) &#123;</span><br><span class="line">                <span class="keyword">self</span>.completionHandler(task.response, responseObject, error);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åœ¨ä¸»é˜Ÿåˆ—å³ä¸»çº¿ç¨‹ä¸­å‘é€é€šçŸ¥</span></span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœç½‘ç»œä»»åŠ¡æˆåŠŸå®Œæˆï¼Œå¼‚æ­¥åœ¨å¹¶å‘é˜Ÿåˆ—ä¸­æ‰§è¡Œæ•°æ®å¤„ç†</span></span><br><span class="line">        <span class="built_in">dispatch_async</span>(url_session_manager_processing_queue(), ^&#123;</span><br><span class="line">            <span class="comment">//åºåˆ—åŒ–å“åº”æ•°æ®</span></span><br><span class="line">            <span class="built_in">NSError</span> *serializationError = <span class="literal">nil</span>;</span><br><span class="line">            responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError];</span><br><span class="line">            <span class="comment">//å¦‚æœæ˜¯ä¸‹è½½ä»»åŠ¡è®¾ç½®å“åº”æ•°æ®ä¸ºæ–‡ä»¶çš„url</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</span><br><span class="line">                responseObject = <span class="keyword">self</span>.downloadFileURL;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœå“åº”å¯¹è±¡åºåˆ—åŒ–æˆåŠŸæˆ–æ˜¯æ–‡ä»¶urlå°±è®¾ç½®ç›¸å…³å­—å…¸key-value</span></span><br><span class="line">            <span class="keyword">if</span> (responseObject) &#123;</span><br><span class="line">                userInfo[AFNetworkingTaskDidCompleteSerializedResponseKey] = responseObject;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœåºåˆ—åŒ–å‡ºé”™ï¼Œè®¾ç½®ç›¸å…³å­—å…¸å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (serializationError) &#123;</span><br><span class="line">                userInfo[AFNetworkingTaskDidCompleteErrorKey] = serializationError;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//åŒç†ï¼Œåœ¨dispatchç»„ä¸­å’Œç‰¹å®šé˜Ÿåˆ—æ‰§è¡Œå›è°ƒå—</span></span><br><span class="line">            dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">self</span>.completionHandler) &#123;</span><br><span class="line">                    <span class="keyword">self</span>.completionHandler(task.response, responseObject, serializationError);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//ä¸»çº¿ç¨‹å‘é€é€šçŸ¥</span></span><br><span class="line">                <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSURLSessionDataDelegate</span></span><br><span class="line"><span class="comment">//å›è°ƒæ–¹æ³•ï¼Œæ”¶åˆ°æ•°æ®</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(__unused <span class="built_in">NSURLSession</span> *)session</span><br><span class="line">          dataTask:(__unused <span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">    didReceiveData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®ä¸‹è½½è¿›åº¦çš„ç›¸å…³å±æ€§</span></span><br><span class="line">    <span class="keyword">self</span>.downloadProgress.totalUnitCount = dataTask.countOfBytesExpectedToReceive;</span><br><span class="line">    <span class="keyword">self</span>.downloadProgress.completedUnitCount = dataTask.countOfBytesReceived;</span><br><span class="line">    <span class="comment">//æ·»åŠ æ•°æ®åˆ°mutableData</span></span><br><span class="line">    [<span class="keyword">self</span>.mutableData appendData:data];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸Šä¼ ä»»åŠ¡çš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">   didSendBodyData:(int64_t)bytesSent</span><br><span class="line">    totalBytesSent:(int64_t)totalBytesSent</span><br><span class="line">totalBytesExpectedToSend:(int64_t)totalBytesExpectedToSend&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®ä¸Šä¼ è¿›åº¦çš„ç›¸å…³å±æ€§</span></span><br><span class="line">    <span class="keyword">self</span>.uploadProgress.totalUnitCount = task.countOfBytesExpectedToSend;</span><br><span class="line">    <span class="keyword">self</span>.uploadProgress.completedUnitCount = task.countOfBytesSent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark - NSURLSessionDownloadDelegate</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹è½½ä»»åŠ¡çš„å›è°ƒæ–¹æ³•</span></span><br><span class="line"><span class="comment">//ç”±äºNSURLSessionçš„downloadTaskç›´æ¥å°†æ–‡ä»¶ä¸‹è½½åˆ°ç£ç›˜æ²™ç›’ä¸­ï¼Œæ‰€ä»¥ä¸éœ€è¦mutableDataè‡ªè¡Œæ¥æ”¶æ•°æ®</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">      didWriteData:(int64_t)bytesWritten</span><br><span class="line"> totalBytesWritten:(int64_t)totalBytesWritten</span><br><span class="line">totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®ä¸‹è½½è¿›åº¦çš„ç›¸å…³å±æ€§</span></span><br><span class="line">    <span class="keyword">self</span>.downloadProgress.totalUnitCount = totalBytesExpectedToWrite;</span><br><span class="line">    <span class="keyword">self</span>.downloadProgress.completedUnitCount = totalBytesWritten;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¢å¤ä¸‹è½½ä»»åŠ¡çš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line"> didResumeAtOffset:(int64_t)fileOffset</span><br><span class="line">expectedTotalBytes:(int64_t)expectedTotalBytes&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®ä¸‹è½½è¿›åº¦çš„ç›¸å…³å±æ€§</span></span><br><span class="line">    <span class="keyword">self</span>.downloadProgress.totalUnitCount = expectedTotalBytes;</span><br><span class="line">    <span class="keyword">self</span>.downloadProgress.completedUnitCount = fileOffset;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸‹è½½ä»»åŠ¡ä¸‹è½½æ–‡ä»¶å®Œæˆåçš„å›è°ƒæ–¹æ³•</span></span><br><span class="line"><span class="comment">//locationå°±æ˜¯æ–‡ä»¶ä¸‹è½½åˆ°ç£ç›˜æ²™ç›’ç›®å½•çš„NSURL</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">      downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">didFinishDownloadingToURL:(<span class="built_in">NSURL</span> *)location</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è®¾ç½®downloadFileURLä¸ºnil</span></span><br><span class="line">    <span class="keyword">self</span>.downloadFileURL = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//å¦‚æœæœ‰ä¸‹è½½å®Œæˆçš„å›è°ƒå—</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadTaskDidFinishDownloading) &#123;</span><br><span class="line">        <span class="comment">//æ‰§è¡Œè¯¥å›è°ƒå—ï¼Œè¿™ä¸ªå›è°ƒå—è¿”å›ä¸€ä¸ªä¸‹è½½çš„æ–‡ä»¶ä¿å­˜çš„è·¯å¾„URL</span></span><br><span class="line">        <span class="comment">//é»˜è®¤ä¿å­˜åœ¨æ²™ç›’tmpæ–‡ä»¶ä¸­ï¼Œå¯èƒ½ä¼šè¢«åˆ é™¤ï¼Œéœ€è¦æŒä¹…åŒ–æ—¶è¦è‡ªå·±è®¾ç½®ä¸€ä¸ªç›®å½•å­˜å‚¨</span></span><br><span class="line">        <span class="keyword">self</span>.downloadFileURL = <span class="keyword">self</span>.downloadTaskDidFinishDownloading(session, downloadTask, location);</span><br><span class="line">        <span class="comment">//å¦‚æœéœ€è¦ç§»åŠ¨æ–‡ä»¶çš„è·¯å¾„ä½¿ç”¨NSFileManaegrç§»åŠ¨</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">self</span>.downloadFileURL) &#123;</span><br><span class="line">            <span class="built_in">NSError</span> *fileManagerError = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (![[<span class="built_in">NSFileManager</span> defaultManager] moveItemAtURL:location toURL:<span class="keyword">self</span>.downloadFileURL error:&amp;fileManagerError]) &#123;</span><br><span class="line">                <span class="comment">//æ–‡ä»¶ç§»åŠ¨å‘ç”Ÿé”™è¯¯å‘é€é€šçŸ¥</span></span><br><span class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFURLSessionDownloadTaskDidFailToMoveFileNotification object:downloadTask userInfo:fileManagerError.userInfo];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>AFURLSessionManagerTaskDelegateçš„æºç ï¼Œä¸»è¦å°±æ˜¯å…³è”ä¸€ä¸ªNSURLSessionTaskå¹¶å®ç°äº†ç›¸å…³ä»»åŠ¡çš„ä»£ç†æ–¹æ³•ç”¨äºæ•°æ®çš„è·å–ã€ä¸Šä¼ æ–‡ä»¶å’Œä¸‹è½½æ–‡ä»¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯NSURLSessionTaskçš„delegateå±æ€§æ˜¯åªè¯»çš„ï¼Œåªèƒ½åœ¨ä½¿ç”¨sessionåˆ›å»ºtaskçš„å‡½æ•°ä¸­ä¼ å…¥ä»£ç†å¯¹è±¡ï¼Œè€Œä¸”é€šè¿‡æºç ä¹Ÿæ²¡æœ‰å‘ç°ç›¸å…³ä»£ç†çš„è®¾ç½®ï¼Œæ‰€ä»¥AFURLSessionManagerTaskDelegateç±»å®ç°ç›¸å…³ä»£ç†æ˜¯ä¸ºäº†å…¶ä»–ç±»æ‰‹åŠ¨è°ƒç”¨ç›¸å…³æ–¹æ³•ï¼ŒAFURLSessionManagerä¹Ÿå®ç°äº†è¿™äº›ä»£ç†ï¼Œæ‰€ä»¥å…·ä½“çš„è°ƒç”¨æ˜¯ç”±AFURLSessionMangeræ‰‹åŠ¨è§¦å‘çš„ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> af_swizzleSelector(Class theClass, SEL originalSelector, SEL swizzledSelector) &#123;</span><br><span class="line">    Method originalMethod = class_getInstanceMethod(theClass, originalSelector);</span><br><span class="line">    Method swizzledMethod = class_getInstanceMethod(theClass, swizzledSelector);</span><br><span class="line">    method_exchangeImplementations(originalMethod, swizzledMethod);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="built_in">BOOL</span> af_addMethod(Class theClass, SEL selector, Method method) &#123;</span><br><span class="line">    <span class="keyword">return</span> class_addMethod(theClass, selector,  method_getImplementation(method),  method_getTypeEncoding(method));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNSURLSessionTaskDidResumeNotification  = <span class="string">@"com.alamofire.networking.nsurlsessiontask.resume"</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> * <span class="keyword">const</span> AFNSURLSessionTaskDidSuspendNotification = <span class="string">@"com.alamofire.networking.nsurlsessiontask.suspend"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">_AFURLSessionTaskSwizzling</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">_AFURLSessionTaskSwizzling</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     WARNING: Trouble Ahead</span></span><br><span class="line"><span class="comment">     https://github.com/AFNetworking/AFNetworking/pull/2702</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">NSClassFromString</span>(<span class="string">@"NSURLSessionTask"</span>)) &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         iOS 7 and iOS 8 differ in NSURLSessionTask implementation, which makes the next bit of code a bit tricky.</span></span><br><span class="line"><span class="comment">         Many Unit Tests have been built to validate as much of this behavior has possible.</span></span><br><span class="line"><span class="comment">         Here is what we know:</span></span><br><span class="line"><span class="comment">            - NSURLSessionTasks are implemented with class clusters, meaning the class you request from the API isn't actually the type of class you will get back.</span></span><br><span class="line"><span class="comment">            - Simply referencing `[NSURLSessionTask class]` will not work. You need to ask an `NSURLSession` to actually create an object, and grab the class from there.</span></span><br><span class="line"><span class="comment">            - On iOS 7, `localDataTask` is a `__NSCFLocalDataTask`, which inherits from `__NSCFLocalSessionTask`, which inherits from `__NSCFURLSessionTask`.</span></span><br><span class="line"><span class="comment">            - On iOS 8, `localDataTask` is a `__NSCFLocalDataTask`, which inherits from `__NSCFLocalSessionTask`, which inherits from `NSURLSessionTask`.</span></span><br><span class="line"><span class="comment">            - On iOS 7, `__NSCFLocalSessionTask` and `__NSCFURLSessionTask` are the only two classes that have their own implementations of `resume` and `suspend`, and `__NSCFLocalSessionTask` DOES NOT CALL SUPER. This means both classes need to be swizzled.</span></span><br><span class="line"><span class="comment">            - On iOS 8, `NSURLSessionTask` is the only class that implements `resume` and `suspend`. This means this is the only class that needs to be swizzled.</span></span><br><span class="line"><span class="comment">            - Because `NSURLSessionTask` is not involved in the class hierarchy for every version of iOS, its easier to add the swizzled methods to a dummy class and manage them there.</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">         Some Assumptions:</span></span><br><span class="line"><span class="comment">            - No implementations of `resume` or `suspend` call super. If this were to change in a future version of iOS, we'd need to handle it.</span></span><br><span class="line"><span class="comment">            - No background task classes override `resume` or `suspend`</span></span><br><span class="line"><span class="comment">         </span></span><br><span class="line"><span class="comment">         The current solution:</span></span><br><span class="line"><span class="comment">            1) Grab an instance of `__NSCFLocalDataTask` by asking an instance of `NSURLSession` for a data task.</span></span><br><span class="line"><span class="comment">            2) Grab a pointer to the original implementation of `af_resume`</span></span><br><span class="line"><span class="comment">            3) Check to see if the current class has an implementation of resume. If so, continue to step 4.</span></span><br><span class="line"><span class="comment">            4) Grab the super class of the current class.</span></span><br><span class="line"><span class="comment">            5) Grab a pointer for the current class to the current implementation of `resume`.</span></span><br><span class="line"><span class="comment">            6) Grab a pointer for the super class to the current implementation of `resume`.</span></span><br><span class="line"><span class="comment">            7) If the current class implementation of `resume` is not equal to the super class implementation of `resume` AND the current implementation of `resume` is not equal to the original implementation of `af_resume`, THEN swizzle the methods</span></span><br><span class="line"><span class="comment">            8) Set the current class to the super class, and repeat steps 3-8</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="built_in">NSURLSessionConfiguration</span> *configuration = [<span class="built_in">NSURLSessionConfiguration</span> ephemeralSessionConfiguration];</span><br><span class="line">        <span class="built_in">NSURLSession</span> * session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:configuration];</span><br><span class="line"><span class="meta">#pragma GCC diagnostic push</span></span><br><span class="line"><span class="meta">#pragma GCC diagnostic ignored <span class="meta-string">"-Wnonnull"</span></span></span><br><span class="line">        <span class="built_in">NSURLSessionDataTask</span> *localDataTask = [session dataTaskWithURL:<span class="literal">nil</span>];</span><br><span class="line"><span class="meta">#pragma clang diagnostic pop</span></span><br><span class="line">        IMP originalAFResumeIMP = method_getImplementation(class_getInstanceMethod([<span class="keyword">self</span> <span class="keyword">class</span>], <span class="keyword">@selector</span>(af_resume)));</span><br><span class="line">        Class currentClass = [localDataTask <span class="keyword">class</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">while</span> (class_getInstanceMethod(currentClass, <span class="keyword">@selector</span>(resume))) &#123;</span><br><span class="line">            Class superClass = [currentClass superclass];</span><br><span class="line">            IMP classResumeIMP = method_getImplementation(class_getInstanceMethod(currentClass, <span class="keyword">@selector</span>(resume)));</span><br><span class="line">            IMP superclassResumeIMP = method_getImplementation(class_getInstanceMethod(superClass, <span class="keyword">@selector</span>(resume)));</span><br><span class="line">            <span class="keyword">if</span> (classResumeIMP != superclassResumeIMP &amp;&amp;</span><br><span class="line">                originalAFResumeIMP != classResumeIMP) &#123;</span><br><span class="line">                [<span class="keyword">self</span> swizzleResumeAndSuspendMethodForClass:currentClass];</span><br><span class="line">            &#125;</span><br><span class="line">            currentClass = [currentClass superclass];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        [localDataTask cancel];</span><br><span class="line">        [session finishTasksAndInvalidate];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)swizzleResumeAndSuspendMethodForClass:(Class)theClass &#123;</span><br><span class="line">    Method afResumeMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(af_resume));</span><br><span class="line">    Method afSuspendMethod = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(af_suspend));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (af_addMethod(theClass, <span class="keyword">@selector</span>(af_resume), afResumeMethod)) &#123;</span><br><span class="line">        af_swizzleSelector(theClass, <span class="keyword">@selector</span>(resume), <span class="keyword">@selector</span>(af_resume));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (af_addMethod(theClass, <span class="keyword">@selector</span>(af_suspend), afSuspendMethod)) &#123;</span><br><span class="line">        af_swizzleSelector(theClass, <span class="keyword">@selector</span>(suspend), <span class="keyword">@selector</span>(af_suspend));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSURLSessionTaskState</span>)state &#123;</span><br><span class="line">    <span class="built_in">NSAssert</span>(<span class="literal">NO</span>, <span class="string">@"State method should never be called in the actual dummy class"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">NSURLSessionTaskStateCanceling</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)af_resume &#123;</span><br><span class="line">    <span class="built_in">NSAssert</span>([<span class="keyword">self</span> respondsToSelector:<span class="keyword">@selector</span>(state)], <span class="string">@"Does not respond to state"</span>);</span><br><span class="line">    <span class="built_in">NSURLSessionTaskState</span> state = [<span class="keyword">self</span> state];</span><br><span class="line">    [<span class="keyword">self</span> af_resume];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (state != <span class="built_in">NSURLSessionTaskStateRunning</span>) &#123;</span><br><span class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNSURLSessionTaskDidResumeNotification object:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)af_suspend &#123;</span><br><span class="line">    <span class="built_in">NSAssert</span>([<span class="keyword">self</span> respondsToSelector:<span class="keyword">@selector</span>(state)], <span class="string">@"Does not respond to state"</span>);</span><br><span class="line">    <span class="built_in">NSURLSessionTaskState</span> state = [<span class="keyword">self</span> state];</span><br><span class="line">    [<span class="keyword">self</span> af_suspend];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (state != <span class="built_in">NSURLSessionTaskStateSuspended</span>) &#123;</span><br><span class="line">        [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNSURLSessionTaskDidSuspendNotification object:<span class="keyword">self</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨åˆ°äº†method-swizzlingçš„æŠ€æœ¯ï¼Œäº¤æ¢äº† resume å’Œ suspendæ–¹æ³•çš„å®ç°ï¼Œå› ä¸ºiOS7å’ŒiOS8ä¸­NSURLSessionTaskçš„çˆ¶ç±»ä¸åŒï¼Œéœ€è¦åšä¸€äº›å¤„ç†ï¼ˆå‘é€taskæš‚åœã€ç»§ç»­é€šçŸ¥ï¼‰ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">AFURLSessionManager</span> ()</span></span><br><span class="line"><span class="comment">//ç®¡ç†çš„sessionè¿è¡Œæ¨¡å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨é»˜è®¤è¿è¡Œæ¨¡å¼ï¼ŒdefaultConfiguration</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSURLSessionConfiguration</span> *sessionConfiguration;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">NSOperationé˜Ÿåˆ—ï¼Œä»£ç†æ–¹æ³•æ‰§è¡Œçš„é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">.hæ–‡ä»¶é‡Œæ˜¯readonlyï¼Œæ‰€ä»¥è¿™é‡Œå®šä¹‰ä¸€ä¸ªreadwriteç”¨äºèµ‹å€¼</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSOperationQueue</span> *operationQueue;</span><br><span class="line"><span class="comment">//ç®¡ç†çš„sessionï¼Œreadwrite</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSURLSession</span> *session;</span><br><span class="line"><span class="comment">//å¯å˜å­—å…¸ï¼Œkeyæ˜¯NSURLSessionTaskçš„å”¯ä¸€NSUIntegerç±»å‹æ ‡è¯†ï¼Œvalueæ˜¯å¯¹åº”çš„AFURLSessionManagerTaskDelgateå¯¹è±¡</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span> *mutableTaskDelegatesKeyedByTaskIdentifier;</span><br><span class="line"><span class="comment">//åªè¯»å±æ€§ï¼Œé€šè¿‡getterè¿”å›æ•°æ®</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readonly</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSString</span> *taskDescriptionForSessionTasks;</span><br><span class="line"><span class="comment">//NSLocké”</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSLock</span> *lock;</span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯ä¸€ç³»åˆ—å›è°ƒå—</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDidBecomeInvalidBlock sessionDidBecomeInvalid;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDidReceiveAuthenticationChallengeBlock sessionDidReceiveAuthenticationChallenge;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDidFinishEventsForBackgroundURLSessionBlock didFinishEventsForBackgroundURLSession;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskWillPerformHTTPRedirectionBlock taskWillPerformHTTPRedirection;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskDidReceiveAuthenticationChallengeBlock taskDidReceiveAuthenticationChallenge;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskNeedNewBodyStreamBlock taskNeedNewBodyStream;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskDidSendBodyDataBlock taskDidSendBodyData;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskDidCompleteBlock taskDidComplete;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDataTaskDidReceiveResponseBlock dataTaskDidReceiveResponse;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDataTaskDidBecomeDownloadTaskBlock dataTaskDidBecomeDownloadTask;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDataTaskDidReceiveDataBlock dataTaskDidReceiveData;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDataTaskWillCacheResponseBlock dataTaskWillCacheResponse;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDownloadTaskDidFinishDownloadingBlock downloadTaskDidFinishDownloading;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDownloadTaskDidWriteDataBlock downloadTaskDidWriteData;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">readwrite</span>, <span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDownloadTaskDidResumeBlock downloadTaskDidResume;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure><p>å»¶å±•é‡Œé¢å®šä¹‰äº†ä¸€äº›å±æ€§å’Œå“åº”çš„å›è°ƒblockã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">AFURLSessionManager</span></span></span><br><span class="line"><span class="comment">//æ„é€ å‡½æ•°</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> initWithSessionConfiguration:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//æ„é€ å‡½æ•°</span></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithSessionConfiguration:(<span class="built_in">NSURLSessionConfiguration</span> *)configuration &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœæ²¡æœ‰æŒ‡å®šsessionè¿è¡Œæ¨¡å¼å°±ä½¿ç”¨é»˜è®¤çš„</span></span><br><span class="line">    <span class="keyword">if</span> (!configuration) &#123;</span><br><span class="line">        configuration = [<span class="built_in">NSURLSessionConfiguration</span> defaultSessionConfiguration];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.sessionConfiguration = configuration;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä»£ç†æ–¹æ³•æ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œæœ€å¤§å¹¶å‘æ•°ä¸º1ï¼Œå³ä¸²è¡Œé˜Ÿåˆ—</span></span><br><span class="line">    <span class="comment">//æ„Ÿè§‰è¿™é‡Œè®¾ç½®ä¸º1æ˜¯ä¸ºäº†è®©å›è°ƒä¸€ä¸ªä¸ªæ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">self</span>.operationQueue = [[<span class="built_in">NSOperationQueue</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.operationQueue.maxConcurrentOperationCount = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//åˆ›å»ºsessionï¼Œæ³¨æ„ä»£ç†å¯¹è±¡æ˜¯self</span></span><br><span class="line">    <span class="keyword">self</span>.session = [<span class="built_in">NSURLSession</span> sessionWithConfiguration:<span class="keyword">self</span>.sessionConfiguration delegate:<span class="keyword">self</span> delegateQueue:<span class="keyword">self</span>.operationQueue];</span><br><span class="line">    <span class="comment">//åˆ›å»ºå“åº”åºåˆ—åŒ–å™¨</span></span><br><span class="line">    <span class="keyword">self</span>.responseSerializer = [AFJSONResponseSerializer serializer];</span><br><span class="line">    <span class="comment">//è®¾ç½®é»˜è®¤å®‰å…¨ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">self</span>.securityPolicy = [AFSecurityPolicy defaultPolicy];</span><br><span class="line"></span><br><span class="line"><span class="meta">#if !TARGET_OS_WATCH</span></span><br><span class="line">    <span class="comment">//è·å–ç½‘ç»œå¯è¾¾æ€§manager</span></span><br><span class="line">    <span class="keyword">self</span>.reachabilityManager = [AFNetworkReachabilityManager sharedManager];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier = [[<span class="built_in">NSMutableDictionary</span> alloc] init];</span><br><span class="line">    <span class="comment">//åˆ›å»ºé”</span></span><br><span class="line">    <span class="keyword">self</span>.lock = [[<span class="built_in">NSLock</span> alloc] init];</span><br><span class="line">    <span class="keyword">self</span>.lock.name = AFURLSessionManagerLockName;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    è·å–sessionä¸­çš„ä»»åŠ¡ï¼Œå¹¶è°ƒç”¨ç›¸å…³æ–¹æ³•å…³è”AFURLSessionManagerTaskDelegate</span></span><br><span class="line"><span class="comment">    ä¸å¤ªæ˜ç™½è¿™é‡Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œåˆšåˆ›å»ºçš„sessionåº”è¯¥æ²¡æœ‰ä»»ä½•ä»»åŠ¡åœ¨æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    [<span class="keyword">self</span>.session getTasksWithCompletionHandler:^(<span class="built_in">NSArray</span> *dataTasks, <span class="built_in">NSArray</span> *uploadTasks, <span class="built_in">NSArray</span> *downloadTasks) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLSessionDataTask</span> *task <span class="keyword">in</span> dataTasks) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addDelegateForDataTask:task uploadProgress:<span class="literal">nil</span> downloadProgress:<span class="literal">nil</span> completionHandler:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLSessionUploadTask</span> *uploadTask <span class="keyword">in</span> uploadTasks) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addDelegateForUploadTask:uploadTask progress:<span class="literal">nil</span> completionHandler:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSURLSessionDownloadTask</span> *downloadTask <span class="keyword">in</span> downloadTasks) &#123;</span><br><span class="line">            [<span class="keyword">self</span> addDelegateForDownloadTask:downloadTask progress:<span class="literal">nil</span> destination:<span class="literal">nil</span> completionHandler:<span class="literal">nil</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ææ„æ–¹æ³•ï¼Œç§»é™¤æ‰€æœ‰é€šçŸ¥ç›‘å¬</span></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–æ–¹æ³•é‡Œé¢æœ‰ä¸€ä¸ªæœ‰ä¸€ä¸ªä¸æ˜ç™½çš„ç‚¹ï¼Œåˆ›å»ºå®Œsessionä¹‹åå°±å»è·å–å®ƒæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œåˆšåˆ›å»ºå®Œsessionä¸ºä½•ä¼šæœ‰ä»»åŠ¡å‘¢ï¼Ÿ<br>è¿™æ˜¯ä¸ºäº†é˜²æ­¢åå°å›æ¥ï¼Œé‡æ–°åˆå§‹åŒ–è¿™ä¸ªsessionï¼Œä¸€äº›ä¹‹å‰çš„åå°è¯·æ±‚ä»»åŠ¡ï¼Œå¯¼è‡´ç¨‹åºçš„crashã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//taskDescriptionForSessionTaskså±æ€§çš„getterï¼Œè¿”å›åœ°å€çš„å­—ç¬¦ä¸²å½¢å¼æ•°æ®ï¼Œå¯ä»¥ä¿è¯è¿™ä¸ªå­—ç¬¦ä¸²æ˜¯å”¯ä¸€çš„</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)taskDescriptionForSessionTasks &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%p"</span>, <span class="keyword">self</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//é€šçŸ¥çš„å›è°ƒæ–¹æ³•ï¼Œæ¥ä¸‹æ¥çš„ä»£ç ä¼šæ·»åŠ ç›¸å…³é€šçŸ¥</span></span><br><span class="line">- (<span class="keyword">void</span>)taskDidResume:(<span class="built_in">NSNotification</span> *)notification &#123;</span><br><span class="line">    <span class="comment">//å‘é€é€šçŸ¥çš„æ—¶å€™ä¼šå°†taskæ·»åŠ è¿›é€šçŸ¥ä¸­</span></span><br><span class="line">    <span class="built_in">NSURLSessionTask</span> *task = notification.object;</span><br><span class="line">    <span class="comment">//åˆ¤æ–­è¿™ä¸ªä»»åŠ¡æ˜¯å¦æ˜¯å½“å‰managerç®¡ç†çš„ï¼Œå¦‚æœæ˜¯å°±å‘é€ç›¸å…³é€šçŸ¥</span></span><br><span class="line">    <span class="comment">//taskçš„taskDescriptionå±æ€§åœ¨ä¸‹æ–‡çš„æºç ä¸­ä¼šè®¾ç½®</span></span><br><span class="line">    <span class="keyword">if</span> ([task respondsToSelector:<span class="keyword">@selector</span>(taskDescription)]) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([task.taskDescription isEqualToString:<span class="keyword">self</span>.taskDescriptionForSessionTasks]) &#123;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidResumeNotification object:task];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åŒä¸Š</span></span><br><span class="line">- (<span class="keyword">void</span>)taskDidSuspend:(<span class="built_in">NSNotification</span> *)notification &#123;</span><br><span class="line">    <span class="built_in">NSURLSessionTask</span> *task = notification.object;</span><br><span class="line">    <span class="keyword">if</span> ([task respondsToSelector:<span class="keyword">@selector</span>(taskDescription)]) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([task.taskDescription isEqualToString:<span class="keyword">self</span>.taskDescriptionForSessionTasks]) &#123;</span><br><span class="line">            <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFNetworkingTaskDidSuspendNotification object:task];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å°±æ˜¯é€šçŸ¥çš„å›è°ƒæ–¹æ³•ï¼Œç”¨äºé€šçŸ¥resumeå’Œsuspendäº‹ä»¶ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¹æ®taskè·å–ç›¸å…³è”çš„AFURLSessionManagerTaskDelegateå¯¹è±¡</span></span><br><span class="line">- (AFURLSessionManagerTaskDelegate *)delegateForTask:(<span class="built_in">NSURLSessionTask</span> *)task &#123;</span><br><span class="line">    <span class="comment">//taskä¸èƒ½ä¸ºç©º</span></span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(task);</span><br><span class="line">    <span class="comment">//ä¸Šé”ï¼Œé€šè¿‡taskçš„å”¯ä¸€taskIdentifierä»å­—å…¸ä¸­å–å€¼ï¼Œè¿™ä¸ªå”¯ä¸€æ ‡è¯†æ˜¯åœ¨åˆ›å»ºtaskçš„æ—¶å€™NSURLSessionTaskä¸ºå…¶è®¾ç½®çš„ï¼Œä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®ï¼Œä¿è¯å”¯ä¸€æ€§</span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = <span class="literal">nil</span>;</span><br><span class="line">    [<span class="keyword">self</span>.lock lock];</span><br><span class="line">    delegate = <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)];</span><br><span class="line">    [<span class="keyword">self</span>.lock unlock];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> delegate;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¸ºtaskè®¾ç½®å…³è”çš„delegate</span></span><br><span class="line">- (<span class="keyword">void</span>)setDelegate:(AFURLSessionManagerTaskDelegate *)delegate</span><br><span class="line">            forTask:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//taskå’Œdelegateéƒ½ä¸èƒ½ä¸ºç©º</span></span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(task);</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(delegate);</span><br><span class="line">    <span class="comment">//ä¸Šé”ï¼Œå‘å­—å…¸ä¸­æ·»åŠ key-valueå¯¹</span></span><br><span class="line">    [<span class="keyword">self</span>.lock lock];</span><br><span class="line">    <span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)] = delegate;</span><br><span class="line">    [<span class="keyword">self</span> addNotificationObserverForTask:task];</span><br><span class="line">    [<span class="keyword">self</span>.lock unlock];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//é‡ç‚¹æ–¹æ³•ï¼Œä¸ºdataTaskåˆ›å»ºä¸€ä¸ªå…³è”çš„AFURLSessionManagerTaskDelegateå¯¹è±¡</span></span><br><span class="line">- (<span class="keyword">void</span>)addDelegateForDataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">                uploadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">              downloadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">             completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åˆ›å»ºAFURLSessionManagerTaskDelegate</span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] initWithTask:dataTask];</span><br><span class="line">    <span class="comment">//è®¾ç½®ç›¸å…³å±æ€§</span></span><br><span class="line">    delegate.manager = <span class="keyword">self</span>;</span><br><span class="line">    delegate.completionHandler = completionHandler;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    è®¾ç½®taskçš„taskDescriptionï¼Œæ³¨æ„å’ŒtaskIdentifieråŒºåˆ†</span></span><br><span class="line"><span class="comment">    taskDescriptionæ˜¯å¼€å‘è€…è‡ªè¡Œè®¾ç½®çš„</span></span><br><span class="line"><span class="comment">    taskIdentifieræ˜¯NSURLSessionTaskè®¾ç½®çš„ï¼Œä¿è¯æ¯ä¸€ä¸ªtaskçš„idä¸åŒ</span></span><br><span class="line"><span class="comment">    è¿™é‡Œè®¾ç½®çš„taskDescriptionå°±æ˜¯AFURLSessionManagerçš„åœ°å€</span></span><br><span class="line"><span class="comment">    æ‰€ä»¥åŒä¸€ä¸ªmanageråˆ›å»ºçš„taskçš„descriptionéƒ½æ˜¯ä¸€è‡´çš„</span></span><br><span class="line"><span class="comment">    è®¾ç½®è¿™ä¸ªå€¼çš„ç›®çš„å°±æ˜¯ä¸ºäº†åŒºåˆ†taskæ˜¯å¦æ˜¯å½“å‰mangeråˆ›å»ºçš„</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    dataTask.taskDescription = <span class="keyword">self</span>.taskDescriptionForSessionTasks;</span><br><span class="line">    <span class="comment">//è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•å°†task-delegateé”®å€¼å¯¹æ·»åŠ è¿›å­—å…¸ä¸­</span></span><br><span class="line">    [<span class="keyword">self</span> setDelegate:delegate forTask:dataTask];</span><br><span class="line">    <span class="comment">//è®¾ç½®å›è°ƒå—</span></span><br><span class="line">    delegate.uploadProgressBlock = uploadProgressBlock;</span><br><span class="line">    delegate.downloadProgressBlock = downloadProgressBlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŒä¸Šï¼Œåˆ›å»ºä¸Šä¼ ä»»åŠ¡çš„AFURLSessionManagerTaskDelegateå¯¹è±¡ï¼Œå¹¶åŠ å…¥åˆ°å­—å…¸ä¸­</span></span><br><span class="line">- (<span class="keyword">void</span>)addDelegateForUploadTask:(<span class="built_in">NSURLSessionUploadTask</span> *)uploadTask</span><br><span class="line">                        progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">               completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] initWithTask:uploadTask];</span><br><span class="line">    delegate.manager = <span class="keyword">self</span>;</span><br><span class="line">    delegate.completionHandler = completionHandler;</span><br><span class="line"></span><br><span class="line">    uploadTask.taskDescription = <span class="keyword">self</span>.taskDescriptionForSessionTasks;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> setDelegate:delegate forTask:uploadTask];</span><br><span class="line"></span><br><span class="line">    delegate.uploadProgressBlock = uploadProgressBlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŒä¸Šï¼Œåˆ›å»ºä¸‹è½½æ–‡ä»¶ä»»åŠ¡çš„AFURLSessionManagerTaskDelegateå¯¹è±¡ï¼Œå¹¶åŠ å…¥åˆ°å­—å…¸ä¸­</span></span><br><span class="line">- (<span class="keyword">void</span>)addDelegateForDownloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">                          progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">                       destination:(<span class="built_in">NSURL</span> * (^)(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response))destination</span><br><span class="line">                 completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> *filePath, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] initWithTask:downloadTask];</span><br><span class="line">    delegate.manager = <span class="keyword">self</span>;</span><br><span class="line">    delegate.completionHandler = completionHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    éœ€è¦æ³¨æ„ä¸‹ï¼ŒAFURLSessionManagerTaskDelegateä¸­ä¸‹è½½æ–‡ä»¶å®Œæˆåä¼šè°ƒç”¨delegate.downloadTaskDidFinishDownloadingå›è°ƒå—</span></span><br><span class="line"><span class="comment">    æ¥è·å–ä¸‹è½½æ–‡ä»¶è¦ç§»åŠ¨åˆ°çš„ç›®å½•URL</span></span><br><span class="line"><span class="comment">    æ‰€ä»¥è¿™é‡Œå°±æ˜¯åˆ›å»ºè¿™ä¸ªå›è°ƒå—ï¼Œç›´æ¥è¿”å›å‚æ•°ä¸­çš„destinationå›è°ƒå—</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> (destination) &#123;</span><br><span class="line">        delegate.downloadTaskDidFinishDownloading = ^<span class="built_in">NSURL</span> * (<span class="built_in">NSURLSession</span> * __unused session, <span class="built_in">NSURLSessionDownloadTask</span> *task, <span class="built_in">NSURL</span> *location) &#123;</span><br><span class="line">            <span class="keyword">return</span> destination(location, task.response);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    downloadTask.taskDescription = <span class="keyword">self</span>.taskDescriptionForSessionTasks;</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> setDelegate:delegate forTask:downloadTask];</span><br><span class="line"></span><br><span class="line">    delegate.downloadProgressBlock = downloadProgressBlock;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä»å­—å…¸ä¸­åˆ é™¤taskå¯¹åº”çš„delegateçš„key-valueå¯¹</span></span><br><span class="line">- (<span class="keyword">void</span>)removeDelegateForTask:(<span class="built_in">NSURLSessionTask</span> *)task &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(task);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span>.lock lock];</span><br><span class="line">    [<span class="keyword">self</span> removeNotificationObserverForTask:task];</span><br><span class="line">    [<span class="keyword">self</span>.mutableTaskDelegatesKeyedByTaskIdentifier removeObjectForKey:@(task.taskIdentifier)];</span><br><span class="line">    [<span class="keyword">self</span>.lock unlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å°±æ˜¯å¯¹AFURLSessionManagerTaskDelegateçš„åˆ›å»ºã€æ·»åŠ è¿›å­—å…¸ã€åˆ é™¤ã€è·å–çš„æ“ä½œï¼Œè¿™æ ·å°±å®ç°äº†æ¯ä¸€ä¸ªNSURLSessionTaskå¯¹åº”ä¸€ä¸ªAFURLSessionManagerTaskDelegateå¯¹è±¡ï¼Œå¯èƒ½è¯»è€…ä¼šæœ‰ç–‘é—®ï¼ŒAFURLSessionManageræ—¢ç„¶å·²ç»å®ç°äº†ä»£ç†çš„æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨å®ƒæ¥å¤„ç†ä»£ç†æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸€ä¸ªç±»æ¥ä¸“é—¨å¤„ç†ï¼Œç»§ç»­çœ‹å®Œæºç å¯èƒ½ä½ å°±ä¼šæ˜ç™½äº†ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ ¹æ®keyPathè·å–ä¸åŒç±»å‹ä»»åŠ¡çš„é›†åˆ</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)tasksForKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    __block <span class="built_in">NSArray</span> *tasks = <span class="literal">nil</span>;</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªä¿¡å·é‡ï¼Œå€¼æ˜¯0</span></span><br><span class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//è¿™ä¸ªæ–¹æ³•æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥ä¸ºäº†åŒæ­¥è¿”å›ç»“æœï¼Œéœ€è¦ä½¿ç”¨é”ï¼Œä¿¡å·é‡å€¼è®¾ç½®ä¸º0æˆ–è€…1æ—¶å°±å¯ä»¥å½“é”æ¥ä½¿ç”¨äº†</span></span><br><span class="line">    [<span class="keyword">self</span>.session getTasksWithCompletionHandler:^(<span class="built_in">NSArray</span> *dataTasks, <span class="built_in">NSArray</span> *uploadTasks, <span class="built_in">NSArray</span> *downloadTasks) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(dataTasks))]) &#123;</span><br><span class="line">            tasks = dataTasks;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(uploadTasks))]) &#123;</span><br><span class="line">            tasks = uploadTasks;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(downloadTasks))]) &#123;</span><br><span class="line">            tasks = downloadTasks;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(tasks))]) &#123;</span><br><span class="line">            tasks = [@[dataTasks, uploadTasks, downloadTasks] valueForKeyPath:<span class="string">@"@unionOfArrays.self"</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//signalé€šçŸ¥ä¿¡å·é‡ï¼Œä¿¡å·é‡å€¼åŠ 1</span></span><br><span class="line">        dispatch_semaphore_signal(semaphore);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="comment">//ç­‰å¾…ä¿¡å·é‡ï¼Œç›´åˆ°å€¼å¤§äº0ï¼Œç­‰å¾…æ—¶é—´æ˜¯forever</span></span><br><span class="line">    dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¸‹é¢æ˜¯tasksã€dataTasksã€uploadTasksã€downloadTaskså±æ€§çš„getterï¼Œéƒ½æ˜¯è°ƒç”¨ä¸Šè¿°æ–¹æ³•æ¥è·å–å¯¹åº”ç±»å‹çš„ä»»åŠ¡é›†åˆ</span></span><br><span class="line">- (<span class="built_in">NSArray</span> *)tasks &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> tasksForKeyPath:<span class="built_in">NSStringFromSelector</span>(_cmd)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span> *)dataTasks &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> tasksForKeyPath:<span class="built_in">NSStringFromSelector</span>(_cmd)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span> *)uploadTasks &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> tasksForKeyPath:<span class="built_in">NSStringFromSelector</span>(_cmd)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSArray</span> *)downloadTasks &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> tasksForKeyPath:<span class="built_in">NSStringFromSelector</span>(_cmd)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">//è®¾ç½®sessionæ— æ•ˆï¼Œæ ¹æ®å‚æ•°åˆ¤æ–­æ˜¯å¦éœ€è¦å–æ¶ˆæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡</span></span><br><span class="line">- (<span class="keyword">void</span>)invalidateSessionCancelingTasks:(<span class="built_in">BOOL</span>)cancelPendingTasks &#123;  </span><br><span class="line">    <span class="comment">//è°ƒç”¨NSURLSessionå¯¹åº”çš„æ–¹æ³•æ¥è®¾ç½®sessionæ— æ•ˆï¼ŒåŒæ—¶æ‰“ç ´å¼•ç”¨å¾ªç¯</span></span><br><span class="line">    <span class="keyword">if</span> (cancelPendingTasks) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.session invalidateAndCancel];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span>.session finishTasksAndInvalidate];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">//responseSerializerçš„setter</span></span><br><span class="line">- (<span class="keyword">void</span>)setResponseSerializer:(<span class="keyword">id</span> &lt;AFURLResponseSerialization&gt;)responseSerializer &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(responseSerializer);</span><br><span class="line"></span><br><span class="line">    _responseSerializer = responseSerializer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">//æ·»åŠ é€šçŸ¥ï¼ŒtaskDidResumeã€taskDidSuspendæ–¹æ³•å‰é¢è®²è¿‡äº†</span></span><br><span class="line">- (<span class="keyword">void</span>)addNotificationObserverForTask:(<span class="built_in">NSURLSessionTask</span> *)task &#123;</span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(taskDidResume:) name:AFNSURLSessionTaskDidResumeNotification object:task];</span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(taskDidSuspend:) name:AFNSURLSessionTaskDidSuspendNotification object:task];</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆ é™¤é€šçŸ¥</span></span><br><span class="line">- (<span class="keyword">void</span>)removeNotificationObserverForTask:(<span class="built_in">NSURLSessionTask</span> *)task &#123;</span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span> name:AFNSURLSessionTaskDidSuspendNotification object:task];</span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] removeObserver:<span class="keyword">self</span> name:AFNSURLSessionTaskDidResumeNotification object:task];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ–¹æ³•æ˜¯ä¸€äº›getterå’Œsetterï¼Œå¾ˆç®€å•ï¼Œä¸å†èµ˜è¿°ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºå¹¶è¿”å›NSURLSessionDataTask</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                            completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> dataTaskWithRequest:request uploadProgress:<span class="literal">nil</span> downloadProgress:<span class="literal">nil</span> completionHandler:completionHandler];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºå¹¶è¿”å›NSURLSessionDataTask</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDataTask</span> *)dataTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                               uploadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                             downloadProgress:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">                            completionHandler:(<span class="keyword">nullable</span> <span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> _Nullable responseObject,  <span class="built_in">NSError</span> * _Nullable error))completionHandler &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ä¸ºäº†è§£å†³iOS8ä¸€ä¸‹çš„ä¸€ä¸ªbugï¼Œè°ƒç”¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—æ¥åˆ›å»ºdataTask</span></span><br><span class="line">    __block <span class="built_in">NSURLSessionDataTask</span> *dataTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨sessionæ¥åˆ›å»ºä¸€ä¸ªNSURLSessionDataTaskå¯¹è±¡</span></span><br><span class="line">        dataTask = [<span class="keyword">self</span>.session dataTaskWithRequest:request];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//ä¸ºè¿™ä¸ªtaskåˆ›å»ºä¸€ä¸ªAFURLSessionManagerTaskDelegateå¹¶å…³è”åŠ å…¥å­—å…¸ä¸­</span></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForDataTask:dataTask uploadProgress:uploadProgressBlock downloadProgress:downloadProgressBlock completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> dataTask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªNSURLSessionUploadTaskå¯¹è±¡</span></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                         fromFile:(<span class="built_in">NSURL</span> *)fileURL</span><br><span class="line">                                         progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                                completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    __block <span class="built_in">NSURLSessionUploadTask</span> *uploadTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        uploadTask = [<span class="keyword">self</span>.session uploadTaskWithRequest:request fromFile:fileURL];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// uploadTask may be nil on iOS7 because uploadTaskWithRequest:fromFile: may return nil despite being documented as nonnull (https://devforums.apple.com/message/926113#926113)</span></span><br><span class="line">    <span class="comment">//è§£å†³iOS7çš„ä¸€ä¸ªbugæŒ‰ç…§é…ç½®çš„å°è¯•æ¬¡æ•°åˆ›å»ºä¸Šä¼ ä»»åŠ¡ï¼Œé»˜è®¤å°è¯•3æ¬¡</span></span><br><span class="line">    <span class="keyword">if</span> (!uploadTask &amp;&amp; <span class="keyword">self</span>.attemptsToRecreateUploadTasksForBackgroundSessions &amp;&amp; <span class="keyword">self</span>.session.configuration.identifier) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> attempts = <span class="number">0</span>; !uploadTask &amp;&amp; attempts &lt; AFMaximumNumberOfAttemptsToRecreateBackgroundSessionUploadTask; attempts++) &#123;</span><br><span class="line">            uploadTask = [<span class="keyword">self</span>.session uploadTaskWithRequest:request fromFile:fileURL];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ›å»ºå…³è”çš„delegateå¹¶æ·»åŠ åˆ°å­—å…¸ä¸­</span></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForUploadTask:uploadTask progress:uploadProgressBlock completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uploadTask;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åŒä¸Š</span></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                         fromData:(<span class="built_in">NSData</span> *)bodyData</span><br><span class="line">                                         progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                                completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    __block <span class="built_in">NSURLSessionUploadTask</span> *uploadTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        uploadTask = [<span class="keyword">self</span>.session uploadTaskWithRequest:request fromData:bodyData];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForUploadTask:uploadTask progress:uploadProgressBlock completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uploadTask;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åŒä¸Š</span></span><br><span class="line">- (<span class="built_in">NSURLSessionUploadTask</span> *)uploadTaskWithStreamedRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                                 progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock</span><br><span class="line">                                        completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    __block <span class="built_in">NSURLSessionUploadTask</span> *uploadTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        uploadTask = [<span class="keyword">self</span>.session uploadTaskWithStreamedRequest:request];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForUploadTask:uploadTask progress:uploadProgressBlock completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> uploadTask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#pragma mark -</span></span><br><span class="line"><span class="comment">//åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼ŒåŒä¸Š</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line">                                             progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">                                          destination:(<span class="built_in">NSURL</span> * (^)(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response))destination</span><br><span class="line">                                    completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> *filePath, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    __block <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        downloadTask = [<span class="keyword">self</span>.session downloadTaskWithRequest:request];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForDownloadTask:downloadTask progress:downloadProgressBlock destination:destination completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> downloadTask;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼ŒåŒä¸Š</span></span><br><span class="line">- (<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTaskWithResumeData:(<span class="built_in">NSData</span> *)resumeData</span><br><span class="line">                                                progress:(<span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock</span><br><span class="line">                                             destination:(<span class="built_in">NSURL</span> * (^)(<span class="built_in">NSURL</span> *targetPath, <span class="built_in">NSURLResponse</span> *response))destination</span><br><span class="line">                                       completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="built_in">NSURL</span> *filePath, <span class="built_in">NSError</span> *error))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    __block <span class="built_in">NSURLSessionDownloadTask</span> *downloadTask = <span class="literal">nil</span>;</span><br><span class="line">    url_session_manager_create_task_safely(^&#123;</span><br><span class="line">        downloadTask = [<span class="keyword">self</span>.session downloadTaskWithResumeData:resumeData];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">self</span> addDelegateForDownloadTask:downloadTask progress:downloadProgressBlock destination:destination completionHandler:completionHandler];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> downloadTask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ–¹æ³•å°±æ˜¯AFURLSessionManagerä¸ºæˆ‘ä»¬æä¾›çš„è·å–NSURLSessionDataTaskã€NSURLSessionUploadTaskå’ŒNSURLSessionDownloadTaskçš„æ–¹æ³•ï¼Œä¸Šé¢è¿™äº›æ–¹æ³•ä¸»è¦ç›®çš„å°±æ˜¯ä¼ å…¥è¿›åº¦æˆ–å®Œæˆå›è°ƒå—ï¼Œç„¶åæ„é€ ä¸€ä¸ªAFURLSessionManagerTaskDeleagteå¯¹è±¡å¹¶å…³è”ï¼Œè¿™æ ·å°±ä¸éœ€è¦å¼€å‘è€…è‡ªè¡Œå®ç°å’Œç®¡ç†ä»£ç†æ–¹æ³•åšç›¸å…³æ•°æ®å¤„ç†ï¼Œåªéœ€è¦åœ¨å›è°ƒå—ä¸­åšå¤„ç†å³å¯ã€‚</p><p>æ¥ä¸‹æ¥æºç ä¸­æ˜¯ä¸€ç³»åˆ—å›è°ƒå—çš„setteræ–¹æ³•ï¼Œå°±ä¸åˆ—ä¸‹æ¥äº†ï¼Œè¯»è€…å¯ä»¥è‡ªå·±çœ‹çœ‹ã€‚æ¥ä¸‹æ¥å°±è®²è§£é‡ç‚¹çš„å„ç§ä»£ç†çš„å›è°ƒæ–¹æ³•ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sessionæ— æ•ˆåçš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">didBecomeInvalidWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœå›è°ƒå—å­˜åœ¨å°±æ‰§è¡Œå›è°ƒå—</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.sessionDidBecomeInvalid) &#123;</span><br><span class="line">        <span class="keyword">self</span>.sessionDidBecomeInvalid(session, error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‘é€å¯¹åº”é€šçŸ¥</span></span><br><span class="line">    [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFURLSessionDidInvalidateNotification object:session];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ”¶åˆ°æœåŠ¡ç«¯çš„challengeï¼Œä¾‹å¦‚httpséœ€è¦éªŒè¯è¯ä¹¦ç­‰</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">didReceiveChallenge:(<span class="built_in">NSURLAuthenticationChallenge</span> *)challenge</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition, <span class="built_in">NSURLCredential</span> *credential))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">    __block <span class="built_in">NSURLCredential</span> *credential = <span class="literal">nil</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¦‚æœæœ‰å¯¹åº”å›è°ƒå—å°±æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.sessionDidReceiveAuthenticationChallenge) &#123;</span><br><span class="line">        disposition = <span class="keyword">self</span>.sessionDidReceiveAuthenticationChallenge(session, challenge, &amp;credential);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//å¤„ç†https</span></span><br><span class="line">        <span class="keyword">if</span> ([challenge.protectionSpace.authenticationMethod isEqualToString:<span class="built_in">NSURLAuthenticationMethodServerTrust</span>]) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span>.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]) &#123;</span><br><span class="line">                credential = [<span class="built_in">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];</span><br><span class="line">                <span class="keyword">if</span> (credential) &#123;</span><br><span class="line">                    disposition = <span class="built_in">NSURLSessionAuthChallengeUseCredential</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                disposition = <span class="built_in">NSURLSessionAuthChallengeCancelAuthenticationChallenge</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">        completionHandler(disposition, credential);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ä¸ªæ–¹æ³•æ˜¯NSURLSessionDelegateçš„æ–¹æ³•ï¼Œå…³äºéªŒè¯HTTPSçš„éƒ¨åˆ†ä»£ç å¯ä»¥å½“åšæ¨¡æ¿ä»£ç æ¥å†™ï¼Œå…·ä½“å†…å®¹ä¸æ˜¯æœ¬æ–‡è®²è§£èŒƒç•´ï¼Œè¯»è€…å¯è‡ªè¡ŒæŸ¥é˜…ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¦æ‰§è¡Œé‡å®šå‘çš„ä»£ç†æ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">willPerformHTTPRedirection:(<span class="built_in">NSHTTPURLResponse</span> *)response</span><br><span class="line">        newRequest:(<span class="built_in">NSURLRequest</span> *)request</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLRequest</span> *))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//å¥—è·¯å°±æ˜¯æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„å›è°ƒå—ï¼Œæ‰§è¡Œå®Œæˆå›è°ƒå—</span></span><br><span class="line">    <span class="built_in">NSURLRequest</span> *redirectRequest = request;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.taskWillPerformHTTPRedirection) &#123;</span><br><span class="line">        redirectRequest = <span class="keyword">self</span>.taskWillPerformHTTPRedirection(session, task, response, request);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">        completionHandler(redirectRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åŒå‰é¢ä¸€æ ·ï¼Œå¤„ç†httpsé“¾æ¥</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didReceiveChallenge:(<span class="built_in">NSURLAuthenticationChallenge</span> *)challenge</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition, <span class="built_in">NSURLCredential</span> *credential))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSURLSessionAuthChallengeDisposition</span> disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">    __block <span class="built_in">NSURLCredential</span> *credential = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.taskDidReceiveAuthenticationChallenge) &#123;</span><br><span class="line">        disposition = <span class="keyword">self</span>.taskDidReceiveAuthenticationChallenge(session, task, challenge, &amp;credential);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ([challenge.protectionSpace.authenticationMethod isEqualToString:<span class="built_in">NSURLAuthenticationMethodServerTrust</span>]) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span>.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]) &#123;</span><br><span class="line">                disposition = <span class="built_in">NSURLSessionAuthChallengeUseCredential</span>;</span><br><span class="line">                credential = [<span class="built_in">NSURLCredential</span> credentialForTrust:challenge.protectionSpace.serverTrust];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                disposition = <span class="built_in">NSURLSessionAuthChallengeCancelAuthenticationChallenge</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            disposition = <span class="built_in">NSURLSessionAuthChallengePerformDefaultHandling</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">        completionHandler(disposition, credential);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å¤„ç†éœ€è¦ä¸€ä¸ªæ–°çš„æµ</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line"> needNewBodyStream:(<span class="keyword">void</span> (^)(<span class="built_in">NSInputStream</span> *bodyStream))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„å›è°ƒå—æ¥è·å–ï¼Œæˆ–è€…copyä¸€ä¸ª</span></span><br><span class="line">    <span class="built_in">NSInputStream</span> *inputStream = <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.taskNeedNewBodyStream) &#123;</span><br><span class="line">        inputStream = <span class="keyword">self</span>.taskNeedNewBodyStream(session, task);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.originalRequest.HTTPBodyStream &amp;&amp; [task.originalRequest.HTTPBodyStream conformsToProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">NSCopying</span>)]) </span>&#123;</span><br><span class="line">        inputStream = [task.originalRequest.HTTPBodyStream <span class="keyword">copy</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">        completionHandler(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä¸Šä¼ ä»»åŠ¡çš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">   didSendBodyData:(int64_t)bytesSent</span><br><span class="line">    totalBytesSent:(int64_t)totalBytesSent</span><br><span class="line">totalBytesExpectedToSend:(int64_t)totalBytesExpectedToSend</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–ä¸Šä¼ çš„æ€»å¤§å°ï¼Œå¦‚æœæ•°æ®ä¸æ­£ç¡®å°±ä»httpé¦–éƒ¨ä¸­è·å–</span></span><br><span class="line">    int64_t totalUnitCount = totalBytesExpectedToSend;</span><br><span class="line">    <span class="keyword">if</span>(totalUnitCount == <span class="built_in">NSURLSessionTransferSizeUnknown</span>) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *contentLength = [task.originalRequest valueForHTTPHeaderField:<span class="string">@"Content-Length"</span>];</span><br><span class="line">        <span class="keyword">if</span>(contentLength) &#123;</span><br><span class="line">            totalUnitCount = (int64_t) [contentLength longLongValue];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è·å–taskå…³è”çš„AFURLSessionManagerTaskDelegateå¯¹è±¡</span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:task];</span><br><span class="line">    <span class="comment">//å¦‚æœä»£ç†å¯¹è±¡å­˜åœ¨ï¼Œå°±è°ƒç”¨ä»£ç†å¯¹è±¡çš„è¿™ä¸ªæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (delegate) &#123;</span><br><span class="line">        [delegate URLSession:session task:task didSendBodyData:bytesSent totalBytesSent:totalBytesSent totalBytesExpectedToSend:totalBytesExpectedToSend];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœç”¨æˆ·è‡ªå®šä¹‰å›è°ƒå—å­˜åœ¨ï¼Œæ‰§è¡Œå›è°ƒå—</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.taskDidSendBodyData) &#123;</span><br><span class="line">        <span class="keyword">self</span>.taskDidSendBodyData(session, task, bytesSent, totalBytesSent, totalUnitCount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ä»»åŠ¡å®Œæˆçš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">              task:(<span class="built_in">NSURLSessionTask</span> *)task</span><br><span class="line">didCompleteWithError:(<span class="built_in">NSError</span> *)error</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//åŒæ ·çš„å¥—è·¯ï¼Œè·å–å…³è”çš„ä»£ç†å¯¹è±¡ï¼Œæ‰‹åŠ¨è°ƒç”¨ä»£ç†å¯¹è±¡çš„è¿™ä¸ªæ–¹æ³•ï¼Œæ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„å›è°ƒå—</span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:task];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// delegate may be nil when completing a task in the background</span></span><br><span class="line">    <span class="keyword">if</span> (delegate) &#123;</span><br><span class="line">        [delegate URLSession:session task:task didCompleteWithError:error];</span><br><span class="line"></span><br><span class="line">        [<span class="keyword">self</span> removeDelegateForTask:task];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.taskDidComplete) &#123;</span><br><span class="line">        <span class="keyword">self</span>.taskDidComplete(session, task, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç æ˜¯NSURLSessionTaskDelegateçš„å›è°ƒæ–¹æ³•ï¼Œé€šè¿‡ä¸Šé¢çš„ä»£ç å¯ä»¥å‘ç°AFURLSessionManagerTaskDelegateçš„ä½œç”¨äº†ï¼ŒAFURLSessionManagerçš„ä»£ç†æ–¹æ³•ä¸­ä¼šæ ¹æ®taskè·å–åˆ°å¯¹åº”çš„delegateï¼Œå¦‚æœéœ€è¦æå‰å¤„ç†ä¸€äº›æ•°æ®å°±å…ˆå¤„ç†ï¼Œå¤„ç†å®Œæˆåæ‰‹åŠ¨è§¦å‘delegateä¸­çš„å¯¹åº”æ–¹æ³•ï¼Œç„¶åå…·ä½“çš„æ•°æ®å¤„ç†å°±äº¤ç”±AFURLSessionManagerTaskDelegateæ¥å¤„ç†ã€‚ç»§ç»­çœ‹å…¶ä»–ä»£ç†æ–¹æ³•:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ”¶åˆ°æœåŠ¡ç«¯å“åº”çš„ä»£ç†å›è°ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">          dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">didReceiveResponse:(<span class="built_in">NSURLResponse</span> *)response</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLSessionResponseDisposition</span> disposition))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰å›è°ƒå—ï¼Œæ‰§è¡Œå®Œæˆå›è°ƒå—</span></span><br><span class="line">    <span class="built_in">NSURLSessionResponseDisposition</span> disposition = <span class="built_in">NSURLSessionResponseAllow</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.dataTaskDidReceiveResponse) &#123;</span><br><span class="line">        disposition = <span class="keyword">self</span>.dataTaskDidReceiveResponse(session, dataTask, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">        completionHandler(disposition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">          dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">didBecomeDownloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">&#123;</span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:dataTask];</span><br><span class="line">    <span class="keyword">if</span> (delegate) &#123;</span><br><span class="line">        [<span class="keyword">self</span> removeDelegateForTask:dataTask];</span><br><span class="line">        [<span class="keyword">self</span> setDelegate:delegate forTask:downloadTask];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.dataTaskDidBecomeDownloadTask) &#123;</span><br><span class="line">        <span class="keyword">self</span>.dataTaskDidBecomeDownloadTask(session, dataTask, downloadTask);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">          dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line">    didReceiveData:(<span class="built_in">NSData</span> *)data</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–ä»£ç†ï¼Œç„¶åè°ƒç”¨ä»£ç†çš„è¿™ä¸ªæ–¹æ³•ï¼Œæœ‰è‡ªå®šä¹‰å›è°ƒå—å°±æ‰§è¡Œ</span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:dataTask];</span><br><span class="line">    [delegate URLSession:session dataTask:dataTask didReceiveData:data];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.dataTaskDidReceiveData) &#123;</span><br><span class="line">        <span class="keyword">self</span>.dataTaskDidReceiveData(session, dataTask, data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">          dataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask</span><br><span class="line"> willCacheResponse:(<span class="built_in">NSCachedURLResponse</span> *)proposedResponse</span><br><span class="line"> completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSCachedURLResponse</span> *cachedResponse))completionHandler</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSCachedURLResponse</span> *cachedResponse = proposedResponse;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.dataTaskWillCacheResponse) &#123;</span><br><span class="line">        cachedResponse = <span class="keyword">self</span>.dataTaskWillCacheResponse(session, dataTask, proposedResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (completionHandler) &#123;</span><br><span class="line">        completionHandler(cachedResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)URLSessionDidFinishEventsForBackgroundURLSession:(<span class="built_in">NSURLSession</span> *)session &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.didFinishEventsForBackgroundURLSession) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            <span class="keyword">self</span>.didFinishEventsForBackgroundURLSession(session);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ˜¯NSURLSessionDataDelegateçš„ä»£ç†æ–¹æ³•ï¼ŒåŒæ ·çš„ï¼Œå¦‚æœAFURLSessionManagerTaskDelegateèƒ½å“åº”çš„å…³äºæ•°æ®å¤„ç†çš„æ–¹æ³•éƒ½ä¼šé€šè¿‡taskæ‰¾åˆ°å¯¹åº”delegateåè°ƒç”¨å…¶å¯¹åº”çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰çš„å›è°ƒå—ï¼Œå¦‚æœä»£ç†ä¸èƒ½å“åº”çš„æ–¹æ³•å°±ç”±AFURLSessionManagerè‡ªè¡Œå¤„ç†ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸‹è½½ä»»åŠ¡ä¸‹è½½æ–‡ä»¶å®Œæˆåçš„å›è°ƒæ–¹æ³•</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">      downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">didFinishDownloadingToURL:(<span class="built_in">NSURL</span> *)location</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//è·å–å¯¹åº”çš„ä»£ç†å¯¹è±¡</span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:downloadTask];</span><br><span class="line">    <span class="comment">//å¦‚æœdownloadTaskDidFinishDownloadingå›è°ƒå—å­˜åœ¨å°±æ‰§è¡Œå®ƒæ¥è·å–ä¸€ä¸ªä¿å­˜æ–‡ä»¶çš„URLè·¯å¾„</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadTaskDidFinishDownloading) &#123;</span><br><span class="line">        <span class="built_in">NSURL</span> *fileURL = <span class="keyword">self</span>.downloadTaskDidFinishDownloading(session, downloadTask, location);</span><br><span class="line">        <span class="comment">//å¦‚æœè¿™ä¸ªè·¯å¾„å­˜åœ¨å°±é€šè¿‡NSFileManageræ¥ç§»åŠ¨ï¼Œç§»åŠ¨å¤±è´¥å‘é€é€šçŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> (fileURL) &#123;</span><br><span class="line">            delegate.downloadFileURL = fileURL;</span><br><span class="line">            <span class="built_in">NSError</span> *error = <span class="literal">nil</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (![[<span class="built_in">NSFileManager</span> defaultManager] moveItemAtURL:location toURL:fileURL error:&amp;error]) &#123;</span><br><span class="line">                [[<span class="built_in">NSNotificationCenter</span> defaultCenter] postNotificationName:AFURLSessionDownloadTaskDidFailToMoveFileNotification object:downloadTask userInfo:error.userInfo];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (delegate) &#123;</span><br><span class="line">        [delegate URLSession:session downloadTask:downloadTask didFinishDownloadingToURL:location];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">      downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line">      didWriteData:(int64_t)bytesWritten</span><br><span class="line"> totalBytesWritten:(int64_t)totalBytesWritten</span><br><span class="line">totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//é€šè¿‡taskè·å–delegate</span></span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:downloadTask];</span><br><span class="line">    <span class="comment">//å¦‚æœdelegateå­˜åœ¨å°±è°ƒç”¨å…¶è¯¥æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (delegate) &#123;</span><br><span class="line">        [delegate URLSession:session downloadTask:downloadTask didWriteData:bytesWritten totalBytesWritten:totalBytesWritten totalBytesExpectedToWrite:totalBytesExpectedToWrite];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦‚æœå›è°ƒå—å­˜åœ¨å°±æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadTaskDidWriteData) &#123;</span><br><span class="line">        <span class="keyword">self</span>.downloadTaskDidWriteData(session, downloadTask, bytesWritten, totalBytesWritten, totalBytesExpectedToWrite);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åŒä¸Šå¥—è·¯</span></span><br><span class="line">- (<span class="keyword">void</span>)URLSession:(<span class="built_in">NSURLSession</span> *)session</span><br><span class="line">      downloadTask:(<span class="built_in">NSURLSessionDownloadTask</span> *)downloadTask</span><br><span class="line"> didResumeAtOffset:(int64_t)fileOffset</span><br><span class="line">expectedTotalBytes:(int64_t)expectedTotalBytes</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    AFURLSessionManagerTaskDelegate *delegate = [<span class="keyword">self</span> delegateForTask:downloadTask];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (delegate) &#123;</span><br><span class="line">        [delegate URLSession:session downloadTask:downloadTask didResumeAtOffset:fileOffset expectedTotalBytes:expectedTotalBytes];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.downloadTaskDidResume) &#123;</span><br><span class="line">        <span class="keyword">self</span>.downloadTaskDidResume(session, downloadTask, fileOffset, expectedTotalBytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°ç°åœ¨ä¸ºæ­¢ï¼ŒAFURLSessionManageræ‰€æœ‰æºç éƒ½çœ‹å®Œäº†ï¼Œä»£ç å°è£…äº†NSURLSessionå¹¶æä¾›äº†ç®€æ´çš„åˆ›å»ºNSURLSessionDataTaskã€NSURLSessionUploadTaskå’ŒNSURLSessionDownloadTaskå¯¹è±¡çš„æ–¹æ³•ï¼Œä½¿ç”¨äººå‘˜å¯ä»¥ä¸éœ€è¦è€ƒè™‘å…·ä½“çš„æ•°æ®å¤„ç†è¿‡ç¨‹ï¼Œæœ€ç®€å•çš„å¯ä»¥åªé€šè¿‡å›è°ƒå—æ¥è·å–ç½‘ç»œè¯·æ±‚çš„å„ç§ä¿¡æ¯ã€‚åœ¨å…·ä½“å®ç°ä¸Šï¼ŒAFURLSessionManageré€šè¿‡å®šä¹‰AFURLSessionManagerTaskDelegateæ¥åšå…·ä½“taskçš„æ•°æ®å¤„ç†ï¼Œè€ŒAFURLSessionManageråªå…³æ³¨äºé€šç”¨éƒ¨åˆ†çš„å®ç°ï¼Œå¹¶æä¾›å„ç§æ–¹æ³•å’Œå›è°ƒå—ç”¨äºå¤„ç†taskï¼Œä½¿å¾—ä»£ç ç»“æ„æ›´æ¸…æ™°ï¼ŒAFURLSessionManagerä»£ç†æ–¹æ³•ç»“æ„ä¹Ÿæ›´ç®€å•ã€‚</p><p>AFURLSessionManagerä¸ªäººæ€»ç»“</p><ol><li>AFURLSessionManagerTaskDelegate æ˜¯ä¸ºäº†å¯¹åº”æ¯ä¸€ä¸ªtaskï¼Œå•ç‹¬å®šä¹‰ä¸€ä¸ªç±»ï¼Œè§£è€¦åˆï¼Œä»£ç é€»è¾‘æ›´æ¸…æ™°</li><li>mutableData åœ¨è¯·æ±‚å®Œæˆä¹‹åç½®ä½ nilï¼ŒèŠ‚çœå†…å­˜</li><li>dispatch_semaphoreçš„ä½¿ç”¨ï¼Œä¿¡å·é‡çº¿ç¨‹åŒæ­¥</li><li>method swizzingå·§å¦™ç›‘å¬ task çš„ suspend å’Œ resume</li><li>NSLock å®‰å…¨åŠ é”ï¼Œé¿å…å­—å…¸ä¸­å‡å¦‚çš„ delegate å’Œ taskä¸å¯¹åº”</li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;NSURLSession æ˜¯ iOS7 æ—¶æ¨å‡ºçš„ï¼Œä¸ºäº†å–ä»£ NSURLConnectionï¼ˆåœ¨iOS9åºŸå¼ƒï¼‰ï¼ŒAFNetWorkingä½¿ç”¨ NSURLSession ä½œä¸ºåŸºç¡€çš„ç½‘ç»œè¯·æ±‚ç±»ã€‚NSURLSession å·¥ä½œåœ¨åœ¨ OSI ä¸ƒå±‚æ¨¡å‹ çš„ä¼šè¯å±‚ï¼Œä¼šè¯å±‚ä¹‹ä¸‹çš„æ‰€æœ‰å·¥ä½œï¼Œç³»ç»Ÿéƒ½å·²ç»å¸®æˆ‘ä»¬åšå¥½äº†ï¼Œæ‰€ä»¥ NSURLSession å¯ä»¥ç†è§£ä¸ºä¼šè¯ã€‚&lt;/p&gt;
    
    </summary>
    
      <category term="iOS" scheme="https://nixzhang5.github.io/categories/iOS/"/>
    
    
      <category term="AFNetWorkingåŸç†" scheme="https://nixzhang5.github.io/tags/AFNetWorking%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Github Blog With Hexo</title>
    <link href="https://nixzhang5.github.io/hello-world.html"/>
    <id>https://nixzhang5.github.io/hello-world.html</id>
    <published>2019-06-21T07:40:42.265Z</published>
    <updated>2019-06-24T10:16:01.754Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><a id="more"></a><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;documentation&lt;/a&gt; for more info. If you get any problems when using Hexo, you can find the answer in &lt;a href=&quot;https://hexo.io/docs/troubleshooting.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;troubleshooting&lt;/a&gt; or you can ask me on &lt;a href=&quot;https://github.com/hexojs/hexo/issues&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
    
    </summary>
    
      <category term="hexo" scheme="https://nixzhang5.github.io/categories/hexo/"/>
    
    
      <category term="hexo" scheme="https://nixzhang5.github.io/tags/hexo/"/>
    
  </entry>
  
</feed>
